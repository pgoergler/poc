var He=Object.defineProperty;var Be=(s,e,o)=>e in s?He(s,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):s[e]=o;var ie=(s,e,o)=>Be(s,typeof e!="symbol"?e+"":e,o);import{c as q}from"./index-rfbDyI-8.js";import{b as l,j as t,H as _,P as v,o as Ve,p as $e,u as Ee,c as Ge,N as Ue,e as Ye,q as Me,B as je,E as qe}from"./react-flow-Crnto5D5.js";import{A as Ke,v as Qe,w as Je,x as Ze,y as et,z as tt,B as ot,E as nt,u as be,c as P}from"./Toast-BomwcAb2.js";import{E as st,F as rt,G as Le,H as at,I as it,J as ct,L as lt,K as se,Q as dt,R as ut,T as J,U as ft,f as we,V as mt,D as gt,P as ve,c as Re,u as pt}from"./style-C_pQfByM.js";import{C as ue,F as ht,T as xt,P as bt}from"./FileAdapter-DmLU9xgd.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]],Et=q("clipboard-list",yt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wt=[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]],Te=q("cloud",wt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=[["path",{d:"M12 3q1 4 4 6.5t3 5.5a1 1 0 0 1-14 0 5 5 0 0 1 1-3 1 1 0 0 0 5 0c0-2-1.5-3-1.5-5q0-2 2.5-4",key:"1slcih"}]],So=q("flame",vt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _t=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],Oo=q("refresh-cw",_t);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=[["path",{d:"M12 3v18",key:"108xh3"}],["path",{d:"m19 8 3 8a5 5 0 0 1-6 0zV7",key:"zcdpyk"}],["path",{d:"M3 7h1a17 17 0 0 0 8-2 17 17 0 0 0 8 2h1",key:"1yorad"}],["path",{d:"m5 8 3 8a5 5 0 0 1-6 0zV7",key:"eua70x"}],["path",{d:"M7 21h10",key:"1b0cd5"}]],Do=q("scale",Nt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=[["path",{d:"M21 9a2.4 2.4 0 0 0-.706-1.706l-3.588-3.588A2.4 2.4 0 0 0 15 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z",key:"1dfntj"}],["path",{d:"M15 3v5a1 1 0 0 0 1 1h5",key:"6s6qgf"}]],Fo=q("sticky-note",kt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tt=[["path",{d:"M12 19h8",key:"baeox8"}],["path",{d:"m4 17 6-6-6-6",key:"1yngyt"}]],It=q("terminal",Tt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const At=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],zo=q("user",At);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ct=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],Se=q("zap",Ct),ce=120,Pt=152,Mt=112,jt={top:{source:"source-top",target:"target-bottom"},right:{source:"source-right",target:"target-left"},bottom:{source:"source-bottom",target:"target-top"},left:{source:"source-left",target:"target-right"}};function Lt(s){return jt[s]}function Rt(s,e,o,a){switch(a){case"top":return{x:s.x,y:s.y-ce};case"right":return{x:s.x+e+ce,y:s.y};case"bottom":return{x:s.x,y:s.y+o+ce};case"left":return{x:s.x-ce,y:s.y}}}function St(){const s=l.useContext(st);if(!s)throw new Error("useSimulationContext must be used within a SimulationProvider");return s}function Oe(){const s=l.useContext(rt);if(!s)throw new Error("useNonStandardConnectionContext must be used within a NonStandardConnectionProvider");return s}function Xo({open:s,onOpenChange:e,onConfirm:o,title:a,description:d,confirmLabel:i="Confirmer",cancelLabel:r="Annuler"}){const n=()=>{o(),e(!1)};return t.jsx(Ke,{open:s,onOpenChange:e,children:t.jsxs(Qe,{children:[t.jsxs(Je,{children:[t.jsx(Ze,{children:a}),t.jsx(et,{children:d})]}),t.jsxs(tt,{children:[t.jsx(ot,{children:r}),t.jsx(nt,{onClick:n,children:i})]})]})})}function Ot({pathRef:s,edgeId:e,onOffsetChange:o}){const[a,d]=l.useState(!1),i=l.useRef(!1),r=l.useCallback(n=>{n.stopPropagation(),n.preventDefault(),i.current=!1,d(!0)},[]);return l.useEffect(()=>{if(!a||!s.current)return;const n=f=>{var b;if(!s.current)return;i.current=!0;const p=s.current.ownerSVGElement;if(!p)return;const y=p.createSVGPoint();y.x=f.clientX,y.y=f.clientY;const m=y.matrixTransform((b=p.getScreenCTM())==null?void 0:b.inverse()),E=s.current.getTotalLength();let g=.5,x=1/0;for(let h=0;h<=100;h++){const w=h/100,T=s.current.getPointAtLength(E*w),A=Math.sqrt(Math.pow(T.x-m.x,2)+Math.pow(T.y-m.y,2));A<x&&(x=A,g=w)}const c=Math.max(.1,Math.min(.9,g));o(e,c)},u=()=>{d(!1)};return document.addEventListener("mousemove",n),document.addEventListener("mouseup",u),()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",u)}},[a,e,s,o]),{isDragging:a,hasDraggedRef:i,handleDragStart:r}}class Dt{serialize(e){try{const{graph:o,nodes:a,edges:d,mappings:i}=e,r=o.getAllNodes().map(m=>({id:m.id,label:m.label,kind:m.kind,category:m.category,executionMode:m.executionMode,config:m.config,awsExtension:m.awsExtension})),n=o.getAllTransitions().map(m=>({id:m.id,sourceDefId:m.sourceDefId,targetDefId:m.targetDefId})),u=a.filter(m=>m.type!=="outcome").map(m=>({id:m.id,definitionId:i.instanceToDefRef.get(m.id),position:{x:m.position.x,y:m.position.y}})),f=a.filter(m=>m.type==="outcome").map(m=>({id:m.id,label:m.data.label||"Outcome",parentPolicyInstanceId:m.parentId,parentPolicyDefId:m.data.parentPolicyDefId||"",position:{x:m.position.x,y:m.position.y}})),p=i.outcomeToTransitionRef?Array.from(i.outcomeToTransitionRef.entries()).map(([m,E])=>({outcomeId:m,transitionId:E})):[],y=d.filter(m=>i.edgeToTransitionRef.has(m.id)).map(m=>{const E=m.data;return{edgeId:m.id,transitionId:i.edgeToTransitionRef.get(m.id),source:m.source,target:m.target,sourceHandle:m.sourceHandle??void 0,targetHandle:m.targetHandle??void 0,label:E==null?void 0:E.label,labelOffset:E==null?void 0:E.labelOffset}});return{success:!0,workflow:{definitions:r,transitions:n,instances:u,edgeMappings:y,outcomes:f,outcomeEdgeMappings:p}}}catch(o){return{success:!1,error:{code:"VALIDATION_ERROR",message:"Failed to serialize workflow",details:o}}}}}class Ft{recoverOrphanEdges(e,o,a,d){var E;const{instanceToDefRef:i,defToInstancesRef:r,edgeToTransitionRef:n,transitionToEdgesRef:u}=a,f=e.filter(g=>{const x=n.get(g.id);return x?o.getTransition(x)!==void 0:!1}),p=new Set(f.map(g=>g.id));for(const g of n.keys())if(!p.has(g)){const x=n.get(g);n.delete(g),x&&((E=u.get(x))==null||E.delete(g))}const y=new Set(n.values()),m=o.getAllTransitions().filter(g=>!y.has(g.id));for(const g of m){const x=this.createEdgeForTransition(g,o,i,r,d);x&&(f.push(x),n.set(x.id,g.id),u.has(g.id)||u.set(g.id,new Set),u.get(g.id).add(x.id))}return{edges:f,edgeToTransitionRef:n,transitionToEdgesRef:u}}createEdgeForTransition(e,o,a,d,i){const r=d.get(e.sourceDefId),n=d.get(e.targetDefId);if(!(r!=null&&r.size)||!(n!=null&&n.size))return null;const u=r.values().next().value,f=n.values().next().value,p=i.get(u),y=i.get(f);if(!p||!y)return null;const{sourceHandle:m,targetHandle:E}=ct(),g=`edge_${u}_${f}`,x=o.getNode(e.sourceDefId),c=o.getNode(e.targetDefId),b=x?Le(x.kind):"floating",h=at(x==null?void 0:x.kind,c==null?void 0:c.kind);return{id:g,source:u,target:f,sourceHandle:m,targetHandle:E,type:b,data:{state:"idle",transitionId:e.id,...h,...b==="commandEdge"?it():{}}}}}class zt{constructor(){ie(this,"edgeRecovery",new Ft)}deserialize(e){try{const o=new lt;for(const c of e.definitions){const b={id:c.id,label:c.label,kind:c.kind,category:c.category,executionMode:c.executionMode,config:c.config,awsExtension:c.awsExtension};o.addNode(b)}for(const c of e.transitions){const b={id:c.id,sourceDefId:c.sourceDefId,targetDefId:c.targetDefId};o.addTransition(b)}const a=new Map,d=new Map,i=e.instances.map(c=>{const b=c.id,h=c.definitionId,w=o.getNode(h);a.set(b,h),d.has(h)||d.set(h,new Set),d.get(h).add(b);let T="event";return w.kind==="policy"?T="policy":w.kind==="externalSystem"?T="externalSystem":w.kind==="externalEvent"?T="externalEvent":w.kind==="command"?T="command":w.kind==="trigger"?T="trigger":w.kind==="hotspot"&&(T="hotspot"),{id:c.id,type:T,position:c.position,data:{label:w.label,executionMode:w.executionMode,definitionId:h}}}),r=new Map,n=new Map,u=new Map;if(e.outcomes)for(const c of e.outcomes){const b=c.id,h=c.parentPolicyInstanceId,w=c.parentPolicyDefId;r.set(b,h),n.has(h)||n.set(h,new Set),n.get(h).add(b),i.push({id:c.id,type:"outcome",position:c.position,parentId:c.parentPolicyInstanceId,data:{label:c.label,parentPolicyInstanceId:h,parentPolicyDefId:w}})}if(e.outcomeEdgeMappings)for(const c of e.outcomeEdgeMappings)u.set(c.outcomeId,c.transitionId);const f=new Map,p=new Map,y=e.edgeMappings.map(c=>{const b=c.transitionId,h=`edge_${c.source}_${c.target}`;f.set(h,b),p.has(b)||p.set(b,new Set),p.get(b).add(h);const w=r.has(c.source);let T;if(w){const L=r.get(c.source);T=L?a.get(L):void 0}else T=a.get(c.source);const A=T?o.getNode(T):void 0,j=A?Le(A.kind):"floating";return{id:h,source:c.source,target:c.target,sourceHandle:c.sourceHandle??"source-right",targetHandle:c.targetHandle??"target-left",type:j,data:{state:"idle",transitionId:b,...c.label!==void 0?{label:c.label}:{},...c.labelOffset!==void 0?{labelOffset:c.labelOffset}:{}}}}),m=new Map(i.map(c=>[c.id,c])),E={instanceToDefRef:a,defToInstancesRef:d,edgeToTransitionRef:f,transitionToEdgesRef:p,outcomeToParentRef:r,policyToOutcomesRef:n,outcomeToTransitionRef:u},g=this.edgeRecovery.recoverOrphanEdges(y,o,E,m),x={instanceToDefRef:a,defToInstancesRef:d,edgeToTransitionRef:g.edgeToTransitionRef,transitionToEdgesRef:g.transitionToEdgesRef,outcomeToParentRef:r,policyToOutcomesRef:n,outcomeToTransitionRef:u};return{success:!0,workflow:{graph:o,nodes:i,edges:g.edges,mappings:x}}}catch(o){return{success:!1,error:{code:"VALIDATION_ERROR",message:"Failed to deserialize workflow",details:o}}}}}class Xt{constructor(){ie(this,"serialization",new Dt);ie(this,"deserialization",new zt)}serialize(e){return this.serialization.serialize(e)}deserialize(e){return this.deserialization.deserialize(e)}}const ne=new Map,Wt=s=>{const e=s.workflow,o=new Set(e.definitions.filter(r=>r.kind==="command"&&r.label.trim()==="").map(r=>r.id));if(o.size===0)return s;const a=new Set(e.transitions.filter(r=>o.has(r.sourceDefId)).map(r=>r.id)),d=new Set(e.instances.filter(r=>o.has(r.definitionId)).map(r=>r.id)),i=new Set(e.edgeMappings.filter(r=>a.has(r.transitionId)||d.has(r.source)||d.has(r.target)).map(r=>r.edgeId));return{...s,workflow:{...e,definitions:e.definitions.filter(r=>!o.has(r.id)),transitions:e.transitions.filter(r=>!a.has(r.id)),instances:e.instances.filter(r=>!d.has(r.id)),edgeMappings:e.edgeMappings.filter(r=>!i.has(r.edgeId))}}},Ht=s=>{const e=s.metadata.name.toLowerCase().trim().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-");return{...s,metadata:{...s.metadata,slugName:e}}},Bt=s=>{const o=s.metadata.targetPlugin==="none"?void 0:s.metadata.targetPlugin;return{...s,metadata:{...s.metadata,targetPlugin:o}}},Vt=s=>({...s,metadata:{...s.metadata,pluginConfig:{}}}),$t=s=>({...s,workflow:{...s.workflow,definitions:s.workflow.definitions.map(e=>({...e,kind:e.kind==="externalSystem"?"externalEvent":e.kind}))}});ne.set(2,Wt);ne.set(3,Ht);ne.set(4,Bt);ne.set(5,Vt);ne.set(6,$t);class Gt{migrate(e){try{let o=e;for(;o.version<ue;){const a=ne.get(o.version);if(!a)return{success:!1,error:{code:"MIGRATION_ERROR",message:`No migration found for version ${o.version}`}};o=a(o),o={...o,version:o.version+1}}return{success:!0,document:o}}catch(o){return{success:!1,error:{code:"MIGRATION_ERROR",message:"Migration failed",details:o}}}}validate(e){if(!e.version||typeof e.version!="number"||!e.metadata||!e.workflow||!Array.isArray(e.workflow.definitions)||!Array.isArray(e.workflow.transitions)||!Array.isArray(e.workflow.instances)||!Array.isArray(e.workflow.edgeMappings))return!1;for(const o of e.workflow.definitions)if(!o.id.startsWith("def_"))return!1;for(const o of e.workflow.transitions)if(!o.id.startsWith("trans_"))return!1;for(const o of e.workflow.instances)if(!o.id.startsWith("inst_"))return!1;return!0}}const le="arko:workflow";class Ut{async save(e){try{const o=JSON.stringify(e);return localStorage.setItem(le,o),{success:!0}}catch(o){return{success:!1,error:{code:"STORAGE_ERROR",message:"Failed to save to localStorage",details:o}}}}async load(){try{const e=localStorage.getItem(le);return e?{success:!0,document:JSON.parse(e)}:{success:!1,error:{code:"NOT_FOUND",message:"No workflow found in localStorage"}}}catch(e){return{success:!1,error:{code:"PARSE_ERROR",message:"Failed to parse stored workflow",details:e}}}}async exists(){return localStorage.getItem(le)!==null}async clear(){try{return localStorage.removeItem(le),{success:!0}}catch(e){return{success:!1,error:{code:"STORAGE_ERROR",message:"Failed to clear localStorage",details:e}}}}}const Yt="1.0",qt="https://arko.dev/ir/v1.json",Kt={id:"serverless-aws-ts",name:"Serverless / TypeScript / AWS",description:"AWS Lambda with TypeScript and Serverless Framework",nodeExtensions:{command:{timeout:30,memory:128},trigger:{timeout:30,memory:128}}},Qt={id:"serverless-aws-php",name:"Serverless / PHP / AWS (Bref)",description:"AWS Lambda with PHP 8.3 and Bref.sh",nodeExtensions:{command:{timeout:30,memory:128},trigger:{timeout:30,memory:128}}},De=new Map([["serverless-aws-ts",Kt],["serverless-aws-php",Qt]]);function Jt(s){return De.get(s)}function Wo(){return Array.from(De.values())}class Zt{compile(e,o){try{const{graph:a,nodes:d,mappings:i}=e,r=o.metadata.targetPlugin?Jt(o.metadata.targetPlugin):void 0,n=r?this.getExtensionProviderForPlugin(r.id):void 0,u=a.getAllNodes(),f=[],p=[],y=[],m=[];for(const h of u)switch(h.kind){case"event":f.push(h);break;case"command":p.push(h);break;case"trigger":y.push(h);break;case"policy":m.push(h);break}const E=this.buildEventTypeMap(f),g=this.compileEvents(f,E),x=this.compilePolicies(m,a,d,i,E),c=this.compileCommands(p,y,a,E,x,n);return{success:!0,ir:{$schema:qt,version:Yt,metadata:{workflowId:dt(),name:o.metadata.name,slugName:o.metadata.slugName||se(o.metadata.name),targetPlugin:o.metadata.targetPlugin,generatedAt:new Date().toISOString(),sourceVersion:6,pluginConfig:o.metadata.pluginConfig},events:g,commands:c,policies:x}}}catch(a){return{success:!1,error:{code:"COMPILATION_ERROR",message:a instanceof Error?a.message:"Unknown compilation error",details:a}}}}getExtensionProviderForPlugin(e){if(e==="serverless-aws-ts")return{getExtensions(o,a){if(!(o.kind!=="command"&&o.kind!=="trigger")&&a)return{aws:{timeout:a.timeout,memory:a.memory}}}}}buildEventTypeMap(e){const o=new Map;for(const a of e){const d=a.config,i=(d==null?void 0:d.type)||ut(a.label);o.set(a.id,i)}return o}compileEvents(e,o){return e.map(a=>{const d=a.config;return{id:J(a.id),name:a.label,type:o.get(a.id),schema:d!=null&&d.schema?this.convertSchema(d.schema):null,outputPath:d==null?void 0:d.outputPath}})}compilePolicies(e,o,a,d,i){return e.map(r=>{var E,g,x,c;const u=o.getIncomingTransitions(r.id).map(b=>i.get(b.sourceDefId)).filter(b=>b!==void 0),f=d.defToInstancesRef.get(r.id),p=f==null?void 0:f.values().next().value,y=p?(E=d.policyToOutcomesRef)==null?void 0:E.get(p):void 0,m=[];if(y){const b=r.config;for(const h of y){const w=a.find(I=>I.id===h),T=((g=w==null?void 0:w.data)==null?void 0:g.label)||"Outcome",A=(x=b==null?void 0:b.outcomeConditions)==null?void 0:x.find(I=>I.outcomeLabel===T),j=(c=d.outcomeToTransitionRef)==null?void 0:c.get(h),L=[];if(j){const I=o.getTransition(j);if(I){const C=o.getNode(I.targetDefId);C&&(C.kind==="command"||C.kind==="trigger")&&L.push(J(C.id))}}m.push({id:J(h),label:T,condition:(A==null?void 0:A.condition)||"",targetCommandIds:L})}}return{id:J(r.id),name:r.label,slugName:se(r.label),consumes:u,outcomes:m}})}compileCommands(e,o,a,d,i,r){const n=[];for(const u of e){const f=this.compileCommand(u,a,d,i,r);n.push(f)}for(const u of o){const f=this.compileTriggerAsCommand(u,a,d,r);f&&n.push(f)}return n}compileCommand(e,o,a,d,i){const r=e.config,u=o.getOutgoingTransitions(e.id).map(y=>a.get(y.targetDefId)).filter(y=>y!==void 0),f=this.buildConsumptions(e.id,o,a,d),p=i==null?void 0:i.getExtensions(e,e.awsExtension);return{id:J(e.id),name:e.label,slugName:(r==null?void 0:r.slugName)||se(e.label,"unnamed"),produces:u,trigger:"consumer",consumes:f,requestSchema:r!=null&&r.requestSchema?this.convertSchema(r.requestSchema):null,extensions:p,outputPath:r==null?void 0:r.outputPath}}compileTriggerAsCommand(e,o,a,d){const i=e.config,n=o.getOutgoingTransitions(e.id).map(y=>a.get(y.targetDefId)).filter(y=>y!==void 0),u=d==null?void 0:d.getExtensions(e,e.awsExtension),f={id:J(e.id),name:e.label,slugName:(i==null?void 0:i.slugName)||se(e.label),produces:n,extensions:u,outputPath:i==null?void 0:i.outputPath};if((i==null?void 0:i.triggerType)==="schedule"&&i.schedule)return{...f,trigger:"scheduled",schedule:i.schedule};const p=(i==null?void 0:i.path)||`/${se(e.label)}`;return{...f,trigger:"http",http:{method:(i==null?void 0:i.httpMethod)||"POST",path:p,pathParameters:ft(p)},requestSchema:i!=null&&i.schema?this.convertSchema(i.schema):null}}buildConsumptions(e,o,a,d){const i=[],r=o.getIncomingTransitions(e);for(const n of r){const u=o.getNode(n.sourceDefId);if(u){if(u.kind==="event"){const f=a.get(u.id);f&&i.push({type:"event",eventType:f})}else if(u.kind==="policy"){const f=d.find(p=>p.id===J(u.id));if(f){const p=f.outcomes.find(y=>y.targetCommandIds.includes(J(e)));p&&i.push({type:"policy",policyId:f.id,outcomeId:p.id})}}}}return i}convertSchema(e){return{properties:e.map(o=>this.convertSchemaProperty(o))}}convertSchemaProperty(e){const o={name:e.name,required:e.required??!1};return e.type==="array"&&e.items?{...o,type:"array",items:{properties:[this.convertSchemaProperty(e.items)]}}:e.type==="object"&&e.properties?{...o,type:"object",nested:this.convertSchema(e.properties)}:{...o,type:e.type}}}const ye={version:7,metadata:{name:"E-commerce Order",slugName:"ecommerce-order",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),description:"Example workflow demonstrating an e-commerce order flow with stock checking"},workflow:{definitions:[{id:"def_01EXAMPLE_TRIGGER",label:"Order Received",kind:"trigger",category:"technical",executionMode:"manual",config:{slugName:"order-received",triggerType:"http",httpMethod:"POST",path:"/orders"}},{id:"def_01EXAMPLE_CMD_CREATE",label:"Create Order",kind:"command",category:"business",executionMode:"automatic",config:{slugName:"create-order"}},{id:"def_01EXAMPLE_EVT_CREATED",label:"Order Created",kind:"event",category:"business",executionMode:"automatic",config:{type:"order.created"}},{id:"def_01EXAMPLE_POLICY",label:"Check Stock",kind:"policy",category:"business",executionMode:"manual",config:{type:"check-stock",outcomeConditions:[{outcomeLabel:"In Stock",condition:"item.quantity > 0"},{outcomeLabel:"Out of Stock",condition:"item.quantity === 0"}]}},{id:"def_01EXAMPLE_CMD_PAYMENT",label:"Process Payment",kind:"command",category:"business",executionMode:"automatic",config:{slugName:"process-payment"}},{id:"def_01EXAMPLE_CMD_NOTIFY",label:"Notify Out of Stock",kind:"command",category:"business",executionMode:"automatic",config:{slugName:"notify-out-of-stock"}},{id:"def_01EXAMPLE_EVT_PAYMENT",label:"Payment Processed",kind:"event",category:"business",executionMode:"automatic",config:{type:"payment.processed"}},{id:"def_01EXAMPLE_EVT_NOTIFIED",label:"Customer Notified",kind:"event",category:"business",executionMode:"automatic",config:{type:"customer.notified"}}],transitions:[{id:"trans_01EXAMPLE_T1",sourceDefId:"def_01EXAMPLE_TRIGGER",targetDefId:"def_01EXAMPLE_CMD_CREATE"},{id:"trans_01EXAMPLE_T2",sourceDefId:"def_01EXAMPLE_CMD_CREATE",targetDefId:"def_01EXAMPLE_EVT_CREATED"},{id:"trans_01EXAMPLE_T3",sourceDefId:"def_01EXAMPLE_EVT_CREATED",targetDefId:"def_01EXAMPLE_POLICY"},{id:"trans_01EXAMPLE_T4",sourceDefId:"def_01EXAMPLE_POLICY",targetDefId:"def_01EXAMPLE_CMD_PAYMENT"},{id:"trans_01EXAMPLE_T5",sourceDefId:"def_01EXAMPLE_POLICY",targetDefId:"def_01EXAMPLE_CMD_NOTIFY"},{id:"trans_01EXAMPLE_T6",sourceDefId:"def_01EXAMPLE_CMD_PAYMENT",targetDefId:"def_01EXAMPLE_EVT_PAYMENT"},{id:"trans_01EXAMPLE_T7",sourceDefId:"def_01EXAMPLE_CMD_NOTIFY",targetDefId:"def_01EXAMPLE_EVT_NOTIFIED"}],instances:[{id:"inst_01EXAMPLE_TRIGGER",definitionId:"def_01EXAMPLE_TRIGGER",position:{x:100,y:300}},{id:"inst_01EXAMPLE_CMD_CREATE",definitionId:"def_01EXAMPLE_CMD_CREATE",position:{x:320,y:300}},{id:"inst_01EXAMPLE_EVT_CREATED",definitionId:"def_01EXAMPLE_EVT_CREATED",position:{x:540,y:300}},{id:"inst_01EXAMPLE_POLICY",definitionId:"def_01EXAMPLE_POLICY",position:{x:760,y:300}},{id:"inst_01EXAMPLE_CMD_PAYMENT",definitionId:"def_01EXAMPLE_CMD_PAYMENT",position:{x:1100,y:180}},{id:"inst_01EXAMPLE_CMD_NOTIFY",definitionId:"def_01EXAMPLE_CMD_NOTIFY",position:{x:1100,y:420}},{id:"inst_01EXAMPLE_EVT_PAYMENT",definitionId:"def_01EXAMPLE_EVT_PAYMENT",position:{x:1320,y:180}},{id:"inst_01EXAMPLE_EVT_NOTIFIED",definitionId:"def_01EXAMPLE_EVT_NOTIFIED",position:{x:1320,y:420}}],edgeMappings:[{edgeId:"edge_01EXAMPLE_E1",transitionId:"trans_01EXAMPLE_T1",source:"inst_01EXAMPLE_TRIGGER",target:"inst_01EXAMPLE_CMD_CREATE"},{edgeId:"edge_01EXAMPLE_E2",transitionId:"trans_01EXAMPLE_T2",source:"inst_01EXAMPLE_CMD_CREATE",target:"inst_01EXAMPLE_EVT_CREATED"},{edgeId:"edge_01EXAMPLE_E3",transitionId:"trans_01EXAMPLE_T3",source:"inst_01EXAMPLE_EVT_CREATED",target:"inst_01EXAMPLE_POLICY"},{edgeId:"edge_01EXAMPLE_E4",transitionId:"trans_01EXAMPLE_T4",source:"outcome_01EXAMPLE_INSTOCK",target:"inst_01EXAMPLE_CMD_PAYMENT"},{edgeId:"edge_01EXAMPLE_E5",transitionId:"trans_01EXAMPLE_T5",source:"outcome_01EXAMPLE_OUTSTOCK",target:"inst_01EXAMPLE_CMD_NOTIFY"},{edgeId:"edge_01EXAMPLE_E6",transitionId:"trans_01EXAMPLE_T6",source:"inst_01EXAMPLE_CMD_PAYMENT",target:"inst_01EXAMPLE_EVT_PAYMENT"},{edgeId:"edge_01EXAMPLE_E7",transitionId:"trans_01EXAMPLE_T7",source:"inst_01EXAMPLE_CMD_NOTIFY",target:"inst_01EXAMPLE_EVT_NOTIFIED"}],outcomes:[{id:"outcome_01EXAMPLE_INSTOCK",label:"In Stock",parentPolicyInstanceId:"inst_01EXAMPLE_POLICY",parentPolicyDefId:"def_01EXAMPLE_POLICY",position:{x:162,y:-30}},{id:"outcome_01EXAMPLE_OUTSTOCK",label:"Out of Stock",parentPolicyInstanceId:"inst_01EXAMPLE_POLICY",parentPolicyDefId:"def_01EXAMPLE_POLICY",position:{x:162,y:100}}],outcomeEdgeMappings:[{outcomeId:"outcome_01EXAMPLE_INSTOCK",transitionId:"trans_01EXAMPLE_T4"},{outcomeId:"outcome_01EXAMPLE_OUTSTOCK",transitionId:"trans_01EXAMPLE_T5"}]}},de="Untitled Workflow",eo=1e3,Fe="arko:workflows";function Y(s){return s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"workflow"}function Ie(){try{const s=localStorage.getItem(Fe);return s?JSON.parse(s):[]}catch{return[]}}function to(s){try{localStorage.setItem(Fe,JSON.stringify(s))}catch(e){console.error("Failed to save workflows to localStorage:",e)}}const oo=l.createContext(null);function Ho({children:s,initialWorkflowId:e}){const o=we(),[a,d]=l.useState(!0),[i,r]=l.useState(null),[n,u]=l.useState(de),[f,p]=l.useState(()=>Y(de)),[y,m]=l.useState(void 0),[E,g]=l.useState({}),[x,c]=l.useState(null),[b,h]=l.useState(null),[w,T]=l.useState(!1),A=l.useRef(null),j=l.useCallback(k=>{u(N=>(p(M=>M===Y(N)?Y(k):M),k))},[]),L=l.useCallback(k=>{p(k)},[]),I=l.useRef(new Xt),C=l.useRef(new Gt),B=l.useRef(new Ut),V=l.useRef(new ht),$=l.useRef(new Zt),X=l.useRef(void 0),W=l.useRef(!1),O=l.useRef(!1),S=l.useCallback(k=>{const N=I.current.deserialize(k.workflow);return N.success?(o.hydrateWorkflow(N.workflow),u(k.metadata.name),p(k.metadata.slugName||Y(k.metadata.name)),m(k.metadata.targetPlugin),g(k.metadata.pluginConfig??{}),c(k.metadata.createdAt),!0):!1},[o]);l.useEffect(()=>{(async()=>{try{const N=await B.current.load();if(N.success){if(!C.current.validate(N.document)){console.warn("Invalid workflow document in localStorage, loading example instead"),S(ye),d(!1);return}const M=C.current.migrate(N.document);M.success&&S(M.document)}else console.info("No saved workflow found, loading example workflow"),S(ye)}catch(N){console.error("Failed to load workflow from localStorage:",N),S(ye)}finally{d(!1)}})()},[]);const K=l.useCallback(async()=>{const k=o.getWorkflowState(),N=I.current.serialize(k);if(!N.success)return{success:!1,error:N.error};const M=new Date().toISOString(),R={version:ue,metadata:{name:n,slugName:f,targetPlugin:y,pluginConfig:E,createdAt:x||M,updatedAt:M},workflow:N.workflow};return x||c(M),B.current.save(R)},[o,n,f,y,E,x]),{nodes:D,edges:re}=o;l.useEffect(()=>{if(!a){if(!W.current){W.current=!0;return}return X.current&&clearTimeout(X.current),X.current=setTimeout(()=>{K()},eo),()=>{X.current&&clearTimeout(X.current)}}},[D,re,n,f,y,E,K,a]);const Q=l.useCallback(()=>{const k=o.getWorkflowState(),N=I.current.serialize(k);if(!N.success)return{success:!1,error:N.error};const M=new Date().toISOString(),R={version:ue,metadata:{name:n,slugName:f,targetPlugin:y,pluginConfig:E,createdAt:x||M,updatedAt:M},workflow:N.workflow},Z=`${f||Y(n)}.json`;return V.current.exportToFile(R,Z)},[o,n,f,y,E,x]),me=l.useCallback(()=>{const k=o.getWorkflowState(),N=new Date().toISOString();return $.current.compile(k,{metadata:{name:n,slugName:f||Y(n),targetPlugin:y,pluginConfig:E,createdAt:x||N,updatedAt:N}})},[o,n,f,y,E,x]),F=l.useCallback(()=>{const k=o.getWorkflowState(),N=I.current.serialize(k);if(!N.success)throw new Error(N.error.message);const M=new Date().toISOString();return{version:ue,metadata:{name:n,slugName:f||Y(n),targetPlugin:y,pluginConfig:E,createdAt:x||M,updatedAt:M},workflow:N.workflow}},[o,n,f,y,E,x]),ge=l.useCallback(async()=>{const k=await V.current.importFromFile();if(!k.success)return k;if(!C.current.validate(k.document))return{success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid workflow file format"}};const N=C.current.migrate(k.document);if(!N.success)return{success:!1,error:N.error};const M=I.current.deserialize(N.document.workflow);return M.success?(o.hydrateWorkflow(M.workflow),u(N.document.metadata.name),p(N.document.metadata.slugName||Y(N.document.metadata.name)),m(N.document.metadata.targetPlugin),g(N.document.metadata.pluginConfig??{}),c(N.document.metadata.createdAt),await B.current.save(N.document),{success:!0,document:N.document}):{success:!1,error:M.error}},[o]),pe=l.useCallback(async()=>(u(de),p(Y(de)),m(void 0),g({}),c(null),h(null),T(!1),A.current=null,B.current.clear()),[]),H=l.useCallback(k=>JSON.stringify({workflow:k.workflow,name:k.metadata.name,slugName:k.metadata.slugName,targetPlugin:k.metadata.targetPlugin,pluginConfig:k.metadata.pluginConfig}),[]),he=l.useCallback(async()=>{const k=F();try{const N=Ie(),M=new Date().toISOString();if(b){const R=N.findIndex(Z=>Z.id===b);R!==-1&&(N[R]={...N[R],document:k,updatedAt:M})}else console.warn("saveToApi called without currentWorkflowId");return to(N),A.current=H(k),T(!1),{success:!0}}catch(N){return{success:!1,error:{code:"STORAGE_ERROR",message:N instanceof Error?N.message:"Failed to save workflow"}}}},[F,b,H]),U=l.useCallback(async k=>{try{const M=Ie().find(ee=>ee.id===k);if(!M)return{success:!1,error:{code:"NOT_FOUND",message:"Workflow not found"}};if(!C.current.validate(M.document))return{success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid workflow document"}};const R=C.current.migrate(M.document);return R.success?S(R.document)?(h(M.id),A.current=H(R.document),T(!1),await B.current.save(R.document),{success:!0,document:R.document}):{success:!1,error:{code:"PARSE_ERROR",message:"Failed to hydrate workflow"}}:{success:!1,error:R.error}}catch(N){return{success:!1,error:{code:"STORAGE_ERROR",message:N instanceof Error?N.message:"Failed to load workflow"}}}},[S,H]);return l.useEffect(()=>{if(a||A.current!==null||b!==null)return;const k=F();A.current=H(k)},[a,b,F,H]),l.useEffect(()=>{if(a||!W.current||A.current===null)return;const k=F(),N=H(k);T(N!==A.current)},[D,re,n,f,y,E,a,F,H]),l.useEffect(()=>{a||e&&!O.current&&(O.current=!0,d(!0),r(null),U(e).then(k=>{k.success||(console.error("Failed to load workflow from URL:",k.error.message),r(k.error))}).finally(()=>{d(!1)}))},[a,e,U]),t.jsx(oo.Provider,{value:{isLoading:a,loadError:i,workflowName:n,setWorkflowName:j,slugName:f,setSlugName:L,targetPlugin:y,setTargetPlugin:m,pluginConfig:E,setPluginConfig:g,saveToLocalStorage:K,exportToFile:Q,exportToIR:me,getWorkflowDocument:F,importFromFile:ge,clearStorage:pe,currentWorkflowId:b,isDirty:w,saveToApi:he,loadFromApi:U,hydrateDocument:S},children:s})}const ze=10,fe=50;function no(s,e){const o=l.useRef([]);return l.useEffect(()=>()=>{o.current.forEach(clearTimeout)},[]),{execute:l.useCallback((d,i)=>{const{isRunning:r,start:n,triggerNode:u,selectTransition:f}=s;if(o.current.forEach(clearTimeout),o.current=[],e!=null&&e.isSourceWaiting)f(i);else if(r){u(d);const p=setTimeout(()=>{f(i)},fe);o.current.push(p)}else{n();const p=setTimeout(()=>{u(d);const y=setTimeout(()=>{f(i)},fe);o.current.push(y)},ze);o.current.push(p)}},[s,e==null?void 0:e.isSourceWaiting])}}function Bo(s){const e=l.useRef([]);return l.useEffect(()=>()=>{e.current.forEach(clearTimeout)},[]),{execute:l.useCallback(a=>{const{isRunning:d,start:i,triggerNode:r,completeManualNode:n}=s;if(e.current.forEach(clearTimeout),e.current=[],d){r(a);const u=setTimeout(()=>{n(a)},fe);e.current.push(u)}else{i();const u=setTimeout(()=>{r(a);const f=setTimeout(()=>{n(a)},fe);e.current.push(f)},ze);e.current.push(u)}},[s])}}function so({ref:s,onClose:e,enabled:o=!0,listenEscape:a=!0,listenClickOutside:d=!0}){l.useEffect(()=>{if(!o)return;const i=u=>{s.current&&!s.current.contains(u.target)&&e()},r=u=>{u.key==="Escape"&&e()},n=setTimeout(()=>{d&&document.addEventListener("mousedown",i),a&&document.addEventListener("keydown",r)},0);return()=>{clearTimeout(n),d&&document.removeEventListener("mousedown",i),a&&document.removeEventListener("keydown",r)}},[s,e,o,a,d])}function Vo(s,e=!0){l.useEffect(()=>{if(!e)return;const o=a=>{a.key==="Escape"&&s()};return document.addEventListener("keydown",o),()=>document.removeEventListener("keydown",o)},[s,e])}function $o(){const s=be(a=>a.sidebarCollapsed),e=be(a=>a.setSidebarCollapsed),o=be(a=>a.toggleSidebar);return{collapsed:s,setCollapsed:e,toggleCollapsed:o}}const oe={event:{gradient:"gradient-event",rotate:"rotate-event",selected:"node-selected-event",pulse:"animate-pulse-event"},command:{gradient:"gradient-command",rotate:"rotate-command",selected:"node-selected-command",pulse:"animate-pulse-command"},policy:{gradient:"gradient-policy",rotate:"rotate-policy",selected:"node-selected-policy",pulse:"animate-pulse-policy"},trigger:{gradient:"gradient-trigger",rotate:"rotate-trigger",selected:"node-selected-trigger",pulse:"animate-pulse-trigger"},externalSystem:{gradient:"gradient-external",rotate:"rotate-external-system",selected:"node-selected-external",pulse:"animate-pulse-external"},externalEvent:{gradient:"gradient-external",rotate:"rotate-external-event",selected:"node-selected-external",pulse:"animate-pulse-external"},hotspot:{gradient:"gradient-hotspot",rotate:"rotate-hotspot",selected:"node-selected-hotspot"}};function ro({text:s,maxWidth:e,maxHeight:o,minFontSize:a=8,maxFontSize:d=18}){return l.useMemo(()=>{if(!s||e<=0||o<=0)return{fontSize:d};const i=document.createElement("div");i.style.cssText=`
      position: absolute;
      left: -9999px;
      top: -9999px;
      width: ${e}px;
      height: ${o}px;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
      font-weight: 400;
      line-height: 1.3;
      white-space: pre-wrap;
      word-wrap: break-word;
      text-align: center;
      box-sizing: border-box;
    `,i.textContent=s,document.body.appendChild(i);let r=a;for(let n=d;n>=a;n--){i.style.fontSize=`${n}px`;const u=i.scrollHeight<=i.clientHeight,f=i.scrollWidth<=i.clientWidth;if(u&&f){r=n;break}}return document.body.removeChild(i),{fontSize:r}},[s,e,o,a,d])}const ao=128,io=78,G=l.memo(l.forwardRef(function({value:e,onChange:o,className:a,placeholder:d="Label",maxWidth:i=ao,maxHeight:r=io,minFontSize:n=8,maxFontSize:u=18,autoSize:f=!1,onEditEnd:p},y){const[m,E]=l.useState(!1),g=l.useRef(null),{fontSize:x}=ro({text:f?"":e||d,maxWidth:i,maxHeight:r,minFontSize:n,maxFontSize:u});l.useImperativeHandle(y,()=>({startEditing:()=>E(!0)}),[]),l.useEffect(()=>{if(m&&g.current){g.current.focus();const I=window.getSelection(),C=document.createRange();C.selectNodeContents(g.current),I==null||I.removeAllRanges(),I==null||I.addRange(C)}},[m]);const c=l.useCallback(I=>{I.stopPropagation(),E(!0)},[]),b=l.useCallback(()=>{var C;if(!g.current)return;const I=((C=g.current.textContent)==null?void 0:C.trim())||"";I!==e&&o(I),E(!1),p==null||p(I)},[e,o,p]),h=l.useCallback(()=>{g.current&&(g.current.textContent=e),E(!1),p==null||p(e)},[e,p]),w=l.useCallback(I=>{I.key==="Enter"&&!I.shiftKey?(I.preventDefault(),b()):I.key==="Escape"&&(I.preventDefault(),h())},[b,h]),T=l.useCallback(()=>{b()},[b]),A=l.useCallback(I=>{m&&I.stopPropagation()},[m]),j=l.useCallback(I=>{m&&I.stopPropagation()},[m]),L=f?void 0:{fontSize:`${x}px`};return t.jsx("span",{ref:g,className:P("flex items-center text-center font-normal text-[0.75rem] whitespace-pre-wrap leading-[1.3] break-words overflow-hidden flex-1 min-w-[4em] min-h-[1.3em] text-postit-text","cursor-text",m&&"outline-none bg-black/20 rounded px-1.5 py-0.5 shadow-[0_0_0_1px_rgba(255,255,255,0.4)] nodrag nopan",a),style:L,contentEditable:m,suppressContentEditableWarning:!0,onDoubleClick:c,onKeyDown:m?w:void 0,onBlur:m?T:void 0,onMouseDown:A,onClick:j,children:e})})),Go=l.memo(function({label:e,selected:o,isCompleted:a,isActive:d,isTargetConnectable:i,isSourceConnectable:r,onLabelChange:n,placeholder:u="Event",instanceCount:f,isOriginal:p,toolbar:y,quickCreateButtons:m}){const E=oe.event;return t.jsxs("div",{className:P("node-postit",E.gradient,E.rotate,"w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o&&`node-selected ${E.selected}`,a&&"bg-success! node-completed",d&&E.pulse,f&&f>1&&!p&&"texture-diagonal-clone"),children:[y,m,t.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:i}),t.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:i}),t.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:i}),t.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:i}),t.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:r}),t.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:r}),t.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:r}),t.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:r}),t.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:t.jsx(G,{value:e,onChange:n,placeholder:u})}),f&&f>1&&t.jsx("div",{className:"absolute top-1 left-1 flex items-center gap-1 z-10",children:t.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${f} instances share this definition`,children:[t.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[t.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),t.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),f]})})]})}),Uo=l.memo(function({label:e,selected:o,isCompact:a,isCompleted:d,isActive:i,isWaiting:r,isTargetConnectable:n,isSourceConnectable:u,onLabelChange:f,onDoubleClick:p,onEditEnd:y,labelRef:m,placeholder:E="Command",instanceCount:g,isOriginal:x,toolbar:c,quickCreateButtons:b}){const h=oe.command;return t.jsxs("div",{className:P("node-postit",h.gradient,h.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",a?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5":"w-[152px]",o&&`node-selected ${h.selected}`,d&&"bg-success! node-completed",i&&"animate-pulse-success",r&&h.pulse,g&&g>1&&!x&&"texture-diagonal-clone"),onDoubleClick:p,children:[c,b,t.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:n}),t.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:n}),t.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:n}),t.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:n}),t.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:u}),t.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:u}),t.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:u}),t.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:u}),t.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:t.jsx(G,{ref:m,value:e,onChange:f,placeholder:E,onEditEnd:y})}),g&&g>1&&t.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex items-center gap-1 z-10",children:t.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${g} instances share this definition`,children:[t.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[t.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),t.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),g]})})]})}),Yo=l.memo(function({label:e,selected:o,isCompleted:a,isActive:d,isWaiting:i,isTargetConnectable:r,isSourceConnectable:n,onLabelChange:u,placeholder:f="Policy",instanceCount:p,isOriginal:y,toolbar:m,quickCreateButtons:E,children:g}){const x=oe.policy;return t.jsxs("div",{className:P("node-postit",x.gradient,x.rotate,"w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o&&`node-selected ${x.selected}`,a&&"bg-success! node-completed",d&&"animate-pulse-success",i&&x.pulse,p&&p>1&&!y&&"texture-diagonal-clone"),children:[m,E,t.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:r}),t.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:r}),t.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:r}),t.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:r}),n!==void 0&&t.jsxs(t.Fragment,{children:[t.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:n}),t.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:n}),t.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:n}),t.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:n})]}),t.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:t.jsx(G,{value:e,onChange:u,placeholder:f})}),p&&p>1&&t.jsx("div",{className:"absolute top-1 left-1 flex items-center gap-1 z-10",children:t.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${p} instances share this definition`,children:[t.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[t.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),t.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),p]})}),g]})}),qo=l.memo(function({label:e,selected:o,isCompact:a,isCompleted:d,isActive:i,isWaiting:r,isTargetConnectable:n,isSourceConnectable:u,onLabelChange:f,onDoubleClick:p,onEditEnd:y,labelRef:m,placeholder:E="Trigger",instanceCount:g,isOriginal:x,toolbar:c,quickCreateButtons:b,playButton:h}){const w=oe.trigger;return t.jsxs("div",{className:P("node-postit",w.gradient,w.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",a?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5 [&_.play-btn]:right-auto [&_.play-btn]:left-1/2 [&_.play-btn]:-translate-x-1/2":"w-[152px]",o&&`node-selected ${w.selected}`,d&&"bg-success! node-completed",i&&"animate-pulse-success",r&&w.pulse,g&&g>1&&!x&&"texture-diagonal-clone"),onDoubleClick:p,children:[c,b,t.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:n}),t.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:n}),t.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:n}),t.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:n}),t.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:u}),t.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:u}),t.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:u}),t.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:u}),t.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:t.jsx(G,{ref:m,value:e,onChange:f,placeholder:E,onEditEnd:y})}),h,g&&g>1&&t.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex items-center gap-1 z-10",children:t.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${g} instances share this definition`,children:[t.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[t.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),t.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),g]})})]})}),Ko=l.memo(function({label:e,selected:o,isCompact:a,isCompleted:d,isActive:i,isWaiting:r,isTargetConnectable:n,isSourceConnectable:u,onLabelChange:f,onDoubleClick:p,onEditEnd:y,labelRef:m,placeholder:E="External System",instanceCount:g,toolbar:x,quickCreateButtons:c,playButton:b}){const h=oe.externalSystem;return t.jsxs("div",{className:P("node-postit",h.gradient,h.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",a?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5 [&_.play-btn]:right-auto [&_.play-btn]:left-1/2 [&_.play-btn]:-translate-x-1/2":"w-[152px]",o&&`node-selected ${h.selected}`,d&&"bg-success! node-completed",i&&"animate-pulse-success",r&&h.pulse),onDoubleClick:p,children:[x,c,t.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:n}),t.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:n}),t.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:n}),t.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:n}),t.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:u}),t.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:u}),t.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:u}),t.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:u}),t.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:t.jsx(G,{ref:m,value:e,onChange:f,placeholder:E,onEditEnd:y})}),b,g&&g>1&&t.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex gap-[3px] z-10",children:t.jsxs("span",{className:"text-[0.4rem] px-[5px] py-0.5 rounded-[3px] bg-black/30 text-white/80 font-semibold tracking-[0.3px] cursor-help",title:`${g} instances share this definition`,children:["x",g]})})]})}),Qo=l.memo(function({label:e,selected:o,isCompact:a,isCompleted:d,isActive:i,isWaiting:r,isTargetConnectable:n,isSourceConnectable:u,onLabelChange:f,onDoubleClick:p,onEditEnd:y,labelRef:m,placeholder:E="External Event",instanceCount:g,toolbar:x,quickCreateButtons:c,playButton:b}){const h=oe.externalEvent;return t.jsxs("div",{className:P("node-postit",h.gradient,h.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",a?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5 [&_.play-btn]:right-auto [&_.play-btn]:left-1/2 [&_.play-btn]:-translate-x-1/2":"w-[152px]",o&&`node-selected ${h.selected}`,d&&"bg-success! node-completed",i&&"animate-pulse-success",r&&h.pulse),onDoubleClick:p,children:[x,c,t.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:n}),t.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:n}),t.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:n}),t.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:n}),t.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:u}),t.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:u}),t.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:u}),t.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:u}),t.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:t.jsx(G,{ref:m,value:e,onChange:f,placeholder:E,onEditEnd:y})}),b,g&&g>1&&t.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex gap-[3px] z-10",children:t.jsxs("span",{className:"text-[0.4rem] px-[5px] py-0.5 rounded-[3px] bg-black/30 text-white/80 font-semibold tracking-[0.3px] cursor-help",title:`${g} instances share this definition`,children:["x",g]})})]})}),Jo=l.memo(function({label:e,selected:o,description:a,onLabelChange:d,placeholder:i="HotSpot",instanceCount:r,toolbar:n}){const u=oe.hotspot;return t.jsxs("div",{className:P("node-postit",u.gradient,u.rotate,"w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o&&`node-selected ${u.selected}`),children:[n,t.jsxs("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:[t.jsx(G,{value:e,onChange:d,placeholder:i}),a&&t.jsx("div",{className:"text-[0.6rem] text-black/70 mt-1 text-center overflow-hidden line-clamp-2 leading-[1.2]",children:a})]}),r&&r>1&&t.jsx("div",{className:"absolute top-1 left-1 flex gap-[3px] z-10",children:t.jsxs("span",{className:"text-[0.4rem] px-[5px] py-0.5 rounded-[3px] bg-black/30 text-white/80 font-semibold tracking-[0.3px] cursor-help",title:`${r} instances share this definition`,children:["x",r]})})]})}),Zo=l.memo(function({label:e,selected:o,isCompleted:a,isActive:d,isTargetConnectable:i,isSourceConnectable:r,onLabelChange:n,placeholder:u="Actor",toolbar:f,quickCreateButtons:p}){return t.jsxs("div",{className:P("node-postit gradient-actor rotate-actor","w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o&&"node-selected node-selected-actor",a&&"bg-success! node-completed",d&&"animate-pulse-actor"),children:[f,p,i!==void 0&&t.jsxs(t.Fragment,{children:[t.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:i}),t.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:i}),t.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:i}),t.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:i})]}),r!==void 0&&t.jsxs(t.Fragment,{children:[t.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:r}),t.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:r}),t.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:r}),t.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:r})]}),t.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:t.jsx(G,{value:e,onChange:n,placeholder:u})})]})}),en=l.memo(function({label:e,selected:o,onLabelChange:a,placeholder:d="Note",toolbar:i}){return t.jsxs("div",{className:P("node-postit gradient-note rotate-note","w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o&&"node-selected node-selected-note"),children:[i,t.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:t.jsx(G,{value:e,onChange:a,placeholder:d})})]})}),co=200,lo=150,tn=l.memo(function({label:e,selected:o,onLabelChange:a,onResizeStart:d,onResize:i,onResizeEnd:r,placeholder:n="Group",toolbar:u,children:f}){const{zoom:p}=Ve(),y=l.useRef(null),m=l.useRef(null),E=Math.min(8,Math.max(.7,1/p));return l.useEffect(()=>{if(y.current&&m.current){m.current.textContent=e||n;const g=m.current.offsetWidth;y.current.style.width=`${Math.max(60,g+4)}px`}},[e,n]),t.jsxs("div",{className:P("relative w-full h-full rounded-lg","border-[1.5px] border-[rgba(139,92,246,0.5)]"),style:{background:"radial-gradient(ellipse at center, transparent 30%, rgba(139,92,246,0.06) 100%)"},children:[t.jsx($e,{minWidth:co,minHeight:lo,isVisible:!0,lineClassName:"group-resize-line !z-[1000]",handleClassName:"group-resize-handle !z-[1000]",onResizeStart:()=>d==null?void 0:d(),onResize:(g,x)=>i==null?void 0:i(x.width,x.height),onResizeEnd:(g,x)=>r==null?void 0:r(x.width,x.height)}),u,t.jsxs("div",{className:P("absolute z-10 origin-bottom-left"),style:{top:`${-10*E-20}px`,left:"8px",transform:`scale(${E})`},children:[t.jsx("span",{ref:m,className:"absolute invisible whitespace-pre text-sm font-semibold","aria-hidden":"true"}),t.jsx("input",{ref:y,type:"text",value:e,onChange:g=>a(g.target.value),placeholder:n,className:P("bg-transparent border-none outline-none","text-sm font-semibold","min-w-[60px]","text-[rgba(139,92,246,0.7)] placeholder:text-[rgba(139,92,246,0.4)]")})]}),t.jsx("div",{className:"w-full h-full pointer-events-none",children:f})]})}),on="w-4 h-4",nn=10,uo=P("w-7 h-7 rounded-md flex items-center justify-center","border-none cursor-pointer","transition-all duration-150","hover:scale-110 active:scale-95","focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-text-primary"),fo=P("p-1.5 rounded","transition-colors","focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1"),sn=P("flex items-center gap-1.5 p-1.5 rounded-lg","bg-bg-secondary/95 backdrop-blur-sm","border border-border shadow-[var(--shadow-toolbar)]"),rn=P("flex gap-1 bg-white rounded-lg shadow-lg p-1 border border-gray-200","dark:bg-bg-secondary dark:border-border");function an(s){return P(uo,{default:"bg-text-muted/20 text-text-secondary hover:bg-text-muted/30",danger:"bg-danger/20 text-danger hover:bg-danger/30",info:"bg-info/20 text-info hover:bg-info/30",accent:"bg-accent/20 text-accent hover:bg-accent/30",event:"bg-node-event/20 text-node-event hover:bg-node-event/30",trigger:"bg-node-trigger/20 text-node-trigger hover:bg-node-trigger/30",command:"bg-node-command/20 text-node-command hover:bg-node-command/30"}[s])}function cn(s){return P(fo,{default:"text-gray-500 hover:bg-gray-50 hover:text-gray-700 dark:hover:bg-text-muted/20 dark:hover:text-text-primary",danger:"text-gray-500 hover:bg-red-50 hover:text-red-500 dark:hover:bg-danger/20 dark:hover:text-danger",purple:"text-gray-500 hover:bg-purple-50 hover:text-purple-500 dark:hover:bg-node-policy/20 dark:hover:text-node-policy"}[s])}function mo(){const{getNode:s}=Ee(),{addNode:e,onConnect:o}=we(),a=l.useCallback((i,r=!1)=>{const u=mt[r?"policy":i];return u?[...u.canConnectTo]:[]},[]),d=l.useCallback((i,r,n)=>{var c,b;const u=s(i);if(!u)return;const f=u.parentId?s(u.parentId):void 0,p=gt(u.position,f==null?void 0:f.position),y=((c=u.measured)==null?void 0:c.width)??Pt,m=((b=u.measured)==null?void 0:b.height)??Mt,E=Rt(p,y,m,n),g=e(r,E),x=Lt(n);o({source:i,target:g,sourceHandle:x.source,targetHandle:x.target})},[s,e,o]);return{getValidTargetTypes:a,createConnectedNode:d}}const go={event:{label:"Event",Icon:Se},command:{label:"Command",Icon:It},policy:{label:"Policy",Icon:Et},trigger:{label:"Trigger",Icon:ve},externalSystem:{label:"Ext System",Icon:Te},externalEvent:{label:"Ext Event",Icon:Te}},po={event:"bg-node-event text-postit-text",command:"bg-[#3b82f6] text-white",policy:"bg-node-policy text-postit-text",trigger:"bg-node-trigger text-postit-text",externalSystem:"bg-node-external text-postit-text",externalEvent:"bg-node-external text-postit-text"};function ho({validTypes:s,anchorPosition:e,direction:o,onSelect:a,onClose:d,typeConfig:i,getIconColorClass:r}){const n=l.useRef(null);so({ref:n,onClose:d});const f=l.useCallback(()=>{const c=s.length*44+8,b=10,h=8;let w,T;switch(o){case"top":w=e.x-180/2,T=e.y-c-h;break;case"bottom":w=e.x-180/2,T=e.y+h;break;case"left":w=e.x-180-h,T=e.y-c/2;break;case"right":w=e.x+h,T=e.y-c/2;break}return w+180>window.innerWidth-b&&(w=window.innerWidth-180-b),T+c>window.innerHeight-b&&(T=window.innerHeight-c-b),w<b&&(w=b),T<b&&(T=b),{x:w,y:T}},[e,o,s.length])(),p=l.useMemo(()=>{if(!s.includes("event"))return s;const x=s.filter(b=>b!=="event"),c=Math.floor(x.length/2);return[...x.slice(0,c),"event",...x.slice(c)]},[s]),y=l.useCallback(x=>{a(x),d()},[a,d]),m=l.useCallback(x=>i&&x in i?i[x]:go[x]??{label:x,Icon:Se},[i]),E=l.useCallback(x=>r?r(x):po[x]??"bg-gray-500 text-white",[r]);if(p.length===0)return null;const g=t.jsx("div",{ref:n,className:P("fixed bg-bg-secondary border border-border rounded-lg","shadow-[0_4px_16px_rgba(0,0,0,0.3)] p-1 z-[10000] min-w-[160px]","animate-zoom-in","light:bg-white light:shadow-[0_4px_16px_rgba(0,0,0,0.15)]"),style:{left:f.x,top:f.y},children:p.map(x=>{const c=m(x);return t.jsxs("button",{className:P("flex items-center gap-2.5 py-2 px-3 rounded-md","cursor-pointer transition-colors duration-100","text-text-primary border-none bg-transparent w-full text-[13px]","hover:bg-bg-tertiary active:scale-[0.98]"),onClick:()=>y(x),children:[t.jsx("span",{className:P("w-6 h-6 rounded flex items-center justify-center shrink-0","[&_svg]:w-3.5 [&_svg]:h-3.5",E(x)),children:t.jsx(c.Icon,{})}),t.jsx("span",{className:"flex-1 text-left",children:c.label})]},x)})});return Ge.createPortal(g,document.body)}const xo=l.memo(ho),bo=l.memo(function({outcomeId:e,canDelete:o,onDelete:a}){const d=l.useCallback(i=>{i.stopPropagation(),o&&a(e)},[e,o,a]);return t.jsx(Ue,{position:v.Top,offset:10,className:P("flex items-center gap-1.5 p-1.5 rounded-lg","bg-bg-secondary/95 backdrop-blur-sm","border border-border shadow-[var(--shadow-toolbar)]"),children:t.jsx("button",{className:P("w-7 h-7 rounded-md flex items-center justify-center","border-none cursor-pointer transition-all duration-150","hover:scale-110 active:scale-95","bg-danger/20 text-danger hover:bg-danger/30","disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"),onClick:d,disabled:!o,title:o?"Delete outcome":"Cannot delete - minimum 2 outcomes required",children:t.jsx(xt,{className:"w-4 h-4"})})})}),ln=l.memo(function({id:e,data:o,selected:a}){const d=Ye(),i=a||d.inProgress,{state:r,selectTransition:n,isRunning:u,start:f,triggerNode:p}=St(),{getOutcomeTransition:y,updateOutcomeLabel:m,deleteOutcome:E,getOutcomesForPolicy:g}=we(),c=(o.parentPolicyDefId?r==null?void 0:r.nodeStates.get(o.parentPolicyDefId):void 0)==="waiting_for_action",b=e,h=y(b),w=!!h,A=g(o.parentPolicyInstanceId).length>2,j=l.useCallback(C=>{A&&E(C)},[A,E]),L=l.useCallback(C=>{C.stopPropagation(),!(!h||!o.parentPolicyDefId)&&(c?n(h):u?(p(o.parentPolicyDefId),setTimeout(()=>{n(h)},50)):(f(),setTimeout(()=>{p(o.parentPolicyDefId),setTimeout(()=>{n(h)},50)},10)))},[h,o.parentPolicyDefId,c,u,f,p,n]),I=l.useCallback(C=>{m(e,C)},[e,m]);return t.jsxs("div",{className:P("gradient-outcome border border-node-policy/50 rounded-md","w-auto h-auto min-w-[50px] min-h-8 p-0","shadow-[0_2px_4px_rgba(0,0,0,0.3)] transition-all duration-200","hover:scale-[1.02]",a&&"node-selected node-selected-outcome shadow-[0_0_8px_rgba(147,51,234,0.8)] border-node-policy",c&&"gradient-outcome-clickable border-node-policy cursor-pointer animate-pulse-outcome hover:scale-[1.08] hover:shadow-[0_0_12px_rgba(147,51,234,0.9)]"),children:[t.jsx(bo,{outcomeId:b,canDelete:A,onDelete:j}),a&&t.jsx(No,{instanceId:b,nodeType:"policy",isOutcome:!0}),t.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:i}),t.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:i}),t.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:i}),t.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:i}),t.jsxs("div",{className:"flex flex-row items-center gap-1.5 py-1 px-2",children:[t.jsx("button",{className:P("w-[18px] h-[18px] rounded-full border flex items-center justify-center","shadow-[0_1px_3px_rgba(0,0,0,0.2)] transition-all duration-200 p-0 outline-none shrink-0",w?"bg-node-policy border-white/30 text-white cursor-pointer hover:scale-[1.15] hover:bg-[#a855f7] hover:border-white/50":"bg-node-policy/40 border-white/20 text-white/50 cursor-default"),onClick:L,disabled:!w,title:w?c?`Select ${o.label}`:`Trigger from ${o.label}`:"Connect this outcome to enable",children:t.jsx(ve,{className:"w-2.5 h-2.5"})}),t.jsx(G,{value:o.label,onChange:I,placeholder:"Outcome",autoSize:!0,className:"text-white [.light_&]:text-postit-text"})]})]})}),yo=["right"];function Eo(s){switch(s){case"top":return"top-[-28px] left-1/2 -translate-x-1/2 hover:-translate-x-1/2";case"right":return"right-[-28px] top-1/2 -translate-y-1/2 hover:-translate-y-1/2";case"bottom":return"bottom-[-28px] left-1/2 -translate-x-1/2 hover:-translate-x-1/2";case"left":return"left-[-28px] top-1/2 -translate-y-1/2 hover:-translate-y-1/2"}}function wo(s){return P("absolute rounded-full border-2 border-border","cursor-pointer flex items-center justify-center text-sm font-bold","pointer-events-auto p-0 transition-all duration-150 z-[5]","shadow-[0_2px_4px_rgba(0,0,0,0.3)]","focus:outline-none focus-visible:outline-2 focus-visible:outline-text-primary focus-visible:outline-offset-2","hover:scale-[1.2] hover:shadow-[0_3px_8px_rgba(0,0,0,0.4)] active:scale-110","dark:bg-[#e0e0e8] dark:border-[#d0d0d8] dark:text-[#1e1e3a]","dark:hover:bg-[#5a5a7a] dark:hover:border-[#f0f0f8] dark:hover:text-[#f0f0f8]","bg-[#6a6a8a] border-[#7a7a9a] text-white shadow-[0_2px_4px_rgba(0,0,0,0.15)]","hover:bg-[#5a5a7a] hover:border-white hover:text-white",s?"w-4 h-4":"w-5 h-5")}function vo({validTypes:s,isCompact:e=!1,onCreateNode:o,renderMenu:a,directions:d=yo}){const[i,r]=l.useState(!1),[n,u]=l.useState(null),[f,p]=l.useState(null),y=l.useRef({top:null,right:null,bottom:null,left:null}),m=l.useCallback((c,b)=>{if(b.stopPropagation(),s.length===1){o(s[0],c);return}const h=y.current[c];if(!h)return;const w=h.getBoundingClientRect();p({x:w.x+w.width/2,y:w.y+w.height/2}),u(c),r(!0)},[s,o]),E=l.useCallback(c=>{n&&(o(c,n),r(!1),u(null))},[n,o]),g=l.useCallback(()=>{r(!1),u(null)},[]);if(s.length===0)return null;const x=wo(e);return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",children:d.map(c=>t.jsx("button",{ref:b=>{y.current[c]=b},className:P(x,Eo(c),"nodrag nopan"),onClick:b=>m(c,b),"aria-label":`Create node ${c==="top"?"above":c==="bottom"?"below":`to the ${c}`}`,title:"Add connected node",children:t.jsx(bt,{className:"w-3 h-3"})},c))}),i&&f&&n&&a({validTypes:s,anchorPosition:f,direction:n,onSelect:E,onClose:g})]})}const _o=l.memo(vo),No=l.memo(function({instanceId:e,nodeType:o,isOutcome:a=!1,isCompact:d=!1}){const{getValidTargetTypes:i,createConnectedNode:r}=mo(),n=i(o,a),u=l.useCallback((p,y)=>{r(e,p,y)},[e,r]),f=l.useCallback(p=>t.jsx(xo,{...p}),[]);return t.jsx(_o,{validTypes:n,isCompact:d,onCreateNode:u,renderMenu:f})}),ko=s=>s.nodes.filter(e=>e.selected).length+s.edges.filter(e=>e.selected).length;function dn({id:s,source:e,sourceX:o,sourceY:a,targetX:d,targetY:i,sourcePosition:r,targetPosition:n,selected:u,markerEnd:f,markerStart:p,data:y,simulationState:m,isRunning:E,start:g,triggerNode:x,selectTransition:c,getSourceDefinitionId:b}){const h=y,w=(h==null?void 0:h.state)||"idle",T=(h==null?void 0:h.progress)||0,A=(h==null?void 0:h.labelOffset)??.5,j=h==null?void 0:h.transitionId,L=(h==null?void 0:h.isNonStandard)||!1,I=h==null?void 0:h.sourceKind,C=h==null?void 0:h.targetKind,{setEdges:B}=Ee(),{showTooltip:V,hideTooltip:$,setHoveredWarningEdgeId:X}=Oe(),W=Me(ko),O=l.useRef(null),[S,K]=l.useState({x:0,y:0}),[D,re]=l.useState({x:0,y:0}),[Q,me]=l.useState(0),F=l.useRef(void 0),ge=l.useCallback((z,xe)=>{B(ae=>ae.map(te=>te.id===z?{...te,data:{...te.data,labelOffset:xe}}:te))},[B]),{isDragging:pe,hasDraggedRef:H,handleDragStart:he}=Ot({pathRef:O,edgeId:s,onOffsetChange:ge}),U=b(e),N=(U?m==null?void 0:m.nodeStates.get(U):void 0)==="waiting_for_action",M=l.useMemo(()=>({isRunning:E,start:g,triggerNode:x,selectTransition:c}),[E,g,x,c]),R=l.useMemo(()=>({isSourceWaiting:N}),[N]),{execute:Z}=no(M,R),ee=Re(o,a,d,i,r,n);l.useLayoutEffect(()=>{if(O.current){const z=O.current.getTotalLength();me(z)}},[ee]),l.useLayoutEffect(()=>{if(O.current&&Q>0){const z=O.current.getPointAtLength(Q*A);re({x:z.x,y:z.y})}},[Q,A]),l.useEffect(()=>{if(w!=="animating"||!O.current)return;const z=O.current,xe=z.getTotalLength(),ae=()=>{const te=(h==null?void 0:h.progress)||0,ke=z.getPointAtLength(xe*te);K({x:ke.x,y:ke.y}),te<1&&(F.current=requestAnimationFrame(ae))};return F.current=requestAnimationFrame(ae),()=>{F.current&&cancelAnimationFrame(F.current)}},[w,h==null?void 0:h.progress]);const Xe=l.useCallback(z=>{z.stopPropagation(),z.preventDefault(),!H.current&&(!j||!U||Z(U,j))},[j,U,Z,H]),We=Q*(1-T),_e=!!j,Ne=_e;return l.useEffect(()=>{if(u&&W===1&&L&&I&&C)return X(s),V({edgeId:s,sourceKind:I,targetKind:C,targetPosition:{x:d,y:i}}),()=>{X(null),$()}},[u,W,L,I,C,s,d,i,V,$,X]),t.jsxs(t.Fragment,{children:[!L&&t.jsx("path",{d:ee,fill:"none",stroke:w==="executed"?"#22c55e":"oklch(55% 0.18 303)",strokeWidth:16,strokeLinecap:"butt",style:{opacity:.15,pointerEvents:"none"}}),t.jsx(je,{id:s,path:ee,markerEnd:f,markerStart:p,className:[w==="idle"&&!u?"animate-dash-flow":"",L?"non-standard":""].filter(Boolean).join(" ")||void 0,style:{strokeDasharray:w==="idle"&&!u?"5 5":"none",opacity:w==="executed"?0:1}}),t.jsx("path",{ref:O,d:ee,fill:"none",stroke:"transparent",strokeWidth:0}),(w==="animating"||w==="executed"||w==="waiting_at_label")&&Q>0&&t.jsx("path",{d:ee,fill:"none",stroke:"#22c55e",strokeWidth:2,style:{strokeDasharray:w!=="executed"?Q:"none",strokeDashoffset:w!=="executed"?We:0}}),w==="animating"&&t.jsxs(t.Fragment,{children:[t.jsx("circle",{cx:S.x,cy:S.y,r:10,fill:"rgba(34, 197, 94, 0.3)"}),t.jsx("circle",{cx:S.x,cy:S.y,r:6,fill:"#22c55e",style:{filter:"drop-shadow(0 0 4px rgba(34, 197, 94, 0.6))"}})]}),w==="waiting_at_label"&&t.jsxs(t.Fragment,{children:[t.jsx("circle",{cx:D.x,cy:D.y,r:10,fill:"rgba(34, 197, 94, 0.3)",className:"animate-ball-fade-out"}),t.jsx("circle",{cx:D.x,cy:D.y,r:6,fill:"#22c55e",className:"animate-ball-fade-out",style:{filter:"drop-shadow(0 0 4px rgba(34, 197, 94, 0.6))"}})]}),u&&t.jsxs(t.Fragment,{children:[t.jsx(Ae,{x:o,y:a}),t.jsx(Ae,{x:d,y:i})]}),t.jsx(qe,{children:t.jsx("div",{className:P("absolute cursor-grab select-none z-[1000] nodrag nopan",pe&&"cursor-grabbing",N&&"[&_.play-btn]:animate-button-pulse"),style:{position:"absolute",transform:`translate(-50%, -50%) translate(${D.x}px, ${D.y}px)`,pointerEvents:"all"},onMouseDown:he,children:t.jsx("button",{className:P("play-btn w-[18px] h-[18px] rounded-full flex items-center justify-center p-0 outline-none shrink-0","shadow-[0_1px_3px_rgba(0,0,0,0.2)] transition-all duration-200",Ne?"bg-[#3b82f6] border border-white/30 text-white cursor-pointer hover:scale-[1.15] hover:bg-[#60a5fa] hover:border-white/50":"bg-[#3b82f6]/40 border border-white/20 text-white/50 cursor-default"),onClick:Xe,disabled:!Ne,title:_e?N?"Select this path":"Trigger command":"No transition connected",children:t.jsx(ve,{className:"w-2.5 h-2.5"})})})})]})}function Ae({x:s,y:e}){return t.jsx("circle",{cx:s,cy:e,r:6,fill:"oklch(40% 0.18 303)",stroke:"#fff",strokeWidth:2,style:{cursor:"grab",filter:"drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3))"}})}const To=s=>s.nodes.filter(e=>e.selected).length+s.edges.filter(e=>e.selected).length;function un({id:s,sourceX:e,sourceY:o,targetX:a,targetY:d,sourcePosition:i,targetPosition:r,selected:n,markerEnd:u,markerStart:f,data:p}){const{theme:y}=pt(),{showTooltip:m,hideTooltip:E,setHoveredWarningEdgeId:g}=Oe(),x=Me(To),c=p,b=(c==null?void 0:c.state)||"idle",h=(c==null?void 0:c.progress)||0,w=(c==null?void 0:c.isNonStandard)||!1,T=c==null?void 0:c.sourceKind,A=c==null?void 0:c.targetKind,j=l.useRef(null),[L,I]=l.useState({x:0,y:0}),[C,B]=l.useState(0),V=l.useRef(void 0),$=Re(e,o,a,d,i,r);l.useLayoutEffect(()=>{if(j.current){const W=j.current.getTotalLength();B(W)}},[$]),l.useEffect(()=>{if(b!=="animating"||!j.current)return;const W=j.current,O=W.getTotalLength(),S=()=>{const K=(c==null?void 0:c.progress)||0,D=W.getPointAtLength(O*K);I({x:D.x,y:D.y}),K<1&&(V.current=requestAnimationFrame(S))};return V.current=requestAnimationFrame(S),()=>{V.current&&cancelAnimationFrame(V.current)}},[b,c==null?void 0:c.progress]);const X=C*(1-h);return l.useEffect(()=>{if(n&&x===1&&w&&T&&A)return g(s),m({edgeId:s,sourceKind:T,targetKind:A,targetPosition:{x:a,y:d}}),()=>{g(null),E()}},[n,x,w,T,A,s,a,d,m,E,g]),t.jsxs(t.Fragment,{children:[!w&&t.jsx("path",{d:$,fill:"none",stroke:b==="executed"?"#22c55e":"oklch(55% 0.18 303)",strokeWidth:16,strokeLinecap:"butt",style:{opacity:.15,pointerEvents:"none"}}),t.jsx(je,{id:s,path:$,markerEnd:u,markerStart:f,className:[b==="idle"&&!n?"animate-dash-flow":"",w?"non-standard":""].filter(Boolean).join(" ")||void 0,style:{strokeDasharray:b==="idle"&&!n?"5 5":"none",opacity:b==="executed"?0:1}}),t.jsx("path",{ref:j,d:$,fill:"none",stroke:"transparent",strokeWidth:0}),(b==="animating"||b==="executed")&&C>0&&t.jsx("path",{d:$,fill:"none",stroke:"#22c55e",strokeWidth:2,style:{strokeDasharray:b==="animating"?C:"none",strokeDashoffset:b==="animating"?X:0}}),b==="animating"&&t.jsxs(t.Fragment,{children:[t.jsx("circle",{cx:L.x,cy:L.y,r:10,fill:"rgba(34, 197, 94, 0.3)"}),t.jsx("circle",{cx:L.x,cy:L.y,r:6,fill:"#22c55e",style:{filter:"drop-shadow(0 0 4px rgba(34, 197, 94, 0.6))"}})]}),n&&t.jsxs(t.Fragment,{children:[t.jsx(Ce,{x:e,y:o,isLight:y==="light"}),t.jsx(Ce,{x:a,y:d,isLight:y==="light"})]})]})}function Ce({x:s,y:e,isLight:o}){const a=o?"#ffffff":"#1e1e3f",d=o?"oklch(45% 0.18 303)":"oklch(70% 0.15 303)";return t.jsx("circle",{cx:s,cy:e,r:6,fill:a,stroke:d,strokeWidth:2,style:{cursor:"grab",filter:"drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3))"}})}const Io=()=>({activeTransitions:new Map,animationFrame:void 0,processedEvents:new Set,previousEventsLength:0,wasWaiting:new Map,animate:null}),Pe=1e3,Ao=500;function fn(s){const{setEdges:e,getEdges:o}=Ee(),a=l.useRef(Io()),d=l.useCallback((n,u,f)=>{e(p=>p.map(y=>{const m=y.data;return(m==null?void 0:m.transitionId)===n?{...y,data:{...y.data,state:u,progress:f}}:y}))},[e]),i=l.useCallback(()=>{const n=a.current,u=Date.now();let f=!1;n.activeTransitions.forEach((p,y)=>{const m=u-p.startTime,E=p.targetProgress-p.startProgress,g=Math.min(m/p.duration,1),x=p.startProgress+g*E;g<1?(f=!0,d(y,"animating",x)):(p.targetProgress<1?(d(y,"waiting_at_label",p.targetProgress),n.wasWaiting.set(y,p.targetProgress)):d(y,"executed",1),n.activeTransitions.delete(y))}),f&&n.animate?n.animationFrame=requestAnimationFrame(n.animate):n.animationFrame=void 0},[d]);l.useEffect(()=>{a.current.animate=i},[i]);const r=l.useCallback(()=>{const n=a.current;n.animationFrame&&(cancelAnimationFrame(n.animationFrame),n.animationFrame=void 0),n.activeTransitions.clear(),n.processedEvents.clear(),n.wasWaiting.clear(),e(u=>u.map(f=>({...f,data:{...f.data,state:"idle",progress:0}})))},[e]);l.useEffect(()=>{const n=a.current;s.length===0&&n.previousEventsLength>0&&r(),n.previousEventsLength=s.length;let u=!1;s.forEach(f=>{var p,y,m;if(!n.processedEvents.has(f.id)){if(n.processedEvents.add(f.id),f.type==="transition:start"){const g=(p=f.data.transition)==null?void 0:p.id;if(!g)return;const x=n.wasWaiting.get(g),c=x!==void 0?x:0,b=x!==void 0?Pe*(1-x):Pe;n.wasWaiting.delete(g),n.activeTransitions.set(g,{transitionId:g,startTime:Date.now(),duration:b,startProgress:c,targetProgress:1}),d(g,"animating",c),u=!0}if(f.type==="transition:reset"){const g=(y=f.data.transition)==null?void 0:y.id;if(!g)return;n.activeTransitions.delete(g),d(g,"idle",0)}if(f.type==="simulation:reset"&&r(),f.type==="node:waiting"){const E=f.data;if(((m=E.node)==null?void 0:m.kind)!=="command")return;const g=E.availableTransitions||[],x=o();for(const c of g){const b=c.id,h=x.find(A=>{const j=A.data;return(j==null?void 0:j.transitionId)===b});if(!h)continue;const w=h.data,T=(w==null?void 0:w.labelOffset)??.5;n.activeTransitions.set(b,{transitionId:b,startTime:Date.now(),duration:Ao,startProgress:0,targetProgress:T}),d(b,"animating",0),u=!0}}}}),u&&!n.animationFrame&&(n.animationFrame=requestAnimationFrame(i))},[s,i,d,r,o]),l.useEffect(()=>{const n=a.current;return()=>{n.animationFrame&&cancelAnimationFrame(n.animationFrame)}},[])}export{Zo as A,_o as B,Te as C,Pt as D,Go as E,So as F,Bo as G,Jo as H,tn as I,no as J,bo as K,G as L,Zt as M,en as N,ln as O,oo as P,No as Q,Oo as R,Do as S,It as T,zo as U,Xt as W,Se as Z,Fo as a,St as b,$o as c,Xo as d,nn as e,an as f,Wo as g,on as h,Uo as i,Yo as j,qo as k,Ko as l,Qo as m,dn as n,un as o,Oe as p,fn as q,Ho as r,rn as s,sn as t,Vo as u,cn as v,Mt as w,Rt as x,Lt as y,xo as z};
