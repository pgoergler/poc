var Be=Object.defineProperty;var He=(s,e,t)=>e in s?Be(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var ie=(s,e,t)=>He(s,typeof e!="symbol"?e+"":e,t);import{c as K}from"./index-CnfOSkNW.js";import{P as v,b as d,j as o,H as _,n as Ve,o as Ge,u as Ee,c as Ue,N as qe,d as Ke,p as je,q as Le,E as Ye}from"./react-flow-BRmdaK4b.js";import{A as Qe,v as Je,w as Ze,x as et,y as tt,z as ot,B as nt,E as st,u as be,f as M}from"./Toast-DGRdhY-b.js";import{D as rt,E as at,F as Re,G as it,H as ct,I as lt,L as dt,J as se,K as ut,Q as ft,R as J,T as mt,e as we,U as gt,C as pt,P as ve,u as ht}from"./useTheme-CgLEhGpF.js";import{C as ue,F as xt,T as bt,P as yt}from"./FileAdapter-CB60OAia.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Et=[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]],wt=K("clipboard-list",Et);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]],Te=K("cloud",vt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _t=[["path",{d:"M12 3q1 4 4 6.5t3 5.5a1 1 0 0 1-14 0 5 5 0 0 1 1-3 1 1 0 0 0 5 0c0-2-1.5-3-1.5-5q0-2 2.5-4",key:"1slcih"}]],Do=K("flame",_t);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],Fo=K("refresh-cw",Nt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=[["path",{d:"M12 3v18",key:"108xh3"}],["path",{d:"m19 8 3 8a5 5 0 0 1-6 0zV7",key:"zcdpyk"}],["path",{d:"M3 7h1a17 17 0 0 0 8-2 17 17 0 0 0 8 2h1",key:"1yorad"}],["path",{d:"m5 8 3 8a5 5 0 0 1-6 0zV7",key:"eua70x"}],["path",{d:"M7 21h10",key:"1b0cd5"}]],zo=K("scale",kt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tt=[["path",{d:"M21 9a2.4 2.4 0 0 0-.706-1.706l-3.588-3.588A2.4 2.4 0 0 0 15 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z",key:"1dfntj"}],["path",{d:"M15 3v5a1 1 0 0 0 1 1h5",key:"6s6qgf"}]],Xo=K("sticky-note",Tt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const It=[["path",{d:"M12 19h8",key:"baeox8"}],["path",{d:"m4 17 6-6-6-6",key:"1yngyt"}]],At=K("terminal",It);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ct=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],Wo=K("user",Ct);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mt=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],Se=K("zap",Mt);function Ie(s,e,t,r){switch(t){case v.Top:return{x:s,y:e-r};case v.Bottom:return{x:s,y:e+r};case v.Left:return{x:s-r,y:e};case v.Right:return{x:s+r,y:e};default:return{x:s,y:e}}}function Pt(s,e,t,r,l=100){const i=t-s,a=r-e,n=Math.sqrt(i*i+a*a);return Math.min(l,n/2)}function Oe(s,e,t,r,l,i){const a=Pt(s,e,t,r),n=Ie(s,e,l,a),u=Ie(t,r,i,a);return`M${s},${e} C${n.x},${n.y} ${u.x},${u.y} ${t},${r}`}const ce=120,jt=152,Lt=112,Rt={top:{source:"source-top",target:"target-bottom"},right:{source:"source-right",target:"target-left"},bottom:{source:"source-bottom",target:"target-top"},left:{source:"source-left",target:"target-right"}};function St(s){return Rt[s]}function Ot(s,e,t,r){switch(r){case"top":return{x:s.x,y:s.y-ce};case"right":return{x:s.x+e+ce,y:s.y};case"bottom":return{x:s.x,y:s.y+t+ce};case"left":return{x:s.x-ce,y:s.y}}}function Dt(){const s=d.useContext(rt);if(!s)throw new Error("useSimulationContext must be used within a SimulationProvider");return s}function De(){const s=d.useContext(at);if(!s)throw new Error("useNonStandardConnectionContext must be used within a NonStandardConnectionProvider");return s}function $o({open:s,onOpenChange:e,onConfirm:t,title:r,description:l,confirmLabel:i="Confirmer",cancelLabel:a="Annuler"}){const n=()=>{t(),e(!1)};return o.jsx(Qe,{open:s,onOpenChange:e,children:o.jsxs(Je,{children:[o.jsxs(Ze,{children:[o.jsx(et,{children:r}),o.jsx(tt,{children:l})]}),o.jsxs(ot,{children:[o.jsx(nt,{children:a}),o.jsx(st,{onClick:n,children:i})]})]})})}function Ft({pathRef:s,edgeId:e,onOffsetChange:t}){const[r,l]=d.useState(!1),i=d.useRef(!1),a=d.useCallback(n=>{n.stopPropagation(),n.preventDefault(),i.current=!1,l(!0)},[]);return d.useEffect(()=>{if(!r||!s.current)return;const n=f=>{var b;if(!s.current)return;i.current=!0;const p=s.current.ownerSVGElement;if(!p)return;const y=p.createSVGPoint();y.x=f.clientX,y.y=f.clientY;const m=y.matrixTransform((b=p.getScreenCTM())==null?void 0:b.inverse()),E=s.current.getTotalLength();let g=.5,x=1/0;for(let h=0;h<=100;h++){const w=h/100,T=s.current.getPointAtLength(E*w),A=Math.sqrt(Math.pow(T.x-m.x,2)+Math.pow(T.y-m.y,2));A<x&&(x=A,g=w)}const c=Math.max(.1,Math.min(.9,g));t(e,c)},u=()=>{l(!1)};return document.addEventListener("mousemove",n),document.addEventListener("mouseup",u),()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",u)}},[r,e,s,t]),{isDragging:r,hasDraggedRef:i,handleDragStart:a}}class zt{serialize(e){try{const{graph:t,nodes:r,edges:l,mappings:i}=e,a=t.getAllNodes().map(m=>({id:m.id,label:m.label,kind:m.kind,category:m.category,executionMode:m.executionMode,config:m.config,awsExtension:m.awsExtension})),n=t.getAllTransitions().map(m=>({id:m.id,sourceDefId:m.sourceDefId,targetDefId:m.targetDefId})),u=r.filter(m=>m.type!=="outcome").map(m=>({id:m.id,definitionId:i.instanceToDefRef.get(m.id),position:{x:m.position.x,y:m.position.y}})),f=r.filter(m=>m.type==="outcome").map(m=>({id:m.id,label:m.data.label||"Outcome",parentPolicyInstanceId:m.parentId,parentPolicyDefId:m.data.parentPolicyDefId||"",position:{x:m.position.x,y:m.position.y}})),p=i.outcomeToTransitionRef?Array.from(i.outcomeToTransitionRef.entries()).map(([m,E])=>({outcomeId:m,transitionId:E})):[],y=l.filter(m=>i.edgeToTransitionRef.has(m.id)).map(m=>{const E=m.data;return{edgeId:m.id,transitionId:i.edgeToTransitionRef.get(m.id),source:m.source,target:m.target,sourceHandle:m.sourceHandle??void 0,targetHandle:m.targetHandle??void 0,label:E==null?void 0:E.label,labelOffset:E==null?void 0:E.labelOffset}});return{success:!0,workflow:{definitions:a,transitions:n,instances:u,edgeMappings:y,outcomes:f,outcomeEdgeMappings:p}}}catch(t){return{success:!1,error:{code:"VALIDATION_ERROR",message:"Failed to serialize workflow",details:t}}}}}class Xt{recoverOrphanEdges(e,t,r,l){var E;const{instanceToDefRef:i,defToInstancesRef:a,edgeToTransitionRef:n,transitionToEdgesRef:u}=r,f=e.filter(g=>{const x=n.get(g.id);return x?t.getTransition(x)!==void 0:!1}),p=new Set(f.map(g=>g.id));for(const g of n.keys())if(!p.has(g)){const x=n.get(g);n.delete(g),x&&((E=u.get(x))==null||E.delete(g))}const y=new Set(n.values()),m=t.getAllTransitions().filter(g=>!y.has(g.id));for(const g of m){const x=this.createEdgeForTransition(g,t,i,a,l);x&&(f.push(x),n.set(x.id,g.id),u.has(g.id)||u.set(g.id,new Set),u.get(g.id).add(x.id))}return{edges:f,edgeToTransitionRef:n,transitionToEdgesRef:u}}createEdgeForTransition(e,t,r,l,i){const a=l.get(e.sourceDefId),n=l.get(e.targetDefId);if(!(a!=null&&a.size)||!(n!=null&&n.size))return null;const u=a.values().next().value,f=n.values().next().value,p=i.get(u),y=i.get(f);if(!p||!y)return null;const{sourceHandle:m,targetHandle:E}=lt(),g=`edge_${u}_${f}`,x=t.getNode(e.sourceDefId),c=t.getNode(e.targetDefId),b=x?Re(x.kind):"floating",h=it(x==null?void 0:x.kind,c==null?void 0:c.kind);return{id:g,source:u,target:f,sourceHandle:m,targetHandle:E,type:b,data:{state:"idle",transitionId:e.id,...h,...b==="commandEdge"?ct():{}}}}}class Wt{constructor(){ie(this,"edgeRecovery",new Xt)}deserialize(e){try{const t=new dt;for(const c of e.definitions){const b={id:c.id,label:c.label,kind:c.kind,category:c.category,executionMode:c.executionMode,config:c.config,awsExtension:c.awsExtension};t.addNode(b)}for(const c of e.transitions){const b={id:c.id,sourceDefId:c.sourceDefId,targetDefId:c.targetDefId};t.addTransition(b)}const r=new Map,l=new Map,i=e.instances.map(c=>{const b=c.id,h=c.definitionId,w=t.getNode(h);r.set(b,h),l.has(h)||l.set(h,new Set),l.get(h).add(b);let T="event";return w.kind==="policy"?T="policy":w.kind==="externalSystem"?T="externalSystem":w.kind==="externalEvent"?T="externalEvent":w.kind==="command"?T="command":w.kind==="trigger"?T="trigger":w.kind==="hotspot"&&(T="hotspot"),{id:c.id,type:T,position:c.position,data:{label:w.label,executionMode:w.executionMode,definitionId:h}}}),a=new Map,n=new Map,u=new Map;if(e.outcomes)for(const c of e.outcomes){const b=c.id,h=c.parentPolicyInstanceId,w=c.parentPolicyDefId;a.set(b,h),n.has(h)||n.set(h,new Set),n.get(h).add(b),i.push({id:c.id,type:"outcome",position:c.position,parentId:c.parentPolicyInstanceId,data:{label:c.label,parentPolicyInstanceId:h,parentPolicyDefId:w}})}if(e.outcomeEdgeMappings)for(const c of e.outcomeEdgeMappings)u.set(c.outcomeId,c.transitionId);const f=new Map,p=new Map,y=e.edgeMappings.map(c=>{const b=c.transitionId,h=`edge_${c.source}_${c.target}`;f.set(h,b),p.has(b)||p.set(b,new Set),p.get(b).add(h);const w=a.has(c.source);let T;if(w){const L=a.get(c.source);T=L?r.get(L):void 0}else T=r.get(c.source);const A=T?t.getNode(T):void 0,j=A?Re(A.kind):"floating";return{id:h,source:c.source,target:c.target,sourceHandle:c.sourceHandle??"source-right",targetHandle:c.targetHandle??"target-left",type:j,data:{state:"idle",transitionId:b,...c.label!==void 0?{label:c.label}:{},...c.labelOffset!==void 0?{labelOffset:c.labelOffset}:{}}}}),m=new Map(i.map(c=>[c.id,c])),E={instanceToDefRef:r,defToInstancesRef:l,edgeToTransitionRef:f,transitionToEdgesRef:p,outcomeToParentRef:a,policyToOutcomesRef:n,outcomeToTransitionRef:u},g=this.edgeRecovery.recoverOrphanEdges(y,t,E,m),x={instanceToDefRef:r,defToInstancesRef:l,edgeToTransitionRef:g.edgeToTransitionRef,transitionToEdgesRef:g.transitionToEdgesRef,outcomeToParentRef:a,policyToOutcomesRef:n,outcomeToTransitionRef:u};return{success:!0,workflow:{graph:t,nodes:i,edges:g.edges,mappings:x}}}catch(t){return{success:!1,error:{code:"VALIDATION_ERROR",message:"Failed to deserialize workflow",details:t}}}}}class $t{constructor(){ie(this,"serialization",new zt);ie(this,"deserialization",new Wt)}serialize(e){return this.serialization.serialize(e)}deserialize(e){return this.deserialization.deserialize(e)}}const ne=new Map,Bt=s=>{const e=s.workflow,t=new Set(e.definitions.filter(a=>a.kind==="command"&&a.label.trim()==="").map(a=>a.id));if(t.size===0)return s;const r=new Set(e.transitions.filter(a=>t.has(a.sourceDefId)).map(a=>a.id)),l=new Set(e.instances.filter(a=>t.has(a.definitionId)).map(a=>a.id)),i=new Set(e.edgeMappings.filter(a=>r.has(a.transitionId)||l.has(a.source)||l.has(a.target)).map(a=>a.edgeId));return{...s,workflow:{...e,definitions:e.definitions.filter(a=>!t.has(a.id)),transitions:e.transitions.filter(a=>!r.has(a.id)),instances:e.instances.filter(a=>!l.has(a.id)),edgeMappings:e.edgeMappings.filter(a=>!i.has(a.edgeId))}}},Ht=s=>{const e=s.metadata.name.toLowerCase().trim().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-");return{...s,metadata:{...s.metadata,slugName:e}}},Vt=s=>{const t=s.metadata.targetPlugin==="none"?void 0:s.metadata.targetPlugin;return{...s,metadata:{...s.metadata,targetPlugin:t}}},Gt=s=>({...s,metadata:{...s.metadata,pluginConfig:{}}}),Ut=s=>({...s,workflow:{...s.workflow,definitions:s.workflow.definitions.map(e=>({...e,kind:e.kind==="externalSystem"?"externalEvent":e.kind}))}});ne.set(2,Bt);ne.set(3,Ht);ne.set(4,Vt);ne.set(5,Gt);ne.set(6,Ut);class qt{migrate(e){try{let t=e;for(;t.version<ue;){const r=ne.get(t.version);if(!r)return{success:!1,error:{code:"MIGRATION_ERROR",message:`No migration found for version ${t.version}`}};t=r(t),t={...t,version:t.version+1}}return{success:!0,document:t}}catch(t){return{success:!1,error:{code:"MIGRATION_ERROR",message:"Migration failed",details:t}}}}validate(e){if(!e.version||typeof e.version!="number"||!e.metadata||!e.workflow||!Array.isArray(e.workflow.definitions)||!Array.isArray(e.workflow.transitions)||!Array.isArray(e.workflow.instances)||!Array.isArray(e.workflow.edgeMappings))return!1;for(const t of e.workflow.definitions)if(!t.id.startsWith("def_"))return!1;for(const t of e.workflow.transitions)if(!t.id.startsWith("trans_"))return!1;for(const t of e.workflow.instances)if(!t.id.startsWith("inst_"))return!1;return!0}}const le="arko:workflow";class Kt{async save(e){try{const t=JSON.stringify(e);return localStorage.setItem(le,t),{success:!0}}catch(t){return{success:!1,error:{code:"STORAGE_ERROR",message:"Failed to save to localStorage",details:t}}}}async load(){try{const e=localStorage.getItem(le);return e?{success:!0,document:JSON.parse(e)}:{success:!1,error:{code:"NOT_FOUND",message:"No workflow found in localStorage"}}}catch(e){return{success:!1,error:{code:"PARSE_ERROR",message:"Failed to parse stored workflow",details:e}}}}async exists(){return localStorage.getItem(le)!==null}async clear(){try{return localStorage.removeItem(le),{success:!0}}catch(e){return{success:!1,error:{code:"STORAGE_ERROR",message:"Failed to clear localStorage",details:e}}}}}const Yt="1.0",Qt="https://arko.dev/ir/v1.json",Jt={id:"serverless-aws-ts",name:"Serverless / TypeScript / AWS",description:"AWS Lambda with TypeScript and Serverless Framework",nodeExtensions:{command:{timeout:30,memory:128},trigger:{timeout:30,memory:128}}},Zt={id:"serverless-aws-php",name:"Serverless / PHP / AWS (Bref)",description:"AWS Lambda with PHP 8.3 and Bref.sh",nodeExtensions:{command:{timeout:30,memory:128},trigger:{timeout:30,memory:128}}},Fe=new Map([["serverless-aws-ts",Jt],["serverless-aws-php",Zt]]);function eo(s){return Fe.get(s)}function Bo(){return Array.from(Fe.values())}class to{compile(e,t){try{const{graph:r,nodes:l,mappings:i}=e,a=t.metadata.targetPlugin?eo(t.metadata.targetPlugin):void 0,n=a?this.getExtensionProviderForPlugin(a.id):void 0,u=r.getAllNodes(),f=[],p=[],y=[],m=[];for(const h of u)switch(h.kind){case"event":f.push(h);break;case"command":p.push(h);break;case"trigger":y.push(h);break;case"policy":m.push(h);break}const E=this.buildEventTypeMap(f),g=this.compileEvents(f,E),x=this.compilePolicies(m,r,l,i,E),c=this.compileCommands(p,y,r,E,x,n);return{success:!0,ir:{$schema:Qt,version:Yt,metadata:{workflowId:ut(),name:t.metadata.name,slugName:t.metadata.slugName||se(t.metadata.name),targetPlugin:t.metadata.targetPlugin,generatedAt:new Date().toISOString(),sourceVersion:6,pluginConfig:t.metadata.pluginConfig},events:g,commands:c,policies:x}}}catch(r){return{success:!1,error:{code:"COMPILATION_ERROR",message:r instanceof Error?r.message:"Unknown compilation error",details:r}}}}getExtensionProviderForPlugin(e){if(e==="serverless-aws-ts")return{getExtensions(t,r){if(!(t.kind!=="command"&&t.kind!=="trigger")&&r)return{aws:{timeout:r.timeout,memory:r.memory}}}}}buildEventTypeMap(e){const t=new Map;for(const r of e){const l=r.config,i=(l==null?void 0:l.type)||ft(r.label);t.set(r.id,i)}return t}compileEvents(e,t){return e.map(r=>{const l=r.config;return{id:J(r.id),name:r.label,type:t.get(r.id),schema:l!=null&&l.schema?this.convertSchema(l.schema):null,outputPath:l==null?void 0:l.outputPath}})}compilePolicies(e,t,r,l,i){return e.map(a=>{var E,g,x,c;const u=t.getIncomingTransitions(a.id).map(b=>i.get(b.sourceDefId)).filter(b=>b!==void 0),f=l.defToInstancesRef.get(a.id),p=f==null?void 0:f.values().next().value,y=p?(E=l.policyToOutcomesRef)==null?void 0:E.get(p):void 0,m=[];if(y){const b=a.config;for(const h of y){const w=r.find(I=>I.id===h),T=((g=w==null?void 0:w.data)==null?void 0:g.label)||"Outcome",A=(x=b==null?void 0:b.outcomeConditions)==null?void 0:x.find(I=>I.outcomeLabel===T),j=(c=l.outcomeToTransitionRef)==null?void 0:c.get(h),L=[];if(j){const I=t.getTransition(j);if(I){const C=t.getNode(I.targetDefId);C&&(C.kind==="command"||C.kind==="trigger")&&L.push(J(C.id))}}m.push({id:J(h),label:T,condition:(A==null?void 0:A.condition)||"",targetCommandIds:L})}}return{id:J(a.id),name:a.label,slugName:se(a.label),consumes:u,outcomes:m}})}compileCommands(e,t,r,l,i,a){const n=[];for(const u of e){const f=this.compileCommand(u,r,l,i,a);n.push(f)}for(const u of t){const f=this.compileTriggerAsCommand(u,r,l,a);f&&n.push(f)}return n}compileCommand(e,t,r,l,i){const a=e.config,u=t.getOutgoingTransitions(e.id).map(y=>r.get(y.targetDefId)).filter(y=>y!==void 0),f=this.buildConsumptions(e.id,t,r,l),p=i==null?void 0:i.getExtensions(e,e.awsExtension);return{id:J(e.id),name:e.label,slugName:(a==null?void 0:a.slugName)||se(e.label,"unnamed"),produces:u,trigger:"consumer",consumes:f,requestSchema:a!=null&&a.requestSchema?this.convertSchema(a.requestSchema):null,extensions:p,outputPath:a==null?void 0:a.outputPath}}compileTriggerAsCommand(e,t,r,l){const i=e.config,n=t.getOutgoingTransitions(e.id).map(y=>r.get(y.targetDefId)).filter(y=>y!==void 0),u=l==null?void 0:l.getExtensions(e,e.awsExtension),f={id:J(e.id),name:e.label,slugName:(i==null?void 0:i.slugName)||se(e.label),produces:n,extensions:u,outputPath:i==null?void 0:i.outputPath};if((i==null?void 0:i.triggerType)==="schedule"&&i.schedule)return{...f,trigger:"scheduled",schedule:i.schedule};const p=(i==null?void 0:i.path)||`/${se(e.label)}`;return{...f,trigger:"http",http:{method:(i==null?void 0:i.httpMethod)||"POST",path:p,pathParameters:mt(p)},requestSchema:i!=null&&i.schema?this.convertSchema(i.schema):null}}buildConsumptions(e,t,r,l){const i=[],a=t.getIncomingTransitions(e);for(const n of a){const u=t.getNode(n.sourceDefId);if(u){if(u.kind==="event"){const f=r.get(u.id);f&&i.push({type:"event",eventType:f})}else if(u.kind==="policy"){const f=l.find(p=>p.id===J(u.id));if(f){const p=f.outcomes.find(y=>y.targetCommandIds.includes(J(e)));p&&i.push({type:"policy",policyId:f.id,outcomeId:p.id})}}}}return i}convertSchema(e){return{properties:e.map(t=>this.convertSchemaProperty(t))}}convertSchemaProperty(e){const t={name:e.name,required:e.required??!1};return e.type==="array"&&e.items?{...t,type:"array",items:{properties:[this.convertSchemaProperty(e.items)]}}:e.type==="object"&&e.properties?{...t,type:"object",nested:this.convertSchema(e.properties)}:{...t,type:e.type}}}const ye={version:7,metadata:{name:"E-commerce Order",slugName:"ecommerce-order",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),description:"Example workflow demonstrating an e-commerce order flow with stock checking"},workflow:{definitions:[{id:"def_01EXAMPLE_TRIGGER",label:"Order Received",kind:"trigger",category:"technical",executionMode:"manual",config:{slugName:"order-received",triggerType:"http",httpMethod:"POST",path:"/orders"}},{id:"def_01EXAMPLE_CMD_CREATE",label:"Create Order",kind:"command",category:"business",executionMode:"automatic",config:{slugName:"create-order"}},{id:"def_01EXAMPLE_EVT_CREATED",label:"Order Created",kind:"event",category:"business",executionMode:"automatic",config:{type:"order.created"}},{id:"def_01EXAMPLE_POLICY",label:"Check Stock",kind:"policy",category:"business",executionMode:"manual",config:{type:"check-stock",outcomeConditions:[{outcomeLabel:"In Stock",condition:"item.quantity > 0"},{outcomeLabel:"Out of Stock",condition:"item.quantity === 0"}]}},{id:"def_01EXAMPLE_CMD_PAYMENT",label:"Process Payment",kind:"command",category:"business",executionMode:"automatic",config:{slugName:"process-payment"}},{id:"def_01EXAMPLE_CMD_NOTIFY",label:"Notify Out of Stock",kind:"command",category:"business",executionMode:"automatic",config:{slugName:"notify-out-of-stock"}},{id:"def_01EXAMPLE_EVT_PAYMENT",label:"Payment Processed",kind:"event",category:"business",executionMode:"automatic",config:{type:"payment.processed"}},{id:"def_01EXAMPLE_EVT_NOTIFIED",label:"Customer Notified",kind:"event",category:"business",executionMode:"automatic",config:{type:"customer.notified"}}],transitions:[{id:"trans_01EXAMPLE_T1",sourceDefId:"def_01EXAMPLE_TRIGGER",targetDefId:"def_01EXAMPLE_CMD_CREATE"},{id:"trans_01EXAMPLE_T2",sourceDefId:"def_01EXAMPLE_CMD_CREATE",targetDefId:"def_01EXAMPLE_EVT_CREATED"},{id:"trans_01EXAMPLE_T3",sourceDefId:"def_01EXAMPLE_EVT_CREATED",targetDefId:"def_01EXAMPLE_POLICY"},{id:"trans_01EXAMPLE_T4",sourceDefId:"def_01EXAMPLE_POLICY",targetDefId:"def_01EXAMPLE_CMD_PAYMENT"},{id:"trans_01EXAMPLE_T5",sourceDefId:"def_01EXAMPLE_POLICY",targetDefId:"def_01EXAMPLE_CMD_NOTIFY"},{id:"trans_01EXAMPLE_T6",sourceDefId:"def_01EXAMPLE_CMD_PAYMENT",targetDefId:"def_01EXAMPLE_EVT_PAYMENT"},{id:"trans_01EXAMPLE_T7",sourceDefId:"def_01EXAMPLE_CMD_NOTIFY",targetDefId:"def_01EXAMPLE_EVT_NOTIFIED"}],instances:[{id:"inst_01EXAMPLE_TRIGGER",definitionId:"def_01EXAMPLE_TRIGGER",position:{x:100,y:300}},{id:"inst_01EXAMPLE_CMD_CREATE",definitionId:"def_01EXAMPLE_CMD_CREATE",position:{x:320,y:300}},{id:"inst_01EXAMPLE_EVT_CREATED",definitionId:"def_01EXAMPLE_EVT_CREATED",position:{x:540,y:300}},{id:"inst_01EXAMPLE_POLICY",definitionId:"def_01EXAMPLE_POLICY",position:{x:760,y:300}},{id:"inst_01EXAMPLE_CMD_PAYMENT",definitionId:"def_01EXAMPLE_CMD_PAYMENT",position:{x:1100,y:180}},{id:"inst_01EXAMPLE_CMD_NOTIFY",definitionId:"def_01EXAMPLE_CMD_NOTIFY",position:{x:1100,y:420}},{id:"inst_01EXAMPLE_EVT_PAYMENT",definitionId:"def_01EXAMPLE_EVT_PAYMENT",position:{x:1320,y:180}},{id:"inst_01EXAMPLE_EVT_NOTIFIED",definitionId:"def_01EXAMPLE_EVT_NOTIFIED",position:{x:1320,y:420}}],edgeMappings:[{edgeId:"edge_01EXAMPLE_E1",transitionId:"trans_01EXAMPLE_T1",source:"inst_01EXAMPLE_TRIGGER",target:"inst_01EXAMPLE_CMD_CREATE"},{edgeId:"edge_01EXAMPLE_E2",transitionId:"trans_01EXAMPLE_T2",source:"inst_01EXAMPLE_CMD_CREATE",target:"inst_01EXAMPLE_EVT_CREATED"},{edgeId:"edge_01EXAMPLE_E3",transitionId:"trans_01EXAMPLE_T3",source:"inst_01EXAMPLE_EVT_CREATED",target:"inst_01EXAMPLE_POLICY"},{edgeId:"edge_01EXAMPLE_E4",transitionId:"trans_01EXAMPLE_T4",source:"outcome_01EXAMPLE_INSTOCK",target:"inst_01EXAMPLE_CMD_PAYMENT"},{edgeId:"edge_01EXAMPLE_E5",transitionId:"trans_01EXAMPLE_T5",source:"outcome_01EXAMPLE_OUTSTOCK",target:"inst_01EXAMPLE_CMD_NOTIFY"},{edgeId:"edge_01EXAMPLE_E6",transitionId:"trans_01EXAMPLE_T6",source:"inst_01EXAMPLE_CMD_PAYMENT",target:"inst_01EXAMPLE_EVT_PAYMENT"},{edgeId:"edge_01EXAMPLE_E7",transitionId:"trans_01EXAMPLE_T7",source:"inst_01EXAMPLE_CMD_NOTIFY",target:"inst_01EXAMPLE_EVT_NOTIFIED"}],outcomes:[{id:"outcome_01EXAMPLE_INSTOCK",label:"In Stock",parentPolicyInstanceId:"inst_01EXAMPLE_POLICY",parentPolicyDefId:"def_01EXAMPLE_POLICY",position:{x:162,y:-30}},{id:"outcome_01EXAMPLE_OUTSTOCK",label:"Out of Stock",parentPolicyInstanceId:"inst_01EXAMPLE_POLICY",parentPolicyDefId:"def_01EXAMPLE_POLICY",position:{x:162,y:100}}],outcomeEdgeMappings:[{outcomeId:"outcome_01EXAMPLE_INSTOCK",transitionId:"trans_01EXAMPLE_T4"},{outcomeId:"outcome_01EXAMPLE_OUTSTOCK",transitionId:"trans_01EXAMPLE_T5"}]}},de="Untitled Workflow",oo=1e3,ze="arko:workflows";function q(s){return s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"workflow"}function Ae(){try{const s=localStorage.getItem(ze);return s?JSON.parse(s):[]}catch{return[]}}function no(s){try{localStorage.setItem(ze,JSON.stringify(s))}catch(e){console.error("Failed to save workflows to localStorage:",e)}}const so=d.createContext(null);function Ho({children:s,initialWorkflowId:e}){const t=we(),[r,l]=d.useState(!0),[i,a]=d.useState(null),[n,u]=d.useState(de),[f,p]=d.useState(()=>q(de)),[y,m]=d.useState(void 0),[E,g]=d.useState({}),[x,c]=d.useState(null),[b,h]=d.useState(null),[w,T]=d.useState(!1),A=d.useRef(null),j=d.useCallback(k=>{u(N=>(p(P=>P===q(N)?q(k):P),k))},[]),L=d.useCallback(k=>{p(k)},[]),I=d.useRef(new $t),C=d.useRef(new qt),B=d.useRef(new Kt),H=d.useRef(new xt),V=d.useRef(new to),X=d.useRef(void 0),W=d.useRef(!1),O=d.useRef(!1),S=d.useCallback(k=>{const N=I.current.deserialize(k.workflow);return N.success?(t.hydrateWorkflow(N.workflow),u(k.metadata.name),p(k.metadata.slugName||q(k.metadata.name)),m(k.metadata.targetPlugin),g(k.metadata.pluginConfig??{}),c(k.metadata.createdAt),!0):!1},[t]);d.useEffect(()=>{(async()=>{try{const N=await B.current.load();if(N.success){if(!C.current.validate(N.document)){console.warn("Invalid workflow document in localStorage, loading example instead"),S(ye),l(!1);return}const P=C.current.migrate(N.document);P.success&&S(P.document)}else console.info("No saved workflow found, loading example workflow"),S(ye)}catch(N){console.error("Failed to load workflow from localStorage:",N),S(ye)}finally{l(!1)}})()},[]);const Y=d.useCallback(async()=>{const k=t.getWorkflowState(),N=I.current.serialize(k);if(!N.success)return{success:!1,error:N.error};const P=new Date().toISOString(),R={version:ue,metadata:{name:n,slugName:f,targetPlugin:y,pluginConfig:E,createdAt:x||P,updatedAt:P},workflow:N.workflow};return x||c(P),B.current.save(R)},[t,n,f,y,E,x]),{nodes:D,edges:re}=t;d.useEffect(()=>{if(!r){if(!W.current){W.current=!0;return}return X.current&&clearTimeout(X.current),X.current=setTimeout(()=>{Y()},oo),()=>{X.current&&clearTimeout(X.current)}}},[D,re,n,f,y,E,Y,r]);const Q=d.useCallback(()=>{const k=t.getWorkflowState(),N=I.current.serialize(k);if(!N.success)return{success:!1,error:N.error};const P=new Date().toISOString(),R={version:ue,metadata:{name:n,slugName:f,targetPlugin:y,pluginConfig:E,createdAt:x||P,updatedAt:P},workflow:N.workflow},Z=`${f||q(n)}.json`;return H.current.exportToFile(R,Z)},[t,n,f,y,E,x]),me=d.useCallback(()=>{const k=t.getWorkflowState(),N=new Date().toISOString();return V.current.compile(k,{metadata:{name:n,slugName:f||q(n),targetPlugin:y,pluginConfig:E,createdAt:x||N,updatedAt:N}})},[t,n,f,y,E,x]),F=d.useCallback(()=>{const k=t.getWorkflowState(),N=I.current.serialize(k);if(!N.success)throw new Error(N.error.message);const P=new Date().toISOString();return{version:ue,metadata:{name:n,slugName:f||q(n),targetPlugin:y,pluginConfig:E,createdAt:x||P,updatedAt:P},workflow:N.workflow}},[t,n,f,y,E,x]),ge=d.useCallback(async()=>{const k=await H.current.importFromFile();if(!k.success)return k;if(!C.current.validate(k.document))return{success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid workflow file format"}};const N=C.current.migrate(k.document);if(!N.success)return{success:!1,error:N.error};const P=I.current.deserialize(N.document.workflow);return P.success?(t.hydrateWorkflow(P.workflow),u(N.document.metadata.name),p(N.document.metadata.slugName||q(N.document.metadata.name)),m(N.document.metadata.targetPlugin),g(N.document.metadata.pluginConfig??{}),c(N.document.metadata.createdAt),await B.current.save(N.document),{success:!0,document:N.document}):{success:!1,error:P.error}},[t]),pe=d.useCallback(async()=>(u(de),p(q(de)),m(void 0),g({}),c(null),h(null),T(!1),A.current=null,B.current.clear()),[]),$=d.useCallback(k=>JSON.stringify({workflow:k.workflow,name:k.metadata.name,slugName:k.metadata.slugName,targetPlugin:k.metadata.targetPlugin,pluginConfig:k.metadata.pluginConfig}),[]),he=d.useCallback(async()=>{const k=F();try{const N=Ae(),P=new Date().toISOString();if(b){const R=N.findIndex(Z=>Z.id===b);R!==-1&&(N[R]={...N[R],document:k,updatedAt:P})}else console.warn("saveToApi called without currentWorkflowId");return no(N),A.current=$(k),T(!1),{success:!0}}catch(N){return{success:!1,error:{code:"STORAGE_ERROR",message:N instanceof Error?N.message:"Failed to save workflow"}}}},[F,b,$]),U=d.useCallback(async k=>{try{const P=Ae().find(ee=>ee.id===k);if(!P)return{success:!1,error:{code:"NOT_FOUND",message:"Workflow not found"}};if(!C.current.validate(P.document))return{success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid workflow document"}};const R=C.current.migrate(P.document);return R.success?S(R.document)?(h(P.id),A.current=$(R.document),T(!1),await B.current.save(R.document),{success:!0,document:R.document}):{success:!1,error:{code:"PARSE_ERROR",message:"Failed to hydrate workflow"}}:{success:!1,error:R.error}}catch(N){return{success:!1,error:{code:"STORAGE_ERROR",message:N instanceof Error?N.message:"Failed to load workflow"}}}},[S,$]);return d.useEffect(()=>{if(r||A.current!==null||b!==null)return;const k=F();A.current=$(k)},[r,b,F,$]),d.useEffect(()=>{if(r||!W.current||A.current===null)return;const k=F(),N=$(k);T(N!==A.current)},[D,re,n,f,y,E,r,F,$]),d.useEffect(()=>{r||e&&!O.current&&(O.current=!0,l(!0),a(null),U(e).then(k=>{k.success||(console.error("Failed to load workflow from URL:",k.error.message),a(k.error))}).finally(()=>{l(!1)}))},[r,e,U]),o.jsx(so.Provider,{value:{isLoading:r,loadError:i,workflowName:n,setWorkflowName:j,slugName:f,setSlugName:L,targetPlugin:y,setTargetPlugin:m,pluginConfig:E,setPluginConfig:g,saveToLocalStorage:Y,exportToFile:Q,exportToIR:me,getWorkflowDocument:F,importFromFile:ge,clearStorage:pe,currentWorkflowId:b,isDirty:w,saveToApi:he,loadFromApi:U,hydrateDocument:S},children:s})}const Xe=10,fe=50;function ro(s,e){const t=d.useRef([]);return d.useEffect(()=>()=>{t.current.forEach(clearTimeout)},[]),{execute:d.useCallback((l,i)=>{const{isRunning:a,start:n,triggerNode:u,selectTransition:f}=s;if(t.current.forEach(clearTimeout),t.current=[],e!=null&&e.isSourceWaiting)f(i);else if(a){u(l);const p=setTimeout(()=>{f(i)},fe);t.current.push(p)}else{n();const p=setTimeout(()=>{u(l);const y=setTimeout(()=>{f(i)},fe);t.current.push(y)},Xe);t.current.push(p)}},[s,e==null?void 0:e.isSourceWaiting])}}function Vo(s){const e=d.useRef([]);return d.useEffect(()=>()=>{e.current.forEach(clearTimeout)},[]),{execute:d.useCallback(r=>{const{isRunning:l,start:i,triggerNode:a,completeManualNode:n}=s;if(e.current.forEach(clearTimeout),e.current=[],l){a(r);const u=setTimeout(()=>{n(r)},fe);e.current.push(u)}else{i();const u=setTimeout(()=>{a(r);const f=setTimeout(()=>{n(r)},fe);e.current.push(f)},Xe);e.current.push(u)}},[s])}}function ao({ref:s,onClose:e,enabled:t=!0,listenEscape:r=!0,listenClickOutside:l=!0}){d.useEffect(()=>{if(!t)return;const i=u=>{s.current&&!s.current.contains(u.target)&&e()},a=u=>{u.key==="Escape"&&e()},n=setTimeout(()=>{l&&document.addEventListener("mousedown",i),r&&document.addEventListener("keydown",a)},0);return()=>{clearTimeout(n),l&&document.removeEventListener("mousedown",i),r&&document.removeEventListener("keydown",a)}},[s,e,t,r,l])}function Go(s,e=!0){d.useEffect(()=>{if(!e)return;const t=r=>{r.key==="Escape"&&s()};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[s,e])}function Uo(){const s=be(r=>r.sidebarCollapsed),e=be(r=>r.setSidebarCollapsed),t=be(r=>r.toggleSidebar);return{collapsed:s,setCollapsed:e,toggleCollapsed:t}}const oe={event:{gradient:"gradient-event",rotate:"rotate-event",selected:"node-selected-event",pulse:"animate-pulse-event"},command:{gradient:"gradient-command",rotate:"rotate-command",selected:"node-selected-command",pulse:"animate-pulse-command"},policy:{gradient:"gradient-policy",rotate:"rotate-policy",selected:"node-selected-policy",pulse:"animate-pulse-policy"},trigger:{gradient:"gradient-trigger",rotate:"rotate-trigger",selected:"node-selected-trigger",pulse:"animate-pulse-trigger"},externalSystem:{gradient:"gradient-external",rotate:"rotate-external-system",selected:"node-selected-external",pulse:"animate-pulse-external"},externalEvent:{gradient:"gradient-external",rotate:"rotate-external-event",selected:"node-selected-external",pulse:"animate-pulse-external"},hotspot:{gradient:"gradient-hotspot",rotate:"rotate-hotspot",selected:"node-selected-hotspot"}};function io({text:s,maxWidth:e,maxHeight:t,minFontSize:r=8,maxFontSize:l=18}){return d.useMemo(()=>{if(!s||e<=0||t<=0)return{fontSize:l};const i=document.createElement("div");i.style.cssText=`
      position: absolute;
      left: -9999px;
      top: -9999px;
      width: ${e}px;
      height: ${t}px;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
      font-weight: 400;
      line-height: 1.3;
      white-space: pre-wrap;
      word-wrap: break-word;
      text-align: center;
      box-sizing: border-box;
    `,i.textContent=s,document.body.appendChild(i);let a=r;for(let n=l;n>=r;n--){i.style.fontSize=`${n}px`;const u=i.scrollHeight<=i.clientHeight,f=i.scrollWidth<=i.clientWidth;if(u&&f){a=n;break}}return document.body.removeChild(i),{fontSize:a}},[s,e,t,r,l])}const co=128,lo=78,G=d.memo(d.forwardRef(function({value:e,onChange:t,className:r,placeholder:l="Label",maxWidth:i=co,maxHeight:a=lo,minFontSize:n=8,maxFontSize:u=18,autoSize:f=!1,onEditEnd:p},y){const[m,E]=d.useState(!1),g=d.useRef(null),{fontSize:x}=io({text:f?"":e||l,maxWidth:i,maxHeight:a,minFontSize:n,maxFontSize:u});d.useImperativeHandle(y,()=>({startEditing:()=>E(!0)}),[]),d.useEffect(()=>{if(m&&g.current){g.current.focus();const I=window.getSelection(),C=document.createRange();C.selectNodeContents(g.current),I==null||I.removeAllRanges(),I==null||I.addRange(C)}},[m]);const c=d.useCallback(I=>{I.stopPropagation(),E(!0)},[]),b=d.useCallback(()=>{var C;if(!g.current)return;const I=((C=g.current.textContent)==null?void 0:C.trim())||"";I!==e&&t(I),E(!1),p==null||p(I)},[e,t,p]),h=d.useCallback(()=>{g.current&&(g.current.textContent=e),E(!1),p==null||p(e)},[e,p]),w=d.useCallback(I=>{I.key==="Enter"&&!I.shiftKey?(I.preventDefault(),b()):I.key==="Escape"&&(I.preventDefault(),h())},[b,h]),T=d.useCallback(()=>{b()},[b]),A=d.useCallback(I=>{m&&I.stopPropagation()},[m]),j=d.useCallback(I=>{m&&I.stopPropagation()},[m]),L=f?void 0:{fontSize:`${x}px`};return o.jsx("span",{ref:g,className:M("flex items-center text-center font-normal text-[0.75rem] whitespace-pre-wrap leading-[1.3] break-words overflow-hidden flex-1 min-w-[4em] min-h-[1.3em] text-postit-text","cursor-text",m&&"outline-none bg-black/20 rounded px-1.5 py-0.5 shadow-[0_0_0_1px_rgba(255,255,255,0.4)] nodrag nopan",r),style:L,contentEditable:m,suppressContentEditableWarning:!0,onDoubleClick:c,onKeyDown:m?w:void 0,onBlur:m?T:void 0,onMouseDown:A,onClick:j,children:e})})),qo=d.memo(function({label:e,selected:t,isCompleted:r,isActive:l,isTargetConnectable:i,isSourceConnectable:a,onLabelChange:n,placeholder:u="Event",instanceCount:f,isOriginal:p,toolbar:y,quickCreateButtons:m}){const E=oe.event;return o.jsxs("div",{className:M("node-postit",E.gradient,E.rotate,"w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&`node-selected ${E.selected}`,r&&"bg-success! node-completed",l&&E.pulse,f&&f>1&&!p&&"texture-diagonal-clone"),children:[y,m,o.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:i}),o.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:i}),o.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:i}),o.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:i}),o.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:a}),o.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:a}),o.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:a}),o.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:a}),o.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:o.jsx(G,{value:e,onChange:n,placeholder:u})}),f&&f>1&&o.jsx("div",{className:"absolute top-1 left-1 flex items-center gap-1 z-10",children:o.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${f} instances share this definition`,children:[o.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[o.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),o.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),f]})})]})}),Ko=d.memo(function({label:e,selected:t,isCompact:r,isCompleted:l,isActive:i,isWaiting:a,isTargetConnectable:n,isSourceConnectable:u,onLabelChange:f,onDoubleClick:p,onEditEnd:y,labelRef:m,placeholder:E="Command",instanceCount:g,isOriginal:x,toolbar:c,quickCreateButtons:b}){const h=oe.command;return o.jsxs("div",{className:M("node-postit",h.gradient,h.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",r?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5":"w-[152px]",t&&`node-selected ${h.selected}`,l&&"bg-success! node-completed",i&&"animate-pulse-success",a&&h.pulse,g&&g>1&&!x&&"texture-diagonal-clone"),onDoubleClick:p,children:[c,b,o.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:n}),o.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:n}),o.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:n}),o.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:n}),o.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:u}),o.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:u}),o.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:u}),o.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:u}),o.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:o.jsx(G,{ref:m,value:e,onChange:f,placeholder:E,onEditEnd:y})}),g&&g>1&&o.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex items-center gap-1 z-10",children:o.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${g} instances share this definition`,children:[o.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[o.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),o.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),g]})})]})}),Yo=d.memo(function({label:e,selected:t,isCompleted:r,isActive:l,isWaiting:i,isTargetConnectable:a,isSourceConnectable:n,onLabelChange:u,placeholder:f="Policy",instanceCount:p,isOriginal:y,toolbar:m,quickCreateButtons:E,children:g}){const x=oe.policy;return o.jsxs("div",{className:M("node-postit",x.gradient,x.rotate,"w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&`node-selected ${x.selected}`,r&&"bg-success! node-completed",l&&"animate-pulse-success",i&&x.pulse,p&&p>1&&!y&&"texture-diagonal-clone"),children:[m,E,o.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:a}),o.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:a}),o.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:a}),o.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:a}),n!==void 0&&o.jsxs(o.Fragment,{children:[o.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:n}),o.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:n}),o.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:n}),o.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:n})]}),o.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:o.jsx(G,{value:e,onChange:u,placeholder:f})}),p&&p>1&&o.jsx("div",{className:"absolute top-1 left-1 flex items-center gap-1 z-10",children:o.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${p} instances share this definition`,children:[o.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[o.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),o.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),p]})}),g]})}),Qo=d.memo(function({label:e,selected:t,isCompact:r,isCompleted:l,isActive:i,isWaiting:a,isTargetConnectable:n,isSourceConnectable:u,onLabelChange:f,onDoubleClick:p,onEditEnd:y,labelRef:m,placeholder:E="Trigger",instanceCount:g,isOriginal:x,toolbar:c,quickCreateButtons:b,playButton:h}){const w=oe.trigger;return o.jsxs("div",{className:M("node-postit",w.gradient,w.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",r?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5 [&_.play-btn]:right-auto [&_.play-btn]:left-1/2 [&_.play-btn]:-translate-x-1/2":"w-[152px]",t&&`node-selected ${w.selected}`,l&&"bg-success! node-completed",i&&"animate-pulse-success",a&&w.pulse,g&&g>1&&!x&&"texture-diagonal-clone"),onDoubleClick:p,children:[c,b,o.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:n}),o.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:n}),o.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:n}),o.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:n}),o.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:u}),o.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:u}),o.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:u}),o.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:u}),o.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:o.jsx(G,{ref:m,value:e,onChange:f,placeholder:E,onEditEnd:y})}),h,g&&g>1&&o.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex items-center gap-1 z-10",children:o.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${g} instances share this definition`,children:[o.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[o.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),o.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),g]})})]})}),Jo=d.memo(function({label:e,selected:t,isCompact:r,isCompleted:l,isActive:i,isWaiting:a,isTargetConnectable:n,isSourceConnectable:u,onLabelChange:f,onDoubleClick:p,onEditEnd:y,labelRef:m,placeholder:E="External System",instanceCount:g,toolbar:x,quickCreateButtons:c,playButton:b}){const h=oe.externalSystem;return o.jsxs("div",{className:M("node-postit",h.gradient,h.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",r?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5 [&_.play-btn]:right-auto [&_.play-btn]:left-1/2 [&_.play-btn]:-translate-x-1/2":"w-[152px]",t&&`node-selected ${h.selected}`,l&&"bg-success! node-completed",i&&"animate-pulse-success",a&&h.pulse),onDoubleClick:p,children:[x,c,o.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:n}),o.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:n}),o.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:n}),o.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:n}),o.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:u}),o.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:u}),o.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:u}),o.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:u}),o.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:o.jsx(G,{ref:m,value:e,onChange:f,placeholder:E,onEditEnd:y})}),b,g&&g>1&&o.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex gap-[3px] z-10",children:o.jsxs("span",{className:"text-[0.4rem] px-[5px] py-0.5 rounded-[3px] bg-black/30 text-white/80 font-semibold tracking-[0.3px] cursor-help",title:`${g} instances share this definition`,children:["x",g]})})]})}),Zo=d.memo(function({label:e,selected:t,isCompact:r,isCompleted:l,isActive:i,isWaiting:a,isTargetConnectable:n,isSourceConnectable:u,onLabelChange:f,onDoubleClick:p,onEditEnd:y,labelRef:m,placeholder:E="External Event",instanceCount:g,toolbar:x,quickCreateButtons:c,playButton:b}){const h=oe.externalEvent;return o.jsxs("div",{className:M("node-postit",h.gradient,h.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",r?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5 [&_.play-btn]:right-auto [&_.play-btn]:left-1/2 [&_.play-btn]:-translate-x-1/2":"w-[152px]",t&&`node-selected ${h.selected}`,l&&"bg-success! node-completed",i&&"animate-pulse-success",a&&h.pulse),onDoubleClick:p,children:[x,c,o.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:n}),o.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:n}),o.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:n}),o.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:n}),o.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:u}),o.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:u}),o.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:u}),o.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:u}),o.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:o.jsx(G,{ref:m,value:e,onChange:f,placeholder:E,onEditEnd:y})}),b,g&&g>1&&o.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex gap-[3px] z-10",children:o.jsxs("span",{className:"text-[0.4rem] px-[5px] py-0.5 rounded-[3px] bg-black/30 text-white/80 font-semibold tracking-[0.3px] cursor-help",title:`${g} instances share this definition`,children:["x",g]})})]})}),en=d.memo(function({label:e,selected:t,description:r,onLabelChange:l,placeholder:i="HotSpot",instanceCount:a,toolbar:n}){const u=oe.hotspot;return o.jsxs("div",{className:M("node-postit",u.gradient,u.rotate,"w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&`node-selected ${u.selected}`),children:[n,o.jsxs("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:[o.jsx(G,{value:e,onChange:l,placeholder:i}),r&&o.jsx("div",{className:"text-[0.6rem] text-black/70 mt-1 text-center overflow-hidden line-clamp-2 leading-[1.2]",children:r})]}),a&&a>1&&o.jsx("div",{className:"absolute top-1 left-1 flex gap-[3px] z-10",children:o.jsxs("span",{className:"text-[0.4rem] px-[5px] py-0.5 rounded-[3px] bg-black/30 text-white/80 font-semibold tracking-[0.3px] cursor-help",title:`${a} instances share this definition`,children:["x",a]})})]})}),tn=d.memo(function({label:e,selected:t,isCompleted:r,isActive:l,isTargetConnectable:i,isSourceConnectable:a,onLabelChange:n,placeholder:u="Actor",toolbar:f,quickCreateButtons:p}){return o.jsxs("div",{className:M("node-postit gradient-actor rotate-actor","w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&"node-selected node-selected-actor",r&&"bg-success! node-completed",l&&"animate-pulse-actor"),children:[f,p,i!==void 0&&o.jsxs(o.Fragment,{children:[o.jsx(_,{type:"target",position:v.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:i}),o.jsx(_,{type:"target",position:v.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:i}),o.jsx(_,{type:"target",position:v.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:i}),o.jsx(_,{type:"target",position:v.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:i})]}),a!==void 0&&o.jsxs(o.Fragment,{children:[o.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:a}),o.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:a}),o.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:a}),o.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:a})]}),o.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:o.jsx(G,{value:e,onChange:n,placeholder:u})})]})}),on=d.memo(function({label:e,selected:t,onLabelChange:r,placeholder:l="Note",toolbar:i}){return o.jsxs("div",{className:M("node-postit gradient-note rotate-note","w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&"node-selected node-selected-note"),children:[i,o.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:o.jsx(G,{value:e,onChange:r,placeholder:l})})]})}),uo=200,fo=150,nn=d.memo(function({label:e,selected:t,onLabelChange:r,onResizeStart:l,onResize:i,onResizeEnd:a,placeholder:n="Group",toolbar:u,children:f}){const{zoom:p}=Ve(),y=d.useRef(null),m=d.useRef(null),E=Math.min(8,Math.max(.7,1/p));return d.useEffect(()=>{if(y.current&&m.current){m.current.textContent=e||n;const g=m.current.offsetWidth;y.current.style.width=`${Math.max(60,g+4)}px`}},[e,n]),o.jsxs("div",{className:M("relative w-full h-full rounded-lg","border-[1.5px] border-[rgba(139,92,246,0.5)]"),style:{background:"radial-gradient(ellipse at center, transparent 30%, rgba(139,92,246,0.06) 100%)"},children:[o.jsx(Ge,{minWidth:uo,minHeight:fo,isVisible:!0,lineClassName:"group-resize-line !z-[1000]",handleClassName:"group-resize-handle !z-[1000]",onResizeStart:()=>l==null?void 0:l(),onResize:(g,x)=>i==null?void 0:i(x.width,x.height),onResizeEnd:(g,x)=>a==null?void 0:a(x.width,x.height)}),u,o.jsxs("div",{className:M("absolute z-10 origin-bottom-left"),style:{top:`${-10*E-20}px`,left:"8px",transform:`scale(${E})`},children:[o.jsx("span",{ref:m,className:"absolute invisible whitespace-pre text-sm font-semibold","aria-hidden":"true"}),o.jsx("input",{ref:y,type:"text",value:e,onChange:g=>r(g.target.value),placeholder:n,className:M("bg-transparent border-none outline-none","text-sm font-semibold","min-w-[60px]","text-[rgba(139,92,246,0.7)] placeholder:text-[rgba(139,92,246,0.4)]")})]}),o.jsx("div",{className:"w-full h-full pointer-events-none",children:f})]})}),sn="w-4 h-4",rn=10,mo=M("w-7 h-7 rounded-md flex items-center justify-center","border-none cursor-pointer","transition-all duration-150","hover:scale-110 active:scale-95","focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-text-primary"),go=M("p-1.5 rounded","transition-colors","focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1"),an=M("flex items-center gap-1.5 p-1.5 rounded-lg","bg-bg-secondary/95 backdrop-blur-sm","border border-border shadow-[var(--shadow-toolbar)]"),cn=M("flex gap-1 bg-white rounded-lg shadow-lg p-1 border border-gray-200","dark:bg-bg-secondary dark:border-border");function ln(s){return M(mo,{default:"bg-text-muted/20 text-text-secondary hover:bg-text-muted/30",danger:"bg-danger/20 text-danger hover:bg-danger/30",info:"bg-info/20 text-info hover:bg-info/30",accent:"bg-accent/20 text-accent hover:bg-accent/30",event:"bg-node-event/20 text-node-event hover:bg-node-event/30",trigger:"bg-node-trigger/20 text-node-trigger hover:bg-node-trigger/30",command:"bg-node-command/20 text-node-command hover:bg-node-command/30"}[s])}function dn(s){return M(go,{default:"text-gray-500 hover:bg-gray-50 hover:text-gray-700 dark:hover:bg-text-muted/20 dark:hover:text-text-primary",danger:"text-gray-500 hover:bg-red-50 hover:text-red-500 dark:hover:bg-danger/20 dark:hover:text-danger",purple:"text-gray-500 hover:bg-purple-50 hover:text-purple-500 dark:hover:bg-node-policy/20 dark:hover:text-node-policy"}[s])}function po(){const{getNode:s}=Ee(),{addNode:e,onConnect:t}=we(),r=d.useCallback((i,a=!1)=>{const u=gt[a?"policy":i];return u?[...u.canConnectTo]:[]},[]),l=d.useCallback((i,a,n)=>{var c,b;const u=s(i);if(!u)return;const f=u.parentId?s(u.parentId):void 0,p=pt(u.position,f==null?void 0:f.position),y=((c=u.measured)==null?void 0:c.width)??jt,m=((b=u.measured)==null?void 0:b.height)??Lt,E=Ot(p,y,m,n),g=e(a,E),x=St(n);t({source:i,target:g,sourceHandle:x.source,targetHandle:x.target})},[s,e,t]);return{getValidTargetTypes:r,createConnectedNode:l}}const ho={event:{label:"Event",Icon:Se},command:{label:"Command",Icon:At},policy:{label:"Policy",Icon:wt},trigger:{label:"Trigger",Icon:ve},externalSystem:{label:"Ext System",Icon:Te},externalEvent:{label:"Ext Event",Icon:Te}},xo={event:"bg-node-event text-postit-text",command:"bg-[#3b82f6] text-white",policy:"bg-node-policy text-postit-text",trigger:"bg-node-trigger text-postit-text",externalSystem:"bg-node-external text-postit-text",externalEvent:"bg-node-external text-postit-text"};function bo({validTypes:s,anchorPosition:e,direction:t,onSelect:r,onClose:l,typeConfig:i,getIconColorClass:a}){const n=d.useRef(null);ao({ref:n,onClose:l});const f=d.useCallback(()=>{const c=s.length*44+8,b=10,h=8;let w,T;switch(t){case"top":w=e.x-180/2,T=e.y-c-h;break;case"bottom":w=e.x-180/2,T=e.y+h;break;case"left":w=e.x-180-h,T=e.y-c/2;break;case"right":w=e.x+h,T=e.y-c/2;break}return w+180>window.innerWidth-b&&(w=window.innerWidth-180-b),T+c>window.innerHeight-b&&(T=window.innerHeight-c-b),w<b&&(w=b),T<b&&(T=b),{x:w,y:T}},[e,t,s.length])(),p=d.useMemo(()=>{if(!s.includes("event"))return s;const x=s.filter(b=>b!=="event"),c=Math.floor(x.length/2);return[...x.slice(0,c),"event",...x.slice(c)]},[s]),y=d.useCallback(x=>{r(x),l()},[r,l]),m=d.useCallback(x=>i&&x in i?i[x]:ho[x]??{label:x,Icon:Se},[i]),E=d.useCallback(x=>a?a(x):xo[x]??"bg-gray-500 text-white",[a]);if(p.length===0)return null;const g=o.jsx("div",{ref:n,className:M("fixed bg-bg-secondary border border-border rounded-lg","shadow-[0_4px_16px_rgba(0,0,0,0.3)] p-1 z-[10000] min-w-[160px]","animate-zoom-in","light:bg-white light:shadow-[0_4px_16px_rgba(0,0,0,0.15)]"),style:{left:f.x,top:f.y},children:p.map(x=>{const c=m(x);return o.jsxs("button",{className:M("flex items-center gap-2.5 py-2 px-3 rounded-md","cursor-pointer transition-colors duration-100","text-text-primary border-none bg-transparent w-full text-[13px]","hover:bg-bg-tertiary active:scale-[0.98]"),onClick:()=>y(x),children:[o.jsx("span",{className:M("w-6 h-6 rounded flex items-center justify-center shrink-0","[&_svg]:w-3.5 [&_svg]:h-3.5",E(x)),children:o.jsx(c.Icon,{})}),o.jsx("span",{className:"flex-1 text-left",children:c.label})]},x)})});return Ue.createPortal(g,document.body)}const yo=d.memo(bo),Eo=d.memo(function({outcomeId:e,canDelete:t,onDelete:r}){const l=d.useCallback(i=>{i.stopPropagation(),t&&r(e)},[e,t,r]);return o.jsx(qe,{position:v.Top,offset:10,className:M("flex items-center gap-1.5 p-1.5 rounded-lg","bg-bg-secondary/95 backdrop-blur-sm","border border-border shadow-[var(--shadow-toolbar)]"),children:o.jsx("button",{className:M("w-7 h-7 rounded-md flex items-center justify-center","border-none cursor-pointer transition-all duration-150","hover:scale-110 active:scale-95","bg-danger/20 text-danger hover:bg-danger/30","disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"),onClick:l,disabled:!t,title:t?"Delete outcome":"Cannot delete - minimum 2 outcomes required",children:o.jsx(bt,{className:"w-4 h-4"})})})}),un=d.memo(function({id:e,data:t,selected:r}){const l=Ke(),i=r||l.inProgress,{state:a,selectTransition:n,isRunning:u,start:f,triggerNode:p}=Dt(),{getOutcomeTransition:y,updateOutcomeLabel:m,deleteOutcome:E,getOutcomesForPolicy:g}=we(),c=(t.parentPolicyDefId?a==null?void 0:a.nodeStates.get(t.parentPolicyDefId):void 0)==="waiting_for_action",b=e,h=y(b),w=!!h,A=g(t.parentPolicyInstanceId).length>2,j=d.useCallback(C=>{A&&E(C)},[A,E]),L=d.useCallback(C=>{C.stopPropagation(),!(!h||!t.parentPolicyDefId)&&(c?n(h):u?(p(t.parentPolicyDefId),setTimeout(()=>{n(h)},50)):(f(),setTimeout(()=>{p(t.parentPolicyDefId),setTimeout(()=>{n(h)},50)},10)))},[h,t.parentPolicyDefId,c,u,f,p,n]),I=d.useCallback(C=>{m(e,C)},[e,m]);return o.jsxs("div",{className:M("gradient-outcome border border-node-policy/50 rounded-md","w-auto h-auto min-w-[50px] min-h-8 p-0","shadow-[0_2px_4px_rgba(0,0,0,0.3)] transition-all duration-200","hover:scale-[1.02]",r&&"node-selected node-selected-outcome shadow-[0_0_8px_rgba(147,51,234,0.8)] border-node-policy",c&&"gradient-outcome-clickable border-node-policy cursor-pointer animate-pulse-outcome hover:scale-[1.08] hover:shadow-[0_0_12px_rgba(147,51,234,0.9)]"),children:[o.jsx(Eo,{outcomeId:b,canDelete:A,onDelete:j}),r&&o.jsx(To,{instanceId:b,nodeType:"policy",isOutcome:!0}),o.jsx(_,{type:"source",position:v.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:i}),o.jsx(_,{type:"source",position:v.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:i}),o.jsx(_,{type:"source",position:v.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:i}),o.jsx(_,{type:"source",position:v.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:i}),o.jsxs("div",{className:"flex flex-row items-center gap-1.5 py-1 px-2",children:[o.jsx("button",{className:M("w-[18px] h-[18px] rounded-full border flex items-center justify-center","shadow-[0_1px_3px_rgba(0,0,0,0.2)] transition-all duration-200 p-0 outline-none shrink-0",w?"bg-node-policy border-white/30 text-white cursor-pointer hover:scale-[1.15] hover:bg-[#a855f7] hover:border-white/50":"bg-node-policy/40 border-white/20 text-white/50 cursor-default"),onClick:L,disabled:!w,title:w?c?`Select ${t.label}`:`Trigger from ${t.label}`:"Connect this outcome to enable",children:o.jsx(ve,{className:"w-2.5 h-2.5"})}),o.jsx(G,{value:t.label,onChange:I,placeholder:"Outcome",autoSize:!0,className:"text-white [.light_&]:text-postit-text"})]})]})}),wo=["right"];function vo(s){switch(s){case"top":return"top-[-28px] left-1/2 -translate-x-1/2 hover:-translate-x-1/2";case"right":return"right-[-28px] top-1/2 -translate-y-1/2 hover:-translate-y-1/2";case"bottom":return"bottom-[-28px] left-1/2 -translate-x-1/2 hover:-translate-x-1/2";case"left":return"left-[-28px] top-1/2 -translate-y-1/2 hover:-translate-y-1/2"}}function _o(s){return M("absolute rounded-full border-2 border-border","cursor-pointer flex items-center justify-center text-sm font-bold","pointer-events-auto p-0 transition-all duration-150 z-[5]","shadow-[0_2px_4px_rgba(0,0,0,0.3)]","focus:outline-none focus-visible:outline-2 focus-visible:outline-text-primary focus-visible:outline-offset-2","hover:scale-[1.2] hover:shadow-[0_3px_8px_rgba(0,0,0,0.4)] active:scale-110","dark:bg-[#e0e0e8] dark:border-[#d0d0d8] dark:text-[#1e1e3a]","dark:hover:bg-[#5a5a7a] dark:hover:border-[#f0f0f8] dark:hover:text-[#f0f0f8]","bg-[#6a6a8a] border-[#7a7a9a] text-white shadow-[0_2px_4px_rgba(0,0,0,0.15)]","hover:bg-[#5a5a7a] hover:border-white hover:text-white",s?"w-4 h-4":"w-5 h-5")}function No({validTypes:s,isCompact:e=!1,onCreateNode:t,renderMenu:r,directions:l=wo}){const[i,a]=d.useState(!1),[n,u]=d.useState(null),[f,p]=d.useState(null),y=d.useRef({top:null,right:null,bottom:null,left:null}),m=d.useCallback((c,b)=>{if(b.stopPropagation(),s.length===1){t(s[0],c);return}const h=y.current[c];if(!h)return;const w=h.getBoundingClientRect();p({x:w.x+w.width/2,y:w.y+w.height/2}),u(c),a(!0)},[s,t]),E=d.useCallback(c=>{n&&(t(c,n),a(!1),u(null))},[n,t]),g=d.useCallback(()=>{a(!1),u(null)},[]);if(s.length===0)return null;const x=_o(e);return o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",children:l.map(c=>o.jsx("button",{ref:b=>{y.current[c]=b},className:M(x,vo(c),"nodrag nopan"),onClick:b=>m(c,b),"aria-label":`Create node ${c==="top"?"above":c==="bottom"?"below":`to the ${c}`}`,title:"Add connected node",children:o.jsx(yt,{className:"w-3 h-3"})},c))}),i&&f&&n&&r({validTypes:s,anchorPosition:f,direction:n,onSelect:E,onClose:g})]})}const ko=d.memo(No),To=d.memo(function({instanceId:e,nodeType:t,isOutcome:r=!1,isCompact:l=!1}){const{getValidTargetTypes:i,createConnectedNode:a}=po(),n=i(t,r),u=d.useCallback((p,y)=>{a(e,p,y)},[e,a]),f=d.useCallback(p=>o.jsx(yo,{...p}),[]);return o.jsx(ko,{validTypes:n,isCompact:l,onCreateNode:u,renderMenu:f})}),Io=s=>s.nodes.filter(e=>e.selected).length+s.edges.filter(e=>e.selected).length;function fn({id:s,source:e,sourceX:t,sourceY:r,targetX:l,targetY:i,sourcePosition:a,targetPosition:n,selected:u,markerEnd:f,markerStart:p,data:y,simulationState:m,isRunning:E,start:g,triggerNode:x,selectTransition:c,getSourceDefinitionId:b}){const h=y,w=(h==null?void 0:h.state)||"idle",T=(h==null?void 0:h.progress)||0,A=(h==null?void 0:h.labelOffset)??.5,j=h==null?void 0:h.transitionId,L=(h==null?void 0:h.isNonStandard)||!1,I=h==null?void 0:h.sourceKind,C=h==null?void 0:h.targetKind,{setEdges:B}=Ee(),{showTooltip:H,hideTooltip:V,setHoveredWarningEdgeId:X}=De(),W=je(Io),O=d.useRef(null),[S,Y]=d.useState({x:0,y:0}),[D,re]=d.useState({x:0,y:0}),[Q,me]=d.useState(0),F=d.useRef(void 0),ge=d.useCallback((z,xe)=>{B(ae=>ae.map(te=>te.id===z?{...te,data:{...te.data,labelOffset:xe}}:te))},[B]),{isDragging:pe,hasDraggedRef:$,handleDragStart:he}=Ft({pathRef:O,edgeId:s,onOffsetChange:ge}),U=b(e),N=(U?m==null?void 0:m.nodeStates.get(U):void 0)==="waiting_for_action",P=d.useMemo(()=>({isRunning:E,start:g,triggerNode:x,selectTransition:c}),[E,g,x,c]),R=d.useMemo(()=>({isSourceWaiting:N}),[N]),{execute:Z}=ro(P,R),ee=Oe(t,r,l,i,a,n);d.useLayoutEffect(()=>{if(O.current){const z=O.current.getTotalLength();me(z)}},[ee]),d.useLayoutEffect(()=>{if(O.current&&Q>0){const z=O.current.getPointAtLength(Q*A);re({x:z.x,y:z.y})}},[Q,A]),d.useEffect(()=>{if(w!=="animating"||!O.current)return;const z=O.current,xe=z.getTotalLength(),ae=()=>{const te=(h==null?void 0:h.progress)||0,ke=z.getPointAtLength(xe*te);Y({x:ke.x,y:ke.y}),te<1&&(F.current=requestAnimationFrame(ae))};return F.current=requestAnimationFrame(ae),()=>{F.current&&cancelAnimationFrame(F.current)}},[w,h==null?void 0:h.progress]);const We=d.useCallback(z=>{z.stopPropagation(),z.preventDefault(),!$.current&&(!j||!U||Z(U,j))},[j,U,Z,$]),$e=Q*(1-T),_e=!!j,Ne=_e;return d.useEffect(()=>{if(u&&W===1&&L&&I&&C)return X(s),H({edgeId:s,sourceKind:I,targetKind:C,targetPosition:{x:l,y:i}}),()=>{X(null),V()}},[u,W,L,I,C,s,l,i,H,V,X]),o.jsxs(o.Fragment,{children:[!L&&o.jsx("path",{d:ee,fill:"none",stroke:w==="executed"?"#22c55e":"oklch(55% 0.18 303)",strokeWidth:16,strokeLinecap:"butt",style:{opacity:.15,pointerEvents:"none"}}),o.jsx(Le,{id:s,path:ee,markerEnd:f,markerStart:p,className:[w==="idle"&&!u?"animate-dash-flow":"",L?"non-standard":""].filter(Boolean).join(" ")||void 0,style:{strokeDasharray:w==="idle"&&!u?"5 5":"none",opacity:w==="executed"?0:1}}),o.jsx("path",{ref:O,d:ee,fill:"none",stroke:"transparent",strokeWidth:0}),(w==="animating"||w==="executed"||w==="waiting_at_label")&&Q>0&&o.jsx("path",{d:ee,fill:"none",stroke:"#22c55e",strokeWidth:2,style:{strokeDasharray:w!=="executed"?Q:"none",strokeDashoffset:w!=="executed"?$e:0}}),w==="animating"&&o.jsxs(o.Fragment,{children:[o.jsx("circle",{cx:S.x,cy:S.y,r:10,fill:"rgba(34, 197, 94, 0.3)"}),o.jsx("circle",{cx:S.x,cy:S.y,r:6,fill:"#22c55e",style:{filter:"drop-shadow(0 0 4px rgba(34, 197, 94, 0.6))"}})]}),w==="waiting_at_label"&&o.jsxs(o.Fragment,{children:[o.jsx("circle",{cx:D.x,cy:D.y,r:10,fill:"rgba(34, 197, 94, 0.3)",className:"animate-ball-fade-out"}),o.jsx("circle",{cx:D.x,cy:D.y,r:6,fill:"#22c55e",className:"animate-ball-fade-out",style:{filter:"drop-shadow(0 0 4px rgba(34, 197, 94, 0.6))"}})]}),u&&o.jsxs(o.Fragment,{children:[o.jsx(Ce,{x:t,y:r}),o.jsx(Ce,{x:l,y:i})]}),o.jsx(Ye,{children:o.jsx("div",{className:M("absolute cursor-grab select-none z-[1000] nodrag nopan",pe&&"cursor-grabbing",N&&"[&_.play-btn]:animate-button-pulse"),style:{position:"absolute",transform:`translate(-50%, -50%) translate(${D.x}px, ${D.y}px)`,pointerEvents:"all"},onMouseDown:he,children:o.jsx("button",{className:M("play-btn w-[18px] h-[18px] rounded-full flex items-center justify-center p-0 outline-none shrink-0","shadow-[0_1px_3px_rgba(0,0,0,0.2)] transition-all duration-200",Ne?"bg-[#3b82f6] border border-white/30 text-white cursor-pointer hover:scale-[1.15] hover:bg-[#60a5fa] hover:border-white/50":"bg-[#3b82f6]/40 border border-white/20 text-white/50 cursor-default"),onClick:We,disabled:!Ne,title:_e?N?"Select this path":"Trigger command":"No transition connected",children:o.jsx(ve,{className:"w-2.5 h-2.5"})})})})]})}function Ce({x:s,y:e}){return o.jsx("circle",{cx:s,cy:e,r:6,fill:"oklch(40% 0.18 303)",stroke:"#fff",strokeWidth:2,style:{cursor:"grab",filter:"drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3))"}})}const Ao=s=>s.nodes.filter(e=>e.selected).length+s.edges.filter(e=>e.selected).length;function mn({id:s,sourceX:e,sourceY:t,targetX:r,targetY:l,sourcePosition:i,targetPosition:a,selected:n,markerEnd:u,markerStart:f,data:p}){const{theme:y}=ht(),{showTooltip:m,hideTooltip:E,setHoveredWarningEdgeId:g}=De(),x=je(Ao),c=p,b=(c==null?void 0:c.state)||"idle",h=(c==null?void 0:c.progress)||0,w=(c==null?void 0:c.isNonStandard)||!1,T=c==null?void 0:c.sourceKind,A=c==null?void 0:c.targetKind,j=d.useRef(null),[L,I]=d.useState({x:0,y:0}),[C,B]=d.useState(0),H=d.useRef(void 0),V=Oe(e,t,r,l,i,a);d.useLayoutEffect(()=>{if(j.current){const W=j.current.getTotalLength();B(W)}},[V]),d.useEffect(()=>{if(b!=="animating"||!j.current)return;const W=j.current,O=W.getTotalLength(),S=()=>{const Y=(c==null?void 0:c.progress)||0,D=W.getPointAtLength(O*Y);I({x:D.x,y:D.y}),Y<1&&(H.current=requestAnimationFrame(S))};return H.current=requestAnimationFrame(S),()=>{H.current&&cancelAnimationFrame(H.current)}},[b,c==null?void 0:c.progress]);const X=C*(1-h);return d.useEffect(()=>{if(n&&x===1&&w&&T&&A)return g(s),m({edgeId:s,sourceKind:T,targetKind:A,targetPosition:{x:r,y:l}}),()=>{g(null),E()}},[n,x,w,T,A,s,r,l,m,E,g]),o.jsxs(o.Fragment,{children:[!w&&o.jsx("path",{d:V,fill:"none",stroke:b==="executed"?"#22c55e":"oklch(55% 0.18 303)",strokeWidth:16,strokeLinecap:"butt",style:{opacity:.15,pointerEvents:"none"}}),o.jsx(Le,{id:s,path:V,markerEnd:u,markerStart:f,className:[b==="idle"&&!n?"animate-dash-flow":"",w?"non-standard":""].filter(Boolean).join(" ")||void 0,style:{strokeDasharray:b==="idle"&&!n?"5 5":"none",opacity:b==="executed"?0:1}}),o.jsx("path",{ref:j,d:V,fill:"none",stroke:"transparent",strokeWidth:0}),(b==="animating"||b==="executed")&&C>0&&o.jsx("path",{d:V,fill:"none",stroke:"#22c55e",strokeWidth:2,style:{strokeDasharray:b==="animating"?C:"none",strokeDashoffset:b==="animating"?X:0}}),b==="animating"&&o.jsxs(o.Fragment,{children:[o.jsx("circle",{cx:L.x,cy:L.y,r:10,fill:"rgba(34, 197, 94, 0.3)"}),o.jsx("circle",{cx:L.x,cy:L.y,r:6,fill:"#22c55e",style:{filter:"drop-shadow(0 0 4px rgba(34, 197, 94, 0.6))"}})]}),n&&o.jsxs(o.Fragment,{children:[o.jsx(Me,{x:e,y:t,isLight:y==="light"}),o.jsx(Me,{x:r,y:l,isLight:y==="light"})]})]})}function Me({x:s,y:e,isLight:t}){const r=t?"#ffffff":"#1e1e3f",l=t?"oklch(45% 0.18 303)":"oklch(70% 0.15 303)";return o.jsx("circle",{cx:s,cy:e,r:6,fill:r,stroke:l,strokeWidth:2,style:{cursor:"grab",filter:"drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3))"}})}const Co=()=>({activeTransitions:new Map,animationFrame:void 0,processedEvents:new Set,previousEventsLength:0,wasWaiting:new Map,animate:null}),Pe=1e3,Mo=500;function gn(s){const{setEdges:e,getEdges:t}=Ee(),r=d.useRef(Co()),l=d.useCallback((n,u,f)=>{e(p=>p.map(y=>{const m=y.data;return(m==null?void 0:m.transitionId)===n?{...y,data:{...y.data,state:u,progress:f}}:y}))},[e]),i=d.useCallback(()=>{const n=r.current,u=Date.now();let f=!1;n.activeTransitions.forEach((p,y)=>{const m=u-p.startTime,E=p.targetProgress-p.startProgress,g=Math.min(m/p.duration,1),x=p.startProgress+g*E;g<1?(f=!0,l(y,"animating",x)):(p.targetProgress<1?(l(y,"waiting_at_label",p.targetProgress),n.wasWaiting.set(y,p.targetProgress)):l(y,"executed",1),n.activeTransitions.delete(y))}),f&&n.animate?n.animationFrame=requestAnimationFrame(n.animate):n.animationFrame=void 0},[l]);d.useEffect(()=>{r.current.animate=i},[i]);const a=d.useCallback(()=>{const n=r.current;n.animationFrame&&(cancelAnimationFrame(n.animationFrame),n.animationFrame=void 0),n.activeTransitions.clear(),n.processedEvents.clear(),n.wasWaiting.clear(),e(u=>u.map(f=>({...f,data:{...f.data,state:"idle",progress:0}})))},[e]);d.useEffect(()=>{const n=r.current;s.length===0&&n.previousEventsLength>0&&a(),n.previousEventsLength=s.length;let u=!1;s.forEach(f=>{var p,y,m;if(!n.processedEvents.has(f.id)){if(n.processedEvents.add(f.id),f.type==="transition:start"){const g=(p=f.data.transition)==null?void 0:p.id;if(!g)return;const x=n.wasWaiting.get(g),c=x!==void 0?x:0,b=x!==void 0?Pe*(1-x):Pe;n.wasWaiting.delete(g),n.activeTransitions.set(g,{transitionId:g,startTime:Date.now(),duration:b,startProgress:c,targetProgress:1}),l(g,"animating",c),u=!0}if(f.type==="transition:reset"){const g=(y=f.data.transition)==null?void 0:y.id;if(!g)return;n.activeTransitions.delete(g),l(g,"idle",0)}if(f.type==="simulation:reset"&&a(),f.type==="node:waiting"){const E=f.data;if(((m=E.node)==null?void 0:m.kind)!=="command")return;const g=E.availableTransitions||[],x=t();for(const c of g){const b=c.id,h=x.find(A=>{const j=A.data;return(j==null?void 0:j.transitionId)===b});if(!h)continue;const w=h.data,T=(w==null?void 0:w.labelOffset)??.5;n.activeTransitions.set(b,{transitionId:b,startTime:Date.now(),duration:Mo,startProgress:0,targetProgress:T}),l(b,"animating",0),u=!0}}}}),u&&!n.animationFrame&&(n.animationFrame=requestAnimationFrame(i))},[s,i,l,a,t]),d.useEffect(()=>{const n=r.current;return()=>{n.animationFrame&&cancelAnimationFrame(n.animationFrame)}},[])}export{tn as A,ko as B,Te as C,jt as D,qo as E,Do as F,Vo as G,en as H,nn as I,ro as J,Eo as K,G as L,to as M,on as N,un as O,so as P,To as Q,Fo as R,zo as S,At as T,Wo as U,$t as W,Se as Z,Xo as a,Dt as b,Uo as c,$o as d,rn as e,ln as f,Bo as g,sn as h,Ko as i,Yo as j,Qo as k,Jo as l,Zo as m,fn as n,mn as o,De as p,gn as q,Ho as r,cn as s,an as t,Go as u,dn as v,Lt as w,Ot as x,St as y,yo as z};
