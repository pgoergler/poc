import{j as e,b as c}from"./react-flow-BRmdaK4b.js";import{c as P,a as k,r as G,s as $,t as Y,v as M,w as z,T as U,P as I,A as V,x as X,y as B,z as H,B as J,E as K,F as q,G as Q,I as Z,J as ee,d as te}from"./Toast-CVFMnbvX.js";import{D as se,F,u as re}from"./ToastContext-CftmO3Oa.js";import{u as ne}from"./index-DUY2w7u4.js";import"./ts-morph-SaAo0aQ4.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],ae=P("ellipsis-vertical",oe),T={event:"#f97316",command:"#3b82f6",policy:"#8b5cf6",trigger:"#22c55e",externalSystem:"#6b7280",externalEvent:"#ec4899",hotspot:"#ef4444",note:"#94a3b8",actor:"#facc15"};function le({workflow:t}){const{instances:s,definitions:x}=t.document.workflow,n=c.useMemo(()=>{if(!s||s.length===0)return[];const f=new Map;for(const b of x)f.set(b.id,b.kind);return s.map(b=>({x:b.position.x,y:b.position.y,kind:f.get(b.definitionId)||"event"}))},[s,x]);if(n.length===0)return e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 text-text-dim",children:[e.jsx(F,{className:"w-8 h-8 opacity-50"}),e.jsx("span",{className:"text-xs",children:"Vide"})]})});const i=Math.min(...n.map(f=>f.x)),r=Math.max(...n.map(f=>f.x)),d=Math.min(...n.map(f=>f.y)),l=Math.max(...n.map(f=>f.y)),h=r-i||1,j=l-d||1,y=200,g=120,N=20,u=6,a=(y-N*2)/h,o=(g-N*2)/j,m=Math.min(a,o,1),w=(y-h*m)/2,S=(g-j*m)/2;return e.jsxs("svg",{viewBox:`0 0 ${y} ${g}`,className:"w-full h-full",preserveAspectRatio:"xMidYMid meet",children:[e.jsx("defs",{children:e.jsx("pattern",{id:"grid",width:"20",height:"20",patternUnits:"userSpaceOnUse",children:e.jsx("path",{d:"M 20 0 L 0 0 0 20",fill:"none",stroke:"currentColor",strokeOpacity:"0.1",strokeWidth:"0.5"})})}),e.jsx("rect",{width:"100%",height:"100%",fill:"url(#grid)"}),n.map((f,b)=>{const p=(f.x-i)*m+w,v=(f.y-d)*m+S,R=T[f.kind]||T.event;return e.jsx("circle",{cx:p,cy:v,r:u,fill:R,opacity:.9},b)})]})}const D=new Intl.RelativeTimeFormat("fr",{numeric:"auto"});function ce(t){const s=new Date(t),n=new Date().getTime()-s.getTime(),i=Math.floor(n/1e3),r=Math.floor(i/60),d=Math.floor(r/60),l=Math.floor(d/24);if(i<60)return D.format(0,"second");if(r<60)return D.format(-r,"minute");if(d<24)return D.format(-d,"hour");if(l<7)return D.format(-l,"day");if(l<30){const h=Math.floor(l/7);return D.format(-h,"week")}if(l<365){const h=Math.floor(l/30.44);return D.format(-h,"month")}return s.toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}function ie({workflow:t,isDeleting:s=!1,onOpen:x,onDelete:n,onExport:i}){const r=t.document.metadata.name||"Sans nom",d=ce(t.updatedAt),l=t.document.metadata.targetPlugin!=null,h=()=>{s||x(t)},j=g=>{g.stopPropagation(),i(t)},y=g=>{g.stopPropagation(),!s&&n(t)};return e.jsxs("div",{className:k("bg-surface border border-border rounded-xl overflow-hidden","transition-all duration-200 cursor-pointer","hover:border-border-hover hover:bg-surface-elevated",s&&"opacity-50 pointer-events-none"),onClick:h,children:[e.jsx("div",{className:k("bg-bg-tertiary h-[140px]","border-b border-border"),children:e.jsx(le,{workflow:t})}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsx("h3",{className:"text-[15px] font-semibold text-text-primary truncate flex-1",children:r}),e.jsxs(G,{children:[e.jsx($,{asChild:!0,children:e.jsx("button",{onClick:g=>g.stopPropagation(),className:k("w-8 h-8 flex items-center justify-center rounded-md shrink-0","bg-transparent border border-border text-text-muted","transition-all duration-200","hover:bg-surface-hover hover:border-border-hover hover:text-text-primary"),title:"Actions",children:e.jsx(ae,{className:"w-4 h-4"})})}),e.jsxs(Y,{align:"end",children:[e.jsxs(M,{onSelect:j,children:[e.jsx(se,{className:"w-4 h-4"}),"Exporter"]}),e.jsx(z,{}),e.jsxs(M,{onSelect:y,className:"text-danger focus:text-danger focus:bg-danger-bg",children:[e.jsx(U,{className:"w-4 h-4"}),"Supprimer"]})]})]})]}),e.jsx("p",{className:"text-xs text-text-muted mb-3",children:d}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:k("inline-flex items-center gap-1 px-2 py-1 rounded-md text-[11px] font-medium",l?"bg-success/20 text-success":"bg-text-muted/20 text-text-muted"),children:l?"Configure":"Brouillon"}),e.jsx("button",{className:k("px-3 py-1.5 rounded-md text-sm font-medium","bg-accent text-white","transition-colors duration-200","hover:bg-accent-hover"),children:"Ouvrir"})]})]})]})}function C(){return e.jsxs("div",{className:"bg-surface border border-border rounded-xl overflow-hidden",children:[e.jsx("div",{className:"bg-bg-tertiary h-[140px] animate-pulse"}),e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"h-5 w-3/5 bg-bg-tertiary rounded animate-pulse mb-2"}),e.jsx("div",{className:"h-4 w-2/5 bg-bg-tertiary rounded animate-pulse mb-3"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"h-6 w-16 bg-bg-tertiary rounded animate-pulse"}),e.jsx("div",{className:"h-8 w-16 bg-bg-tertiary rounded animate-pulse"})]})]})]})}function de({onCreateWorkflow:t}){return e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 px-10 text-center",children:[e.jsx("div",{className:k("w-20 h-20 rounded-full mb-6","bg-accent-light flex items-center justify-center"),children:e.jsx(F,{className:"w-10 h-10 text-accent"})}),e.jsx("h2",{className:"text-xl font-semibold text-text-primary mb-2",children:"Aucun workflow"}),e.jsx("p",{className:"text-sm text-text-muted mb-6 max-w-md",children:"Vous n'avez pas encore de workflow. Commencez par en creer un pour modeliser vos processus metier."}),e.jsxs("button",{onClick:t,className:k("inline-flex items-center gap-2 px-5 py-2.5 rounded-md","bg-accent text-white font-medium","transition-colors duration-200","hover:bg-accent-hover"),children:[e.jsx(I,{className:"w-5 h-5"}),"Creer mon premier workflow"]})]})}function ue({workflows:t,isLoading:s,deletingWorkflowId:x,onOpenWorkflow:n,onDeleteWorkflow:i,onExportWorkflow:r,onCreateWorkflow:d}){return s&&t.length===0?e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5",children:[e.jsx(C,{}),e.jsx(C,{}),e.jsx(C,{}),e.jsx(C,{})]}):t.length===0?e.jsx(de,{onCreateWorkflow:d}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5",children:t.map(l=>e.jsx(ie,{workflow:l,isDeleting:x===l.id,onOpen:n,onDelete:i,onExport:r},l.id))})}function me({workflow:t,open:s,onOpenChange:x,onConfirm:n}){const[i,r]=c.useState(!1),d=async()=>{if(t){r(!0);try{await n(t),x(!1)}finally{r(!1)}}},l=(t==null?void 0:t.document.metadata.name)||"Sans nom";return e.jsx(V,{open:s,onOpenChange:x,children:e.jsxs(X,{children:[e.jsxs(B,{children:[e.jsx(H,{children:"Supprimer ce workflow ?"}),e.jsxs(J,{children:["Vous etes sur le point de supprimer ",e.jsxs("strong",{className:"text-text-primary",children:['"',l,'"']}),". Cette action est irreversible et toutes les donnees associees seront perdues."]})]}),e.jsxs(K,{children:[e.jsx(q,{disabled:i,children:"Annuler"}),e.jsx(Q,{onClick:d,disabled:i,children:i?"Suppression...":"Supprimer"})]})]})})}const _="arko:workflows";function fe(){return`wf_${Z()}`}function E(){try{const t=localStorage.getItem(_);return t?JSON.parse(t):[]}catch{return[]}}function W(t){try{localStorage.setItem(_,JSON.stringify(t))}catch(s){console.error("Failed to save workflows to localStorage:",s)}}function xe(){const[t,s]=c.useState([]),[x,n]=c.useState(!1),[i,r]=c.useState(null),d=c.useRef(!1),l=c.useCallback(()=>{r(null)},[]),h=c.useCallback(async()=>{n(!0),r(null);try{await new Promise(a=>setTimeout(a,50));const u=E();u.sort((a,o)=>new Date(o.updatedAt).getTime()-new Date(a.updatedAt).getTime()),s(u)}catch(u){r({code:"STORAGE_ERROR",message:u instanceof Error?u.message:"Failed to fetch workflows"})}finally{n(!1)}},[]);c.useEffect(()=>{d.current||(d.current=!0,h())},[h]);const j=c.useCallback(async u=>{n(!0),r(null);try{const a=new Date().toISOString(),o={id:fe(),document:u,createdAt:a,updatedAt:a},m=E(),w=[o,...m];return W(w),s(w),o}catch(a){return r({code:"STORAGE_ERROR",message:a instanceof Error?a.message:"Failed to create workflow"}),null}finally{n(!1)}},[]),y=c.useCallback(async(u,a)=>{n(!0),r(null);try{const o=E(),m=o.findIndex(S=>S.id===u);if(m===-1)return r({code:"NOT_FOUND",message:"Workflow not found"}),null;const w={...o[m],document:a,updatedAt:new Date().toISOString()};return o[m]=w,W(o),s(o),w}catch(o){return r({code:"STORAGE_ERROR",message:o instanceof Error?o.message:"Failed to update workflow"}),null}finally{n(!1)}},[]),g=c.useCallback(async u=>{n(!0),r(null);try{const o=E().filter(m=>m.id!==u);return W(o),s(o),!0}catch(a){return r({code:"STORAGE_ERROR",message:a instanceof Error?a.message:"Failed to delete workflow"}),!1}finally{n(!1)}},[]),N=c.useCallback(async u=>{r(null);try{const o=E().find(m=>m.id===u);return o||(r({code:"NOT_FOUND",message:"Workflow not found"}),null)}catch(a){return r({code:"STORAGE_ERROR",message:a instanceof Error?a.message:"Failed to get workflow"}),null}},[]);return{workflows:t,total:t.length,isLoading:x,error:i,fetchWorkflows:h,createWorkflow:j,updateWorkflow:y,deleteWorkflow:g,getWorkflow:N,clearError:l}}function he(t){const s=new Date().toISOString();return{version:te,metadata:{name:t,createdAt:s,updatedAt:s},workflow:{definitions:[],transitions:[],instances:[],edgeMappings:[],outcomes:[],outcomeEdgeMappings:[]}}}const ge=new ee;function ke(){const t=ne(),{showSuccess:s,showError:x}=re(),{workflows:n,total:i,isLoading:r,error:d,fetchWorkflows:l,createWorkflow:h,deleteWorkflow:j}=xe(),[y,g]=c.useState(null),[N,u]=c.useState(!1),[a,o]=c.useState(null);c.useEffect(()=>{l()},[l]);const m=c.useCallback(p=>{t(`/conception/${p.id}`)},[t]),w=c.useCallback(async()=>{const p=he("Nouveau workflow"),v=await h(p);v&&t(`/conception/${v.id}`)},[h,t]),S=c.useCallback(p=>{g(p),u(!0)},[]),f=c.useCallback(p=>{var O;const v=p.document.metadata.name||"workflow",L=`${v.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"")}.arko.json`,A=ge.exportToFile(p.document,L);A.success?s("Export réussi",`${v} exporté.`):x("Erreur d'export",((O=A.error)==null?void 0:O.message)||"Erreur inconnue")},[s,x]),b=c.useCallback(async p=>{o(p.id);try{await j(p.id)}finally{o(null)}},[j]);return e.jsxs("div",{className:"min-h-screen bg-bg-primary",children:[e.jsx("header",{className:"border-b border-border bg-bg-secondary",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-6 py-5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-2xl font-bold text-accent",children:"Arko"}),e.jsx("h1",{className:"text-xl font-semibold text-text-primary",children:"Mes Workflows"})]}),e.jsxs("button",{onClick:w,className:k("inline-flex items-center gap-2 px-5 py-2.5 rounded-md","bg-accent text-white font-medium","transition-colors duration-200","hover:bg-accent-hover"),children:[e.jsx(I,{className:"w-5 h-5"}),"Nouveau workflow"]})]})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-6 py-8",children:[d&&e.jsx("div",{className:"mb-6 p-4 bg-danger-bg border border-danger/30 rounded-lg text-danger text-sm",children:d.message}),n.length>0&&e.jsx("div",{className:"mb-6 flex items-center justify-between",children:e.jsxs("span",{className:"text-sm text-text-muted",children:[i," workflow",i>1?"s":""]})}),e.jsx(ue,{workflows:n,isLoading:r,deletingWorkflowId:a,onOpenWorkflow:m,onDeleteWorkflow:S,onExportWorkflow:f,onCreateWorkflow:w})]}),e.jsx(me,{workflow:y,open:N,onOpenChange:u,onConfirm:b})]})}export{ke as default};
