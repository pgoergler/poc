import{j as e,b as i}from"./react-flow-JpbcPcxa.js";import{a as y,T as I,P as R,A as F,b as _,d as L,e as P,f as G,g as Y,h as U,i as $,u as V,C as X}from"./AlertDialog-CqlDNawf.js";import{F as O}from"./file-text-DQwcm1n5.js";import{u as z}from"./index-BFeJPTYW.js";import"./ts-morph-SaAo0aQ4.js";const W={event:"#f97316",command:"#3b82f6",policy:"#8b5cf6",trigger:"#22c55e",externalSystem:"#6b7280",externalEvent:"#ec4899",hotspot:"#ef4444",note:"#94a3b8",actor:"#facc15"};function H({workflow:t}){const{instances:r,definitions:x}=t.document.workflow,n=i.useMemo(()=>{if(!r||r.length===0)return[];const m=new Map;for(const j of x)m.set(j.id,j.kind);return r.map(j=>({x:j.position.x,y:j.position.y,kind:m.get(j.definitionId)||"event"}))},[r,x]);if(n.length===0)return e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 text-text-dim",children:[e.jsx(O,{className:"w-8 h-8 opacity-50"}),e.jsx("span",{className:"text-xs",children:"Vide"})]})});const c=Math.min(...n.map(m=>m.x)),s=Math.max(...n.map(m=>m.x)),l=Math.min(...n.map(m=>m.y)),u=Math.max(...n.map(m=>m.y)),g=s-c||1,b=u-l||1,k=200,w=120,v=20,d=6,a=(k-v*2)/g,o=(w-v*2)/b,f=Math.min(a,o,1),p=(k-g*f)/2,h=(w-b*f)/2;return e.jsxs("svg",{viewBox:`0 0 ${k} ${w}`,className:"w-full h-full",preserveAspectRatio:"xMidYMid meet",children:[e.jsx("defs",{children:e.jsx("pattern",{id:"grid",width:"20",height:"20",patternUnits:"userSpaceOnUse",children:e.jsx("path",{d:"M 20 0 L 0 0 0 20",fill:"none",stroke:"currentColor",strokeOpacity:"0.1",strokeWidth:"0.5"})})}),e.jsx("rect",{width:"100%",height:"100%",fill:"url(#grid)"}),n.map((m,j)=>{const A=(m.x-c)*f+p,T=(m.y-l)*f+h,M=W[m.kind]||W.event;return e.jsx("circle",{cx:A,cy:T,r:d,fill:M,opacity:.9},j)})]})}const N=new Intl.RelativeTimeFormat("fr",{numeric:"auto"});function B(t){const r=new Date(t),n=new Date().getTime()-r.getTime(),c=Math.floor(n/1e3),s=Math.floor(c/60),l=Math.floor(s/60),u=Math.floor(l/24);if(c<60)return N.format(0,"second");if(s<60)return N.format(-s,"minute");if(l<24)return N.format(-l,"hour");if(u<7)return N.format(-u,"day");if(u<30){const g=Math.floor(u/7);return N.format(-g,"week")}if(u<365){const g=Math.floor(u/30.44);return N.format(-g,"month")}return r.toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}function J({workflow:t,isDeleting:r=!1,onOpen:x,onDelete:n}){const c=t.document.metadata.name||"Sans nom",s=B(t.updatedAt),l=t.document.metadata.targetPlugin!=null,u=()=>{r||x(t)},g=b=>{b.stopPropagation(),!r&&n(t)};return e.jsxs("div",{className:y("bg-surface border border-border rounded-xl overflow-hidden","transition-all duration-200 cursor-pointer","hover:border-border-hover hover:bg-surface-elevated",r&&"opacity-50 pointer-events-none"),onClick:u,children:[e.jsx("div",{className:y("bg-bg-tertiary h-[140px]","border-b border-border"),children:e.jsx(H,{workflow:t})}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsx("h3",{className:"text-[15px] font-semibold text-text-primary truncate flex-1",children:c}),e.jsx("button",{onClick:g,className:y("w-8 h-8 flex items-center justify-center rounded-md shrink-0","bg-transparent border border-border text-text-muted","transition-all duration-200","hover:bg-danger-bg hover:border-danger/30 hover:text-danger"),title:"Supprimer",children:e.jsx(I,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-xs text-text-muted mb-3",children:s}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:y("inline-flex items-center gap-1 px-2 py-1 rounded-md text-[11px] font-medium",l?"bg-success/20 text-success":"bg-text-muted/20 text-text-muted"),children:l?"Configure":"Brouillon"}),e.jsx("button",{className:y("px-3 py-1.5 rounded-md text-sm font-medium","bg-accent text-white","transition-colors duration-200","hover:bg-accent-hover"),children:"Ouvrir"})]})]})]})}function D(){return e.jsxs("div",{className:"bg-surface border border-border rounded-xl overflow-hidden",children:[e.jsx("div",{className:"bg-bg-tertiary h-[140px] animate-pulse"}),e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"h-5 w-3/5 bg-bg-tertiary rounded animate-pulse mb-2"}),e.jsx("div",{className:"h-4 w-2/5 bg-bg-tertiary rounded animate-pulse mb-3"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"h-6 w-16 bg-bg-tertiary rounded animate-pulse"}),e.jsx("div",{className:"h-8 w-16 bg-bg-tertiary rounded animate-pulse"})]})]})]})}function K({onCreateWorkflow:t}){return e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 px-10 text-center",children:[e.jsx("div",{className:y("w-20 h-20 rounded-full mb-6","bg-accent-light flex items-center justify-center"),children:e.jsx(O,{className:"w-10 h-10 text-accent"})}),e.jsx("h2",{className:"text-xl font-semibold text-text-primary mb-2",children:"Aucun workflow"}),e.jsx("p",{className:"text-sm text-text-muted mb-6 max-w-md",children:"Vous n'avez pas encore de workflow. Commencez par en creer un pour modeliser vos processus metier."}),e.jsxs("button",{onClick:t,className:y("inline-flex items-center gap-2 px-5 py-2.5 rounded-md","bg-accent text-white font-medium","transition-colors duration-200","hover:bg-accent-hover"),children:[e.jsx(R,{className:"w-5 h-5"}),"Creer mon premier workflow"]})]})}function q({workflows:t,isLoading:r,deletingWorkflowId:x,onOpenWorkflow:n,onDeleteWorkflow:c,onCreateWorkflow:s}){return r&&t.length===0?e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5",children:[e.jsx(D,{}),e.jsx(D,{}),e.jsx(D,{}),e.jsx(D,{})]}):t.length===0?e.jsx(K,{onCreateWorkflow:s}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5",children:t.map(l=>e.jsx(J,{workflow:l,isDeleting:x===l.id,onOpen:n,onDelete:c},l.id))})}function Q({workflow:t,open:r,onOpenChange:x,onConfirm:n}){const[c,s]=i.useState(!1),l=async()=>{if(t){s(!0);try{await n(t),x(!1)}finally{s(!1)}}},u=(t==null?void 0:t.document.metadata.name)||"Sans nom";return e.jsx(F,{open:r,onOpenChange:x,children:e.jsxs(_,{children:[e.jsxs(L,{children:[e.jsx(P,{children:"Supprimer ce workflow ?"}),e.jsxs(G,{children:["Vous etes sur le point de supprimer ",e.jsxs("strong",{className:"text-text-primary",children:['"',u,'"']}),". Cette action est irreversible et toutes les donnees associees seront perdues."]})]}),e.jsxs(Y,{children:[e.jsx(U,{disabled:c,children:"Annuler"}),e.jsx($,{onClick:l,disabled:c,children:c?"Suppression...":"Supprimer"})]})]})})}const E="arko:workflows";function Z(){return`wf_${V()}`}function S(){try{const t=localStorage.getItem(E);return t?JSON.parse(t):[]}catch{return[]}}function C(t){try{localStorage.setItem(E,JSON.stringify(t))}catch(r){console.error("Failed to save workflows to localStorage:",r)}}function ee(){const[t,r]=i.useState([]),[x,n]=i.useState(!1),[c,s]=i.useState(null),l=i.useRef(!1),u=i.useCallback(()=>{s(null)},[]),g=i.useCallback(async()=>{n(!0),s(null);try{await new Promise(a=>setTimeout(a,50));const d=S();d.sort((a,o)=>new Date(o.updatedAt).getTime()-new Date(a.updatedAt).getTime()),r(d)}catch(d){s({code:"STORAGE_ERROR",message:d instanceof Error?d.message:"Failed to fetch workflows"})}finally{n(!1)}},[]);i.useEffect(()=>{l.current||(l.current=!0,g())},[g]);const b=i.useCallback(async d=>{n(!0),s(null);try{const a=new Date().toISOString(),o={id:Z(),document:d,createdAt:a,updatedAt:a},f=S(),p=[o,...f];return C(p),r(p),o}catch(a){return s({code:"STORAGE_ERROR",message:a instanceof Error?a.message:"Failed to create workflow"}),null}finally{n(!1)}},[]),k=i.useCallback(async(d,a)=>{n(!0),s(null);try{const o=S(),f=o.findIndex(h=>h.id===d);if(f===-1)return s({code:"NOT_FOUND",message:"Workflow not found"}),null;const p={...o[f],document:a,updatedAt:new Date().toISOString()};return o[f]=p,C(o),r(o),p}catch(o){return s({code:"STORAGE_ERROR",message:o instanceof Error?o.message:"Failed to update workflow"}),null}finally{n(!1)}},[]),w=i.useCallback(async d=>{n(!0),s(null);try{const o=S().filter(f=>f.id!==d);return C(o),r(o),!0}catch(a){return s({code:"STORAGE_ERROR",message:a instanceof Error?a.message:"Failed to delete workflow"}),!1}finally{n(!1)}},[]),v=i.useCallback(async d=>{s(null);try{const o=S().find(f=>f.id===d);return o||(s({code:"NOT_FOUND",message:"Workflow not found"}),null)}catch(a){return s({code:"STORAGE_ERROR",message:a instanceof Error?a.message:"Failed to get workflow"}),null}},[]);return{workflows:t,total:t.length,isLoading:x,error:c,fetchWorkflows:g,createWorkflow:b,updateWorkflow:k,deleteWorkflow:w,getWorkflow:v,clearError:u}}function te(t){const r=new Date().toISOString();return{version:X,metadata:{name:t,createdAt:r,updatedAt:r},workflow:{definitions:[],transitions:[],instances:[],edgeMappings:[],outcomes:[],outcomeEdgeMappings:[]}}}function le(){const t=z(),{workflows:r,total:x,isLoading:n,error:c,fetchWorkflows:s,createWorkflow:l,deleteWorkflow:u}=ee(),[g,b]=i.useState(null),[k,w]=i.useState(!1),[v,d]=i.useState(null);i.useEffect(()=>{s()},[s]);const a=i.useCallback(h=>{t(`/conception/${h.id}`)},[t]),o=i.useCallback(async()=>{const h=te("Nouveau workflow"),m=await l(h);m&&t(`/conception/${m.id}`)},[l,t]),f=i.useCallback(h=>{b(h),w(!0)},[]),p=i.useCallback(async h=>{d(h.id);try{await u(h.id)}finally{d(null)}},[u]);return e.jsxs("div",{className:"min-h-screen bg-bg-primary",children:[e.jsx("header",{className:"border-b border-border bg-bg-secondary",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-6 py-5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-2xl font-bold text-accent",children:"Arko"}),e.jsx("h1",{className:"text-xl font-semibold text-text-primary",children:"Mes Workflows"})]}),e.jsxs("button",{onClick:o,className:y("inline-flex items-center gap-2 px-5 py-2.5 rounded-md","bg-accent text-white font-medium","transition-colors duration-200","hover:bg-accent-hover"),children:[e.jsx(R,{className:"w-5 h-5"}),"Nouveau workflow"]})]})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-6 py-8",children:[c&&e.jsx("div",{className:"mb-6 p-4 bg-danger-bg border border-danger/30 rounded-lg text-danger text-sm",children:c.message}),r.length>0&&e.jsx("div",{className:"mb-6 flex items-center justify-between",children:e.jsxs("span",{className:"text-sm text-text-muted",children:[x," workflow",x>1?"s":""]})}),e.jsx(q,{workflows:r,isLoading:n,deletingWorkflowId:v,onOpenWorkflow:a,onDeleteWorkflow:f,onCreateWorkflow:o})]}),e.jsx(Q,{workflow:g,open:k,onOpenChange:w,onConfirm:p})]})}export{le as default};
