var Xt=Object.defineProperty;var Bt=(n,e,t)=>e in n?Xt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var ee=(n,e,t)=>Bt(n,typeof e!="symbol"?e+"":e,t);import{c as re,I as De,u as xe,d as Se,J as Vt,A as Gt,x as Ht,y as Ut,z as qt,B as Yt,E as Kt,F as Qt,G as Jt,a as Y,T as Zt,P as en}from"./Toast-Bv7rl_JM.js";import{P as A,b as a,l as Ge,m as tn,h as at,k as it,u as ve,j as g,H as j,n as nn,o as on,c as sn,N as rn,d as an,p as ct,E as cn}from"./react-flow-ruwbRUGr.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ln=[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]],dn=re("clipboard-list",ln);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const un=[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]],He=re("cloud",un);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fn=[["path",{d:"M12 3q1 4 4 6.5t3 5.5a1 1 0 0 1-14 0 5 5 0 0 1 1-3 1 1 0 0 0 5 0c0-2-1.5-3-1.5-5q0-2 2.5-4",key:"1slcih"}]],fs=re("flame",fn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gn=[["path",{d:"M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401",key:"kfwtm"}]],gs=re("moon",gn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mn=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],Ve=re("play",mn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hn=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],ms=re("refresh-cw",hn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pn=[["path",{d:"M12 3v18",key:"108xh3"}],["path",{d:"m19 8 3 8a5 5 0 0 1-6 0zV7",key:"zcdpyk"}],["path",{d:"M3 7h1a17 17 0 0 0 8-2 17 17 0 0 0 8 2h1",key:"1yorad"}],["path",{d:"m5 8 3 8a5 5 0 0 1-6 0zV7",key:"eua70x"}],["path",{d:"M7 21h10",key:"1b0cd5"}]],hs=re("scale",pn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xn=[["path",{d:"M21 9a2.4 2.4 0 0 0-.706-1.706l-3.588-3.588A2.4 2.4 0 0 0 15 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z",key:"1dfntj"}],["path",{d:"M15 3v5a1 1 0 0 0 1 1h5",key:"6s6qgf"}]],ps=re("sticky-note",xn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bn=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],xs=re("sun",bn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const En=[["path",{d:"M12 19h8",key:"baeox8"}],["path",{d:"m4 17 6-6-6-6",key:"1yngyt"}]],yn=re("terminal",En);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wn=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],bs=re("user",wn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vn=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],lt=re("zap",vn);function le(n){switch(n){case"trigger":case"externalSystem":case"externalEvent":case"hotspot":case"note":case"actor":return"manual";case"event":case"policy":case"command":default:return"automatic"}}function Tn(n,e){if(n!=="command"&&n!=="policy")throw new Error(`calculateDynamicExecutionMode called with non-dynamic kind: ${n}`);return e<=1?"automatic":"manual"}function Nn(n){return n.executionMode==="manual"}function kn(n,e){return n.executionMode==="manual"?!1:e>0}class ye{constructor(){ee(this,"nodes",new Map);ee(this,"transitions",new Map);ee(this,"outgoingEdges",new Map);ee(this,"incomingEdges",new Map)}addNode(e){if(this.nodes.has(e.id))throw new Error(`Node with id ${e.id} already exists`);this.nodes.set(e.id,e),this.outgoingEdges.set(e.id,new Set),this.incomingEdges.set(e.id,new Set)}getNode(e){return this.nodes.get(e)}hasNode(e){return this.nodes.has(e)}getAllNodes(){return Array.from(this.nodes.values())}updateNode(e,t){const o=this.nodes.get(e);if(!o)return;const s={...o,...t};return this.nodes.set(e,s),s}removeNode(e){if(!this.nodes.has(e))return!1;const t=this.outgoingEdges.get(e)??new Set,o=this.incomingEdges.get(e)??new Set;for(const s of t)this.removeTransition(s);for(const s of o)this.removeTransition(s);return this.nodes.delete(e),this.outgoingEdges.delete(e),this.incomingEdges.delete(e),!0}addTransition(e){if(this.transitions.has(e.id))throw new Error(`Transition with id ${e.id} already exists`);if(!this.nodes.has(e.sourceDefId))throw new Error(`Source node ${e.sourceDefId} does not exist`);if(!this.nodes.has(e.targetDefId))throw new Error(`Target node ${e.targetDefId} does not exist`);this.transitions.set(e.id,e),this.outgoingEdges.get(e.sourceDefId).add(e.id),this.incomingEdges.get(e.targetDefId).add(e.id),this.recalculateExecutionMode(e.sourceDefId)}getTransition(e){return this.transitions.get(e)}getAllTransitions(){return Array.from(this.transitions.values())}removeTransition(e){var s,r;const t=this.transitions.get(e);if(!t)return!1;const o=t.sourceDefId;return(s=this.outgoingEdges.get(t.sourceDefId))==null||s.delete(e),(r=this.incomingEdges.get(t.targetDefId))==null||r.delete(e),this.transitions.delete(e),this.recalculateExecutionMode(o),!0}getOutgoingTransitions(e){const t=this.outgoingEdges.get(e);return t?Array.from(t).map(o=>this.transitions.get(o)).filter(Boolean):[]}getIncomingTransitions(e){const t=this.incomingEdges.get(e);return t?Array.from(t).map(o=>this.transitions.get(o)).filter(Boolean):[]}getSuccessors(e){return this.getOutgoingTransitions(e).map(t=>this.nodes.get(t.targetDefId)).filter(Boolean)}getPredecessors(e){return this.getIncomingTransitions(e).map(t=>this.nodes.get(t.sourceDefId)).filter(Boolean)}get nodeCount(){return this.nodes.size}get transitionCount(){return this.transitions.size}getEntryNodes(){return this.getAllNodes().filter(e=>{var t;return(((t=this.incomingEdges.get(e.id))==null?void 0:t.size)??0)===0})}getTerminalNodes(){return this.getAllNodes().filter(e=>{var t;return(((t=this.outgoingEdges.get(e.id))==null?void 0:t.size)??0)===0})}recalculateExecutionMode(e){var r;const t=this.nodes.get(e);if(!t||t.kind!=="command"&&t.kind!=="policy")return;const o=((r=this.outgoingEdges.get(e))==null?void 0:r.size)??0,s=Tn(t.kind,o);t.executionMode!==s&&this.nodes.set(e,{...t,executionMode:s})}requiresUserAction(e){const t=this.nodes.get(e);return t?Nn(t):!1}canAutoTraverse(e){var s;const t=this.nodes.get(e);if(!t)return!1;const o=((s=this.outgoingEdges.get(e))==null?void 0:s.size)??0;return kn(t,o)}getReachableNodes(e){const t=[],o=new Set,s=[];for(const r of this.getSuccessors(e))o.has(r.id)||(o.add(r.id),s.push(r.id),t.push(r));for(;s.length>0;){const r=s.shift();for(const c of this.getSuccessors(r))o.has(c.id)||(o.add(c.id),s.push(c.id),t.push(c))}return t}getReachableTransitions(e){const t=[],o=new Set;for(const s of this.getOutgoingTransitions(e))o.has(s.id)||(o.add(s.id),t.push(s));for(const s of this.getReachableNodes(e))for(const r of this.getOutgoingTransitions(s.id))o.has(r.id)||(o.add(r.id),t.push(r));return t}}function ae(n,e=""){return n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]+/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")||e}function je(n,e=""){return n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().replace(/\s+/g,".").replace(/[^a-z0-9.-]+/g,".").replace(/^[.-]+|[.-]+$/g,"").replace(/\.+/g,".").replace(/-+/g,"-")||e}function Es(n){return n.length<=13?n:`${n.slice(0,5)}...${n.slice(-5)}`}function ge(n){return n.replace(/^(def_|trans_|inst_|outcome_)/,"")}function ys(n,e,t){const o=ae(n);if(o)return o;const s=e.replace(/^def_/,"").toLowerCase();return`${t}-${s.slice(0,8)}`}function ws(n,e){const t=je(n);return t||`event.${e.replace(/^def_/,"").toLowerCase().slice(0,8)}`}function Cn(n){const e=n.match(/\{([^}]+)\}/g);return e?e.map(t=>t.slice(1,-1)):[]}function _n(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}function Ue(n,e,t,o){switch(t){case A.Top:return{x:n,y:e-o};case A.Bottom:return{x:n,y:e+o};case A.Left:return{x:n-o,y:e};case A.Right:return{x:n+o,y:e};default:return{x:n,y:e}}}function Mn(n,e,t,o,s=100){const r=t-n,c=o-e,l=Math.sqrt(r*r+c*c);return Math.min(s,l/2)}function dt(n,e,t,o,s,r){const c=Mn(n,e,t,o),l=Ue(n,e,s,c),h=Ue(t,o,r,c);return`M${n},${e} C${l.x},${l.y} ${h.x},${h.y} ${t},${o}`}function de(){return`def_${De()}`}function In(){return`trans_${De()}`}function ke(){return`inst_${De()}`}function Xe(){return`outcome_${De()}`}function ze(n){const e=je(n.label);return{id:de(),label:n.label,kind:"event",category:"business",executionMode:le("event"),config:e?{type:e}:void 0}}function qe(n){return{id:de(),label:n.label,kind:"policy",category:"business",executionMode:le("policy")}}function Sn(n){const e=ae(n.label);return{id:de(),label:n.label,kind:"trigger",category:"business",executionMode:le("trigger"),config:e?{slugName:e}:void 0}}function Ye(n){const e=ae(n.label);return{id:de(),label:n.label,kind:"externalSystem",category:"technical",executionMode:le("externalSystem"),config:e?{slugName:e}:void 0}}function An(n){const e=ae(n.label);return{id:de(),label:n.label,kind:"externalEvent",category:"technical",executionMode:le("externalEvent"),config:e?{slugName:e}:void 0}}function Ke(n){const e=ae(n.label);return{id:de(),label:n.label,kind:"command",category:"business",executionMode:le("command"),config:e?{slugName:e}:void 0}}function Qe(n){return{id:de(),label:n.label,kind:"hotspot",category:"business",executionMode:le("hotspot")}}function Je(n){return{id:de(),label:n.label,kind:"note",category:"business",executionMode:le("note")}}function Ze(n){return{id:de(),label:n.label,kind:"actor",category:"business",executionMode:le("actor")}}function Rn(n){return{id:In(),sourceDefId:n.sourceDefId,targetDefId:n.targetDefId}}const Pn={transitionDelay:1e3,autoStart:!1};class On{constructor(){ee(this,"listeners",new Map)}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}off(e,t){var o;(o=this.listeners.get(e))==null||o.delete(t)}emit(e,t){const o=this.listeners.get(e);if(o)for(const s of o)try{s(t)}catch(r){console.error(`Error in event handler for ${String(e)}:`,r)}}once(e,t){const o=s=>{this.off(e,o),t(s)};return this.on(e,o)}removeAllListeners(e){e?this.listeners.delete(e):this.listeners.clear()}listenerCount(e){var t;return((t=this.listeners.get(e))==null?void 0:t.size)??0}}class Dn extends On{constructor(t,o={}){super();ee(this,"graph");ee(this,"config");ee(this,"running",!1);ee(this,"nodeStates",new Map);ee(this,"transitionStates",new Map);ee(this,"activeNodes",new Set);ee(this,"pendingActions",new Set);ee(this,"activeTimeouts",new Set);this.graph=t,this.config={...Pn,...o},this.initializeState()}initializeState(){for(const t of this.graph.getAllNodes())this.nodeStates.set(t.id,"idle");for(const t of this.graph.getAllTransitions())this.transitionStates.set(t.id,"idle")}getState(){return{isRunning:this.running,nodeStates:new Map(this.nodeStates),transitionStates:new Map(this.transitionStates),activeNodes:new Set(this.activeNodes),pendingActions:new Set(this.pendingActions)}}getNodeState(t){return this.nodeStates.get(t)}getTransitionState(t){return this.transitionStates.get(t)}isSimulationRunning(){return this.running}start(){if(!this.running&&(this.running=!0,this.emit("simulation:start",{timestamp:Date.now()}),this.config.autoStart))for(const t of this.graph.getEntryNodes())this.triggerNode(t.id)}stop(){if(this.running){this.running=!1;for(const t of this.activeTimeouts)clearTimeout(t);this.activeTimeouts.clear(),this.emit("simulation:stop",{timestamp:Date.now()})}}reset(){this.stop(),this.nodeStates.clear(),this.transitionStates.clear(),this.activeNodes.clear(),this.pendingActions.clear(),this.initializeState(),this.emit("simulation:reset",{timestamp:Date.now()})}resetAllStates(){const t=Date.now();for(const o of this.graph.getAllNodes())this.nodeStates.set(o.id,"idle"),this.emit("node:reset",{node:o,timestamp:t});for(const o of this.graph.getAllTransitions())this.transitionStates.set(o.id,"idle"),this.emit("transition:reset",{transition:o,timestamp:t});this.activeNodes.clear(),this.pendingActions.clear()}triggerNode(t){if(!this.running){this.emitError(`Cannot trigger node ${t}: simulation is not running`,t);return}if(!this.graph.getNode(t)){this.emitError(`Node ${t} not found`,t);return}this.resetAllStates(),this.enterNode(t)}selectTransition(t){if(!this.running){this.emitError("Cannot select transition: simulation is not running",void 0,t);return}const o=this.graph.getTransition(t);if(!o){this.emitError(`Transition ${t} not found`,void 0,t);return}if(!this.graph.getNode(o.sourceDefId)){this.emitError("Source node for transition not found",o.sourceDefId,t);return}if(!this.pendingActions.has(o.sourceDefId)){this.emitError(`Node ${o.sourceDefId} is not waiting for action`,o.sourceDefId);return}this.resetAllStates(),this.executeTransition(o)}completeManualNode(t){if(!this.running){this.emitError("Cannot complete node: simulation is not running",t);return}if(!this.graph.getNode(t)){this.emitError(`Node ${t} not found`,t);return}if(!this.pendingActions.has(t)){this.emitError(`Node ${t} is not waiting for action`,t);return}this.resetAllStates(),this.pendingActions.delete(t),this.exitNode(t)}enterNode(t){const o=this.graph.getNode(t);o&&(this.nodeStates.set(t,"entering"),this.activeNodes.add(t),this.emit("node:enter",{node:o,timestamp:Date.now()}),this.activateNode(t))}activateNode(t){const o=this.graph.getNode(t);o&&(this.nodeStates.set(t,"active"),this.emit("node:active",{node:o,timestamp:Date.now()}),this.graph.requiresUserAction(t)?this.waitForAction(t):this.graph.canAutoTraverse(t)?this.exitNode(t):this.completeNode(t))}waitForAction(t){const o=this.graph.getNode(t);if(!o)return;this.nodeStates.set(t,"waiting_for_action"),this.pendingActions.add(t);const s=this.graph.getOutgoingTransitions(t);this.emit("node:waiting",{node:o,availableTransitions:s,timestamp:Date.now()})}exitNode(t){const o=this.graph.getNode(t);if(!o)return;this.nodeStates.set(t,"exiting"),this.emit("node:exit",{node:o,timestamp:Date.now()});const s=this.graph.getOutgoingTransitions(t);if(s.length===0)this.completeNode(t);else if(s.length===1)this.executeTransition(s[0]),this.completeNode(t);else{for(const r of s)this.executeTransition(r);this.completeNode(t)}}completeNode(t){const o=this.graph.getNode(t);o&&(this.nodeStates.set(t,"completed"),this.activeNodes.delete(t),this.emit("node:complete",{node:o,timestamp:Date.now()}))}executeTransition(t){this.transitionStates.set(t.id,"in_progress"),this.emit("transition:start",{transition:t,timestamp:Date.now()});const o=setTimeout(()=>{this.activeTimeouts.delete(o),this.completeTransition(t)},this.config.transitionDelay);this.activeTimeouts.add(o)}completeTransition(t){this.transitionStates.set(t.id,"completed"),this.emit("transition:complete",{transition:t,timestamp:Date.now()}),this.enterNode(t.targetDefId)}emitError(t,o,s){this.emit("error",{message:t,nodeId:o,transitionId:s,timestamp:Date.now()})}}function ut(){const n=a.useRef(new Map),e=a.useRef(new Map),t=a.useRef(new Map),o=a.useRef(new Map),s=a.useCallback(i=>n.current.get(i),[]),r=a.useCallback(i=>{const u=e.current.get(i);return u?Array.from(u):[]},[]),c=a.useCallback(i=>{const u=n.current.get(i);if(!u)return!0;const m=e.current.get(u);if(!m||m.size<=1)return!0;const b=Array.from(m).sort();return i===b[0]},[]),l=a.useCallback((i,u,m)=>{if(!i.current)return;const T=i.current.getOutgoingTransitions(u).find(w=>w.targetDefId===m);return T==null?void 0:T.id},[]),h=a.useCallback(i=>t.current.get(i),[]),f=a.useCallback(i=>o.current.get(i),[]),x=a.useCallback((i,u)=>{n.current.set(i,u);let m=e.current.get(u);m||(m=new Set,e.current.set(u,m)),m.add(i)},[]),E=a.useCallback(i=>{const u=n.current.get(i);if(!u)return;n.current.delete(i);const m=e.current.get(u);return m&&(m.delete(i),m.size===0&&e.current.delete(u)),u},[]),p=a.useCallback((i,u)=>{t.current.set(i,u);let m=o.current.get(u);m||(m=new Set,o.current.set(u,m)),m.add(i)},[]),y=a.useCallback(i=>{const u=t.current.get(i);if(!u)return;t.current.delete(i);const m=o.current.get(u);return m&&(m.delete(i),m.size===0&&o.current.delete(u)),u},[]),d=a.useCallback(()=>{n.current.clear(),e.current.clear(),t.current.clear(),o.current.clear()},[]);return{instanceToDefRef:n,defToInstancesRef:e,edgeToTransitionRef:t,transitionToEdgesRef:o,getDefinitionForInstance:s,getInstancesForDefinition:r,isOriginalInstance:c,findExistingTransition:l,getEdgeTransition:h,getEdgesForTransition:f,registerInstance:x,unregisterInstance:E,registerEdge:p,unregisterEdge:y,resetMappings:d}}function vs(n,e){return{x:n.x-e.x,y:n.y-e.y}}function jn(n,e){return{x:n.x+e.x,y:n.y+e.y}}function Ln(n,e){return e?jn(n,e):n}const we=152,ft=102,gt=80,Le=32,oe=10;function Ae(n,e,t=we,o=ft,s=gt,r=Le){const c=n+s<=0,l=n>=t,h=e+r<=0,f=e>=o;if(c)return{x:-s-oe,y:Math.max(-r,Math.min(e,o))};if(l)return{x:t+oe,y:Math.max(-r,Math.min(e,o))};if(h)return{x:Math.max(-s,Math.min(n,t)),y:-r-oe};if(f)return{x:Math.max(-s,Math.min(n,t)),y:o+oe};const x=n+s/2,E=e+r/2,p=t/2,y=o/2,d=x-p,i=E-y;return Math.abs(d)>Math.abs(i)?d>0?{x:t+oe,y:Math.max(-r,Math.min(e,o))}:{x:-s-oe,y:Math.max(-r,Math.min(e,o))}:i>0?{x:Math.max(-s,Math.min(n,t)),y:o+oe}:{x:Math.max(-s,Math.min(n,t)),y:-r-oe}}const Be={command:{canConnectTo:["event"],canReceiveFrom:["event","policy","externalEvent"]},policy:{canConnectTo:["command","externalEvent","trigger","externalSystem"],canReceiveFrom:["event"]},externalEvent:{canConnectTo:["command","trigger"],canReceiveFrom:["event","policy"]},externalSystem:{canConnectTo:["event"],canReceiveFrom:["event","policy","externalEvent"]},trigger:{canConnectTo:["event"],canReceiveFrom:["event","policy","externalEvent"]},event:{canConnectTo:["policy","command","externalEvent","trigger","externalSystem"],canReceiveFrom:["command","trigger","externalSystem"]}};function Fn(n,e){const t=Be[n],o=Be[e];if(!t||!o)return!1;const s=t.canConnectTo.includes(e),r=o.canReceiveFrom.includes(n);return s&&r}function zn(n,e){return e?"policy":n}function mt(n){return n==="command"?"commandEdge":"floating"}function $e(n){return n>=2?"commandEdge":"floating"}function $n(n,e){return{sourceHandle:"source-right",targetHandle:"target-left"}}function Re(){return{label:"Path",labelOffset:.5}}function Pe(n,e){return!n||!e?{isNonStandard:!1}:{isNonStandard:!Fn(n,e),sourceKind:n,targetKind:e}}function Wn(n,e,t,o){const s=n.source,r=n.target,c=o.has(s);let l;if(c){const d=o.get(s);l=d?t.get(d):void 0}else l=t.get(s);const h=t.get(r);if(!l||!h)return n;const f=e.getNode(l),x=e.getNode(h),E=c?"policy":f==null?void 0:f.kind,p=x==null?void 0:x.kind,y=Pe(E,p);return{...n,data:{...n.data,...y}}}const Ce=120,Xn=152,Bn=112,Vn={top:{source:"source-top",target:"target-bottom"},right:{source:"source-right",target:"target-left"},bottom:{source:"source-bottom",target:"target-top"},left:{source:"source-left",target:"target-right"}};function Gn(n){return Vn[n]}function Hn(n,e,t,o){switch(o){case"top":return{x:n.x,y:n.y-Ce};case"right":return{x:n.x+e+Ce,y:n.y};case"bottom":return{x:n.x,y:n.y+t+Ce};case"left":return{x:n.x-Ce,y:n.y}}}function ht(n,e,t,o){n.set(t,o);let s=e.get(o);s||(s=new Set,e.set(o,s)),s.add(t)}function pt(n,e,t,o){const s=n.get(o);if(!s)return;n.delete(o),t.delete(o);const r=e.get(s);r&&(r.delete(o),r.size===0&&e.delete(s))}function xt(n,e){var t;return((t=n.get(e))==null?void 0:t.size)??0}function Un(n,e,t){var r;const o=e.get(n);return o?(((r=t.get(o))==null?void 0:r.size)??0)>2:!1}function qn(n,e,t,o){return n.filter(s=>{const r=s;return r.type!=="remove"||!r.id||!e.has(r.id)||o!=null&&o.has(r.id)?!0:Un(r.id,e,t)})}function Yn(n,e,t,o){return n}function Kn(n,e=we){return Ae(e+oe,n*(Le+oe))}function Qn(n,e,t,o,s){return{id:n,type:"outcome",position:s,parentId:e,data:{label:o,parentPolicyId:e,parentPolicyInstanceId:e,parentPolicyDefId:t}}}function Jn(n,e,t,o,s,r,c){var x;const l=e.get(n);if(!l||(((x=t.get(l))==null?void 0:x.size)??0)<=2)return!1;if(o.get(n)){const E=s.cleanupEdgesFromSource(n);E.length>0&&c(p=>p.filter(y=>!E.includes(y.id)))}return pt(e,t,o,n),r(E=>E.filter(p=>p.id!==n)),!0}function Zn(n,e,t,o,s,r,c){const l=c(),h=xt(s,n),f=Kn(h),x=Qn(l,n,e,t,f);return ht(o,s,l,n),r(E=>[...E,x]),l}function eo(n,e,t){t(o=>o.map(s=>s.id===n?{...s,data:{...s.data,label:e}}:s))}function bt(n){const{instanceToDefRef:e,setNodes:t,getNodes:o}=n,s=a.useRef(new Map),r=a.useRef(new Map),c=a.useRef(new Map),l=a.useCallback(w=>c.current.get(w),[]),h=a.useCallback(w=>{const v=r.current.get(w);return v?Array.from(v):[]},[]),f=a.useCallback(w=>{const v=r.current.get(w);if(!v)return[];const S=o();return Array.from(v).map(B=>{var $;const C=S.find(R=>R.id===B),N=(($=C==null?void 0:C.data)==null?void 0:$.label)||"Outcome";return{id:B,label:N}})},[o]),x=a.useCallback(w=>s.current.has(w),[]),E=a.useCallback(w=>s.current.get(w),[]),p=a.useCallback(w=>xt(r.current,w),[]),y=a.useCallback((w,v)=>{ht(s.current,r.current,w,v)},[]),d=a.useCallback(w=>{pt(s.current,r.current,c.current,w)},[]),i=a.useCallback((w,v)=>{c.current.set(w,v)},[]),u=a.useCallback(w=>{c.current.delete(w)},[]),m=a.useCallback((w,v)=>{var B;const S=(B=e.current)==null?void 0:B.get(w);if(!S)throw new Error(`Policy instance ${w} not found`);return Zn(w,S,v,s.current,r.current,t,Xe)},[e,t]),b=a.useCallback((w,v)=>{eo(w,v,t)},[t]),T=a.useCallback(()=>{s.current.clear(),r.current.clear(),c.current.clear()},[]);return{outcomeToParentRef:s,policyToOutcomesRef:r,outcomeToTransitionRef:c,getOutcomeTransition:l,getOutcomesForPolicy:h,getOutcomesWithLabels:f,isOutcome:x,getOutcomeParent:E,getOutcomeCount:p,registerOutcome:y,unregisterOutcome:d,setOutcomeTransition:i,clearOutcomeTransition:u,addOutcomeToPolicy:m,updateOutcomeLabel:b,resetMappings:T}}function Et(n,e){const{edgeToTransitionRef:t,transitionToEdgesRef:o}=e,s=a.useCallback(p=>t.current.get(p),[t]),r=a.useCallback(p=>o.current.get(p),[o]),c=a.useCallback(p=>{const y=o.current.get(p);return y!==void 0&&y.size>0},[o]),l=a.useCallback((p,y)=>{if(!n.current)return;const i=n.current.getOutgoingTransitions(p).find(u=>u.targetDefId===y);return i==null?void 0:i.id},[n]),h=a.useCallback((p,y)=>{t.current.set(p,y);let d=o.current.get(y);d||(d=new Set,o.current.set(y,d)),d.add(p)},[t,o]),f=a.useCallback((p,y,d)=>{const i=Rn({sourceDefId:y,targetDefId:d});return n.current.addTransition(i),t.current.set(p,i.id),o.current.set(i.id,new Set([p])),i.id},[n,t,o]),x=a.useCallback(p=>{const y=t.current.get(p);if(!y)return{transitionDeleted:!1};t.current.delete(p);const d=o.current.get(y);return d==null||d.delete(p),!d||d.size===0?(o.current.delete(y),n.current.removeTransition(y),{transitionDeleted:!0,transitionId:y}):{transitionDeleted:!1,transitionId:y}},[n,t,o]),E=a.useCallback((p,y,d,i)=>{if((i==null?void 0:i.allowReuseExisting)??!0){const m=l(y,d);if(m)return h(p,m),m}return f(p,y,d)},[l,h,f]);return{getTransitionForEdge:s,getEdgesForTransition:r,hasEdgesForTransition:c,findExistingTransition:l,linkEdgeToTransition:h,linkEdgeToNewTransition:f,unlinkEdgeFromTransition:x,getOrCreateTransitionAndLink:E}}function yt(n,e){const t=a.useCallback(h=>{var x;const f=(x=e.current)==null?void 0:x.get(h);return f?Array.from(f):[]},[e]),o=a.useCallback(h=>{var f,x;return((x=(f=n.current)==null?void 0:f.getNode(h))==null?void 0:x.kind)==="command"},[n]),s=a.useCallback((h,f)=>{const x=t(h);if(x.length===0)return 0;const E=new Set(x);let p=0;for(const y of f)E.has(y.source)&&p++;return p},[t]),r=a.useCallback((h,f,x)=>{let E=s(h,f);return E+=(x==null?void 0:x.pendingAdd)??0,$e(E)},[s]),c=a.useCallback((h,f,x)=>{const E=t(h);if(E.length===0)return f;const p=new Set(E);let y=0;for(const i of f)p.has(i.source)&&y++;y+=(x==null?void 0:x.pendingAdd)??0;const d=$e(y);return f.map(i=>{var u;return!p.has(i.source)||i.type===d?i:{...i,type:d,data:{...i.data,...d==="commandEdge"&&!((u=i.data)!=null&&u.label)?Re():{}}}})},[t]),l=a.useCallback((h,f,x,E)=>{const p=new Map;for(const y of h){const d=x.get(y.source);if(!d)continue;const i=f.getNode(d);(i==null?void 0:i.kind)==="command"&&p.set(d,(p.get(d)??0)+1)}return h.map(y=>{var b;const d=x.get(y.source);if(!d)return y;const i=f.getNode(d);if((i==null?void 0:i.kind)!=="command")return y;const u=p.get(d)??0,m=$e(u);return y.type===m?y:{...y,type:m,data:{...y.data,...m==="commandEdge"&&!((b=y.data)!=null&&b.label)?Re():{}}}})},[]);return{countCommandEdges:s,resolveEdgeType:r,normalizeCommandEdges:c,normalizeAllCommandEdges:l,isCommandDefinition:o,getCommandInstanceIds:t}}const et=["hotspot","note","actor"];function to(n){const{edges:e,setNodes:t,setEdges:o,onNodesChangeInternal:s,onEdgesChangeInternal:r,graphRef:c,getNode:l,nodesRef:h,instanceToDefRef:f,defToInstancesRef:x,edgeToTransitionRef:E,transitionToEdgesRef:p,outcomeManagement:y,edgeTransitionManager:d,commandEdgeResolver:i}=n,{isOutcome:u,unregisterOutcome:m,getOutcomesForPolicy:b,setOutcomeTransition:T,clearOutcomeTransition:w,outcomeToParentRef:v,policyToOutcomesRef:S}=y,B=a.useCallback(O=>{const k=f.current.get(O);if(!k)return;const I=b(O);for(const W of I)m(W);f.current.delete(O);const D=x.current.get(k);if(D==null||D.delete(O),!D||D.size===0){x.current.delete(k),c.current.removeNode(k);for(const[W,L]of E.current)c.current.getTransition(L)||(E.current.delete(W),p.current.delete(L))}},[c,f,x,E,p,b,m]),C=a.useCallback(O=>{d.unlinkEdgeFromTransition(O)},[d]),N=a.useCallback(O=>{const k=new Set;for(const F of O)if(F.type==="remove"){const G=S.current.get(F.id);if(G)for(const X of G)k.add(X)}const I=qn(O,v.current,S.current,k);for(const F of k)I.some(G=>G.type==="remove"&&G.id===F)||I.push({type:"remove",id:F});const D=I.map(F=>{var G,X,H,U;if(F.type==="position"&&F.position){const K=v.current.get(F.id);if(K){const J=l(F.id),Z=l(K),_=Ae(F.position.x,F.position.y,((G=Z==null?void 0:Z.measured)==null?void 0:G.width)??we,((X=Z==null?void 0:Z.measured)==null?void 0:X.height)??ft,((H=J==null?void 0:J.measured)==null?void 0:H.width)??gt,((U=J==null?void 0:J.measured)==null?void 0:U.height)??Le);return{...F,position:_}}}return F}),W=new Set;for(const F of D)F.type==="remove"&&W.add(F.id);const L=new Set;for(const F of e)(W.has(F.source)||W.has(F.target))&&L.add(F.id);for(const F of L)C(F);L.size>0&&o(F=>F.filter(G=>!L.has(G.id)));for(const F of D)F.type==="remove"&&B(F.id);s(D)},[s,B,C,l,e,o,S,v]),$=a.useCallback(O=>{const k=Yn(O,e,v.current,S.current),I=new Set,D=new Set;for(const W of k)if(W.type==="remove"){const L=e.find(F=>F.id===W.id);if(L){const F=L.source,G=L.target,X=f.current.get(F);if(X){const H=c.current.getNode(X);if((H==null?void 0:H.kind)==="command"){I.add(X);const U=f.current.get(G);if(U){const K=c.current.getNode(U);(K==null?void 0:K.kind)==="event"&&D.add(G)}}}}C(W.id)}r(k),I.size>0&&o(W=>{let L=W;for(const F of I)L=i.normalizeCommandEdges(F,L);return L}),D.size>0&&t(W=>W.map(L=>D.has(L.id)?e.some(G=>{if(G.target!==L.id||k.some(K=>K.type==="remove"&&K.id===G.id))return!1;const H=f.current.get(G.source);if(!H)return!1;const U=c.current.getNode(H);return(U==null?void 0:U.kind)==="command"})?L:{...L,data:{...L.data,hasCommandParent:!1}}:L))},[r,C,e,o,t,i,c,f,v,S]),R=a.useCallback(O=>{if(!O.source||!O.target)return!1;const k=O.source,I=O.target;if(k===I)return!1;const D=u(k),W=h.current.find(X=>X.id===k),L=zn(W==null?void 0:W.type,D),F=h.current.find(X=>X.id===I),G=F==null?void 0:F.type;return!(!L||!G||et.includes(L)||et.includes(G))},[u,h]),P=a.useCallback(O=>{if(!O.source||!O.target)return;const k=O.source,I=O.target,D=`edge_${k}_${I}`;if(E.current.has(D))return;const W=u(k);let L;if(W){const _=k,M=v.current.get(_);L=f.current.get(M)}else L=f.current.get(k);const F=f.current.get(I);if(!L||!F)return;const G=d.findExistingTransition(L,F);if(G&&!W&&d.hasEdgesForTransition(G))return;const X=W?d.linkEdgeToNewTransition(D,L,F):d.getOrCreateTransitionAndLink(D,L,F);W&&T(k,X);const H=c.current.getNode(L),U=c.current.getNode(F),K=(H==null?void 0:H.kind)==="command",J=W?"policy":H==null?void 0:H.kind,Z=Pe(J,U==null?void 0:U.kind);K?(o(_=>{const M=i.resolveEdgeType(L,_,{pendingAdd:1}),V=Ge({...O,id:D,type:M,data:{state:"idle",transitionId:X,...Z,...M==="commandEdge"?Re():{}}},_);return i.normalizeCommandEdges(L,V)}),(U==null?void 0:U.kind)==="event"&&t(_=>_.map(M=>M.id===I?{...M,data:{...M.data,hasCommandParent:!0}}:M))):o(_=>Ge({...O,id:D,type:"floating",data:{state:"idle",transitionId:X,...Z}},_))},[o,t,d,i,c,f,E,v,u,T]),z=a.useCallback((O,k)=>{if(!k.source||!k.target)return;const I=O.id,D=k.source,W=k.target,L=`edge_${D}_${W}`,F=I!==L;if(e.some(q=>q.id!==I&&q.id!==L&&q.source===D&&q.target===W)||F&&E.current.has(L))return;const X=u(D);let H;if(X){const q=D,fe=v.current.get(q);H=f.current.get(fe)}else H=f.current.get(D);const U=f.current.get(W);if(!H||!U)return;const K=E.current.get(I),J=K?c.current.getTransition(K):void 0,Z=!J||J.sourceDefId!==H||J.targetDefId!==U;let _;const M=O.source,V=v.current.has(M);if(Z){K&&(d.unlinkEdgeFromTransition(I),V&&w(M));const q=d.findExistingTransition(H,U);if(q&&!X&&d.hasEdgesForTransition(q))return;_=X?d.linkEdgeToNewTransition(L,H,U):d.getOrCreateTransitionAndLink(L,H,U),X&&T(D,_)}else{if(_=K,F){E.current.delete(I),E.current.set(L,_);const q=p.current.get(_);q&&(q.delete(I),q.add(L))}V&&M!==D&&w(M),X&&T(D,_)}const Q=c.current.getNode(H),te=c.current.getNode(U),ue=(Q==null?void 0:Q.kind)==="command",Ee=ue?"commandEdge":"floating",he=X?"policy":Q==null?void 0:Q.kind,pe=Pe(he,te==null?void 0:te.kind);o(q=>tn(O,k,q).map(ne=>{var se;return ne.source===k.source&&ne.target===k.target?{...ne,id:L,type:Ee,data:{...ne.data,...Z?{state:"idle",progress:0}:{},transitionId:_,...pe,...ue&&!((se=ne.data)!=null&&se.label)?{label:"Path",labelOffset:.5}:{}}}:ne}))},[e,o,d,c,f,E,p,v,u,T,w]);return{onNodesChange:N,onEdgesChange:$,onConnect:P,onReconnect:z,isValidConnection:R}}function tt(n,e,t,o,s){return{id:n,type:"outcome",position:s,parentId:t,data:{label:e,parentPolicyInstanceId:t,parentPolicyDefId:o}}}function no(n){const{edges:e,setNodes:t,setEdges:o,graphRef:s,getNode:r,instanceMapping:c,outcomeManagement:l,edgeTransitionManager:h}=n,{instanceToDefRef:f,defToInstancesRef:x,edgeToTransitionRef:E,transitionToEdgesRef:p}=c,{outcomeToParentRef:y,policyToOutcomesRef:d,getOutcomesForPolicy:i,registerOutcome:u,unregisterOutcome:m}=l,b=a.useCallback(N=>{const $=f.current.get(N);if(!$)return;const R=i(N);for(const z of R)m(z);f.current.delete(N);const P=x.current.get($);if(P==null||P.delete(N),!P||P.size===0){x.current.delete($),s.current.removeNode($);for(const[z,O]of E.current)s.current.getTransition(O)||(E.current.delete(z),p.current.delete(O))}},[s,f,x,E,p,i,m]),T=a.useCallback((N,$,R)=>{let P,z="event";if(N==="event"){const k=ze({label:R||"Event"});s.current.addNode(k);const I=ke();f.current.set(I,k.id),x.current.set(k.id,new Set([I]));const D={id:I,type:"event",position:$,data:{label:k.label,executionMode:k.executionMode,definitionId:k.id}};return t(W=>[...W,D]),I}if(N==="trigger"){const k=Sn({label:R||"Trigger"});s.current.addNode(k);const I=ke();f.current.set(I,k.id),x.current.set(k.id,new Set([I]));const D={id:I,type:"trigger",position:$,data:{label:k.label,definitionId:k.id}};return t(W=>[...W,D]),I}N==="policy"?(P=qe({label:R||"Policy"}),z="policy"):N==="externalSystem"?(P=Ye({label:R||"External System"}),z="externalSystem"):N==="externalEvent"?(P=An({label:R||"External Event"}),z="externalEvent"):N==="command"?(P=Ke({label:R??"Command"}),z="command"):N==="hotspot"?(P=Qe({label:R||"HotSpot"}),z="hotspot"):N==="note"?(P=Je({label:R||"Note"}),z="note"):N==="actor"?(P=Ze({label:R||"Actor"}),z="actor"):(P=ze({label:R||"Event"}),z="event"),s.current.addNode(P);const O=ke();if(f.current.set(O,P.id),x.current.set(P.id,new Set([O])),N==="policy"){const k={id:O,type:"policy",position:$,data:{label:P.label,executionMode:P.executionMode,definitionId:P.id}},I=Xe(),D=Xe(),W=Ae(we+oe,0),L=Ae(we+oe,Le+oe),F=tt(I,"Yes",O,P.id,W),G=tt(D,"No",O,P.id,L);u(I,O),u(D,O),t(X=>[...X,k,F,G])}else{const k={id:O,type:z,position:$,data:{label:P.label,executionMode:P.executionMode,definitionId:P.id}};t(I=>[...I,k])}return O},[s,f,x,t,u]),w=a.useCallback((N,$)=>{const R=s.current.getNode(N);if(!R)throw new Error(`Definition ${N} does not exist`);const P=ke();f.current.set(P,N);const z=x.current.get(N)??new Set;z.add(P),x.current.set(N,z);const O={id:P,type:R.kind,position:$,data:{label:R.label,executionMode:R.executionMode,definitionId:N}};return t(k=>[...k,O]),P},[s,f,x,t]),v=a.useCallback(N=>{const $=f.current.get(N);if(!$)return;const R=r(N);if(!R)return;const P={x:R.position.x+50,y:R.position.y+50};return w($,P)},[f,r,w]),S=a.useCallback(N=>{const $=f.current.get(N);if(!$)return;const R=s.current.getNode($);if(!R)return;const P=x.current.get($);if(!P||P.size<=1)return;let z;R.kind==="event"?z=ze({label:R.label}):R.kind==="policy"?z=qe({label:R.label}):R.kind==="command"?z=Ke({label:R.label}):R.kind==="hotspot"?z=Qe({label:R.label}):R.kind==="note"?z=Je({label:R.label}):R.kind==="actor"?z=Ze({label:R.label}):z=Ye({label:R.label}),s.current.addNode(z),f.current.set(N,z.id),P.delete(N),x.current.set(z.id,new Set([N]));const O=e.filter(k=>k.source===N||k.target===N);for(const k of O){const I=k.source===N,D=I?k.target:k.source;if(y.current.has(D))continue;const W=f.current.get(D);if(!W||W===$)continue;const L=I?z.id:W,F=I?W:z.id;h.getOrCreateTransitionAndLink(k.id,L,F)}t(k=>k.map(I=>I.id===N?{...I,data:{...I.data,definitionId:z.id}}:I)),o(k=>k.map(I=>{if(I.source===N||I.target===N){const D=E.current.get(I.id);if(D)return{...I,data:{...I.data,transitionId:D}}}return I}))},[s,f,x,y,E,e,t,o,h]),B=a.useCallback(N=>{const $=d.current.get(N),R=new Set([N]);if($)for(const P of $)R.add(P);b(N),t(P=>P.filter(z=>!R.has(z.id)))},[d,b,t]),C=a.useCallback(N=>{const $=x.current.get(N);if(!$)return;const R=new Set($);for(const P of R)f.current.delete(P);x.current.delete(N),s.current.removeNode(N),t(P=>P.filter(z=>!R.has(z.id)))},[s,f,x,t]);return{addNode:T,addInstance:w,duplicateInstance:v,dissociateInstance:S,deleteInstance:B,deleteDefinition:C,handleInstanceDeletion:b}}function oo(n){const{setNodes:e,graphRef:t,instanceMapping:o}=n,{defToInstancesRef:s,getDefinitionForInstance:r,getInstancesForDefinition:c,isOriginalInstance:l}=o,h=a.useCallback(u=>c(u),[c]),f=a.useCallback((u,m)=>{t.current.updateNode(u,{executionMode:m});const b=s.current.get(u);b&&e(T=>T.map(w=>b.has(w.id)?{...w,data:{...w.data,executionMode:m}}:w))},[t,s,e]),x=a.useCallback((u,m)=>{const b=t.current.getNode(u);if(!b)return;t.current.updateNode(u,{label:m});const T=b.config;if(b.kind==="command"||b.kind==="trigger"||b.kind==="externalSystem"||b.kind==="externalEvent"){const v=ae(m);if(v){const S=T;if((S==null?void 0:S.slugName)!==v){const C={...S,slugName:v};t.current.updateNode(u,{config:C})}}}else if(b.kind==="event"){const v=je(m);if(v){const S=T;if((S==null?void 0:S.type)!==v){const C={...S,type:v};t.current.updateNode(u,{config:C})}}}const w=s.current.get(u);w&&e(v=>v.map(S=>w.has(S.id)?{...S,data:{...S.data,label:m}}:S))},[t,s,e]),E=a.useCallback((u,m)=>{t.current.updateNode(u,{config:m})},[t]),p=a.useCallback((u,m)=>{t.current.updateNode(u,{awsExtension:m})},[t]),y=a.useCallback(u=>{var m;return(m=t.current.getNode(u))==null?void 0:m.config},[t]),d=a.useCallback(u=>{var m;return(m=t.current.getNode(u))==null?void 0:m.awsExtension},[t]),i=a.useCallback((u,m)=>{var S;const b=t.current.getNode(u);if(!b||b.kind!=="command"&&b.kind!=="trigger"||b.kind===m)return;const T=m==="trigger"?"manual":"automatic";t.current.updateNode(u,{kind:m,executionMode:T}),m==="command"&&t.current.recalculateExecutionMode(u);const w=s.current.get(u);if(!w)return;const v=(S=t.current.getNode(u))==null?void 0:S.executionMode;e(B=>B.map(C=>w.has(C.id)?{...C,type:m,data:{...C.data,executionMode:v}}:C))},[t,s,e]);return{getDefinitionForInstance:r,getInstancesForDefinition:h,isOriginalInstance:l,updateNodeExecutionMode:f,updateNodeLabel:x,updateNodeConfig:E,updateNodeAwsExtension:p,getNodeConfig:y,getNodeAwsExtension:d,convertNodeKind:i}}function so(n){const{edges:e,setNodes:t,setEdges:o,outcomeManagement:s,edgeTransitionManager:r}=n,{outcomeToParentRef:c,policyToOutcomesRef:l,outcomeToTransitionRef:h,getOutcomeTransition:f,getOutcomesForPolicy:x,getOutcomesWithLabels:E,addOutcomeToPolicy:p,updateOutcomeLabel:y}=s,d=a.useMemo(()=>({cleanupEdgesFromSource:u=>{const m=e.filter(b=>b.source===u).map(b=>b.id);for(const b of m)r.unlinkEdgeFromTransition(b);return m}}),[e,r]),i=a.useCallback(u=>Jn(u,c.current,l.current,h.current,d,t,o),[c,l,h,d,t,o]);return{getOutcomeTransition:f,getOutcomesForPolicy:x,getOutcomesWithLabels:E,addOutcomeToPolicy:p,deleteOutcome:i,updateOutcomeLabel:y}}const _e=16;function ro(n){const{nodes:e,edges:t,setNodes:o,setEdges:s,graphRef:r,instanceMapping:c,outcomeManagement:l,commandEdgeResolver:h,incrementGraphVersion:f}=n,{instanceToDefRef:x,defToInstancesRef:E,edgeToTransitionRef:p,transitionToEdgesRef:y}=c,{outcomeToParentRef:d,policyToOutcomesRef:i,outcomeToTransitionRef:u,resetMappings:m}=l,b=a.useCallback(()=>{r.current=new ye,c.resetMappings(),m(),o([]),s([]),f()},[r,o,s,c,m,f]),T=a.useCallback(()=>({graph:r.current,nodes:e,edges:t,mappings:{instanceToDefRef:new Map(x.current),defToInstancesRef:new Map(Array.from(E.current.entries()).map(([v,S])=>[v,new Set(S)])),edgeToTransitionRef:new Map(p.current),transitionToEdgesRef:new Map(Array.from(y.current.entries()).map(([v,S])=>[v,new Set(S)])),outcomeToParentRef:new Map(d.current),policyToOutcomesRef:new Map(Array.from(i.current.entries()).map(([v,S])=>[v,new Set(S)])),outcomeToTransitionRef:new Map(u.current)}}),[e,t,r,x,E,p,y,d,i,u]),w=a.useCallback(v=>{r.current=v.graph,x.current=v.mappings.instanceToDefRef,E.current=v.mappings.defToInstancesRef,p.current=v.mappings.edgeToTransitionRef,y.current=v.mappings.transitionToEdgesRef,d.current=v.mappings.outcomeToParentRef??new Map,i.current=v.mappings.policyToOutcomesRef??new Map,u.current=v.mappings.outcomeToTransitionRef??new Map;const S=v.nodes.map(N=>({...N,position:{x:Math.round(N.position.x/_e)*_e,y:Math.round(N.position.y/_e)*_e}})),C=h.normalizeAllCommandEdges(v.edges,v.graph,v.mappings.instanceToDefRef,v.mappings.defToInstancesRef).map(N=>Wn(N,v.graph,v.mappings.instanceToDefRef,v.mappings.outcomeToParentRef??new Map));o(S),s(C),f()},[r,x,E,p,y,d,i,u,o,s,h,f]);return{reset:b,getWorkflowState:T,hydrateWorkflow:w}}const ao=[],io=[];function co(n){const e=a.useRef(new ye),[t,o]=a.useState(0),s=ut(),[r,c,l]=at(ao),[h,f,x]=it(io),E=a.useRef([]);E.current=r;const{getNode:p,getNodes:y}=ve(),d=Et(e,{edgeToTransitionRef:s.edgeToTransitionRef,transitionToEdgesRef:s.transitionToEdgesRef}),i=yt(e,s.defToInstancesRef),u=bt({instanceToDefRef:s.instanceToDefRef,setNodes:c,getNodes:y}),m=(n==null?void 0:n.graphRef)??e,b=n?n.incrementGraphVersion:()=>o(Ne=>Ne+1),T=(n==null?void 0:n.nodes)??r,w=(n==null?void 0:n.edges)??h,v=(n==null?void 0:n.setNodes)??c,S=(n==null?void 0:n.setEdges)??f,B=(n==null?void 0:n.onNodesChangeInternal)??l,C=(n==null?void 0:n.onEdgesChangeInternal)??x,N=(n==null?void 0:n.nodesRef)??E,$=(n==null?void 0:n.instanceMapping)??s,{instanceToDefRef:R,defToInstancesRef:P,edgeToTransitionRef:z,transitionToEdgesRef:O}=$,k=(n==null?void 0:n.edgeTransitionManager)??d,I=(n==null?void 0:n.commandEdgeResolver)??i,D=(n==null?void 0:n.outcomeManagement)??u,W=a.useMemo(()=>w.map(Ne=>({...Ne,reconnectable:Ne.selected??!1})),[w]),{outcomeToParentRef:L,policyToOutcomesRef:F,outcomeToTransitionRef:G}=D,X={nodes:T,edges:w,setNodes:v,setEdges:S,onNodesChangeInternal:B,onEdgesChangeInternal:C,graphRef:m,graph:m.current,getNode:p,nodesRef:N,instanceMapping:$,instanceToDefRef:R,defToInstancesRef:P,edgeToTransitionRef:z,transitionToEdgesRef:O,outcomeManagement:D,edgeTransitionManager:k,commandEdgeResolver:I,incrementGraphVersion:b},{onNodesChange:H,onEdgesChange:U,onConnect:K,onReconnect:J,isValidConnection:Z}=to(X),{addNode:_,addInstance:M,duplicateInstance:V,dissociateInstance:Q,deleteInstance:te,deleteDefinition:ue}=no(X),{getDefinitionForInstance:Ee,getInstancesForDefinition:he,isOriginalInstance:pe,updateNodeExecutionMode:q,updateNodeLabel:fe,updateNodeConfig:ne,updateNodeAwsExtension:se,getNodeConfig:Te,getNodeAwsExtension:It,convertNodeKind:St}=oo(X),{getOutcomeTransition:At,getOutcomesForPolicy:Rt,getOutcomesWithLabels:Pt,addOutcomeToPolicy:Ot,deleteOutcome:Dt,updateOutcomeLabel:jt}=so(X),{reset:Lt,getWorkflowState:Ft,hydrateWorkflow:zt}=ro(X),$t=a.useMemo(()=>e.current,[t]),Wt=(n==null?void 0:n.graph)??$t;return{nodes:T,edges:W,graph:Wt,onNodesChange:H,onEdgesChange:U,onConnect:K,isValidConnection:Z,onReconnect:J,addNode:_,addInstance:M,duplicateInstance:V,dissociateInstance:Q,deleteInstance:te,deleteDefinition:ue,getDefinitionForInstance:Ee,getInstancesForDefinition:he,isOriginalInstance:pe,updateNodeExecutionMode:q,updateNodeLabel:fe,updateNodeConfig:ne,updateNodeAwsExtension:se,getNodeConfig:Te,getNodeAwsExtension:It,convertNodeKind:St,reset:Lt,getWorkflowState:Ft,hydrateWorkflow:zt,getOutcomeTransition:At,getOutcomesForPolicy:Rt,getOutcomesWithLabels:Pt,addOutcomeToPolicy:Ot,deleteOutcome:Dt,updateOutcomeLabel:jt}}const lo=[],uo=[];function fo(){const n=a.useRef(new ye),[e,t]=a.useState(0),o=ut(),{instanceToDefRef:s,defToInstancesRef:r,edgeToTransitionRef:c,transitionToEdgesRef:l}=o,[h,f,x]=at(lo),[E,p,y]=it(uo),d=a.useRef([]);d.current=h;const i=a.useMemo(()=>E.map(P=>({...P,reconnectable:P.selected??!1})),[E]),{getNode:u,getNodes:m}=ve(),b=Et(n,{edgeToTransitionRef:c,transitionToEdgesRef:l}),T=yt(n,r),w=bt({instanceToDefRef:s,setNodes:f,getNodes:m}),{outcomeToParentRef:v,policyToOutcomesRef:S,outcomeToTransitionRef:B,resetMappings:C}=w,N=a.useCallback(()=>{t(P=>P+1)},[]),$=a.useCallback(()=>{n.current=new ye,o.resetMappings(),C(),f([]),p([]),t(P=>P+1)},[f,p,o,C]),R=a.useMemo(()=>n.current,[e]);return{nodes:h,edges:E,edgesWithReconnectable:i,setNodes:f,setEdges:p,onNodesChangeInternal:x,onEdgesChangeInternal:y,graphRef:n,graph:R,getNode:u,getNodes:m,nodesRef:d,instanceMapping:o,instanceToDefRef:s,defToInstancesRef:r,edgeToTransitionRef:c,transitionToEdgesRef:l,outcomeManagement:w,outcomeToParentRef:v,policyToOutcomesRef:S,outcomeToTransitionRef:B,edgeTransitionManager:b,commandEdgeResolver:T,incrementGraphVersion:N,reset:$}}const wt=a.createContext(null);function go({children:n}){const e=fo();return g.jsx(wt.Provider,{value:e,children:n})}function mo(){const n=a.useContext(wt);if(!n)throw new Error("useWorkflowCoreContext must be used within a WorkflowCoreProvider");return n}const vt=a.createContext(null);function ho({children:n}){const e=mo(),t=co(e);return g.jsx(vt.Provider,{value:t,children:n})}function Ts({children:n}){return g.jsx(go,{children:g.jsx(ho,{children:n})})}function Fe(){const n=a.useContext(vt);if(!n)throw new Error("useWorkflow must be used within a WorkflowProvider");return n}function po(n){const e=a.useRef(null),[t,o]=a.useState(null),[s,r]=a.useState([]),[c,l]=a.useState(!1);a.useEffect(()=>{const d=new Dn(n,{transitionDelay:1e3});e.current=d;const i=(m,b)=>{const T={id:`${Date.now()}-${Math.random()}`,type:m,timestamp:b.timestamp,data:b};r(w=>[...w,T]),o(d.getState())},u=[d.on("simulation:start",m=>{i("simulation:start",m),l(!0)}),d.on("simulation:stop",m=>{i("simulation:stop",m),l(!1)}),d.on("simulation:reset",m=>{i("simulation:reset",m),l(!1)}),d.on("node:enter",m=>i("node:enter",m)),d.on("node:active",m=>i("node:active",m)),d.on("node:waiting",m=>i("node:waiting",m)),d.on("node:exit",m=>i("node:exit",m)),d.on("node:complete",m=>i("node:complete",m)),d.on("node:reset",m=>i("node:reset",m)),d.on("transition:start",m=>i("transition:start",m)),d.on("transition:complete",m=>i("transition:complete",m)),d.on("transition:reset",m=>i("transition:reset",m)),d.on("error",m=>i("error",m)),d.on("state:initialized",()=>{o(d.getState())})];return queueMicrotask(()=>{o(d.getState())}),()=>{u.forEach(m=>m()),d.stop(),e.current=null}},[n]);const h=a.useCallback(()=>{var d;(d=e.current)==null||d.start()},[]),f=a.useCallback(()=>{var d;(d=e.current)==null||d.stop()},[]),x=a.useCallback(()=>{var d;(d=e.current)==null||d.reset(),r([])},[]),E=a.useCallback(d=>{var i;(i=e.current)==null||i.triggerNode(d)},[]),p=a.useCallback(d=>{var i;(i=e.current)==null||i.selectTransition(d)},[]),y=a.useCallback(d=>{var i;(i=e.current)==null||i.completeManualNode(d)},[]);return{isRunning:c,state:t,events:s,start:h,stop:f,reset:x,triggerNode:E,selectTransition:p,completeManualNode:y}}const Tt=a.createContext(null);function Ns({children:n}){const{graph:e}=Fe(),t=po(e);return g.jsx(Tt.Provider,{value:t,children:n})}function xo(){const n=a.useContext(Tt);if(!n)throw new Error("useSimulationContext must be used within a SimulationProvider");return n}const Nt=a.createContext(null);function ks({children:n}){const[e,t]=a.useState(null),[o,s]=a.useState(null),r=a.useCallback(h=>{t(h)},[]),c=a.useCallback(()=>{t(null)},[]),l={pendingTooltip:e,hoveredWarningEdgeId:o,showTooltip:r,hideTooltip:c,setHoveredWarningEdgeId:s};return g.jsx(Nt.Provider,{value:l,children:n})}function kt(){const n=a.useContext(Nt);if(!n)throw new Error("useNonStandardConnectionContext must be used within a NonStandardConnectionProvider");return n}function bo(){const n=xe(o=>o.theme),e=xe(o=>o.setTheme),t=xe(o=>o.toggleTheme);return{theme:n,setTheme:e,toggleTheme:t}}function Eo({pathRef:n,edgeId:e,onOffsetChange:t}){const[o,s]=a.useState(!1),r=a.useRef(!1),c=a.useCallback(l=>{l.stopPropagation(),l.preventDefault(),r.current=!1,s(!0)},[]);return a.useEffect(()=>{if(!o||!n.current)return;const l=f=>{var m;if(!n.current)return;r.current=!0;const x=n.current.ownerSVGElement;if(!x)return;const E=x.createSVGPoint();E.x=f.clientX,E.y=f.clientY;const p=E.matrixTransform((m=x.getScreenCTM())==null?void 0:m.inverse()),y=n.current.getTotalLength();let d=.5,i=1/0;for(let b=0;b<=100;b++){const T=b/100,w=n.current.getPointAtLength(y*T),v=Math.sqrt(Math.pow(w.x-p.x,2)+Math.pow(w.y-p.y,2));v<i&&(i=v,d=T)}const u=Math.max(.1,Math.min(.9,d));t(e,u)},h=()=>{s(!1)};return document.addEventListener("mousemove",l),document.addEventListener("mouseup",h),()=>{document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",h)}},[o,e,n,t]),{isDragging:o,hasDraggedRef:r,handleDragStart:c}}class yo{serialize(e){try{const{graph:t,nodes:o,edges:s,mappings:r}=e,c=t.getAllNodes().map(p=>({id:p.id,label:p.label,kind:p.kind,category:p.category,executionMode:p.executionMode,config:p.config,awsExtension:p.awsExtension})),l=t.getAllTransitions().map(p=>({id:p.id,sourceDefId:p.sourceDefId,targetDefId:p.targetDefId})),h=o.filter(p=>p.type!=="outcome").map(p=>({id:p.id,definitionId:r.instanceToDefRef.get(p.id),position:{x:p.position.x,y:p.position.y}})),f=o.filter(p=>p.type==="outcome").map(p=>({id:p.id,label:p.data.label||"Outcome",parentPolicyInstanceId:p.parentId,parentPolicyDefId:p.data.parentPolicyDefId||"",position:{x:p.position.x,y:p.position.y}})),x=r.outcomeToTransitionRef?Array.from(r.outcomeToTransitionRef.entries()).map(([p,y])=>({outcomeId:p,transitionId:y})):[],E=s.filter(p=>r.edgeToTransitionRef.has(p.id)).map(p=>{const y=p.data;return{edgeId:p.id,transitionId:r.edgeToTransitionRef.get(p.id),source:p.source,target:p.target,sourceHandle:p.sourceHandle??void 0,targetHandle:p.targetHandle??void 0,label:y==null?void 0:y.label,labelOffset:y==null?void 0:y.labelOffset}});return{success:!0,workflow:{definitions:c,transitions:l,instances:h,edgeMappings:E,outcomes:f,outcomeEdgeMappings:x}}}catch(t){return{success:!1,error:{code:"VALIDATION_ERROR",message:"Failed to serialize workflow",details:t}}}}}class wo{recoverOrphanEdges(e,t,o,s){var y;const{instanceToDefRef:r,defToInstancesRef:c,edgeToTransitionRef:l,transitionToEdgesRef:h}=o,f=e.filter(d=>{const i=l.get(d.id);return i?t.getTransition(i)!==void 0:!1}),x=new Set(f.map(d=>d.id));for(const d of l.keys())if(!x.has(d)){const i=l.get(d);l.delete(d),i&&((y=h.get(i))==null||y.delete(d))}const E=new Set(l.values()),p=t.getAllTransitions().filter(d=>!E.has(d.id));for(const d of p){const i=this.createEdgeForTransition(d,t,r,c,s);i&&(f.push(i),l.set(i.id,d.id),h.has(d.id)||h.set(d.id,new Set),h.get(d.id).add(i.id))}return{edges:f,edgeToTransitionRef:l,transitionToEdgesRef:h}}createEdgeForTransition(e,t,o,s,r){const c=s.get(e.sourceDefId),l=s.get(e.targetDefId);if(!(c!=null&&c.size)||!(l!=null&&l.size))return null;const h=c.values().next().value,f=l.values().next().value,x=r.get(h),E=r.get(f);if(!x||!E)return null;const{sourceHandle:p,targetHandle:y}=$n(),d=`edge_${h}_${f}`,i=t.getNode(e.sourceDefId),u=t.getNode(e.targetDefId),m=i?mt(i.kind):"floating",b=Pe(i==null?void 0:i.kind,u==null?void 0:u.kind);return{id:d,source:h,target:f,sourceHandle:p,targetHandle:y,type:m,data:{state:"idle",transitionId:e.id,...b,...m==="commandEdge"?Re():{}}}}}class vo{constructor(){ee(this,"edgeRecovery",new wo)}deserialize(e){try{const t=new ye;for(const u of e.definitions){const m={id:u.id,label:u.label,kind:u.kind,category:u.category,executionMode:u.executionMode,config:u.config,awsExtension:u.awsExtension};t.addNode(m)}for(const u of e.transitions){const m={id:u.id,sourceDefId:u.sourceDefId,targetDefId:u.targetDefId};t.addTransition(m)}const o=new Map,s=new Map,r=e.instances.map(u=>{const m=u.id,b=u.definitionId,T=t.getNode(b);o.set(m,b),s.has(b)||s.set(b,new Set),s.get(b).add(m);let w="event";return T.kind==="policy"?w="policy":T.kind==="externalSystem"?w="externalSystem":T.kind==="externalEvent"?w="externalEvent":T.kind==="command"?w="command":T.kind==="trigger"?w="trigger":T.kind==="hotspot"&&(w="hotspot"),{id:u.id,type:w,position:u.position,data:{label:T.label,executionMode:T.executionMode,definitionId:b}}}),c=new Map,l=new Map,h=new Map;if(e.outcomes)for(const u of e.outcomes){const m=u.id,b=u.parentPolicyInstanceId,T=u.parentPolicyDefId;c.set(m,b),l.has(b)||l.set(b,new Set),l.get(b).add(m),r.push({id:u.id,type:"outcome",position:u.position,parentId:u.parentPolicyInstanceId,data:{label:u.label,parentPolicyInstanceId:b,parentPolicyDefId:T}})}if(e.outcomeEdgeMappings)for(const u of e.outcomeEdgeMappings)h.set(u.outcomeId,u.transitionId);const f=new Map,x=new Map,E=e.edgeMappings.map(u=>{const m=u.transitionId,b=`edge_${u.source}_${u.target}`;f.set(b,m),x.has(m)||x.set(m,new Set),x.get(m).add(b);const T=c.has(u.source);let w;if(T){const B=c.get(u.source);w=B?o.get(B):void 0}else w=o.get(u.source);const v=w?t.getNode(w):void 0,S=v?mt(v.kind):"floating";return{id:b,source:u.source,target:u.target,sourceHandle:u.sourceHandle??"source-right",targetHandle:u.targetHandle??"target-left",type:S,data:{state:"idle",transitionId:m,...u.label!==void 0?{label:u.label}:{},...u.labelOffset!==void 0?{labelOffset:u.labelOffset}:{}}}}),p=new Map(r.map(u=>[u.id,u])),y={instanceToDefRef:o,defToInstancesRef:s,edgeToTransitionRef:f,transitionToEdgesRef:x,outcomeToParentRef:c,policyToOutcomesRef:l,outcomeToTransitionRef:h},d=this.edgeRecovery.recoverOrphanEdges(E,t,y,p),i={instanceToDefRef:o,defToInstancesRef:s,edgeToTransitionRef:d.edgeToTransitionRef,transitionToEdgesRef:d.transitionToEdgesRef,outcomeToParentRef:c,policyToOutcomesRef:l,outcomeToTransitionRef:h};return{success:!0,workflow:{graph:t,nodes:r,edges:d.edges,mappings:i}}}catch(t){return{success:!1,error:{code:"VALIDATION_ERROR",message:"Failed to deserialize workflow",details:t}}}}}class To{constructor(){ee(this,"serialization",new yo);ee(this,"deserialization",new vo)}serialize(e){return this.serialization.serialize(e)}deserialize(e){return this.deserialization.deserialize(e)}}const be=new Map,No=n=>{const e=n.workflow,t=new Set(e.definitions.filter(c=>c.kind==="command"&&c.label.trim()==="").map(c=>c.id));if(t.size===0)return n;const o=new Set(e.transitions.filter(c=>t.has(c.sourceDefId)).map(c=>c.id)),s=new Set(e.instances.filter(c=>t.has(c.definitionId)).map(c=>c.id)),r=new Set(e.edgeMappings.filter(c=>o.has(c.transitionId)||s.has(c.source)||s.has(c.target)).map(c=>c.edgeId));return{...n,workflow:{...e,definitions:e.definitions.filter(c=>!t.has(c.id)),transitions:e.transitions.filter(c=>!o.has(c.id)),instances:e.instances.filter(c=>!s.has(c.id)),edgeMappings:e.edgeMappings.filter(c=>!r.has(c.edgeId))}}},ko=n=>{const e=n.metadata.name.toLowerCase().trim().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-");return{...n,metadata:{...n.metadata,slugName:e}}},Co=n=>{const t=n.metadata.targetPlugin==="none"?void 0:n.metadata.targetPlugin;return{...n,metadata:{...n.metadata,targetPlugin:t}}},_o=n=>({...n,metadata:{...n.metadata,pluginConfig:{}}}),Mo=n=>({...n,workflow:{...n.workflow,definitions:n.workflow.definitions.map(e=>({...e,kind:e.kind==="externalSystem"?"externalEvent":e.kind}))}});be.set(2,No);be.set(3,ko);be.set(4,Co);be.set(5,_o);be.set(6,Mo);class Io{migrate(e){try{let t=e;for(;t.version<Se;){const o=be.get(t.version);if(!o)return{success:!1,error:{code:"MIGRATION_ERROR",message:`No migration found for version ${t.version}`}};t=o(t),t={...t,version:t.version+1}}return{success:!0,document:t}}catch(t){return{success:!1,error:{code:"MIGRATION_ERROR",message:"Migration failed",details:t}}}}validate(e){if(!e.version||typeof e.version!="number"||!e.metadata||!e.workflow||!Array.isArray(e.workflow.definitions)||!Array.isArray(e.workflow.transitions)||!Array.isArray(e.workflow.instances)||!Array.isArray(e.workflow.edgeMappings))return!1;for(const t of e.workflow.definitions)if(!t.id.startsWith("def_"))return!1;for(const t of e.workflow.transitions)if(!t.id.startsWith("trans_"))return!1;for(const t of e.workflow.instances)if(!t.id.startsWith("inst_"))return!1;return!0}}const Me="arko:workflow";class So{async save(e){try{const t=JSON.stringify(e);return localStorage.setItem(Me,t),{success:!0}}catch(t){return{success:!1,error:{code:"STORAGE_ERROR",message:"Failed to save to localStorage",details:t}}}}async load(){try{const e=localStorage.getItem(Me);return e?{success:!0,document:JSON.parse(e)}:{success:!1,error:{code:"NOT_FOUND",message:"No workflow found in localStorage"}}}catch(e){return{success:!1,error:{code:"PARSE_ERROR",message:"Failed to parse stored workflow",details:e}}}}async exists(){return localStorage.getItem(Me)!==null}async clear(){try{return localStorage.removeItem(Me),{success:!0}}catch(e){return{success:!1,error:{code:"STORAGE_ERROR",message:"Failed to clear localStorage",details:e}}}}}const Ao="1.0",Ro="https://arko.dev/ir/v1.json",Po={id:"serverless-aws-ts",name:"Serverless / TypeScript / AWS",description:"AWS Lambda with TypeScript and Serverless Framework",nodeExtensions:{command:{timeout:30,memory:128},trigger:{timeout:30,memory:128}}},Oo={id:"serverless-aws-php",name:"Serverless / PHP / AWS (Bref)",description:"AWS Lambda with PHP 8.3 and Bref.sh",nodeExtensions:{command:{timeout:30,memory:128},trigger:{timeout:30,memory:128}}},Ct=new Map([["serverless-aws-ts",Po],["serverless-aws-php",Oo]]);function Do(n){return Ct.get(n)}function Cs(){return Array.from(Ct.values())}class jo{compile(e,t){try{const{graph:o,nodes:s,mappings:r}=e,c=t.metadata.targetPlugin?Do(t.metadata.targetPlugin):void 0,l=c?this.getExtensionProviderForPlugin(c.id):void 0,h=o.getAllNodes(),f=[],x=[],E=[],p=[];for(const b of h)switch(b.kind){case"event":f.push(b);break;case"command":x.push(b);break;case"trigger":E.push(b);break;case"policy":p.push(b);break}const y=this.buildEventTypeMap(f),d=this.compileEvents(f,y),i=this.compilePolicies(p,o,s,r,y),u=this.compileCommands(x,E,o,y,i,l);return{success:!0,ir:{$schema:Ro,version:Ao,metadata:{workflowId:_n(),name:t.metadata.name,slugName:t.metadata.slugName||ae(t.metadata.name),targetPlugin:t.metadata.targetPlugin,generatedAt:new Date().toISOString(),sourceVersion:6,pluginConfig:t.metadata.pluginConfig},events:d,commands:u,policies:i}}}catch(o){return{success:!1,error:{code:"COMPILATION_ERROR",message:o instanceof Error?o.message:"Unknown compilation error",details:o}}}}getExtensionProviderForPlugin(e){if(e==="serverless-aws-ts")return{getExtensions(t,o){if(!(t.kind!=="command"&&t.kind!=="trigger")&&o)return{aws:{timeout:o.timeout,memory:o.memory}}}}}buildEventTypeMap(e){const t=new Map;for(const o of e){const s=o.config,r=(s==null?void 0:s.type)||je(o.label);t.set(o.id,r)}return t}compileEvents(e,t){return e.map(o=>{const s=o.config;return{id:ge(o.id),name:o.label,type:t.get(o.id),schema:s!=null&&s.schema?this.convertSchema(s.schema):null,outputPath:s==null?void 0:s.outputPath}})}compilePolicies(e,t,o,s,r){return e.map(c=>{var y,d,i,u;const h=t.getIncomingTransitions(c.id).map(m=>r.get(m.sourceDefId)).filter(m=>m!==void 0),f=s.defToInstancesRef.get(c.id),x=f==null?void 0:f.values().next().value,E=x?(y=s.policyToOutcomesRef)==null?void 0:y.get(x):void 0,p=[];if(E){const m=c.config;for(const b of E){const T=o.find(C=>C.id===b),w=((d=T==null?void 0:T.data)==null?void 0:d.label)||"Outcome",v=(i=m==null?void 0:m.outcomeConditions)==null?void 0:i.find(C=>C.outcomeLabel===w),S=(u=s.outcomeToTransitionRef)==null?void 0:u.get(b),B=[];if(S){const C=t.getTransition(S);if(C){const N=t.getNode(C.targetDefId);N&&(N.kind==="command"||N.kind==="trigger")&&B.push(ge(N.id))}}p.push({id:ge(b),label:w,condition:(v==null?void 0:v.condition)||"",targetCommandIds:B})}}return{id:ge(c.id),name:c.label,slugName:ae(c.label),consumes:h,outcomes:p}})}compileCommands(e,t,o,s,r,c){const l=[];for(const h of e){const f=this.compileCommand(h,o,s,r,c);l.push(f)}for(const h of t){const f=this.compileTriggerAsCommand(h,o,s,c);f&&l.push(f)}return l}compileCommand(e,t,o,s,r){const c=e.config,h=t.getOutgoingTransitions(e.id).map(E=>o.get(E.targetDefId)).filter(E=>E!==void 0),f=this.buildConsumptions(e.id,t,o,s),x=r==null?void 0:r.getExtensions(e,e.awsExtension);return{id:ge(e.id),name:e.label,slugName:(c==null?void 0:c.slugName)||ae(e.label,"unnamed"),produces:h,trigger:"consumer",consumes:f,requestSchema:c!=null&&c.requestSchema?this.convertSchema(c.requestSchema):null,extensions:x,outputPath:c==null?void 0:c.outputPath}}compileTriggerAsCommand(e,t,o,s){const r=e.config,l=t.getOutgoingTransitions(e.id).map(E=>o.get(E.targetDefId)).filter(E=>E!==void 0),h=s==null?void 0:s.getExtensions(e,e.awsExtension),f={id:ge(e.id),name:e.label,slugName:(r==null?void 0:r.slugName)||ae(e.label),produces:l,extensions:h,outputPath:r==null?void 0:r.outputPath};if((r==null?void 0:r.triggerType)==="schedule"&&r.schedule)return{...f,trigger:"scheduled",schedule:r.schedule};const x=(r==null?void 0:r.path)||`/${ae(e.label)}`;return{...f,trigger:"http",http:{method:(r==null?void 0:r.httpMethod)||"POST",path:x,pathParameters:Cn(x)},requestSchema:r!=null&&r.schema?this.convertSchema(r.schema):null}}buildConsumptions(e,t,o,s){const r=[],c=t.getIncomingTransitions(e);for(const l of c){const h=t.getNode(l.sourceDefId);if(h){if(h.kind==="event"){const f=o.get(h.id);f&&r.push({type:"event",eventType:f})}else if(h.kind==="policy"){const f=s.find(x=>x.id===ge(h.id));if(f){const x=f.outcomes.find(E=>E.targetCommandIds.includes(ge(e)));x&&r.push({type:"policy",policyId:f.id,outcomeId:x.id})}}}}return r}convertSchema(e){return{properties:e.map(t=>this.convertSchemaProperty(t))}}convertSchemaProperty(e){const t={name:e.name,required:e.required??!1};return e.type==="array"&&e.items?{...t,type:"array",items:{properties:[this.convertSchemaProperty(e.items)]}}:e.type==="object"&&e.properties?{...t,type:"object",nested:this.convertSchema(e.properties)}:{...t,type:e.type}}}const We={version:7,metadata:{name:"E-commerce Order",slugName:"ecommerce-order",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),description:"Example workflow demonstrating an e-commerce order flow with stock checking"},workflow:{definitions:[{id:"def_01EXAMPLE_TRIGGER",label:"Order Received",kind:"trigger",category:"technical",executionMode:"manual",config:{slugName:"order-received",triggerType:"http",httpMethod:"POST",path:"/orders"}},{id:"def_01EXAMPLE_CMD_CREATE",label:"Create Order",kind:"command",category:"business",executionMode:"automatic",config:{slugName:"create-order"}},{id:"def_01EXAMPLE_EVT_CREATED",label:"Order Created",kind:"event",category:"business",executionMode:"automatic",config:{type:"order.created"}},{id:"def_01EXAMPLE_POLICY",label:"Check Stock",kind:"policy",category:"business",executionMode:"manual",config:{type:"check-stock",outcomeConditions:[{outcomeLabel:"In Stock",condition:"item.quantity > 0"},{outcomeLabel:"Out of Stock",condition:"item.quantity === 0"}]}},{id:"def_01EXAMPLE_CMD_PAYMENT",label:"Process Payment",kind:"command",category:"business",executionMode:"automatic",config:{slugName:"process-payment"}},{id:"def_01EXAMPLE_CMD_NOTIFY",label:"Notify Out of Stock",kind:"command",category:"business",executionMode:"automatic",config:{slugName:"notify-out-of-stock"}},{id:"def_01EXAMPLE_EVT_PAYMENT",label:"Payment Processed",kind:"event",category:"business",executionMode:"automatic",config:{type:"payment.processed"}},{id:"def_01EXAMPLE_EVT_NOTIFIED",label:"Customer Notified",kind:"event",category:"business",executionMode:"automatic",config:{type:"customer.notified"}}],transitions:[{id:"trans_01EXAMPLE_T1",sourceDefId:"def_01EXAMPLE_TRIGGER",targetDefId:"def_01EXAMPLE_CMD_CREATE"},{id:"trans_01EXAMPLE_T2",sourceDefId:"def_01EXAMPLE_CMD_CREATE",targetDefId:"def_01EXAMPLE_EVT_CREATED"},{id:"trans_01EXAMPLE_T3",sourceDefId:"def_01EXAMPLE_EVT_CREATED",targetDefId:"def_01EXAMPLE_POLICY"},{id:"trans_01EXAMPLE_T4",sourceDefId:"def_01EXAMPLE_POLICY",targetDefId:"def_01EXAMPLE_CMD_PAYMENT"},{id:"trans_01EXAMPLE_T5",sourceDefId:"def_01EXAMPLE_POLICY",targetDefId:"def_01EXAMPLE_CMD_NOTIFY"},{id:"trans_01EXAMPLE_T6",sourceDefId:"def_01EXAMPLE_CMD_PAYMENT",targetDefId:"def_01EXAMPLE_EVT_PAYMENT"},{id:"trans_01EXAMPLE_T7",sourceDefId:"def_01EXAMPLE_CMD_NOTIFY",targetDefId:"def_01EXAMPLE_EVT_NOTIFIED"}],instances:[{id:"inst_01EXAMPLE_TRIGGER",definitionId:"def_01EXAMPLE_TRIGGER",position:{x:100,y:300}},{id:"inst_01EXAMPLE_CMD_CREATE",definitionId:"def_01EXAMPLE_CMD_CREATE",position:{x:320,y:300}},{id:"inst_01EXAMPLE_EVT_CREATED",definitionId:"def_01EXAMPLE_EVT_CREATED",position:{x:540,y:300}},{id:"inst_01EXAMPLE_POLICY",definitionId:"def_01EXAMPLE_POLICY",position:{x:760,y:300}},{id:"inst_01EXAMPLE_CMD_PAYMENT",definitionId:"def_01EXAMPLE_CMD_PAYMENT",position:{x:1100,y:180}},{id:"inst_01EXAMPLE_CMD_NOTIFY",definitionId:"def_01EXAMPLE_CMD_NOTIFY",position:{x:1100,y:420}},{id:"inst_01EXAMPLE_EVT_PAYMENT",definitionId:"def_01EXAMPLE_EVT_PAYMENT",position:{x:1320,y:180}},{id:"inst_01EXAMPLE_EVT_NOTIFIED",definitionId:"def_01EXAMPLE_EVT_NOTIFIED",position:{x:1320,y:420}}],edgeMappings:[{edgeId:"edge_01EXAMPLE_E1",transitionId:"trans_01EXAMPLE_T1",source:"inst_01EXAMPLE_TRIGGER",target:"inst_01EXAMPLE_CMD_CREATE"},{edgeId:"edge_01EXAMPLE_E2",transitionId:"trans_01EXAMPLE_T2",source:"inst_01EXAMPLE_CMD_CREATE",target:"inst_01EXAMPLE_EVT_CREATED"},{edgeId:"edge_01EXAMPLE_E3",transitionId:"trans_01EXAMPLE_T3",source:"inst_01EXAMPLE_EVT_CREATED",target:"inst_01EXAMPLE_POLICY"},{edgeId:"edge_01EXAMPLE_E4",transitionId:"trans_01EXAMPLE_T4",source:"outcome_01EXAMPLE_INSTOCK",target:"inst_01EXAMPLE_CMD_PAYMENT"},{edgeId:"edge_01EXAMPLE_E5",transitionId:"trans_01EXAMPLE_T5",source:"outcome_01EXAMPLE_OUTSTOCK",target:"inst_01EXAMPLE_CMD_NOTIFY"},{edgeId:"edge_01EXAMPLE_E6",transitionId:"trans_01EXAMPLE_T6",source:"inst_01EXAMPLE_CMD_PAYMENT",target:"inst_01EXAMPLE_EVT_PAYMENT"},{edgeId:"edge_01EXAMPLE_E7",transitionId:"trans_01EXAMPLE_T7",source:"inst_01EXAMPLE_CMD_NOTIFY",target:"inst_01EXAMPLE_EVT_NOTIFIED"}],outcomes:[{id:"outcome_01EXAMPLE_INSTOCK",label:"In Stock",parentPolicyInstanceId:"inst_01EXAMPLE_POLICY",parentPolicyDefId:"def_01EXAMPLE_POLICY",position:{x:162,y:-30}},{id:"outcome_01EXAMPLE_OUTSTOCK",label:"Out of Stock",parentPolicyInstanceId:"inst_01EXAMPLE_POLICY",parentPolicyDefId:"def_01EXAMPLE_POLICY",position:{x:162,y:100}}],outcomeEdgeMappings:[{outcomeId:"outcome_01EXAMPLE_INSTOCK",transitionId:"trans_01EXAMPLE_T4"},{outcomeId:"outcome_01EXAMPLE_OUTSTOCK",transitionId:"trans_01EXAMPLE_T5"}]}},Ie="Untitled Workflow",Lo=1e3,_t="arko:workflows";function ce(n){return n.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"workflow"}function nt(){try{const n=localStorage.getItem(_t);return n?JSON.parse(n):[]}catch{return[]}}function Fo(n){try{localStorage.setItem(_t,JSON.stringify(n))}catch(e){console.error("Failed to save workflows to localStorage:",e)}}const zo=a.createContext(null);function _s({children:n,initialWorkflowId:e}){const t=Fe(),[o,s]=a.useState(!0),[r,c]=a.useState(null),[l,h]=a.useState(Ie),[f,x]=a.useState(()=>ce(Ie)),[E,p]=a.useState(void 0),[y,d]=a.useState({}),[i,u]=a.useState(null),[m,b]=a.useState(null),[T,w]=a.useState(!1),v=a.useRef(null),S=a.useCallback(_=>{h(M=>(x(V=>V===ce(M)?ce(_):V),_))},[]),B=a.useCallback(_=>{x(_)},[]),C=a.useRef(new To),N=a.useRef(new Io),$=a.useRef(new So),R=a.useRef(new Vt),P=a.useRef(new jo),z=a.useRef(void 0),O=a.useRef(!1),k=a.useRef(!1),I=a.useCallback(_=>{const M=C.current.deserialize(_.workflow);return M.success?(t.hydrateWorkflow(M.workflow),h(_.metadata.name),x(_.metadata.slugName||ce(_.metadata.name)),p(_.metadata.targetPlugin),d(_.metadata.pluginConfig??{}),u(_.metadata.createdAt),!0):!1},[t]);a.useEffect(()=>{(async()=>{try{const M=await $.current.load();if(M.success){if(!N.current.validate(M.document)){console.warn("Invalid workflow document in localStorage, loading example instead"),I(We),s(!1);return}const V=N.current.migrate(M.document);V.success&&I(V.document)}else console.info("No saved workflow found, loading example workflow"),I(We)}catch(M){console.error("Failed to load workflow from localStorage:",M),I(We)}finally{s(!1)}})()},[]);const D=a.useCallback(async()=>{const _=t.getWorkflowState(),M=C.current.serialize(_);if(!M.success)return{success:!1,error:M.error};const V=new Date().toISOString(),Q={version:Se,metadata:{name:l,slugName:f,targetPlugin:E,pluginConfig:y,createdAt:i||V,updatedAt:V},workflow:M.workflow};return i||u(V),$.current.save(Q)},[t,l,f,E,y,i]),{nodes:W,edges:L}=t;a.useEffect(()=>{if(!o){if(!O.current){O.current=!0;return}return z.current&&clearTimeout(z.current),z.current=setTimeout(()=>{D()},Lo),()=>{z.current&&clearTimeout(z.current)}}},[W,L,l,f,E,y,D,o]);const F=a.useCallback(()=>{const _=t.getWorkflowState(),M=C.current.serialize(_);if(!M.success)return{success:!1,error:M.error};const V=new Date().toISOString(),Q={version:Se,metadata:{name:l,slugName:f,targetPlugin:E,pluginConfig:y,createdAt:i||V,updatedAt:V},workflow:M.workflow},te=`${f||ce(l)}.json`;return R.current.exportToFile(Q,te)},[t,l,f,E,y,i]),G=a.useCallback(()=>{const _=t.getWorkflowState(),M=new Date().toISOString();return P.current.compile(_,{metadata:{name:l,slugName:f||ce(l),targetPlugin:E,pluginConfig:y,createdAt:i||M,updatedAt:M}})},[t,l,f,E,y,i]),X=a.useCallback(()=>{const _=t.getWorkflowState(),M=C.current.serialize(_);if(!M.success)throw new Error(M.error.message);const V=new Date().toISOString();return{version:Se,metadata:{name:l,slugName:f||ce(l),targetPlugin:E,pluginConfig:y,createdAt:i||V,updatedAt:V},workflow:M.workflow}},[t,l,f,E,y,i]),H=a.useCallback(async()=>{const _=await R.current.importFromFile();if(!_.success)return _;if(!N.current.validate(_.document))return{success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid workflow file format"}};const M=N.current.migrate(_.document);if(!M.success)return{success:!1,error:M.error};const V=C.current.deserialize(M.document.workflow);return V.success?(t.hydrateWorkflow(V.workflow),h(M.document.metadata.name),x(M.document.metadata.slugName||ce(M.document.metadata.name)),p(M.document.metadata.targetPlugin),d(M.document.metadata.pluginConfig??{}),u(M.document.metadata.createdAt),await $.current.save(M.document),{success:!0,document:M.document}):{success:!1,error:V.error}},[t]),U=a.useCallback(async()=>(h(Ie),x(ce(Ie)),p(void 0),d({}),u(null),b(null),w(!1),v.current=null,$.current.clear()),[]),K=a.useCallback(_=>JSON.stringify({workflow:_.workflow,name:_.metadata.name,slugName:_.metadata.slugName,targetPlugin:_.metadata.targetPlugin,pluginConfig:_.metadata.pluginConfig}),[]),J=a.useCallback(async()=>{const _=X();try{const M=nt(),V=new Date().toISOString();if(m){const Q=M.findIndex(te=>te.id===m);Q!==-1&&(M[Q]={...M[Q],document:_,updatedAt:V})}else console.warn("saveToApi called without currentWorkflowId");return Fo(M),v.current=K(_),w(!1),{success:!0}}catch(M){return{success:!1,error:{code:"STORAGE_ERROR",message:M instanceof Error?M.message:"Failed to save workflow"}}}},[X,m,K]),Z=a.useCallback(async _=>{try{const V=nt().find(ue=>ue.id===_);if(!V)return{success:!1,error:{code:"NOT_FOUND",message:"Workflow not found"}};if(!N.current.validate(V.document))return{success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid workflow document"}};const Q=N.current.migrate(V.document);return Q.success?I(Q.document)?(b(V.id),v.current=K(Q.document),w(!1),await $.current.save(Q.document),{success:!0,document:Q.document}):{success:!1,error:{code:"PARSE_ERROR",message:"Failed to hydrate workflow"}}:{success:!1,error:Q.error}}catch(M){return{success:!1,error:{code:"STORAGE_ERROR",message:M instanceof Error?M.message:"Failed to load workflow"}}}},[I,K]);return a.useEffect(()=>{if(o||v.current!==null||m!==null)return;const _=X();v.current=K(_)},[o,m,X,K]),a.useEffect(()=>{if(o||!O.current||v.current===null)return;const _=X(),M=K(_);w(M!==v.current)},[W,L,l,f,E,y,o,X,K]),a.useEffect(()=>{o||e&&!k.current&&(k.current=!0,s(!0),c(null),Z(e).then(_=>{_.success||(console.error("Failed to load workflow from URL:",_.error.message),c(_.error))}).finally(()=>{s(!1)}))},[o,e,Z]),g.jsx(zo.Provider,{value:{isLoading:o,loadError:r,workflowName:l,setWorkflowName:S,slugName:f,setSlugName:B,targetPlugin:E,setTargetPlugin:p,pluginConfig:y,setPluginConfig:d,saveToLocalStorage:D,exportToFile:F,exportToIR:G,getWorkflowDocument:X,importFromFile:H,clearStorage:U,currentWorkflowId:m,isDirty:T,saveToApi:J,loadFromApi:Z,hydrateDocument:I},children:n})}function Ms({open:n,onOpenChange:e,onConfirm:t,title:o,description:s,confirmLabel:r="Confirmer",cancelLabel:c="Annuler"}){const l=()=>{t(),e(!1)};return g.jsx(Gt,{open:n,onOpenChange:e,children:g.jsxs(Ht,{children:[g.jsxs(Ut,{children:[g.jsx(qt,{children:o}),g.jsx(Yt,{children:s})]}),g.jsxs(Kt,{children:[g.jsx(Qt,{children:c}),g.jsx(Jt,{onClick:l,children:r})]})]})})}const Mt=10,Oe=50;function $o(n,e){const t=a.useRef([]);return a.useEffect(()=>()=>{t.current.forEach(clearTimeout)},[]),{execute:a.useCallback((s,r)=>{const{isRunning:c,start:l,triggerNode:h,selectTransition:f}=n;if(t.current.forEach(clearTimeout),t.current=[],e!=null&&e.isSourceWaiting)f(r);else if(c){h(s);const x=setTimeout(()=>{f(r)},Oe);t.current.push(x)}else{l();const x=setTimeout(()=>{h(s);const E=setTimeout(()=>{f(r)},Oe);t.current.push(E)},Mt);t.current.push(x)}},[n,e==null?void 0:e.isSourceWaiting])}}function Is(n){const e=a.useRef([]);return a.useEffect(()=>()=>{e.current.forEach(clearTimeout)},[]),{execute:a.useCallback(o=>{const{isRunning:s,start:r,triggerNode:c,completeManualNode:l}=n;if(e.current.forEach(clearTimeout),e.current=[],s){c(o);const h=setTimeout(()=>{l(o)},Oe);e.current.push(h)}else{r();const h=setTimeout(()=>{c(o);const f=setTimeout(()=>{l(o)},Oe);e.current.push(f)},Mt);e.current.push(h)}},[n])}}function Wo({ref:n,onClose:e,enabled:t=!0,listenEscape:o=!0,listenClickOutside:s=!0}){a.useEffect(()=>{if(!t)return;const r=h=>{n.current&&!n.current.contains(h.target)&&e()},c=h=>{h.key==="Escape"&&e()},l=setTimeout(()=>{s&&document.addEventListener("mousedown",r),o&&document.addEventListener("keydown",c)},0);return()=>{clearTimeout(l),s&&document.removeEventListener("mousedown",r),o&&document.removeEventListener("keydown",c)}},[n,e,t,o,s])}function Ss(n,e=!0){a.useEffect(()=>{if(!e)return;const t=o=>{o.key==="Escape"&&n()};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[n,e])}function As(){const n=xe(o=>o.sidebarCollapsed),e=xe(o=>o.setSidebarCollapsed),t=xe(o=>o.toggleSidebar);return{collapsed:n,setCollapsed:e,toggleCollapsed:t}}const me={event:{gradient:"gradient-event",rotate:"rotate-event",selected:"node-selected-event",pulse:"animate-pulse-event"},command:{gradient:"gradient-command",rotate:"rotate-command",selected:"node-selected-command",pulse:"animate-pulse-command"},policy:{gradient:"gradient-policy",rotate:"rotate-policy",selected:"node-selected-policy",pulse:"animate-pulse-policy"},trigger:{gradient:"gradient-trigger",rotate:"rotate-trigger",selected:"node-selected-trigger",pulse:"animate-pulse-trigger"},externalSystem:{gradient:"gradient-external",rotate:"rotate-external-system",selected:"node-selected-external",pulse:"animate-pulse-external"},externalEvent:{gradient:"gradient-external",rotate:"rotate-external-event",selected:"node-selected-external",pulse:"animate-pulse-external"},hotspot:{gradient:"gradient-hotspot",rotate:"rotate-hotspot",selected:"node-selected-hotspot"}};function Xo({text:n,maxWidth:e,maxHeight:t,minFontSize:o=8,maxFontSize:s=18}){return a.useMemo(()=>{if(!n||e<=0||t<=0)return{fontSize:s};const r=document.createElement("div");r.style.cssText=`
      position: absolute;
      left: -9999px;
      top: -9999px;
      width: ${e}px;
      height: ${t}px;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
      font-weight: 400;
      line-height: 1.3;
      white-space: pre-wrap;
      word-wrap: break-word;
      text-align: center;
      box-sizing: border-box;
    `,r.textContent=n,document.body.appendChild(r);let c=o;for(let l=s;l>=o;l--){r.style.fontSize=`${l}px`;const h=r.scrollHeight<=r.clientHeight,f=r.scrollWidth<=r.clientWidth;if(h&&f){c=l;break}}return document.body.removeChild(r),{fontSize:c}},[n,e,t,o,s])}const Bo=128,Vo=78,ie=a.memo(a.forwardRef(function({value:e,onChange:t,className:o,placeholder:s="Label",maxWidth:r=Bo,maxHeight:c=Vo,minFontSize:l=8,maxFontSize:h=18,autoSize:f=!1,onEditEnd:x},E){const[p,y]=a.useState(!1),d=a.useRef(null),{fontSize:i}=Xo({text:f?"":e||s,maxWidth:r,maxHeight:c,minFontSize:l,maxFontSize:h});a.useImperativeHandle(E,()=>({startEditing:()=>y(!0)}),[]),a.useEffect(()=>{if(p&&d.current){d.current.focus();const C=window.getSelection(),N=document.createRange();N.selectNodeContents(d.current),C==null||C.removeAllRanges(),C==null||C.addRange(N)}},[p]);const u=a.useCallback(C=>{C.stopPropagation(),y(!0)},[]),m=a.useCallback(()=>{var N;if(!d.current)return;const C=((N=d.current.textContent)==null?void 0:N.trim())||"";C!==e&&t(C),y(!1),x==null||x(C)},[e,t,x]),b=a.useCallback(()=>{d.current&&(d.current.textContent=e),y(!1),x==null||x(e)},[e,x]),T=a.useCallback(C=>{C.key==="Enter"&&!C.shiftKey?(C.preventDefault(),m()):C.key==="Escape"&&(C.preventDefault(),b())},[m,b]),w=a.useCallback(()=>{m()},[m]),v=a.useCallback(C=>{p&&C.stopPropagation()},[p]),S=a.useCallback(C=>{p&&C.stopPropagation()},[p]),B=f?void 0:{fontSize:`${i}px`};return g.jsx("span",{ref:d,className:Y("flex items-center text-center font-normal text-[0.75rem] whitespace-pre-wrap leading-[1.3] break-words overflow-hidden flex-1 min-w-[4em] min-h-[1.3em] text-postit-text","cursor-text",p&&"outline-none bg-black/20 rounded px-1.5 py-0.5 shadow-[0_0_0_1px_rgba(255,255,255,0.4)] nodrag nopan",o),style:B,contentEditable:p,suppressContentEditableWarning:!0,onDoubleClick:u,onKeyDown:p?T:void 0,onBlur:p?w:void 0,onMouseDown:v,onClick:S,children:e})})),Rs=a.memo(function({label:e,selected:t,isCompleted:o,isActive:s,isTargetConnectable:r,isSourceConnectable:c,onLabelChange:l,placeholder:h="Event",instanceCount:f,isOriginal:x,toolbar:E,quickCreateButtons:p}){const y=me.event;return g.jsxs("div",{className:Y("node-postit",y.gradient,y.rotate,"w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&`node-selected ${y.selected}`,o&&"bg-success! node-completed",s&&y.pulse,f&&f>1&&!x&&"texture-diagonal-clone"),children:[E,p,g.jsx(j,{type:"target",position:A.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:r}),g.jsx(j,{type:"target",position:A.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:r}),g.jsx(j,{type:"target",position:A.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:r}),g.jsx(j,{type:"target",position:A.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:r}),g.jsx(j,{type:"source",position:A.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:c}),g.jsx(j,{type:"source",position:A.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:c}),g.jsx(j,{type:"source",position:A.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:c}),g.jsx(j,{type:"source",position:A.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:c}),g.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ie,{value:e,onChange:l,placeholder:h})}),f&&f>1&&g.jsx("div",{className:"absolute top-1 left-1 flex items-center gap-1 z-10",children:g.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${f} instances share this definition`,children:[g.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[g.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),g.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),f]})})]})}),Ps=a.memo(function({label:e,selected:t,isCompact:o,isCompleted:s,isActive:r,isWaiting:c,isTargetConnectable:l,isSourceConnectable:h,onLabelChange:f,onDoubleClick:x,onEditEnd:E,labelRef:p,placeholder:y="Command",instanceCount:d,isOriginal:i,toolbar:u,quickCreateButtons:m}){const b=me.command;return g.jsxs("div",{className:Y("node-postit",b.gradient,b.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5":"w-[152px]",t&&`node-selected ${b.selected}`,s&&"bg-success! node-completed",r&&"animate-pulse-success",c&&b.pulse,d&&d>1&&!i&&"texture-diagonal-clone"),onDoubleClick:x,children:[u,m,g.jsx(j,{type:"target",position:A.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(j,{type:"target",position:A.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(j,{type:"target",position:A.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(j,{type:"target",position:A.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(j,{type:"source",position:A.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(j,{type:"source",position:A.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(j,{type:"source",position:A.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx(j,{type:"source",position:A.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ie,{ref:p,value:e,onChange:f,placeholder:y,onEditEnd:E})}),d&&d>1&&g.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex items-center gap-1 z-10",children:g.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${d} instances share this definition`,children:[g.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[g.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),g.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),d]})})]})}),Os=a.memo(function({label:e,selected:t,isCompleted:o,isActive:s,isWaiting:r,isTargetConnectable:c,isSourceConnectable:l,onLabelChange:h,placeholder:f="Policy",instanceCount:x,isOriginal:E,toolbar:p,quickCreateButtons:y,children:d}){const i=me.policy;return g.jsxs("div",{className:Y("node-postit",i.gradient,i.rotate,"w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&`node-selected ${i.selected}`,o&&"bg-success! node-completed",s&&"animate-pulse-success",r&&i.pulse,x&&x>1&&!E&&"texture-diagonal-clone"),children:[p,y,g.jsx(j,{type:"target",position:A.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:c}),g.jsx(j,{type:"target",position:A.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:c}),g.jsx(j,{type:"target",position:A.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:c}),g.jsx(j,{type:"target",position:A.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:c}),l!==void 0&&g.jsxs(g.Fragment,{children:[g.jsx(j,{type:"source",position:A.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(j,{type:"source",position:A.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(j,{type:"source",position:A.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(j,{type:"source",position:A.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:l})]}),g.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ie,{value:e,onChange:h,placeholder:f})}),x&&x>1&&g.jsx("div",{className:"absolute top-1 left-1 flex items-center gap-1 z-10",children:g.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${x} instances share this definition`,children:[g.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[g.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),g.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),x]})}),d]})}),Ds=a.memo(function({label:e,selected:t,isCompact:o,isCompleted:s,isActive:r,isWaiting:c,isTargetConnectable:l,isSourceConnectable:h,onLabelChange:f,onDoubleClick:x,onEditEnd:E,labelRef:p,placeholder:y="Trigger",instanceCount:d,isOriginal:i,toolbar:u,quickCreateButtons:m,playButton:b}){const T=me.trigger;return g.jsxs("div",{className:Y("node-postit",T.gradient,T.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5 [&_.play-btn]:right-auto [&_.play-btn]:left-1/2 [&_.play-btn]:-translate-x-1/2":"w-[152px]",t&&`node-selected ${T.selected}`,s&&"bg-success! node-completed",r&&"animate-pulse-success",c&&T.pulse,d&&d>1&&!i&&"texture-diagonal-clone"),onDoubleClick:x,children:[u,m,g.jsx(j,{type:"target",position:A.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(j,{type:"target",position:A.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(j,{type:"target",position:A.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(j,{type:"target",position:A.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(j,{type:"source",position:A.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(j,{type:"source",position:A.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(j,{type:"source",position:A.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx(j,{type:"source",position:A.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ie,{ref:p,value:e,onChange:f,placeholder:y,onEditEnd:E})}),b,d&&d>1&&g.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex items-center gap-1 z-10",children:g.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${d} instances share this definition`,children:[g.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[g.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),g.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),d]})})]})}),js=a.memo(function({label:e,selected:t,isCompact:o,isCompleted:s,isActive:r,isWaiting:c,isTargetConnectable:l,isSourceConnectable:h,onLabelChange:f,onDoubleClick:x,onEditEnd:E,labelRef:p,placeholder:y="External System",instanceCount:d,toolbar:i,quickCreateButtons:u,playButton:m}){const b=me.externalSystem;return g.jsxs("div",{className:Y("node-postit",b.gradient,b.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5 [&_.play-btn]:right-auto [&_.play-btn]:left-1/2 [&_.play-btn]:-translate-x-1/2":"w-[152px]",t&&`node-selected ${b.selected}`,s&&"bg-success! node-completed",r&&"animate-pulse-success",c&&b.pulse),onDoubleClick:x,children:[i,u,g.jsx(j,{type:"target",position:A.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(j,{type:"target",position:A.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(j,{type:"target",position:A.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(j,{type:"target",position:A.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(j,{type:"source",position:A.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(j,{type:"source",position:A.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(j,{type:"source",position:A.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx(j,{type:"source",position:A.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ie,{ref:p,value:e,onChange:f,placeholder:y,onEditEnd:E})}),m,d&&d>1&&g.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex gap-[3px] z-10",children:g.jsxs("span",{className:"text-[0.4rem] px-[5px] py-0.5 rounded-[3px] bg-black/30 text-white/80 font-semibold tracking-[0.3px] cursor-help",title:`${d} instances share this definition`,children:["x",d]})})]})}),Ls=a.memo(function({label:e,selected:t,isCompact:o,isCompleted:s,isActive:r,isWaiting:c,isTargetConnectable:l,isSourceConnectable:h,onLabelChange:f,onDoubleClick:x,onEditEnd:E,labelRef:p,placeholder:y="External Event",instanceCount:d,toolbar:i,quickCreateButtons:u,playButton:m}){const b=me.externalEvent;return g.jsxs("div",{className:Y("node-postit",b.gradient,b.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5 [&_.play-btn]:right-auto [&_.play-btn]:left-1/2 [&_.play-btn]:-translate-x-1/2":"w-[152px]",t&&`node-selected ${b.selected}`,s&&"bg-success! node-completed",r&&"animate-pulse-success",c&&b.pulse),onDoubleClick:x,children:[i,u,g.jsx(j,{type:"target",position:A.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(j,{type:"target",position:A.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(j,{type:"target",position:A.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(j,{type:"target",position:A.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(j,{type:"source",position:A.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(j,{type:"source",position:A.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(j,{type:"source",position:A.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx(j,{type:"source",position:A.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ie,{ref:p,value:e,onChange:f,placeholder:y,onEditEnd:E})}),m,d&&d>1&&g.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex gap-[3px] z-10",children:g.jsxs("span",{className:"text-[0.4rem] px-[5px] py-0.5 rounded-[3px] bg-black/30 text-white/80 font-semibold tracking-[0.3px] cursor-help",title:`${d} instances share this definition`,children:["x",d]})})]})}),Fs=a.memo(function({label:e,selected:t,description:o,onLabelChange:s,placeholder:r="HotSpot",instanceCount:c,toolbar:l}){const h=me.hotspot;return g.jsxs("div",{className:Y("node-postit",h.gradient,h.rotate,"w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&`node-selected ${h.selected}`),children:[l,g.jsxs("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:[g.jsx(ie,{value:e,onChange:s,placeholder:r}),o&&g.jsx("div",{className:"text-[0.6rem] text-black/70 mt-1 text-center overflow-hidden line-clamp-2 leading-[1.2]",children:o})]}),c&&c>1&&g.jsx("div",{className:"absolute top-1 left-1 flex gap-[3px] z-10",children:g.jsxs("span",{className:"text-[0.4rem] px-[5px] py-0.5 rounded-[3px] bg-black/30 text-white/80 font-semibold tracking-[0.3px] cursor-help",title:`${c} instances share this definition`,children:["x",c]})})]})}),zs=a.memo(function({label:e,selected:t,isCompleted:o,isActive:s,isTargetConnectable:r,isSourceConnectable:c,onLabelChange:l,placeholder:h="Actor",toolbar:f,quickCreateButtons:x}){return g.jsxs("div",{className:Y("node-postit gradient-actor rotate-actor","w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&"node-selected node-selected-actor",o&&"bg-success! node-completed",s&&"animate-pulse-actor"),children:[f,x,r!==void 0&&g.jsxs(g.Fragment,{children:[g.jsx(j,{type:"target",position:A.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:r}),g.jsx(j,{type:"target",position:A.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:r}),g.jsx(j,{type:"target",position:A.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:r}),g.jsx(j,{type:"target",position:A.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:r})]}),c!==void 0&&g.jsxs(g.Fragment,{children:[g.jsx(j,{type:"source",position:A.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:c}),g.jsx(j,{type:"source",position:A.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:c}),g.jsx(j,{type:"source",position:A.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:c}),g.jsx(j,{type:"source",position:A.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:c})]}),g.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ie,{value:e,onChange:l,placeholder:h})})]})}),$s=a.memo(function({label:e,selected:t,onLabelChange:o,placeholder:s="Note",toolbar:r}){return g.jsxs("div",{className:Y("node-postit gradient-note rotate-note","w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&"node-selected node-selected-note"),children:[r,g.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ie,{value:e,onChange:o,placeholder:s})})]})}),Go=200,Ho=150,Ws=a.memo(function({label:e,selected:t,onLabelChange:o,onResizeStart:s,onResize:r,onResizeEnd:c,placeholder:l="Group",toolbar:h,children:f}){const{zoom:x}=nn(),E=a.useRef(null),p=a.useRef(null),y=Math.min(8,Math.max(.7,1/x));return a.useEffect(()=>{if(E.current&&p.current){p.current.textContent=e||l;const d=p.current.offsetWidth;E.current.style.width=`${Math.max(60,d+4)}px`}},[e,l]),g.jsxs("div",{className:Y("relative w-full h-full rounded-lg","border-[1.5px] border-[rgba(139,92,246,0.5)]"),style:{background:"radial-gradient(ellipse at center, transparent 30%, rgba(139,92,246,0.06) 100%)"},children:[g.jsx(on,{minWidth:Go,minHeight:Ho,isVisible:!0,lineClassName:"group-resize-line !z-[1000]",handleClassName:"group-resize-handle !z-[1000]",onResizeStart:()=>s==null?void 0:s(),onResize:(d,i)=>r==null?void 0:r(i.width,i.height),onResizeEnd:(d,i)=>c==null?void 0:c(i.width,i.height)}),h,g.jsxs("div",{className:Y("absolute z-10 origin-bottom-left"),style:{top:`${-10*y-20}px`,left:"8px",transform:`scale(${y})`},children:[g.jsx("span",{ref:p,className:"absolute invisible whitespace-pre text-sm font-semibold","aria-hidden":"true"}),g.jsx("input",{ref:E,type:"text",value:e,onChange:d=>o(d.target.value),placeholder:l,className:Y("bg-transparent border-none outline-none","text-sm font-semibold","min-w-[60px]","text-[rgba(139,92,246,0.7)] placeholder:text-[rgba(139,92,246,0.4)]")})]}),g.jsx("div",{className:"w-full h-full pointer-events-none",children:f})]})}),Xs="w-4 h-4",Bs=10,Uo=Y("w-7 h-7 rounded-md flex items-center justify-center","border-none cursor-pointer","transition-all duration-150","hover:scale-110 active:scale-95","focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-text-primary"),qo=Y("p-1.5 rounded","transition-colors","focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1"),Vs=Y("flex items-center gap-1.5 p-1.5 rounded-lg","bg-bg-secondary/95 backdrop-blur-sm","border border-border shadow-[var(--shadow-toolbar)]"),Gs=Y("flex gap-1 bg-white rounded-lg shadow-lg p-1 border border-gray-200","dark:bg-bg-secondary dark:border-border");function Hs(n){return Y(Uo,{default:"bg-text-muted/20 text-text-secondary hover:bg-text-muted/30",danger:"bg-danger/20 text-danger hover:bg-danger/30",info:"bg-info/20 text-info hover:bg-info/30",accent:"bg-accent/20 text-accent hover:bg-accent/30",event:"bg-node-event/20 text-node-event hover:bg-node-event/30",trigger:"bg-node-trigger/20 text-node-trigger hover:bg-node-trigger/30",command:"bg-node-command/20 text-node-command hover:bg-node-command/30"}[n])}function Us(n){return Y(qo,{default:"text-gray-500 hover:bg-gray-50 hover:text-gray-700 dark:hover:bg-text-muted/20 dark:hover:text-text-primary",danger:"text-gray-500 hover:bg-red-50 hover:text-red-500 dark:hover:bg-danger/20 dark:hover:text-danger",purple:"text-gray-500 hover:bg-purple-50 hover:text-purple-500 dark:hover:bg-node-policy/20 dark:hover:text-node-policy"}[n])}function Yo(){const{getNode:n}=ve(),{addNode:e,onConnect:t}=Fe(),o=a.useCallback((r,c=!1)=>{const h=Be[c?"policy":r];return h?[...h.canConnectTo]:[]},[]),s=a.useCallback((r,c,l)=>{var u,m;const h=n(r);if(!h)return;const f=h.parentId?n(h.parentId):void 0,x=Ln(h.position,f==null?void 0:f.position),E=((u=h.measured)==null?void 0:u.width)??Xn,p=((m=h.measured)==null?void 0:m.height)??Bn,y=Hn(x,E,p,l),d=e(c,y),i=Gn(l);t({source:r,target:d,sourceHandle:i.source,targetHandle:i.target})},[n,e,t]);return{getValidTargetTypes:o,createConnectedNode:s}}const Ko={event:{label:"Event",Icon:lt},command:{label:"Command",Icon:yn},policy:{label:"Policy",Icon:dn},trigger:{label:"Trigger",Icon:Ve},externalSystem:{label:"Ext System",Icon:He},externalEvent:{label:"Ext Event",Icon:He}},Qo={event:"bg-node-event text-postit-text",command:"bg-[#3b82f6] text-white",policy:"bg-node-policy text-postit-text",trigger:"bg-node-trigger text-postit-text",externalSystem:"bg-node-external text-postit-text",externalEvent:"bg-node-external text-postit-text"};function Jo({validTypes:n,anchorPosition:e,direction:t,onSelect:o,onClose:s,typeConfig:r,getIconColorClass:c}){const l=a.useRef(null);Wo({ref:l,onClose:s});const f=a.useCallback(()=>{const u=n.length*44+8,m=10,b=8;let T,w;switch(t){case"top":T=e.x-180/2,w=e.y-u-b;break;case"bottom":T=e.x-180/2,w=e.y+b;break;case"left":T=e.x-180-b,w=e.y-u/2;break;case"right":T=e.x+b,w=e.y-u/2;break}return T+180>window.innerWidth-m&&(T=window.innerWidth-180-m),w+u>window.innerHeight-m&&(w=window.innerHeight-u-m),T<m&&(T=m),w<m&&(w=m),{x:T,y:w}},[e,t,n.length])(),x=a.useMemo(()=>{if(!n.includes("event"))return n;const i=n.filter(m=>m!=="event"),u=Math.floor(i.length/2);return[...i.slice(0,u),"event",...i.slice(u)]},[n]),E=a.useCallback(i=>{o(i),s()},[o,s]),p=a.useCallback(i=>r&&i in r?r[i]:Ko[i]??{label:i,Icon:lt},[r]),y=a.useCallback(i=>c?c(i):Qo[i]??"bg-gray-500 text-white",[c]);if(x.length===0)return null;const d=g.jsx("div",{ref:l,className:Y("fixed bg-bg-secondary border border-border rounded-lg","shadow-[0_4px_16px_rgba(0,0,0,0.3)] p-1 z-[10000] min-w-[160px]","animate-zoom-in","light:bg-white light:shadow-[0_4px_16px_rgba(0,0,0,0.15)]"),style:{left:f.x,top:f.y},children:x.map(i=>{const u=p(i);return g.jsxs("button",{className:Y("flex items-center gap-2.5 py-2 px-3 rounded-md","cursor-pointer transition-colors duration-100","text-text-primary border-none bg-transparent w-full text-[13px]","hover:bg-bg-tertiary active:scale-[0.98]"),onClick:()=>E(i),children:[g.jsx("span",{className:Y("w-6 h-6 rounded flex items-center justify-center shrink-0","[&_svg]:w-3.5 [&_svg]:h-3.5",y(i)),children:g.jsx(u.Icon,{})}),g.jsx("span",{className:"flex-1 text-left",children:u.label})]},i)})});return sn.createPortal(d,document.body)}const Zo=a.memo(Jo),es=a.memo(function({outcomeId:e,canDelete:t,onDelete:o}){const s=a.useCallback(r=>{r.stopPropagation(),t&&o(e)},[e,t,o]);return g.jsx(rn,{position:A.Top,offset:10,className:Y("flex items-center gap-1.5 p-1.5 rounded-lg","bg-bg-secondary/95 backdrop-blur-sm","border border-border shadow-[var(--shadow-toolbar)]"),children:g.jsx("button",{className:Y("w-7 h-7 rounded-md flex items-center justify-center","border-none cursor-pointer transition-all duration-150","hover:scale-110 active:scale-95","bg-danger/20 text-danger hover:bg-danger/30","disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"),onClick:s,disabled:!t,title:t?"Delete outcome":"Cannot delete - minimum 2 outcomes required",children:g.jsx(Zt,{className:"w-4 h-4"})})})}),qs=a.memo(function({id:e,data:t,selected:o}){const s=an(),r=o||s.inProgress,{state:c,selectTransition:l,isRunning:h,start:f,triggerNode:x}=xo(),{getOutcomeTransition:E,updateOutcomeLabel:p,deleteOutcome:y,getOutcomesForPolicy:d}=Fe(),u=(t.parentPolicyDefId?c==null?void 0:c.nodeStates.get(t.parentPolicyDefId):void 0)==="waiting_for_action",m=e,b=E(m),T=!!b,v=d(t.parentPolicyInstanceId).length>2,S=a.useCallback(N=>{v&&y(N)},[v,y]),B=a.useCallback(N=>{N.stopPropagation(),!(!b||!t.parentPolicyDefId)&&(u?l(b):h?(x(t.parentPolicyDefId),setTimeout(()=>{l(b)},50)):(f(),setTimeout(()=>{x(t.parentPolicyDefId),setTimeout(()=>{l(b)},50)},10)))},[b,t.parentPolicyDefId,u,h,f,x,l]),C=a.useCallback(N=>{p(e,N)},[e,p]);return g.jsxs("div",{className:Y("gradient-outcome border border-node-policy/50 rounded-md","w-auto h-auto min-w-[50px] min-h-8 p-0","shadow-[0_2px_4px_rgba(0,0,0,0.3)] transition-all duration-200","hover:scale-[1.02]",o&&"node-selected node-selected-outcome shadow-[0_0_8px_rgba(147,51,234,0.8)] border-node-policy",u&&"gradient-outcome-clickable border-node-policy cursor-pointer animate-pulse-outcome hover:scale-[1.08] hover:shadow-[0_0_12px_rgba(147,51,234,0.9)]"),children:[g.jsx(es,{outcomeId:m,canDelete:v,onDelete:S}),o&&g.jsx(as,{instanceId:m,nodeType:"policy",isOutcome:!0}),g.jsx(j,{type:"source",position:A.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:r}),g.jsx(j,{type:"source",position:A.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:r}),g.jsx(j,{type:"source",position:A.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:r}),g.jsx(j,{type:"source",position:A.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:r}),g.jsxs("div",{className:"flex flex-row items-center gap-1.5 py-1 px-2",children:[g.jsx("button",{className:Y("w-[18px] h-[18px] rounded-full border flex items-center justify-center","shadow-[0_1px_3px_rgba(0,0,0,0.2)] transition-all duration-200 p-0 outline-none shrink-0",T?"bg-node-policy border-white/30 text-white cursor-pointer hover:scale-[1.15] hover:bg-[#a855f7] hover:border-white/50":"bg-node-policy/40 border-white/20 text-white/50 cursor-default"),onClick:B,disabled:!T,title:T?u?`Select ${t.label}`:`Trigger from ${t.label}`:"Connect this outcome to enable",children:g.jsx(Ve,{className:"w-2.5 h-2.5"})}),g.jsx(ie,{value:t.label,onChange:C,placeholder:"Outcome",autoSize:!0,className:"text-white [.light_&]:text-postit-text"})]})]})}),ts=["right"];function ns(n){switch(n){case"top":return"top-[-28px] left-1/2 -translate-x-1/2 hover:-translate-x-1/2";case"right":return"right-[-28px] top-1/2 -translate-y-1/2 hover:-translate-y-1/2";case"bottom":return"bottom-[-28px] left-1/2 -translate-x-1/2 hover:-translate-x-1/2";case"left":return"left-[-28px] top-1/2 -translate-y-1/2 hover:-translate-y-1/2"}}function os(n){return Y("absolute rounded-full border-2 border-border","cursor-pointer flex items-center justify-center text-sm font-bold","pointer-events-auto p-0 transition-all duration-150 z-[5]","shadow-[0_2px_4px_rgba(0,0,0,0.3)]","focus:outline-none focus-visible:outline-2 focus-visible:outline-text-primary focus-visible:outline-offset-2","hover:scale-[1.2] hover:shadow-[0_3px_8px_rgba(0,0,0,0.4)] active:scale-110","dark:bg-[#e0e0e8] dark:border-[#d0d0d8] dark:text-[#1e1e3a]","dark:hover:bg-[#5a5a7a] dark:hover:border-[#f0f0f8] dark:hover:text-[#f0f0f8]","bg-[#6a6a8a] border-[#7a7a9a] text-white shadow-[0_2px_4px_rgba(0,0,0,0.15)]","hover:bg-[#5a5a7a] hover:border-white hover:text-white",n?"w-4 h-4":"w-5 h-5")}function ss({validTypes:n,isCompact:e=!1,onCreateNode:t,renderMenu:o,directions:s=ts}){const[r,c]=a.useState(!1),[l,h]=a.useState(null),[f,x]=a.useState(null),E=a.useRef({top:null,right:null,bottom:null,left:null}),p=a.useCallback((u,m)=>{if(m.stopPropagation(),n.length===1){t(n[0],u);return}const b=E.current[u];if(!b)return;const T=b.getBoundingClientRect();x({x:T.x+T.width/2,y:T.y+T.height/2}),h(u),c(!0)},[n,t]),y=a.useCallback(u=>{l&&(t(u,l),c(!1),h(null))},[l,t]),d=a.useCallback(()=>{c(!1),h(null)},[]);if(n.length===0)return null;const i=os(e);return g.jsxs(g.Fragment,{children:[g.jsx("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",children:s.map(u=>g.jsx("button",{ref:m=>{E.current[u]=m},className:Y(i,ns(u),"nodrag nopan"),onClick:m=>p(u,m),"aria-label":`Create node ${u==="top"?"above":u==="bottom"?"below":`to the ${u}`}`,title:"Add connected node",children:g.jsx(en,{className:"w-3 h-3"})},u))}),r&&f&&l&&o({validTypes:n,anchorPosition:f,direction:l,onSelect:y,onClose:d})]})}const rs=a.memo(ss),as=a.memo(function({instanceId:e,nodeType:t,isOutcome:o=!1,isCompact:s=!1}){const{getValidTargetTypes:r,createConnectedNode:c}=Yo(),l=r(t,o),h=a.useCallback((x,E)=>{c(e,x,E)},[e,c]),f=a.useCallback(x=>g.jsx(Zo,{...x}),[]);return g.jsx(rs,{validTypes:l,isCompact:s,onCreateNode:h,renderMenu:f})});function Ys({id:n,source:e,sourceX:t,sourceY:o,targetX:s,targetY:r,sourcePosition:c,targetPosition:l,selected:h,markerEnd:f,markerStart:x,data:E,simulationState:p,isRunning:y,start:d,triggerNode:i,selectTransition:u,getSourceDefinitionId:m}){const b=E,T=(b==null?void 0:b.state)||"idle",w=(b==null?void 0:b.progress)||0,v=(b==null?void 0:b.labelOffset)??.5,S=b==null?void 0:b.transitionId,B=(b==null?void 0:b.isNonStandard)||!1,C=b==null?void 0:b.sourceKind,N=b==null?void 0:b.targetKind,{setEdges:$}=ve(),{showTooltip:R,hideTooltip:P,setHoveredWarningEdgeId:z}=kt(),O=a.useRef(null),[k,I]=a.useState({x:0,y:0}),[D,W]=a.useState({x:0,y:0}),[L,F]=a.useState(0),G=a.useRef(void 0),X=a.useCallback((q,fe)=>{$(ne=>ne.map(se=>se.id===q?{...se,data:{...se.data,labelOffset:fe}}:se))},[$]),{isDragging:H,hasDraggedRef:U,handleDragStart:K}=Eo({pathRef:O,edgeId:n,onOffsetChange:X}),J=m(e),_=(J?p==null?void 0:p.nodeStates.get(J):void 0)==="waiting_for_action",M=a.useMemo(()=>({isRunning:y,start:d,triggerNode:i,selectTransition:u}),[y,d,i,u]),V=a.useMemo(()=>({isSourceWaiting:_}),[_]),{execute:Q}=$o(M,V),te=dt(t,o,s,r,c,l);a.useLayoutEffect(()=>{if(O.current){const q=O.current.getTotalLength();F(q)}},[te]),a.useLayoutEffect(()=>{if(O.current&&L>0){const q=O.current.getPointAtLength(L*v);W({x:q.x,y:q.y})}},[L,v]),a.useEffect(()=>{if(T!=="animating"||!O.current)return;const q=O.current,fe=q.getTotalLength(),ne=()=>{const se=(b==null?void 0:b.progress)||0,Te=q.getPointAtLength(fe*se);I({x:Te.x,y:Te.y}),se<1&&(G.current=requestAnimationFrame(ne))};return G.current=requestAnimationFrame(ne),()=>{G.current&&cancelAnimationFrame(G.current)}},[T,b==null?void 0:b.progress]);const ue=a.useCallback(q=>{q.stopPropagation(),q.preventDefault(),!U.current&&(!S||!J||Q(J,S))},[S,J,Q,U]),Ee=L*(1-w),he=!!S,pe=he;return a.useEffect(()=>{if(h&&B&&C&&N)return z(n),R({edgeId:n,sourceKind:C,targetKind:N,targetPosition:{x:s,y:r}}),()=>{z(null),P()}},[h,B,C,N,n,s,r,R,P,z]),g.jsxs(g.Fragment,{children:[!B&&g.jsx("path",{d:te,fill:"none",stroke:T==="executed"?"#22c55e":"oklch(55% 0.18 303)",strokeWidth:16,strokeLinecap:"butt",style:{opacity:.15,pointerEvents:"none"}}),g.jsx(ct,{id:n,path:te,markerEnd:f,markerStart:x,className:[T==="idle"&&!h?"animate-dash-flow":"",B?"non-standard":""].filter(Boolean).join(" ")||void 0,style:{strokeDasharray:T==="idle"&&!h?"5 5":"none",opacity:T==="executed"?0:1}}),g.jsx("path",{ref:O,d:te,fill:"none",stroke:"transparent",strokeWidth:0}),(T==="animating"||T==="executed"||T==="waiting_at_label")&&L>0&&g.jsx("path",{d:te,fill:"none",stroke:"#22c55e",strokeWidth:2,style:{strokeDasharray:T!=="executed"?L:"none",strokeDashoffset:T!=="executed"?Ee:0}}),T==="animating"&&g.jsxs(g.Fragment,{children:[g.jsx("circle",{cx:k.x,cy:k.y,r:10,fill:"rgba(34, 197, 94, 0.3)"}),g.jsx("circle",{cx:k.x,cy:k.y,r:6,fill:"#22c55e",style:{filter:"drop-shadow(0 0 4px rgba(34, 197, 94, 0.6))"}})]}),T==="waiting_at_label"&&g.jsxs(g.Fragment,{children:[g.jsx("circle",{cx:D.x,cy:D.y,r:10,fill:"rgba(34, 197, 94, 0.3)",className:"animate-ball-fade-out"}),g.jsx("circle",{cx:D.x,cy:D.y,r:6,fill:"#22c55e",className:"animate-ball-fade-out",style:{filter:"drop-shadow(0 0 4px rgba(34, 197, 94, 0.6))"}})]}),h&&g.jsxs(g.Fragment,{children:[g.jsx(ot,{x:t,y:o}),g.jsx(ot,{x:s,y:r})]}),g.jsx(cn,{children:g.jsx("div",{className:Y("absolute cursor-grab select-none z-[1000] nodrag nopan",H&&"cursor-grabbing",_&&"[&_.play-btn]:animate-button-pulse"),style:{position:"absolute",transform:`translate(-50%, -50%) translate(${D.x}px, ${D.y}px)`,pointerEvents:"all"},onMouseDown:K,children:g.jsx("button",{className:Y("play-btn w-[18px] h-[18px] rounded-full flex items-center justify-center p-0 outline-none shrink-0","shadow-[0_1px_3px_rgba(0,0,0,0.2)] transition-all duration-200",pe?"bg-[#3b82f6] border border-white/30 text-white cursor-pointer hover:scale-[1.15] hover:bg-[#60a5fa] hover:border-white/50":"bg-[#3b82f6]/40 border border-white/20 text-white/50 cursor-default"),onClick:ue,disabled:!pe,title:he?_?"Select this path":"Trigger command":"No transition connected",children:g.jsx(Ve,{className:"w-2.5 h-2.5"})})})})]})}function ot({x:n,y:e}){return g.jsx("circle",{cx:n,cy:e,r:6,fill:"oklch(40% 0.18 303)",stroke:"#fff",strokeWidth:2,style:{cursor:"grab",filter:"drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3))"}})}function Ks({id:n,sourceX:e,sourceY:t,targetX:o,targetY:s,sourcePosition:r,targetPosition:c,selected:l,markerEnd:h,markerStart:f,data:x}){const{theme:E}=bo(),{showTooltip:p,hideTooltip:y,setHoveredWarningEdgeId:d}=kt(),i=x,u=(i==null?void 0:i.state)||"idle",m=(i==null?void 0:i.progress)||0,b=(i==null?void 0:i.isNonStandard)||!1,T=i==null?void 0:i.sourceKind,w=i==null?void 0:i.targetKind,v=a.useRef(null),[S,B]=a.useState({x:0,y:0}),[C,N]=a.useState(0),$=a.useRef(void 0),R=dt(e,t,o,s,r,c);a.useLayoutEffect(()=>{if(v.current){const z=v.current.getTotalLength();N(z)}},[R]),a.useEffect(()=>{if(u!=="animating"||!v.current)return;const z=v.current,O=z.getTotalLength(),k=()=>{const I=(i==null?void 0:i.progress)||0,D=z.getPointAtLength(O*I);B({x:D.x,y:D.y}),I<1&&($.current=requestAnimationFrame(k))};return $.current=requestAnimationFrame(k),()=>{$.current&&cancelAnimationFrame($.current)}},[u,i==null?void 0:i.progress]);const P=C*(1-m);return a.useEffect(()=>{if(l&&b&&T&&w)return d(n),p({edgeId:n,sourceKind:T,targetKind:w,targetPosition:{x:o,y:s}}),()=>{d(null),y()}},[l,b,T,w,n,o,s,p,y,d]),g.jsxs(g.Fragment,{children:[!b&&g.jsx("path",{d:R,fill:"none",stroke:u==="executed"?"#22c55e":"oklch(55% 0.18 303)",strokeWidth:16,strokeLinecap:"butt",style:{opacity:.15,pointerEvents:"none"}}),g.jsx(ct,{id:n,path:R,markerEnd:h,markerStart:f,className:[u==="idle"&&!l?"animate-dash-flow":"",b?"non-standard":""].filter(Boolean).join(" ")||void 0,style:{strokeDasharray:u==="idle"&&!l?"5 5":"none",opacity:u==="executed"?0:1}}),g.jsx("path",{ref:v,d:R,fill:"none",stroke:"transparent",strokeWidth:0}),(u==="animating"||u==="executed")&&C>0&&g.jsx("path",{d:R,fill:"none",stroke:"#22c55e",strokeWidth:2,style:{strokeDasharray:u==="animating"?C:"none",strokeDashoffset:u==="animating"?P:0}}),u==="animating"&&g.jsxs(g.Fragment,{children:[g.jsx("circle",{cx:S.x,cy:S.y,r:10,fill:"rgba(34, 197, 94, 0.3)"}),g.jsx("circle",{cx:S.x,cy:S.y,r:6,fill:"#22c55e",style:{filter:"drop-shadow(0 0 4px rgba(34, 197, 94, 0.6))"}})]}),l&&g.jsxs(g.Fragment,{children:[g.jsx(st,{x:e,y:t,isLight:E==="light"}),g.jsx(st,{x:o,y:s,isLight:E==="light"})]})]})}function st({x:n,y:e,isLight:t}){const o=t?"#ffffff":"#1e1e3f",s=t?"oklch(45% 0.18 303)":"oklch(70% 0.15 303)";return g.jsx("circle",{cx:n,cy:e,r:6,fill:o,stroke:s,strokeWidth:2,style:{cursor:"grab",filter:"drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3))"}})}const is=()=>({activeTransitions:new Map,animationFrame:void 0,processedEvents:new Set,previousEventsLength:0,wasWaiting:new Map,animate:null}),rt=1e3,cs=500;function Qs(n){const{setEdges:e,getEdges:t}=ve(),o=a.useRef(is()),s=a.useCallback((l,h,f)=>{e(x=>x.map(E=>{const p=E.data;return(p==null?void 0:p.transitionId)===l?{...E,data:{...E.data,state:h,progress:f}}:E}))},[e]),r=a.useCallback(()=>{const l=o.current,h=Date.now();let f=!1;l.activeTransitions.forEach((x,E)=>{const p=h-x.startTime,y=x.targetProgress-x.startProgress,d=Math.min(p/x.duration,1),i=x.startProgress+d*y;d<1?(f=!0,s(E,"animating",i)):(x.targetProgress<1?(s(E,"waiting_at_label",x.targetProgress),l.wasWaiting.set(E,x.targetProgress)):s(E,"executed",1),l.activeTransitions.delete(E))}),f&&l.animate?l.animationFrame=requestAnimationFrame(l.animate):l.animationFrame=void 0},[s]);a.useEffect(()=>{o.current.animate=r},[r]);const c=a.useCallback(()=>{const l=o.current;l.animationFrame&&(cancelAnimationFrame(l.animationFrame),l.animationFrame=void 0),l.activeTransitions.clear(),l.processedEvents.clear(),l.wasWaiting.clear(),e(h=>h.map(f=>({...f,data:{...f.data,state:"idle",progress:0}})))},[e]);a.useEffect(()=>{const l=o.current;n.length===0&&l.previousEventsLength>0&&c(),l.previousEventsLength=n.length;let h=!1;n.forEach(f=>{var x,E,p;if(!l.processedEvents.has(f.id)){if(l.processedEvents.add(f.id),f.type==="transition:start"){const d=(x=f.data.transition)==null?void 0:x.id;if(!d)return;const i=l.wasWaiting.get(d),u=i!==void 0?i:0,m=i!==void 0?rt*(1-i):rt;l.wasWaiting.delete(d),l.activeTransitions.set(d,{transitionId:d,startTime:Date.now(),duration:m,startProgress:u,targetProgress:1}),s(d,"animating",u),h=!0}if(f.type==="transition:reset"){const d=(E=f.data.transition)==null?void 0:E.id;if(!d)return;l.activeTransitions.delete(d),s(d,"idle",0)}if(f.type==="simulation:reset"&&c(),f.type==="node:waiting"){const y=f.data;if(((p=y.node)==null?void 0:p.kind)!=="command")return;const d=y.availableTransitions||[],i=t();for(const u of d){const m=u.id,b=i.find(v=>{const S=v.data;return(S==null?void 0:S.transitionId)===m});if(!b)continue;const T=b.data,w=(T==null?void 0:T.labelOffset)??.5;l.activeTransitions.set(m,{transitionId:m,startTime:Date.now(),duration:cs,startProgress:0,targetProgress:w}),s(m,"animating",0),h=!0}}}}),h&&!l.animationFrame&&(l.animationFrame=requestAnimationFrame(r))},[n,r,s,c,t]),a.useEffect(()=>{const l=o.current;return()=>{l.animationFrame&&cancelAnimationFrame(l.animationFrame)}},[])}export{Ae as $,zs as A,Ys as B,He as C,Ks as D,Rs as E,fs as F,kt as G,Fs as H,Qs as I,ks as J,Ts as K,_s as L,gs as M,$s as N,qs as O,zo as P,as as Q,ms as R,hs as S,yn as T,bs as U,Ns as V,To as W,jn as X,ye as Y,lt as Z,qn as _,Xe as a,Le as a0,gt as a1,ft as a2,we as a3,Yn as a4,ht as a5,Qn as a6,le as a7,pt as a8,vs as a9,Zn as aa,Jn as ab,eo as ac,xt as ad,Kn as ae,po as af,Gs as ag,Us as ah,Ln as ai,Xn as aj,Bn as ak,Hn as al,Gn as am,Zo as an,rs as ao,Is as ap,Ws as aq,$o as ar,es as as,ie as at,Es as au,jo as av,In as b,de as c,Fe as d,ws as e,ys as f,ke as g,Ss as h,Cs as i,Ve as j,ps as k,xo as l,As as m,bo as n,xs as o,Ms as p,Bs as q,Hs as r,Xs as s,Vs as t,mo as u,Ps as v,Os as w,Ds as x,js as y,Ls as z};
