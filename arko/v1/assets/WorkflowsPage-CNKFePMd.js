import{j as e,b as m}from"./react-flow-Crnto5D5.js";import{c as b,D as U,a as V,b as X,f as T,e as q,A as B,v as K,w as G,x as J,y as Q,z as Z,B as ee,E as te}from"./Toast-CIIUxHDx.js";import{c as L,g as se,u as re,a as ne,e as ae}from"./index-nfnT3jBy.js";import{D as oe,F as _,u as ie}from"./ToastContext-CYaFnpXp.js";import{T as le,P as F,u as ce,F as de,C as ue}from"./useWorkflowRepository-DP_eX4Ym.js";import"./ts-morph-SaAo0aQ4.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],xe=L("ellipsis-vertical",me);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],pe=L("upload",fe),R={event:"#f97316",command:"#3b82f6",policy:"#8b5cf6",trigger:"#22c55e",externalSystem:"#6b7280",externalEvent:"#ec4899",hotspot:"#ef4444",note:"#94a3b8",actor:"#facc15"};function ge({workflow:t}){const{instances:r,definitions:l}=t.document.workflow,n=m.useMemo(()=>{if(!r||r.length===0)return[];const f=new Map;for(const g of l)f.set(g.id,g.kind);return r.map(g=>({x:g.position.x,y:g.position.y,kind:f.get(g.definitionId)||"event"}))},[r,l]);if(n.length===0)return e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 text-text-dim",children:[e.jsx(_,{className:"w-8 h-8 opacity-50"}),e.jsx("span",{className:"text-xs",children:"Vide"})]})});const a=Math.min(...n.map(f=>f.x)),c=Math.max(...n.map(f=>f.x)),i=Math.min(...n.map(f=>f.y)),s=Math.max(...n.map(f=>f.y)),d=c-a||1,u=s-i||1,x=200,p=120,o=20,v=6,y=(x-o*2)/d,k=(p-o*2)/u,j=Math.min(y,k,1),E=(x-d*j)/2,C=(p-u*j)/2;return e.jsxs("svg",{viewBox:`0 0 ${x} ${p}`,className:"w-full h-full",preserveAspectRatio:"xMidYMid meet",children:[e.jsx("defs",{children:e.jsx("pattern",{id:"grid",width:"20",height:"20",patternUnits:"userSpaceOnUse",children:e.jsx("path",{d:"M 20 0 L 0 0 0 20",fill:"none",stroke:"currentColor",strokeOpacity:"0.1",strokeWidth:"0.5"})})}),e.jsx("rect",{width:"100%",height:"100%",fill:"url(#grid)"}),n.map((f,g)=>{const N=(f.x-a)*j+E,W=(f.y-i)*j+C,S=R[f.kind]||R.event;return e.jsx("circle",{cx:N,cy:W,r:v,fill:S,opacity:.9},g)})]})}const w=new Intl.RelativeTimeFormat("fr",{numeric:"auto"});function he(t){const r=new Date(t),n=new Date().getTime()-r.getTime(),a=Math.floor(n/1e3),c=Math.floor(a/60),i=Math.floor(c/60),s=Math.floor(i/24);if(a<60)return w.format(0,"second");if(c<60)return w.format(-c,"minute");if(i<24)return w.format(-i,"hour");if(s<7)return w.format(-s,"day");if(s<30){const d=Math.floor(s/7);return w.format(-d,"week")}if(s<365){const d=Math.floor(s/30.44);return w.format(-d,"month")}return r.toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})}function be({workflow:t,isDeleting:r=!1,onOpen:l,onDelete:n,onExport:a}){const c=t.document.metadata.name||"Sans nom",i=he(t.updatedAt),s=t.document.metadata.targetPlugin!=null,d=()=>{r||l(t)},u=p=>{p.stopPropagation(),a(t)},x=p=>{p.stopPropagation(),!r&&n(t)};return e.jsxs("div",{className:b("bg-surface border border-border rounded-xl overflow-hidden","transition-all duration-200 cursor-pointer","hover:border-border-hover hover:bg-surface-elevated",r&&"opacity-50 pointer-events-none"),onClick:d,children:[e.jsx("div",{className:b("bg-bg-tertiary h-[140px]","border-b border-border"),children:e.jsx(ge,{workflow:t})}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsx("h3",{className:"text-[15px] font-semibold text-text-primary truncate flex-1",children:c}),e.jsx("div",{onClick:p=>p.stopPropagation(),children:e.jsxs(U,{children:[e.jsx(V,{asChild:!0,children:e.jsx("button",{className:b("w-8 h-8 flex items-center justify-center rounded-md shrink-0","bg-transparent border border-border text-text-muted","transition-all duration-200","hover:bg-surface-hover hover:border-border-hover hover:text-text-primary"),title:"Actions",children:e.jsx(xe,{className:"w-4 h-4"})})}),e.jsxs(X,{align:"end",children:[e.jsxs(T,{onSelect:u,children:[e.jsx(oe,{className:"w-4 h-4"}),"Exporter"]}),e.jsx(q,{}),e.jsxs(T,{onSelect:x,className:"text-danger focus:text-danger focus:bg-danger-bg",children:[e.jsx(le,{className:"w-4 h-4"}),"Supprimer"]})]})]})})]}),e.jsx("p",{className:"text-xs text-text-muted mb-3",children:i}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:b("inline-flex items-center gap-1 px-2 py-1 rounded-md text-[11px] font-medium",s?"bg-success/20 text-success":"bg-text-muted/20 text-text-muted"),children:s?"Configure":"Brouillon"}),e.jsx("button",{className:b("px-3 py-1.5 rounded-md text-sm font-medium","bg-accent text-white","transition-colors duration-200","hover:bg-accent-hover"),children:"Ouvrir"})]})]})]})}function D(){return e.jsxs("div",{className:"bg-surface border border-border rounded-xl overflow-hidden",children:[e.jsx("div",{className:"bg-bg-tertiary h-[140px] animate-pulse"}),e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"h-5 w-3/5 bg-bg-tertiary rounded animate-pulse mb-2"}),e.jsx("div",{className:"h-4 w-2/5 bg-bg-tertiary rounded animate-pulse mb-3"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"h-6 w-16 bg-bg-tertiary rounded animate-pulse"}),e.jsx("div",{className:"h-8 w-16 bg-bg-tertiary rounded animate-pulse"})]})]})]})}function je({onCreateWorkflow:t}){return e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 px-10 text-center",children:[e.jsx("div",{className:b("w-20 h-20 rounded-full mb-6","bg-accent-light flex items-center justify-center"),children:e.jsx(_,{className:"w-10 h-10 text-accent"})}),e.jsx("h2",{className:"text-xl font-semibold text-text-primary mb-2",children:"Aucun workflow"}),e.jsx("p",{className:"text-sm text-text-muted mb-6 max-w-md",children:"Vous n'avez pas encore de workflow. Commencez par en creer un pour modeliser vos processus metier."}),e.jsxs("button",{onClick:t,className:b("inline-flex items-center gap-2 px-5 py-2.5 rounded-md","bg-accent text-white font-medium","transition-colors duration-200","hover:bg-accent-hover"),children:[e.jsx(F,{className:"w-5 h-5"}),"Creer mon premier workflow"]})]})}function we({workflows:t,isLoading:r,deletingWorkflowId:l,onOpenWorkflow:n,onDeleteWorkflow:a,onExportWorkflow:c,onCreateWorkflow:i}){return r&&t.length===0?e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5",children:[e.jsx(D,{}),e.jsx(D,{}),e.jsx(D,{}),e.jsx(D,{})]}):t.length===0?e.jsx(je,{onCreateWorkflow:i}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5",children:t.map(s=>e.jsx(be,{workflow:s,isDeleting:l===s.id,onOpen:n,onDelete:a,onExport:c},s.id))})}function ve({workflow:t,open:r,onOpenChange:l,onConfirm:n}){const[a,c]=m.useState(!1),i=async()=>{if(t){c(!0);try{await n(t),l(!1)}finally{c(!1)}}},s=(t==null?void 0:t.document.metadata.name)||"Sans nom";return e.jsx(B,{open:r,onOpenChange:l,children:e.jsxs(K,{children:[e.jsxs(G,{children:[e.jsx(J,{children:"Supprimer ce workflow ?"}),e.jsxs(Q,{children:["Vous etes sur le point de supprimer ",e.jsxs("strong",{className:"text-text-primary",children:['"',s,'"']}),". Cette action est irreversible et toutes les donnees associees seront perdues."]})]}),e.jsxs(Z,{children:[e.jsx(ee,{disabled:a,children:"Annuler"}),e.jsx(te,{onClick:i,disabled:a,children:a?"Suppression...":"Supprimer"})]})]})})}const P="arko:workflows",A="arko:migrated";function ye(){try{const t=localStorage.getItem(P);return t?JSON.parse(t).length>0:!1}catch{return!1}}function ke(){return localStorage.getItem(A)==="true"}function Ne(){try{const t=localStorage.getItem(P);return t?JSON.parse(t):[]}catch{return[]}}async function Me(t,r){const{skipExisting:l=!0,markComplete:n=!0,onProgress:a}=r??{},c=se(),i=Ne(),s={success:!0,total:i.length,migrated:0,skipped:0,failed:0,results:[]};if(i.length===0)return n&&localStorage.setItem(A,"true"),s;for(let d=0;d<i.length;d++){const u=i[d];a==null||a(d+1,i.length);try{if(l){const{data:p}=await c.from("workflows").select("id").eq("id",u.id).eq("user_id",t).single();if(p){s.skipped++,s.results.push({id:u.id,success:!0,skipped:!0});continue}}const{error:x}=await c.from("workflows").insert({id:u.id,user_id:t,document:u.document,created_at:u.createdAt,updated_at:u.updatedAt});x?(s.failed++,s.success=!1,s.results.push({id:u.id,success:!1,error:x.message})):(s.migrated++,s.results.push({id:u.id,success:!0}))}catch(x){s.failed++,s.success=!1,s.results.push({id:u.id,success:!1,error:x instanceof Error?x.message:"Unknown error"})}}return n&&s.success&&localStorage.setItem(A,"true"),s}function Ce(){const{authEnabled:t,isAuthenticated:r,user:l}=re(),[n,a]=m.useState({status:"idle",progress:null,result:null,error:null}),[c,i]=m.useState(!1),s=m.useMemo(()=>t&&r&&l!==null&&!ke()&&ye()&&!c&&n.status!=="completed",[t,r,l,c,n.status]),d=m.useMemo(()=>n.status!=="idle"?n.status:s?"pending":"idle",[n.status,s]),u=m.useMemo(()=>({...n,status:d}),[n,d]),x=m.useCallback(async()=>{if(l){a({status:"migrating",progress:{current:0,total:0},result:null,error:null});try{const o=await Me(l.id,{skipExisting:!0,markComplete:!0,onProgress:(v,y)=>{a(k=>({...k,progress:{current:v,total:y}}))}});a({status:o.success?"completed":"error",progress:null,result:o,error:o.success?null:"Some workflows failed to migrate"})}catch(o){a({status:"error",progress:null,result:null,error:o instanceof Error?o.message:"Migration failed"})}}},[l]),p=m.useCallback(()=>{i(!0),a(o=>({...o,status:"idle"}))},[]);return{state:u,needsMigration:s,startMigration:x,dismissMigration:p}}function Se(t){const r=new Date().toISOString();return{version:ue,metadata:{name:t,createdAt:r,updatedAt:r},workflow:{definitions:[],transitions:[],instances:[],edgeMappings:[],outcomes:[],outcomeEdgeMappings:[]}}}const De=new de;function Le(){const t=ne(),{showSuccess:r,showError:l}=ie(),{workflows:n,total:a,isLoading:c,error:i,fetchWorkflows:s,createWorkflow:d,deleteWorkflow:u,backend:x}=ce(),{needsMigration:p,state:o,startMigration:v,dismissMigration:y}=Ce(),[k,j]=m.useState(null),[E,C]=m.useState(!1),[f,g]=m.useState(null),N=m.useRef(!1);m.useEffect(()=>{o.status==="completed"&&!N.current&&(N.current=!0,s(),o.result&&r("Migration terminée",`${o.result.migrated} workflow(s) migré(s) vers le cloud.`)),o.status!=="completed"&&(N.current=!1)},[o.status,o.result,s,r]);const W=m.useCallback(h=>{t(`/workflow/${h.id}`)},[t]),S=m.useCallback(async()=>{const h=Se("Nouveau workflow"),M=await d(h);M&&t(`/workflow/${M.id}`)},[d,t]),$=m.useCallback(h=>{j(h),C(!0)},[]),Y=m.useCallback(h=>{var O;const M=h.document.metadata.name||"workflow",H=`${M.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"")}.arko.json`,I=De.exportToFile(h.document,H);I.success?r("Export réussi",`${M} exporté.`):l("Erreur d'export",((O=I.error)==null?void 0:O.message)||"Erreur inconnue")},[r,l]),z=m.useCallback(async h=>{g(h.id);try{await u(h.id)}finally{g(null)}},[u]);return e.jsxs("div",{className:"min-h-screen bg-bg-primary",children:[e.jsx("header",{className:"border-b border-border bg-bg-secondary",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-6 py-5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-2xl font-bold text-accent",children:"Arko"}),e.jsx("h1",{className:"text-xl font-semibold text-text-primary",children:"Mes Workflows"})]}),e.jsxs("button",{onClick:S,className:b("inline-flex items-center gap-2 px-5 py-2.5 rounded-md","bg-accent text-white font-medium","transition-colors duration-200","hover:bg-accent-hover"),children:[e.jsx(F,{className:"w-5 h-5"}),"Nouveau workflow"]})]})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-6 py-8",children:[p&&e.jsxs("div",{className:"mb-6 p-4 bg-accent-light border border-accent/30 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(pe,{className:"w-5 h-5 text-accent"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-text-primary",children:"Workflows locaux détectés"}),e.jsx("p",{className:"text-xs text-text-muted",children:"Migrez vos workflows vers le cloud pour y accéder depuis n'importe où."})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:y,className:"px-3 py-1.5 text-sm text-text-muted hover:text-text-primary transition-colors",children:"Plus tard"}),e.jsx("button",{onClick:v,disabled:o.status==="migrating",className:b("inline-flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium","bg-accent text-white","hover:bg-accent-hover transition-colors","disabled:opacity-50 disabled:cursor-not-allowed"),children:o.status==="migrating"?e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-4 h-4 animate-spin"}),"Migration..."]}):"Migrer maintenant"})]})]}),o.progress&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"h-1.5 bg-bg-tertiary rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-accent transition-all duration-300",style:{width:`${o.progress.current/o.progress.total*100}%`}})}),e.jsxs("p",{className:"mt-1 text-xs text-text-muted",children:[o.progress.current," / ",o.progress.total]})]})]}),i&&e.jsx("div",{className:"mb-6 p-4 bg-danger-bg border border-danger/30 rounded-lg text-danger text-sm",children:i.message}),n.length>0&&e.jsx("div",{className:"mb-6 flex items-center justify-between",children:e.jsxs("span",{className:"text-sm text-text-muted",children:[a," workflow",a>1?"s":"",x==="supabase"&&e.jsx("span",{className:"ml-2 px-2 py-0.5 text-xs bg-success/10 text-success rounded",children:"Cloud"}),x==="local"&&e.jsx("span",{className:"ml-2 px-2 py-0.5 text-xs bg-warning/10 text-warning rounded",children:"Local"})]})}),e.jsx(we,{workflows:n,isLoading:c,deletingWorkflowId:f,onOpenWorkflow:W,onDeleteWorkflow:$,onExportWorkflow:Y,onCreateWorkflow:S})]}),e.jsx(ve,{workflow:k,open:E,onOpenChange:C,onConfirm:z})]})}export{Le as default};
