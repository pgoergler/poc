import{h as _e,k as Oe,b as n,u as te,l as Le,j as o,N as Ge,P as ee,d as Z,H as oe,m as Me,i as Ae,S as Be,B as He,e as Fe,C as ze,f as qe}from"./react-flow-JpbcPcxa.js";import{ag as V,ah as ie,ai as We,aj as Ye,ak as $e,al as Ke,am as Ue,an as Xe,ao as Qe,c as Ze,b as ce,ap as Ve,aq as Je,d as le,ar as de,as as et,at as tt,au as ot,av as nt,aw as rt,ax as st,ay as at,az as it,aA as ct,aB as ue,O as pe,aC as lt,aD as dt,aE as ut,aF as pt,aG as gt,aH as ft,aI as mt,Q as ht,Y as bt,_ as xt,aJ as he,$ as vt,l as se,a0 as Ct,a1 as yt,a2 as Nt,a4 as wt,a3 as Dt,aK as kt,aL as jt,aM as It,aN as St,a6 as Tt,a7 as Et,y as be,a9 as Pt,Z as Rt,T as _t,S as Ot,m as ge,U as Lt,F as Gt,n as Mt,x as At,B as Bt,M as Ht,R as Ft,J as zt}from"./style-ChzY8bZH.js";import{c as qt,u as xe,P as Wt,T as ve,a as A}from"./AlertDialog-CqlDNawf.js";import"./ts-morph-SaAo0aQ4.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],Ce=qt("square",Yt);function $t(r,t){const e=r.filter(g=>{var l;return g.type==="remove"&&"id"in g&&((l=t(g.id))==null?void 0:l.type)==="group"});if(e.length===0)return{filteredChanges:r,childIdsToPreserve:new Set,groupIdsBeingDeleted:new Set};const a=new Set(e.map(g=>g.id)),i=new Set;for(const g of r)if(g.type==="remove"&&"id"in g){const l=t(g.id);l!=null&&l.parentId&&a.has(l.parentId)&&i.add(g.id)}return{filteredChanges:r.filter(g=>g.type==="remove"&&"id"in g?!i.has(g.id):!0),childIdsToPreserve:i,groupIdsBeingDeleted:a}}function Kt(r,t,e){if(t.size===0)return r;const a=new Map;for(const i of e){const u=r.find(g=>g.id===i);u&&a.set(i,u.position)}return r.map(i=>{if(t.has(i.id)&&i.parentId){const u=a.get(i.parentId);return{...i,parentId:void 0,position:u?V(i.position,u):i.position,data:{...i.data,groupId:void 0}}}return i})}function Ut(r,t,e){const{filteredChanges:a,childIdsToPreserve:i,groupIdsBeingDeleted:u}=$t(r,t);return i.size>0&&e(g=>Kt(g,i,u)),a}function fe(){return`disc_${xe()}`}function Xt(){return`group_${xe()}`}const ye=n.createContext(null);function L(){const r=n.useContext(ye);if(!r)throw new Error("useDiscovery must be used within a DiscoveryProvider");return r}function me(r){return r==="group"||r==="note"?null:r}function Qt({children:r}){const[t,e,a]=_e([]),[i,u,g]=Oe([]),l=n.useRef(new ie),m=n.useRef(new Map),h=n.useRef(new Map),f=n.useRef(new Map),C=n.useRef(new Map),D=n.useRef(new Map),{getNode:N}=te(),I=n.useCallback(s=>{const x=Ut(s,N,e),b=new Set;for(const c of x)if(c.type==="remove"){const d=C.current.get(c.id);if(d)for(const E of d)b.add(E)}const p=We(x,f.current,C.current,b).map(c=>{var d,E,q,X;if(c.type==="position"&&c.position){const Q=f.current.get(c.id);if(Q){const K=N(c.id),U=N(Q),Re=Ye(c.position.x,c.position.y,((d=U==null?void 0:U.measured)==null?void 0:d.width)??Xe,((E=U==null?void 0:U.measured)==null?void 0:E.height)??Ue,((q=K==null?void 0:K.measured)==null?void 0:q.width)??Ke,((X=K==null?void 0:K.measured)==null?void 0:X.height)??$e);return{...c,position:Re}}}return c});a(p)},[N,e,a]),S=n.useCallback(s=>{const x=Qe(s,i,f.current,C.current);g(x)},[i,g]),k=n.useCallback(s=>{const x=m.current.get(s);if(!x)return!1;const b=l.current.getNode(x);return(b==null?void 0:b.kind)==="command"},[]),y=n.useCallback((s,x)=>x.filter(b=>b.source===s).length,[]),w=n.useCallback((s,x)=>{const v=y(s,x)>=2?"commandEdge":"floating";return x.map(p=>{var c;return p.source!==s||p.type===v?p:{...p,type:v,data:{...p.data,...v==="commandEdge"&&!((c=p.data)!=null&&c.label)?{label:"Path",labelOffset:.5}:{}}}})},[y]),P=n.useCallback(s=>{if(!s.source||!s.target)return;const x=f.current.has(s.source),b=f.current.get(s.source);let v;x&&b?v=m.current.get(b):v=m.current.get(s.source);const p=m.current.get(s.target),c=!x&&k(s.source);if(v&&p){const d=Ze(),E={id:d,sourceDefId:v,targetDefId:p};try{l.current.addTransition(E)}catch{}u(q=>{const X={...s,id:`edge_${d}`,source:s.source,target:s.target,type:"floating",data:{transitionId:d,state:"idle"}},Q=[...q,X];return c?w(s.source,Q):Q}),h.current.set(`edge_${d}`,d),x&&D.current.set(s.source,d)}else u(d=>Le({...s,type:"floating",data:{state:"idle"}},d))},[u,k,w]),R=s=>({event:"Event",command:"Command",policy:"Policy",trigger:"Trigger",externalSystem:"External System",externalEvent:"External Event",hotspot:"HotSpot",actor:"Actor",note:"Note",group:"Group"})[s]||"",O=n.useCallback((s,x)=>{["True","False"].forEach((v,p)=>{const c=ce(),d=at(p),E=Je(c,s,x,v,d);Ve(f.current,C.current,c,s),e(q=>[...q,E])})},[e]),T=n.useCallback((s,x,b)=>{const v=fe(),p=me(s),c=b??R(s);let d;if(p){d=le();const q={id:d,label:c,kind:p,category:p==="externalSystem"||p==="externalEvent"?"technical":"business",executionMode:de(p)};l.current.addNode(q),m.current.set(v,d)}const E={id:v,type:s,position:x,data:{label:c,kind:s,definitionId:d}};return e(q=>[...q,E]),s==="policy"&&d&&setTimeout(()=>{O(v,d)},0),v},[e,O]),j=n.useCallback(s=>{const x=m.current.get(s);x&&(l.current.removeNode(x),m.current.delete(s));const b=C.current.get(s);if(b&&b.size>0){const v=Array.from(b);u(p=>{const c=p.filter(d=>v.includes(d.source));for(const d of c){const E=h.current.get(d.id);if(E){try{l.current.removeTransition(E)}catch{}h.current.delete(d.id)}}return p.filter(d=>!v.includes(d.source))});for(const p of v)et(f.current,C.current,D.current,p)}e(v=>{const p=v.find(c=>c.id===s);if((p==null?void 0:p.type)==="group"){const c=p.position;return v.filter(d=>d.id!==s).map(d=>d.parentId===s?{...d,parentId:void 0,position:V(d.position,c),data:{...d.data,groupId:void 0}}:d)}if(b&&b.size>0){const c=Array.from(b);return v.filter(d=>d.id!==s&&!c.includes(d.id))}return v.filter(c=>c.id!==s)}),u(v=>{const p=v.filter(c=>c.source===s||c.target===s);for(const c of p){const d=h.current.get(c.id);if(d){try{l.current.removeTransition(d)}catch{}h.current.delete(c.id)}}return v.filter(c=>c.source!==s&&c.target!==s)})},[e,u]),G=n.useCallback((s,x)=>{const b=m.current.get(s);b&&l.current.updateNode(b,{label:x}),e(v=>v.map(p=>p.id===s?{...p,data:{...p.data,label:x}}:p))},[e]),H=n.useCallback(s=>{const x=t.find(E=>E.id===s);if(!x||x.type==="group")return;const b=x.data.kind,v=fe(),p=me(b);let c;if(p){c=le();const E={id:c,label:x.data.label,kind:p,category:p==="externalSystem"||p==="externalEvent"?"technical":"business",executionMode:de(p)};l.current.addNode(E),m.current.set(v,c)}const d={...x,id:v,position:{x:x.position.x+20,y:x.position.y+20},selected:!1,data:{...x.data,definitionId:c}};return e(E=>[...E,d]),v},[t,e]),F=n.useCallback((s,x)=>{const b=Xt();return e(v=>{let p=x;if(!p){const E=v.filter(X=>X.type==="group").map(X=>{var K,U;const Q=(U=(K=X.data)==null?void 0:K.label)==null?void 0:U.match(/^Group\s+(\d+)$/i);return Q?parseInt(Q[1],10):0});p=`Group ${(E.length>0?Math.max(...E):0)+1}`}return[{id:b,type:"group",position:s,data:{label:p,kind:"group"},width:400,height:300},...v]}),b},[e]),B=n.useCallback((s,x)=>{e(b=>{const v=b.find(d=>d.id===x),p=b.find(d=>d.id===s);if(!v||!p||p.type==="group")return b;const c=tt(p.position,v.position);return b.map(d=>d.id===s?{...d,parentId:x,position:c,data:{...d.data,groupId:x}}:d)})},[e]),z=n.useCallback((s,x)=>{e(b=>{const v=b.find(d=>d.id===s);if(!v||!v.parentId)return b;const p=b.find(d=>d.id===v.parentId);if(!p)return b;const c=x??V(v.position,p.position);return b.map(d=>d.id===s?{...d,parentId:void 0,position:c,data:{...d.data,groupId:void 0}}:d)})},[e]),_=n.useCallback(s=>t.filter(x=>x.parentId===s).map(x=>x.id),[t]),M=n.useCallback(()=>{const s=t.filter(b=>b.selected),x=s.map(b=>b.id);for(const b of s){const v=m.current.get(b.id);v&&(l.current.removeNode(v),m.current.delete(b.id))}e(b=>{const v=b.filter(c=>c.selected&&c.type==="group").map(c=>c.id),p=new Map;for(const c of v){const d=b.find(E=>E.id===c);d&&p.set(c,d.position)}return b.filter(c=>!c.selected).map(c=>{if(c.parentId&&v.includes(c.parentId)){const d=p.get(c.parentId);return{...c,parentId:void 0,position:d?V(c.position,d):c.position,data:{...c.data,groupId:void 0}}}return c})}),u(b=>{const v=b.filter(p=>x.includes(p.source)||x.includes(p.target));for(const p of v){const c=h.current.get(p.id);if(c){try{l.current.removeTransition(c)}catch{}h.current.delete(p.id)}}return b.filter(p=>!x.includes(p.source)&&!x.includes(p.target))})},[t,e,u]),we=n.useCallback(()=>{l.current=new ie,m.current.clear(),h.current.clear(),f.current.clear(),C.current.clear(),D.current.clear(),e([]),u([])},[e,u]),ae=n.useCallback(()=>({cleanupEdgesFromSource:s=>{const b=i.filter(v=>v.source===s).map(v=>v.id);for(const v of b){const p=h.current.get(v);if(p){try{l.current.removeTransition(p)}catch{}h.current.delete(v)}}return b}}),[i]),De=n.useCallback((s,x)=>{const b=m.current.get(s);if(!b)throw new Error(`Policy ${s} not found`);return ot(s,b,x,f.current,C.current,e,ce)},[e]),ke=n.useCallback(s=>{const x=ae();return nt(s,f.current,C.current,D.current,x,e,u)},[e,u,ae]),je=n.useCallback((s,x)=>{rt(s,x,e)},[e]),Ie=n.useCallback(s=>D.current.get(s),[]),Se=n.useCallback(s=>st(C.current,s),[]),Te=n.useCallback(s=>m.current.get(s),[]),Ee=n.useCallback(()=>l.current,[]),Pe={nodes:t,edges:i,getGraph:Ee,onNodesChange:I,onEdgesChange:S,onConnect:P,setEdges:u,addNode:T,deleteNode:j,updateNodeLabel:G,duplicateNode:H,addGroup:F,addNodeToGroup:B,removeNodeFromGroup:z,getNodesInGroup:_,addOutcomeToPolicy:De,deleteOutcome:ke,updateOutcomeLabel:je,getOutcomeTransition:Ie,getOutcomeCount:Se,deleteSelected:M,clearCanvas:we,getDefinitionIdForNode:Te};return o.jsx(ye.Provider,{value:Pe,children:r})}const Ne=n.createContext(null);function Zt({children:r}){const{getGraph:t}=L(),e=n.useMemo(()=>t(),[t]),a=it(e);return o.jsx(Ne.Provider,{value:a,children:r})}function Y(){const r=n.useContext(Ne);if(!r)throw new Error("useDiscoverySimulation must be used within a DiscoverySimulationProvider");return r}const $=n.memo(function({onDelete:t,onAddOutcome:e}){return o.jsxs(Ge,{position:ee.Top,offset:8,className:ct,children:[e&&o.jsx("button",{onClick:e,className:ue("purple"),title:"Add outcome",children:o.jsx(Wt,{className:pe})}),o.jsx("button",{onClick:t,className:ue("danger"),title:"Delete node",children:o.jsx(ve,{className:pe})})]})}),Vt=["event","command","policy","trigger","externalSystem","externalEvent"];function Jt(){const{getNode:r}=te(),{addNode:t,onConnect:e,addNodeToGroup:a}=L(),i=n.useCallback(()=>Vt,[]),u=n.useCallback((g,l,m)=>{var y,w;const h=r(g);if(!h)return;const f=h.parentId?r(h.parentId):void 0,C=lt(h.position,f==null?void 0:f.position),D=((y=h.measured)==null?void 0:y.width)??dt,N=((w=h.measured)==null?void 0:w.height)??ut,I=pt(C,D,N,m),S=t(l,I);if(h.parentId&&f)if(f.type==="policy"){if(f.parentId){const P=r(f.parentId);(P==null?void 0:P.type)==="group"&&setTimeout(()=>{a(S,f.parentId)},0)}}else f.type==="group"&&setTimeout(()=>{a(S,h.parentId)},0);const k=gt(m);setTimeout(()=>{e({source:g,target:S,sourceHandle:k.source,targetHandle:k.target})},0)},[r,t,e,a]);return{getValidTargetTypes:i,createConnectedNode:u}}const J=n.memo(function({nodeId:t,isCompact:e=!1,isOutcome:a=!1}){const i=a||e,{getValidTargetTypes:u,createConnectedNode:g}=Jt(),l=u(),m=n.useCallback((f,C)=>{g(t,f,C)},[t,g]),h=n.useCallback(f=>o.jsx(ft,{...f}),[]);return o.jsx(mt,{validTypes:l,isCompact:i,onCreateNode:m,renderMenu:h})}),eo=n.memo(function({id:t,data:e,selected:a}){const i=Z(),u=i.inProgress,g=a||i.inProgress,{updateNodeLabel:l,deleteNode:m}=L(),{state:h}=Y(),f=e.definitionId?h==null?void 0:h.nodeStates.get(e.definitionId):void 0,C=f==="completed",D=f==="active"||f==="entering",N=n.useCallback(S=>{l(t,S)},[t,l]),I=n.useCallback(()=>{m(t)},[t,m]);return o.jsx(ht,{label:e.label,selected:a,isCompleted:C,isActive:D,isTargetConnectable:u,isSourceConnectable:g,onLabelChange:N,placeholder:"Event",toolbar:a?o.jsx($,{onDelete:I}):void 0,quickCreateButtons:a?o.jsx(J,{nodeId:t}):void 0})}),to=n.memo(function({id:t,data:e,selected:a}){const i=Z(),u=i.inProgress,g=a||i.inProgress,{updateNodeLabel:l,deleteNode:m}=L(),{state:h}=Y(),f=e.definitionId?h==null?void 0:h.nodeStates.get(e.definitionId):void 0,C=f==="completed",D=f==="active"||f==="entering",N=n.useCallback(S=>{l(t,S)},[t,l]),I=n.useCallback(()=>{m(t)},[t,m]);return o.jsx(bt,{label:e.label,selected:a,isCompleted:C,isActive:D,isTargetConnectable:u,isSourceConnectable:g,onLabelChange:N,placeholder:"Command",toolbar:a?o.jsx($,{onDelete:I}):void 0,quickCreateButtons:a?o.jsx(J,{nodeId:t}):void 0})}),oo=n.memo(function({id:t,data:e,selected:a}){const u=Z().inProgress,{updateNodeLabel:g,deleteNode:l,addOutcomeToPolicy:m}=L(),{state:h}=Y(),f=e.definitionId?h==null?void 0:h.nodeStates.get(e.definitionId):void 0,C=f==="completed",D=f==="active"||f==="entering",N=f==="waiting_for_action",I=n.useCallback(y=>{g(t,y)},[t,g]),S=n.useCallback(()=>{l(t)},[t,l]),k=n.useCallback(()=>{m(t,"New")},[t,m]);return o.jsx(xt,{label:e.label,selected:a,isCompleted:C,isActive:D,isWaiting:N,isTargetConnectable:u,onLabelChange:I,placeholder:"Policy",toolbar:a?o.jsx($,{onDelete:S,onAddOutcome:k}):void 0})}),no=n.memo(function({id:t,data:e,selected:a}){const i=Z(),u=i.inProgress,g=a||i.inProgress,{updateNodeLabel:l,deleteNode:m}=L(),{state:h,isRunning:f,start:C,triggerNode:D,completeManualNode:N}=Y(),I=n.useMemo(()=>({isRunning:f,start:C,triggerNode:D,completeManualNode:N}),[f,C,D,N]),{execute:S}=he(I),k=e.definitionId?h==null?void 0:h.nodeStates.get(e.definitionId):void 0,y=k==="completed",w=k==="active"||k==="entering",P=n.useCallback(T=>{l(t,T)},[t,l]),R=n.useCallback(()=>{m(t)},[t,m]),O=n.useCallback(T=>{T.stopPropagation(),e.definitionId&&S(e.definitionId)},[e.definitionId,S]);return o.jsx(vt,{label:e.label,selected:a,isCompleted:y,isActive:w,isTargetConnectable:u,isSourceConnectable:g,onLabelChange:P,placeholder:"Trigger",toolbar:a?o.jsx($,{onDelete:R}):void 0,quickCreateButtons:a?o.jsx(J,{nodeId:t}):void 0,playButton:o.jsx("button",{className:"play-btn absolute bottom-1.5 right-1.5 w-6 h-6 min-w-6 min-h-6 shrink-0 rounded-full bg-white border-2 border-transparent cursor-pointer flex items-center justify-center shadow-[0_2px_4px_rgba(0,0,0,0.3)] transition-all duration-200 p-0 outline-none z-[5] text-node-trigger hover:scale-[1.15] hover:bg-[#f0f0f0] hover:border-node-trigger",onClick:O,title:f?"Trigger this node":"Start simulation and trigger",children:o.jsx(se,{fill:"currentColor",strokeWidth:0,style:{width:12,height:12}})})})}),ro=n.memo(function({id:t,data:e,selected:a}){const i=Z(),u=i.inProgress,g=a||i.inProgress,{updateNodeLabel:l,deleteNode:m}=L(),{state:h}=Y(),f=e.definitionId?h==null?void 0:h.nodeStates.get(e.definitionId):void 0,C=f==="completed",D=f==="active"||f==="entering",N=n.useCallback(S=>{l(t,S)},[t,l]),I=n.useCallback(()=>{m(t)},[t,m]);return o.jsx(Ct,{label:e.label,selected:a,isCompleted:C,isActive:D,isTargetConnectable:u,isSourceConnectable:g,onLabelChange:N,placeholder:"External System",toolbar:a?o.jsx($,{onDelete:I}):void 0,quickCreateButtons:a?o.jsx(J,{nodeId:t}):void 0})}),so=n.memo(function({id:t,data:e,selected:a}){const i=Z(),u=i.inProgress,g=a||i.inProgress,{updateNodeLabel:l,deleteNode:m}=L(),{state:h,isRunning:f,start:C,triggerNode:D,completeManualNode:N}=Y(),I=n.useMemo(()=>({isRunning:f,start:C,triggerNode:D,completeManualNode:N}),[f,C,D,N]),{execute:S}=he(I),k=e.definitionId?h==null?void 0:h.nodeStates.get(e.definitionId):void 0,y=k==="completed",w=k==="active"||k==="entering",P=n.useCallback(T=>{l(t,T)},[t,l]),R=n.useCallback(()=>{m(t)},[t,m]),O=n.useCallback(T=>{T.stopPropagation(),e.definitionId&&S(e.definitionId)},[e.definitionId,S]);return o.jsx(yt,{label:e.label,selected:a,isCompleted:y,isActive:w,isTargetConnectable:u,isSourceConnectable:g,onLabelChange:P,placeholder:"External Event",toolbar:a?o.jsx($,{onDelete:R}):void 0,quickCreateButtons:a?o.jsx(J,{nodeId:t}):void 0,playButton:o.jsx("button",{className:"play-btn absolute bottom-1.5 right-1.5 w-6 h-6 min-w-6 min-h-6 shrink-0 rounded-full bg-white border-2 border-transparent cursor-pointer flex items-center justify-center shadow-[0_2px_4px_rgba(0,0,0,0.3)] transition-all duration-200 p-0 outline-none z-[5] text-node-external hover:scale-[1.15] hover:bg-[#f0f0f0] hover:border-node-external",onClick:O,title:f?"Trigger this node":"Start simulation and trigger",children:o.jsx(se,{fill:"currentColor",strokeWidth:0,style:{width:12,height:12}})})})}),ao=n.memo(function({id:t,data:e,selected:a}){const{updateNodeLabel:i,deleteNode:u}=L(),g=n.useCallback(m=>{i(t,m)},[t,i]),l=n.useCallback(()=>{u(t)},[t,u]);return o.jsx(Nt,{label:e.label,selected:a,description:e.description,onLabelChange:g,placeholder:"HotSpot",toolbar:a?o.jsx($,{onDelete:l}):void 0})}),io=n.memo(function({id:t,data:e,selected:a}){const{updateNodeLabel:i,deleteNode:u}=L(),g=n.useCallback(m=>{i(t,m)},[t,i]),l=n.useCallback(()=>{u(t)},[t,u]);return o.jsx(wt,{label:e.label,selected:a,onLabelChange:g,placeholder:"Actor",toolbar:a?o.jsx($,{onDelete:l}):void 0})}),co=n.memo(function({id:t,data:e,selected:a}){const{updateNodeLabel:i,deleteNode:u}=L(),g=n.useCallback(m=>{i(t,m)},[t,i]),l=n.useCallback(()=>{u(t)},[t,u]);return o.jsx(Dt,{label:e.label,selected:a,onLabelChange:g,placeholder:"Note",toolbar:a?o.jsx($,{onDelete:l}):void 0})});function lo(r){const{getNodes:t,getNode:e}=te(),{getNodesInGroup:a,removeNodeFromGroup:i,addNodeToGroup:u}=L(),g=n.useRef([]),l=n.useCallback(()=>{const h=e(r);if(!h)return;const f=h.position,C=a(r),D=t();g.current=C.map(N=>{var k,y;const I=D.find(w=>w.id===N);if(!I)return null;const S=V(I.position,f);return{id:N,absoluteX:S.x,absoluteY:S.y,width:((k=I.measured)==null?void 0:k.width)??I.width??100,height:((y=I.measured)==null?void 0:y.height)??I.height??60}}).filter(N=>N!==null)},[r,e,t,a]),m=n.useCallback((h,f)=>{var k,y;const C=e(r);if(!C)return;const D=C.position.x,N=C.position.y;for(const w of g.current){const P=w.absoluteX+w.width/2,R=w.absoluteY+w.height/2,O=D,T=D+h,j=N,G=N+f;(P<O||P>T||R<j||R>G)&&i(w.id,{x:w.absoluteX,y:w.absoluteY})}const S=t().filter(w=>w.type!=="group"&&!w.parentId);for(const w of S){const P=((k=w.measured)==null?void 0:k.width)??w.width??100,R=((y=w.measured)==null?void 0:y.height)??w.height??60,O=w.position.x+P/2,T=w.position.y+R/2;O>=D&&O<=D+h&&T>=N&&T<=N+f&&u(w.id,r)}g.current=[]},[r,e,t,i,u]);return{handleResizeStart:l,handleResizeEnd:m}}const uo=n.memo(function({id:t,data:e,selected:a}){const{updateNodeLabel:i,deleteNode:u}=L(),{handleResizeStart:g,handleResizeEnd:l}=lo(t),m=n.useCallback(f=>{i(t,f)},[t,i]),h=n.useCallback(()=>{u(t)},[t,u]);return o.jsx(kt,{label:e.label,selected:a,onLabelChange:m,onResizeStart:g,onResizeEnd:l,placeholder:"Group",toolbar:a?o.jsx($,{onDelete:h}):void 0})}),po=n.memo(function({id:t,data:e,selected:a}){const i=Z(),u=a||i.inProgress,{state:g,selectTransition:l,isRunning:m,start:h,triggerNode:f}=Y(),{getOutcomeTransition:C,updateOutcomeLabel:D,deleteOutcome:N,getOutcomeCount:I}=L(),k=(e.parentPolicyDefId?g==null?void 0:g.nodeStates.get(e.parentPolicyDefId):void 0)==="waiting_for_action",y=n.useMemo(()=>({isRunning:m,start:h,triggerNode:f,selectTransition:l}),[m,h,f,l]),w=n.useMemo(()=>({isSourceWaiting:k}),[k]),{execute:P}=jt(y,w),R=C(t),O=!!R,j=I(e.parentPolicyId)>2,G=n.useCallback(B=>{B.stopPropagation(),!(!R||!e.parentPolicyDefId)&&P(e.parentPolicyDefId,R)},[R,e.parentPolicyDefId,P]),H=n.useCallback(B=>{D(t,B)},[t,D]),F=n.useCallback(B=>{N(B)},[N]);return o.jsxs("div",{className:A("gradient-outcome border border-node-policy/50 rounded-md","w-auto h-auto min-w-[50px] min-h-8 p-0","shadow-[0_2px_4px_rgba(0,0,0,0.3)] transition-all duration-200","hover:scale-[1.02]",a&&"node-selected node-selected-outcome shadow-[0_0_8px_rgba(147,51,234,0.8)] border-node-policy",k&&"gradient-outcome-clickable border-node-policy cursor-pointer animate-pulse-outcome hover:scale-[1.08] hover:shadow-[0_0_12px_rgba(147,51,234,0.9)]"),children:[o.jsx(It,{outcomeId:t,canDelete:j,onDelete:F}),a&&o.jsx(J,{nodeId:t,isOutcome:!0}),o.jsx(oe,{type:"source",position:ee.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:u}),o.jsx(oe,{type:"source",position:ee.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:u}),o.jsx(oe,{type:"source",position:ee.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:u}),o.jsx(oe,{type:"source",position:ee.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:u}),o.jsxs("div",{className:"flex flex-row items-center gap-1.5 py-1 px-2",children:[o.jsx("button",{className:A("w-[18px] h-[18px] rounded-full border flex items-center justify-center","shadow-[0_1px_3px_rgba(0,0,0,0.2)] transition-all duration-200 p-0 outline-none shrink-0",O?"bg-node-policy border-white/30 text-white cursor-pointer hover:scale-[1.15] hover:bg-[#a855f7] hover:border-white/50":"bg-node-policy/40 border-white/20 text-white/50 cursor-default"),onClick:G,disabled:!O,title:O?k?`Select ${e.label}`:`Trigger from ${e.label}`:"Connect this outcome to enable",children:o.jsx(se,{className:"w-2.5 h-2.5"})}),o.jsx(St,{value:e.label,onChange:H,placeholder:"Outcome",autoSize:!0,className:"text-white [.light_&]:text-postit-text"})]})]})}),go={event:eo,command:to,policy:oo,trigger:no,externalSystem:ro,externalEvent:so,hotspot:ao,actor:io,note:co,group:uo,outcome:po};function fo(r){const{state:t,selectTransition:e,isRunning:a,start:i,triggerNode:u}=Y(),{getDefinitionIdForNode:g}=L(),l=n.useCallback(m=>g(m),[g]);return o.jsx(Tt,{...r,simulationState:t,isRunning:a,start:i,triggerNode:u,selectTransition:e,getSourceDefinitionId:l})}const mo={floating:Et,commandEdge:fo},ne=16;function re(r,t){var i,u;const e=t.width??((i=t.measured)==null?void 0:i.width)??400,a=t.height??((u=t.measured)==null?void 0:u.height)??300;return r.x>=t.position.x&&r.x<=t.position.x+e&&r.y>=t.position.y&&r.y<=t.position.y+a}function ho(){const r=n.useRef(null),{screenToFlowPosition:t,getNodes:e}=te(),{nodes:a,edges:i,onNodesChange:u,onEdgesChange:g,onConnect:l,setEdges:m,addNode:h,addGroup:f,addNodeToGroup:C,removeNodeFromGroup:D}=L(),N=n.useRef(!0),{theme:I}=be(),{events:S}=Y();Pt(S);const k=n.useCallback(T=>{T.preventDefault(),T.dataTransfer.dropEffect="move"},[]),y=n.useCallback(T=>{T.preventDefault();const j=T.dataTransfer.getData("application/reactflow");if(!j||!r.current)return;const G=t({x:T.clientX,y:T.clientY}),H={x:Math.round(G.x/ne)*ne,y:Math.round(G.y/ne)*ne};if(j==="group"){const F=f(H);setTimeout(()=>{const B=e(),z=B.find(M=>M.id===F);if(!z)return;const _=B.filter(M=>M.type!=="group"&&!M.parentId);for(const M of _)re(M.position,z)&&C(M.id,F)},0)}else{const F=h(j,H),z=e().filter(_=>_.type==="group");for(const _ of z)if(re(H,_)){setTimeout(()=>{C(F,_.id)},0);break}}},[t,h,f,e,C]),w=n.useCallback((T,j)=>{const G=e();if(j.type==="group"){const _=G.filter(M=>M.type!=="group"&&!M.parentId);for(const M of _)re(M.position,j)&&C(M.id,j.id);return}if(j.type==="outcome")return;const H=G.filter(_=>_.type==="group"),F=j.parentId?G.find(_=>_.id===j.parentId):void 0,B=F?V(j.position,F.position):j.position;let z=null;for(const _ of H)if(_.id!==j.id&&re(B,_)){z=_.id;break}z?j.parentId!==z&&(j.parentId&&D(j.id),C(j.id,z)):j.parentId&&D(j.id)},[e,C,D]),P=n.useCallback(()=>{N.current=!1},[]),R=n.useCallback((T,j)=>{N.current=!0,m(G=>Me(T,j,G))},[m]),O=n.useCallback((T,j)=>{N.current||m(G=>G.filter(H=>H.id!==j.id)),N.current=!0},[m]);return o.jsx("div",{ref:r,className:"w-full h-full gradient-canvas",children:o.jsxs(Ae,{nodes:a,edges:i,onNodesChange:u,onEdgesChange:g,onConnect:l,onReconnectStart:P,onReconnect:R,onReconnectEnd:O,onDragOver:k,onDrop:y,onNodeDragStop:w,nodeTypes:go,edgeTypes:mo,colorMode:I,snapToGrid:!0,snapGrid:[16,16],elevateEdgesOnSelect:!0,selectionOnDrag:!0,selectionMode:Be.Partial,selectionKeyCode:"Shift",multiSelectionKeyCode:["Meta","Control","Shift"],deleteKeyCode:["Backspace","Delete"],minZoom:.01,defaultEdgeOptions:{type:"floating",data:{state:"idle"},reconnectable:!0},children:[o.jsx(He,{variant:Fe.Dots,gap:16,size:1,offset:[16,16],bgColor:"transparent"}),o.jsx(ze,{showZoom:!1,showInteractive:!1})]})})}const W={width:20,height:20},bo={event:{gradient:"bg-gradient-to-b from-postit-event to-postit-event-dark",rotate:"-rotate-1",hoverRotate:"hover:-rotate-1 hover:scale-105"},command:{gradient:"bg-gradient-to-b from-postit-command to-postit-command-dark",rotate:"rotate-[0.8deg]",hoverRotate:"hover:rotate-[0.8deg] hover:scale-105"},policy:{gradient:"bg-gradient-to-b from-postit-policy to-postit-policy-dark",rotate:"rotate-[0.5deg]",hoverRotate:"hover:rotate-[0.5deg] hover:scale-105"},trigger:{gradient:"bg-gradient-to-b from-postit-trigger to-postit-trigger-dark",rotate:"rotate-1",hoverRotate:"hover:rotate-1 hover:scale-105"},externalSystem:{gradient:"bg-gradient-to-b from-postit-external to-postit-external-dark",rotate:"-rotate-[0.5deg]",hoverRotate:"hover:-rotate-[0.5deg] hover:scale-105"},externalEvent:{gradient:"bg-gradient-to-b from-postit-external to-postit-external-dark",rotate:"rotate-[0.8deg]",hoverRotate:"hover:rotate-[0.8deg] hover:scale-105"},hotspot:{gradient:"bg-gradient-to-b from-postit-hotspot to-postit-hotspot-dark",rotate:"rotate-[1.2deg]",hoverRotate:"hover:rotate-[1.2deg] hover:scale-105"},actor:{gradient:"bg-gradient-to-b from-postit-actor to-postit-actor-dark",rotate:"-rotate-[0.8deg]",hoverRotate:"hover:-rotate-[0.8deg] hover:scale-105"},note:{gradient:"bg-gradient-to-b from-postit-note to-postit-note-dark",rotate:"rotate-[0.3deg]",hoverRotate:"hover:rotate-[0.3deg] hover:scale-105"},group:{gradient:"bg-transparent border-2 border-dashed border-[rgba(139,92,246,0.5)]",rotate:"rotate-0",hoverRotate:"hover:rotate-0 hover:scale-105 hover:border-[rgba(139,92,246,0.8)]"}},xo=[{type:"event",label:"Event",icon:o.jsx(Rt,{style:{...W,color:"#ea580c"}}),description:"Business fact that happened (e.g., OrderCreated)"},{type:"command",label:"Command",icon:o.jsx(_t,{style:{...W,color:"#2563eb"}}),description:"Action to execute that produces events"},{type:"policy",label:"Policy",icon:o.jsx(Ot,{style:{...W,color:"#9333ea"}}),description:"Decision logic with multiple outcomes"},{type:"trigger",label:"Trigger",icon:o.jsx(se,{style:{...W,color:"#0d9488"}}),description:"Entry point: HTTP endpoint or scheduled job"},{type:"externalSystem",label:"Ext System",icon:o.jsx(ge,{style:{...W,color:"#db2777"}}),description:"External system integration"},{type:"externalEvent",label:"Ext Event",icon:o.jsx(ge,{style:{...W,color:"#db2777"}}),description:"Event from external source"},{type:"actor",label:"Actor",icon:o.jsx(Lt,{style:{...W,color:"#ca8a04"}}),description:"Person or role in the system"},{type:"hotspot",label:"HotSpot",icon:o.jsx(Gt,{style:{...W,color:"#ef4444"}}),description:"Point of attention or concern"},{type:"note",label:"Note",icon:o.jsx(Mt,{style:{...W,color:"#737373"}}),description:"Free-form annotation"},{type:"group",label:"Group",icon:o.jsx(Ce,{style:{...W,color:"rgba(139,92,246,0.8)"}}),description:"Container frame (Miro-style)"}];function vo({collapsed:r=!1}){const t=(e,a)=>{e.dataTransfer.setData("application/reactflow",a),e.dataTransfer.effectAllowed="move"};return o.jsxs("div",{className:"flex flex-col gap-2",children:[!r&&o.jsx("h3",{className:"m-0 mb-2 text-[0.85rem] text-text-dim uppercase tracking-[0.5px]",children:"Nodes"}),o.jsx("div",{className:A("grid gap-2",r?"grid-cols-1":"grid-cols-2"),children:xo.map(({type:e,label:a,icon:i,description:u})=>{const g=bo[e],l=e==="group";return o.jsxs("div",{className:A("flex flex-col items-center justify-center gap-1 py-2.5 px-2 cursor-grab select-none text-center relative transition-all duration-200",!l&&"shadow-[2px_2px_6px_rgba(0,0,0,0.25),inset_0_-2px_3px_rgba(0,0,0,0.05)]",!l&&'before:content-[""] before:absolute before:top-0 before:left-[20%] before:right-[20%] before:h-[5px] before:bg-black/10 before:rounded-b',l&&"rounded-lg",g.gradient,g.rotate,!l&&"hover:shadow-[3px_3px_8px_rgba(0,0,0,0.35),inset_0_-2px_3px_rgba(0,0,0,0.05)]",g.hoverRotate,"active:cursor-grabbing",r&&!l&&"p-2.5 w-9 h-9 before:left-[15%] before:right-[15%] before:h-1 hover:scale-110 hover:rotate-0",r&&l&&"p-2.5 w-9 h-9 hover:scale-110"),draggable:!0,onDragStart:m=>t(m,e),title:r?`${a}: ${u}`:u,children:[o.jsx("span",{className:"text-[1.3rem] flex items-center justify-center",children:i}),!r&&o.jsx("span",{className:A("font-medium text-xs",l?"text-[rgba(139,92,246,0.7)]":"text-postit-text"),children:a})]},e)})}),!r&&o.jsx("p",{className:"m-0 text-[0.8rem] text-text-faint",children:"Drag to canvas"})]})}function Co(){const{collapsed:r,toggleCollapsed:t}=At(),{theme:e,toggleTheme:a}=be(),{nodes:i,clearCanvas:u}=L(),{isRunning:g,stop:l,reset:m}=Y(),{fitView:h}=te(),[f,C]=n.useState(!1),D=n.useMemo(()=>i.filter(y=>y.type==="group").map(y=>{var w,P,R;return{id:y.id,label:((w=y.data)==null?void 0:w.label)||"Untitled Group",position:y.position,width:y.width??((P=y.measured)==null?void 0:P.width)??400,height:y.height??((R=y.measured)==null?void 0:R.height)??300}}).sort((y,w)=>y.label.localeCompare(w.label)),[i]),N=y=>{h({nodes:[{id:y}],padding:.3,duration:300,maxZoom:1.5})},I=()=>{C(!0)},S=()=>{g&&l(),m(),u()},k=()=>{g&&l(),m()};return o.jsxs("div",{className:A("flex flex-col h-full p-5 gap-6 overflow-y-auto transition-all duration-200","bg-bg-secondary border-r border-border","w-[220px] min-w-[220px]",r&&"w-[60px] min-w-[60px] p-3 gap-4"),children:[o.jsxs("div",{className:A("flex items-center justify-between gap-3 pb-4 border-b border-border",r&&"justify-center pb-3"),children:[!r&&o.jsx("h2",{className:"m-0 text-[1.4rem] text-text-primary whitespace-nowrap overflow-hidden",children:"Discovery"}),o.jsxs("div",{className:A("flex items-center gap-2",r&&"flex-col gap-1.5"),children:[o.jsx("button",{className:"w-7 h-7 rounded-md bg-bg-tertiary border border-border-hover text-text-primary cursor-pointer flex items-center justify-center transition-all duration-200 shrink-0 p-0 hover:bg-border-hover hover:border-border-active hover:text-accent focus:outline-none",onClick:a,title:e==="dark"?"Switch to light mode":"Switch to dark mode",children:e==="dark"?o.jsx(Bt,{className:"w-4 h-4"}):o.jsx(Ht,{className:"w-4 h-4"})}),o.jsx("button",{className:"w-7 h-7 rounded-md bg-bg-tertiary border border-border-hover text-text-primary cursor-pointer text-base flex items-center justify-center transition-all duration-200 shrink-0 p-0 hover:bg-border-hover hover:border-border-active focus:outline-none",onClick:t,title:r?"Expand sidebar":"Collapse sidebar",children:r?"→":"←"})]})]}),o.jsx(vo,{collapsed:r}),D.length>0&&o.jsxs("div",{className:"flex flex-col gap-2",children:[!r&&o.jsx("h3",{className:"m-0 mb-2 text-[0.85rem] text-text-dim uppercase tracking-[0.5px]",children:"Groups"}),o.jsx("div",{className:A("flex flex-col gap-1.5",r&&"items-center"),children:D.map(y=>o.jsxs("button",{className:A("flex items-center gap-2 px-2 py-1.5 rounded-md cursor-pointer","bg-transparent border border-dashed border-[rgba(139,92,246,0.4)]","text-[rgba(139,92,246,0.8)] text-xs font-medium text-left","hover:border-[rgba(139,92,246,0.7)] hover:bg-[rgba(139,92,246,0.1)]","transition-all duration-150","min-w-0 max-w-full overflow-hidden",r&&"w-9 h-9 p-0 justify-center"),onClick:()=>N(y.id),title:r?y.label:`Navigate to ${y.label}`,children:[o.jsx(Ce,{className:A("w-4 h-4 shrink-0",r&&"w-5 h-5")}),!r&&o.jsx("span",{className:"truncate min-w-0",children:y.label||"Untitled"})]},y.id))})]}),o.jsxs("div",{className:"flex flex-col gap-2",children:[!r&&o.jsx("h3",{className:"m-0 mb-2 text-[0.85rem] text-text-dim uppercase tracking-[0.5px]",children:"Simulation"}),o.jsxs("button",{className:A("btn-secondary flex items-center gap-2 w-full",r&&"w-9 h-9 p-2 justify-center"),onClick:k,title:"Reset Simulation",children:[o.jsx(Ft,{className:A("w-[18px] h-[18px] shrink-0",r&&"w-5 h-5")}),!r&&o.jsx("span",{children:"Reset"})]})]}),o.jsx("div",{className:"mt-auto pt-4 border-t border-border",children:o.jsxs("button",{className:A("btn-danger flex items-center gap-2 w-full",r&&"w-9 h-9 p-2 justify-center"),onClick:I,title:"Clear Canvas",children:[o.jsx(ve,{className:A("w-[18px] h-[18px] shrink-0",r&&"w-5 h-5")}),!r&&o.jsx("span",{children:"Clear Canvas"})]})}),o.jsx(zt,{open:f,onOpenChange:C,onConfirm:S,title:"Effacer le canvas ?",description:"Cette action supprimera tous les noeuds et les connexions. Cette action est irréversible.",confirmLabel:"Effacer",cancelLabel:"Annuler"})]})}function yo(){return o.jsx(qe,{children:o.jsx(Qt,{children:o.jsx(Zt,{children:o.jsxs("div",{className:"h-screen w-screen flex",children:[o.jsx(Co,{}),o.jsx("main",{className:"flex-1 relative",children:o.jsx(ho,{})})]})})})})}function jo(){return o.jsx(yo,{})}export{jo as default};
