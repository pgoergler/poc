import{c as h,g as b,u as F}from"./index-2_Z97WPX.js";import{b as n}from"./react-flow-Crnto5D5.js";import{F as L}from"./Toast-COtti-pl.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const T=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],M=h("plus",T);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const N=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],x=h("trash-2",N),q=7;class ${exportToFile(a,u){try{const o=JSON.stringify(a,null,2),t=new Blob([o],{type:"application/json"}),e=URL.createObjectURL(t),r=window.document.createElement("a");return r.href=e,r.download=u||`workflow-${Date.now()}.json`,r.click(),URL.revokeObjectURL(e),{success:!0}}catch(o){return{success:!1,error:{code:"STORAGE_ERROR",message:"Failed to export file",details:o}}}}importFromFile(){return new Promise(a=>{const u=window.document.createElement("input");u.type="file",u.accept=".json",u.onchange=async o=>{var e;const t=(e=o.target.files)==null?void 0:e[0];if(!t){a({success:!1,error:{code:"NOT_FOUND",message:"No file selected"}});return}try{const r=await t.text(),l=JSON.parse(r);a({success:!0,document:l})}catch(r){a({success:!1,error:{code:"PARSE_ERROR",message:"Failed to parse file",details:r}})}},u.oncancel=()=>{a({success:!1,error:{code:"NOT_FOUND",message:"File selection cancelled"}})},u.click()})}}const S="arko:workflows";function A(){return`wf_${L()}`}function y(){try{const s=localStorage.getItem(S);return s?JSON.parse(s):[]}catch{return[]}}function O(s){try{localStorage.setItem(S,JSON.stringify(s))}catch(a){console.error("Failed to save workflows to localStorage:",a)}}function v(){const[s,a]=n.useState([]),[u,o]=n.useState(!1),[t,e]=n.useState(null),r=n.useRef(!1),l=n.useCallback(()=>{e(null)},[]),d=n.useCallback(async()=>{o(!0),e(null);try{await new Promise(i=>setTimeout(i,50));const k=y();k.sort((i,f)=>new Date(f.updatedAt).getTime()-new Date(i.updatedAt).getTime()),a(k)}catch(k){e({code:"STORAGE_ERROR",message:k instanceof Error?k.message:"Failed to fetch workflows"})}finally{o(!1)}},[]);n.useEffect(()=>{r.current||(r.current=!0,d())},[d]);const m=n.useCallback(async k=>{o(!0),e(null);try{const i=new Date().toISOString(),f={id:A(),document:k,createdAt:i,updatedAt:i},p=y(),R=[f,...p];return O(R),a(R),f}catch(i){return e({code:"STORAGE_ERROR",message:i instanceof Error?i.message:"Failed to create workflow"}),null}finally{o(!1)}},[]),c=n.useCallback(async(k,i)=>{o(!0),e(null);try{const f=y(),p=f.findIndex(_=>_.id===k);if(p===-1)return e({code:"NOT_FOUND",message:"Workflow not found"}),null;const R={...f[p],document:i,updatedAt:new Date().toISOString()};return f[p]=R,O(f),a(f),R}catch(f){return e({code:"STORAGE_ERROR",message:f instanceof Error?f.message:"Failed to update workflow"}),null}finally{o(!1)}},[]),w=n.useCallback(async k=>{o(!0),e(null);try{const f=y().filter(p=>p.id!==k);return O(f),a(f),!0}catch(i){return e({code:"STORAGE_ERROR",message:i instanceof Error?i.message:"Failed to delete workflow"}),!1}finally{o(!1)}},[]),E=n.useCallback(async k=>{e(null);try{const f=y().find(p=>p.id===k);return f||(e({code:"NOT_FOUND",message:"Workflow not found"}),null)}catch(i){return e({code:"STORAGE_ERROR",message:i instanceof Error?i.message:"Failed to get workflow"}),null}},[]);return{workflows:s,total:s.length,isLoading:u,error:t,fetchWorkflows:d,createWorkflow:m,updateWorkflow:c,deleteWorkflow:w,getWorkflow:E,clearError:l}}function D(){return`wf_${L()}`}function W(s){return{id:s.id,document:s.document,createdAt:s.created_at,updatedAt:s.updated_at}}function g(s,a="STORAGE_ERROR"){return{code:a,message:s}}function P(s,a){const u=b(),o={workflows:[],isLoading:!1,error:null};function t(e){Object.assign(o,e),a==null||a(o)}return{get workflows(){return o.workflows},get total(){return o.workflows.length},get isLoading(){return o.isLoading},get error(){return o.error},clearError(){t({error:null})},async fetchWorkflows(){t({isLoading:!0,error:null});try{const{data:e,error:r}=await u.from("workflows").select("*").eq("user_id",s).order("updated_at",{ascending:!1});if(r){t({isLoading:!1,error:g(r.message)});return}const l=(e??[]).map(W);t({workflows:l,isLoading:!1})}catch(e){t({isLoading:!1,error:g(e instanceof Error?e.message:"Failed to fetch workflows")})}},async createWorkflow(e){t({isLoading:!0,error:null});try{const r=D(),{data:l,error:d}=await u.from("workflows").insert({id:r,user_id:s,document:e}).select().single();if(d)return t({isLoading:!1,error:g(d.message)}),null;const m=W(l);return t({workflows:[m,...o.workflows],isLoading:!1}),m}catch(r){return t({isLoading:!1,error:g(r instanceof Error?r.message:"Failed to create workflow")}),null}},async updateWorkflow(e,r){t({isLoading:!0,error:null});try{const{data:l,error:d}=await u.from("workflows").update({document:r,updated_at:new Date().toISOString()}).eq("id",e).eq("user_id",s).select().single();if(d)return d.code==="PGRST116"?(t({isLoading:!1,error:g("Workflow not found","NOT_FOUND")}),null):(t({isLoading:!1,error:g(d.message)}),null);const m=W(l),c=o.workflows.map(w=>w.id===e?m:w);return t({workflows:c,isLoading:!1}),m}catch(l){return t({isLoading:!1,error:g(l instanceof Error?l.message:"Failed to update workflow")}),null}},async deleteWorkflow(e){t({isLoading:!0,error:null});try{const{error:r}=await u.from("workflows").delete().eq("id",e).eq("user_id",s);if(r)return t({isLoading:!1,error:g(r.message)}),!1;const l=o.workflows.filter(d=>d.id!==e);return t({workflows:l,isLoading:!1}),!0}catch(r){return t({isLoading:!1,error:g(r instanceof Error?r.message:"Failed to delete workflow")}),!1}},async getWorkflow(e){t({error:null});try{const{data:r,error:l}=await u.from("workflows").select("*").eq("id",e).eq("user_id",s).single();return l?l.code==="PGRST116"?(t({error:g("Workflow not found","NOT_FOUND")}),null):(t({error:g(l.message)}),null):W(r)}catch(r){return t({error:g(r instanceof Error?r.message:"Failed to get workflow")}),null}}}}function C(s){const[a,u]=n.useState({workflows:[],isLoading:!1,error:null}),o=n.useRef(null);n.useEffect(()=>{if(!s){o.current=null;return}o.current=P(s,c=>{u({workflows:c.workflows,isLoading:c.isLoading,error:c.error})}),o.current.fetchWorkflows()},[s]);const t=n.useCallback(()=>{var c;return((c=o.current)==null?void 0:c.fetchWorkflows())??Promise.resolve()},[]),e=n.useCallback(c=>{var w;return((w=o.current)==null?void 0:w.createWorkflow(c))??Promise.resolve(null)},[]),r=n.useCallback((c,w)=>{var E;return((E=o.current)==null?void 0:E.updateWorkflow(c,w))??Promise.resolve(null)},[]),l=n.useCallback(c=>{var w;return((w=o.current)==null?void 0:w.deleteWorkflow(c))??Promise.resolve(!1)},[]),d=n.useCallback(c=>{var w;return((w=o.current)==null?void 0:w.getWorkflow(c))??Promise.resolve(null)},[]),m=n.useCallback(()=>{var c;return(c=o.current)==null?void 0:c.clearError()},[]);return n.useMemo(()=>s?{workflows:a.workflows,total:a.workflows.length,isLoading:a.isLoading,error:a.error,fetchWorkflows:t,createWorkflow:e,updateWorkflow:r,deleteWorkflow:l,getWorkflow:d,clearError:m}:null,[s,a.workflows,a.isLoading,a.error,t,e,r,l,d,m])}function I(){const{authEnabled:s,isAuthenticated:a,user:u}=F(),o=v(),t=C(s&&a&&u?u.id:null),e=s&&a&&t!==null,r=e?t:o;return n.useMemo(()=>({...r,backend:e?"supabase":"local"}),[r,e])}export{q as C,$ as F,M as P,x as T,I as u};
