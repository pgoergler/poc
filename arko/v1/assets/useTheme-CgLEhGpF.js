var dt=Object.defineProperty;var lt=(n,t,e)=>t in n?dt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var X=(n,t,e)=>lt(n,typeof t!="symbol"?t+"":t,e);import{c as ye}from"./index-CnfOSkNW.js";import{b as c,l as ke,m as gt,h as ze,k as $e,u as _e,j as te}from"./react-flow-BRmdaK4b.js";import{F as fe,u as Ee}from"./Toast-DGRdhY-b.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=[["path",{d:"M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401",key:"kfwtm"}]],an=ye("moon",ft);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],cn=ye("play",mt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ht=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],un=ye("sun",ht);function J(n){switch(n){case"trigger":case"externalSystem":case"externalEvent":case"hotspot":case"note":case"actor":return"manual";case"event":case"policy":case"command":default:return"automatic"}}function pt(n,t){if(n!=="command"&&n!=="policy")throw new Error(`calculateDynamicExecutionMode called with non-dynamic kind: ${n}`);return t<=1?"automatic":"manual"}function Tt(n){return n.executionMode==="manual"}function Et(n,t){return n.executionMode==="manual"?!1:t>0}class le{constructor(){X(this,"nodes",new Map);X(this,"transitions",new Map);X(this,"outgoingEdges",new Map);X(this,"incomingEdges",new Map)}addNode(t){if(this.nodes.has(t.id))throw new Error(`Node with id ${t.id} already exists`);this.nodes.set(t.id,t),this.outgoingEdges.set(t.id,new Set),this.incomingEdges.set(t.id,new Set)}getNode(t){return this.nodes.get(t)}hasNode(t){return this.nodes.has(t)}getAllNodes(){return Array.from(this.nodes.values())}updateNode(t,e){const s=this.nodes.get(t);if(!s)return;const o={...s,...e};return this.nodes.set(t,o),o}removeNode(t){if(!this.nodes.has(t))return!1;const e=this.outgoingEdges.get(t)??new Set,s=this.incomingEdges.get(t)??new Set;for(const o of e)this.removeTransition(o);for(const o of s)this.removeTransition(o);return this.nodes.delete(t),this.outgoingEdges.delete(t),this.incomingEdges.delete(t),!0}addTransition(t){if(this.transitions.has(t.id))throw new Error(`Transition with id ${t.id} already exists`);if(!this.nodes.has(t.sourceDefId))throw new Error(`Source node ${t.sourceDefId} does not exist`);if(!this.nodes.has(t.targetDefId))throw new Error(`Target node ${t.targetDefId} does not exist`);this.transitions.set(t.id,t),this.outgoingEdges.get(t.sourceDefId).add(t.id),this.incomingEdges.get(t.targetDefId).add(t.id),this.recalculateExecutionMode(t.sourceDefId)}getTransition(t){return this.transitions.get(t)}getAllTransitions(){return Array.from(this.transitions.values())}removeTransition(t){var o,u;const e=this.transitions.get(t);if(!e)return!1;const s=e.sourceDefId;return(o=this.outgoingEdges.get(e.sourceDefId))==null||o.delete(t),(u=this.incomingEdges.get(e.targetDefId))==null||u.delete(t),this.transitions.delete(t),this.recalculateExecutionMode(s),!0}getOutgoingTransitions(t){const e=this.outgoingEdges.get(t);return e?Array.from(e).map(s=>this.transitions.get(s)).filter(Boolean):[]}getIncomingTransitions(t){const e=this.incomingEdges.get(t);return e?Array.from(e).map(s=>this.transitions.get(s)).filter(Boolean):[]}getSuccessors(t){return this.getOutgoingTransitions(t).map(e=>this.nodes.get(e.targetDefId)).filter(Boolean)}getPredecessors(t){return this.getIncomingTransitions(t).map(e=>this.nodes.get(e.sourceDefId)).filter(Boolean)}get nodeCount(){return this.nodes.size}get transitionCount(){return this.transitions.size}getEntryNodes(){return this.getAllNodes().filter(t=>{var e;return(((e=this.incomingEdges.get(t.id))==null?void 0:e.size)??0)===0})}getTerminalNodes(){return this.getAllNodes().filter(t=>{var e;return(((e=this.outgoingEdges.get(t.id))==null?void 0:e.size)??0)===0})}recalculateExecutionMode(t){var u;const e=this.nodes.get(t);if(!e||e.kind!=="command"&&e.kind!=="policy")return;const s=((u=this.outgoingEdges.get(t))==null?void 0:u.size)??0,o=pt(e.kind,s);e.executionMode!==o&&this.nodes.set(t,{...e,executionMode:o})}requiresUserAction(t){const e=this.nodes.get(t);return e?Tt(e):!1}canAutoTraverse(t){var o;const e=this.nodes.get(t);if(!e)return!1;const s=((o=this.outgoingEdges.get(t))==null?void 0:o.size)??0;return Et(e,s)}getReachableNodes(t){const e=[],s=new Set,o=[];for(const u of this.getSuccessors(t))s.has(u.id)||(s.add(u.id),o.push(u.id),e.push(u));for(;o.length>0;){const u=o.shift();for(const T of this.getSuccessors(u))s.has(T.id)||(s.add(T.id),o.push(T.id),e.push(T))}return e}getReachableTransitions(t){const e=[],s=new Set;for(const o of this.getOutgoingTransitions(t))s.has(o.id)||(s.add(o.id),e.push(o));for(const o of this.getReachableNodes(t))for(const u of this.getOutgoingTransitions(o.id))s.has(u.id)||(s.add(u.id),e.push(u));return e}}function ne(n,t=""){return n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]+/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")||t}function Se(n,t=""){return n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().replace(/\s+/g,".").replace(/[^a-z0-9.-]+/g,".").replace(/^[.-]+|[.-]+$/g,"").replace(/\.+/g,".").replace(/-+/g,"-")||t}function dn(n){return n.length<=13?n:`${n.slice(0,5)}...${n.slice(-5)}`}function ln(n){return n.replace(/^(def_|trans_|inst_|outcome_)/,"")}function gn(n,t,e){const s=ne(n);if(s)return s;const o=t.replace(/^def_/,"").toLowerCase();return`${e}-${o.slice(0,8)}`}function fn(n,t){const e=Se(n);return e||`event.${t.replace(/^def_/,"").toLowerCase().slice(0,8)}`}function mn(n){const t=n.match(/\{([^}]+)\}/g);return t?t.map(e=>e.slice(1,-1)):[]}function hn(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const t=Math.random()*16|0;return(n==="x"?t:t&3|8).toString(16)})}function Q(){return`def_${fe()}`}function Ct(){return`trans_${fe()}`}function ue(){return`inst_${fe()}`}function Ne(){return`outcome_${fe()}`}function Ce(n){const t=Se(n.label);return{id:Q(),label:n.label,kind:"event",category:"business",executionMode:J("event"),config:t?{type:t}:void 0}}function Me(n){return{id:Q(),label:n.label,kind:"policy",category:"business",executionMode:J("policy")}}function xt(n){const t=ne(n.label);return{id:Q(),label:n.label,kind:"trigger",category:"business",executionMode:J("trigger"),config:t?{slugName:t}:void 0}}function we(n){const t=ne(n.label);return{id:Q(),label:n.label,kind:"externalSystem",category:"technical",executionMode:J("externalSystem"),config:t?{slugName:t}:void 0}}function Nt(n){const t=ne(n.label);return{id:Q(),label:n.label,kind:"externalEvent",category:"technical",executionMode:J("externalEvent"),config:t?{slugName:t}:void 0}}function Re(n){const t=ne(n.label);return{id:Q(),label:n.label,kind:"command",category:"business",executionMode:J("command"),config:t?{slugName:t}:void 0}}function De(n){return{id:Q(),label:n.label,kind:"hotspot",category:"business",executionMode:J("hotspot")}}function Ie(n){return{id:Q(),label:n.label,kind:"note",category:"business",executionMode:J("note")}}function Oe(n){return{id:Q(),label:n.label,kind:"actor",category:"business",executionMode:J("actor")}}function bt(n){return{id:Ct(),sourceDefId:n.sourceDefId,targetDefId:n.targetDefId}}const vt={transitionDelay:1e3,autoStart:!1};class yt{constructor(){X(this,"listeners",new Map)}on(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>this.off(t,e)}off(t,e){var s;(s=this.listeners.get(t))==null||s.delete(e)}emit(t,e){const s=this.listeners.get(t);if(s)for(const o of s)try{o(e)}catch(u){console.error(`Error in event handler for ${String(t)}:`,u)}}once(t,e){const s=o=>{this.off(t,s),e(o)};return this.on(t,s)}removeAllListeners(t){t?this.listeners.delete(t):this.listeners.clear()}listenerCount(t){var e;return((e=this.listeners.get(t))==null?void 0:e.size)??0}}class St extends yt{constructor(e,s={}){super();X(this,"graph");X(this,"config");X(this,"running",!1);X(this,"nodeStates",new Map);X(this,"transitionStates",new Map);X(this,"activeNodes",new Set);X(this,"pendingActions",new Set);X(this,"activeTimeouts",new Set);this.graph=e,this.config={...vt,...s},this.initializeState()}initializeState(){for(const e of this.graph.getAllNodes())this.nodeStates.set(e.id,"idle");for(const e of this.graph.getAllTransitions())this.transitionStates.set(e.id,"idle")}getState(){return{isRunning:this.running,nodeStates:new Map(this.nodeStates),transitionStates:new Map(this.transitionStates),activeNodes:new Set(this.activeNodes),pendingActions:new Set(this.pendingActions)}}getNodeState(e){return this.nodeStates.get(e)}getTransitionState(e){return this.transitionStates.get(e)}isSimulationRunning(){return this.running}start(){if(!this.running&&(this.running=!0,this.emit("simulation:start",{timestamp:Date.now()}),this.config.autoStart))for(const e of this.graph.getEntryNodes())this.triggerNode(e.id)}stop(){if(this.running){this.running=!1;for(const e of this.activeTimeouts)clearTimeout(e);this.activeTimeouts.clear(),this.emit("simulation:stop",{timestamp:Date.now()})}}reset(){this.stop(),this.nodeStates.clear(),this.transitionStates.clear(),this.activeNodes.clear(),this.pendingActions.clear(),this.initializeState(),this.emit("simulation:reset",{timestamp:Date.now()})}resetAllStates(){const e=Date.now();for(const s of this.graph.getAllNodes())this.nodeStates.set(s.id,"idle"),this.emit("node:reset",{node:s,timestamp:e});for(const s of this.graph.getAllTransitions())this.transitionStates.set(s.id,"idle"),this.emit("transition:reset",{transition:s,timestamp:e});this.activeNodes.clear(),this.pendingActions.clear()}triggerNode(e){if(!this.running){this.emitError(`Cannot trigger node ${e}: simulation is not running`,e);return}if(!this.graph.getNode(e)){this.emitError(`Node ${e} not found`,e);return}this.resetAllStates(),this.enterNode(e)}selectTransition(e){if(!this.running){this.emitError("Cannot select transition: simulation is not running",void 0,e);return}const s=this.graph.getTransition(e);if(!s){this.emitError(`Transition ${e} not found`,void 0,e);return}if(!this.graph.getNode(s.sourceDefId)){this.emitError("Source node for transition not found",s.sourceDefId,e);return}if(!this.pendingActions.has(s.sourceDefId)){this.emitError(`Node ${s.sourceDefId} is not waiting for action`,s.sourceDefId);return}this.resetAllStates(),this.executeTransition(s)}completeManualNode(e){if(!this.running){this.emitError("Cannot complete node: simulation is not running",e);return}if(!this.graph.getNode(e)){this.emitError(`Node ${e} not found`,e);return}if(!this.pendingActions.has(e)){this.emitError(`Node ${e} is not waiting for action`,e);return}this.resetAllStates(),this.pendingActions.delete(e),this.exitNode(e)}enterNode(e){const s=this.graph.getNode(e);s&&(this.nodeStates.set(e,"entering"),this.activeNodes.add(e),this.emit("node:enter",{node:s,timestamp:Date.now()}),this.activateNode(e))}activateNode(e){const s=this.graph.getNode(e);s&&(this.nodeStates.set(e,"active"),this.emit("node:active",{node:s,timestamp:Date.now()}),this.graph.requiresUserAction(e)?this.waitForAction(e):this.graph.canAutoTraverse(e)?this.exitNode(e):this.completeNode(e))}waitForAction(e){const s=this.graph.getNode(e);if(!s)return;this.nodeStates.set(e,"waiting_for_action"),this.pendingActions.add(e);const o=this.graph.getOutgoingTransitions(e);this.emit("node:waiting",{node:s,availableTransitions:o,timestamp:Date.now()})}exitNode(e){const s=this.graph.getNode(e);if(!s)return;this.nodeStates.set(e,"exiting"),this.emit("node:exit",{node:s,timestamp:Date.now()});const o=this.graph.getOutgoingTransitions(e);if(o.length===0)this.completeNode(e);else if(o.length===1)this.executeTransition(o[0]),this.completeNode(e);else{for(const u of o)this.executeTransition(u);this.completeNode(e)}}completeNode(e){const s=this.graph.getNode(e);s&&(this.nodeStates.set(e,"completed"),this.activeNodes.delete(e),this.emit("node:complete",{node:s,timestamp:Date.now()}))}executeTransition(e){this.transitionStates.set(e.id,"in_progress"),this.emit("transition:start",{transition:e,timestamp:Date.now()});const s=setTimeout(()=>{this.activeTimeouts.delete(s),this.completeTransition(e)},this.config.transitionDelay);this.activeTimeouts.add(s)}completeTransition(e){this.transitionStates.set(e.id,"completed"),this.emit("transition:complete",{transition:e,timestamp:Date.now()}),this.enterNode(e.targetDefId)}emitError(e,s,o){this.emit("error",{message:e,nodeId:s,transitionId:o,timestamp:Date.now()})}}function Le(){const n=c.useRef(new Map),t=c.useRef(new Map),e=c.useRef(new Map),s=c.useRef(new Map),o=c.useCallback(r=>n.current.get(r),[]),u=c.useCallback(r=>{const d=t.current.get(r);return d?Array.from(d):[]},[]),T=c.useCallback(r=>{const d=n.current.get(r);if(!d)return!0;const a=t.current.get(d);if(!a||a.size<=1)return!0;const D=Array.from(a).sort();return r===D[0]},[]),M=c.useCallback((r,d,a)=>{if(!r.current)return;const z=r.current.getOutgoingTransitions(d).find(x=>x.targetDefId===a);return z==null?void 0:z.id},[]),y=c.useCallback(r=>e.current.get(r),[]),l=c.useCallback(r=>s.current.get(r),[]),g=c.useCallback((r,d)=>{n.current.set(r,d);let a=t.current.get(d);a||(a=new Set,t.current.set(d,a)),a.add(r)},[]),E=c.useCallback(r=>{const d=n.current.get(r);if(!d)return;n.current.delete(r);const a=t.current.get(d);return a&&(a.delete(r),a.size===0&&t.current.delete(d)),d},[]),f=c.useCallback((r,d)=>{e.current.set(r,d);let a=s.current.get(d);a||(a=new Set,s.current.set(d,a)),a.add(r)},[]),m=c.useCallback(r=>{const d=e.current.get(r);if(!d)return;e.current.delete(r);const a=s.current.get(d);return a&&(a.delete(r),a.size===0&&s.current.delete(d)),d},[]),i=c.useCallback(()=>{n.current.clear(),t.current.clear(),e.current.clear(),s.current.clear()},[]);return{instanceToDefRef:n,defToInstancesRef:t,edgeToTransitionRef:e,transitionToEdgesRef:s,getDefinitionForInstance:o,getInstancesForDefinition:u,isOriginalInstance:T,findExistingTransition:M,getEdgeTransition:y,getEdgesForTransition:l,registerInstance:g,unregisterInstance:E,registerEdge:f,unregisterEdge:m,resetMappings:i}}function pn(n,t){return{x:n.x-t.x,y:n.y-t.y}}function kt(n,t){return{x:n.x+t.x,y:n.y+t.y}}function Tn(n,t){return t?kt(n,t):n}const oe=152,Ge=102,We=80,me=32,Z=10;function ge(n,t,e=oe,s=Ge,o=We,u=me){const T=n+o<=0,M=n>=e,y=t+u<=0,l=t>=s;if(T)return{x:-o-Z,y:Math.max(-u,Math.min(t,s))};if(M)return{x:e+Z,y:Math.max(-u,Math.min(t,s))};if(y)return{x:Math.max(-o,Math.min(n,e)),y:-u-Z};if(l)return{x:Math.max(-o,Math.min(n,e)),y:s+Z};const g=n+o/2,E=t+u/2,f=e/2,m=s/2,i=g-f,r=E-m;return Math.abs(i)>Math.abs(r)?i>0?{x:e+Z,y:Math.max(-u,Math.min(t,s))}:{x:-o-Z,y:Math.max(-u,Math.min(t,s))}:r>0?{x:Math.max(-o,Math.min(n,e)),y:s+Z}:{x:Math.max(-o,Math.min(n,e)),y:-u-Z}}const Ae={command:{canConnectTo:["event"],canReceiveFrom:["event","policy","externalEvent"]},policy:{canConnectTo:["command","externalEvent","trigger","externalSystem"],canReceiveFrom:["event"]},externalEvent:{canConnectTo:["command","trigger"],canReceiveFrom:["event","policy"]},externalSystem:{canConnectTo:["event"],canReceiveFrom:["event","policy","externalEvent"]},trigger:{canConnectTo:["event"],canReceiveFrom:["event","policy","externalEvent"]},event:{canConnectTo:["policy","command","externalEvent","trigger","externalSystem"],canReceiveFrom:["command","trigger","externalSystem"]}};function Mt(n,t){const e=Ae[n],s=Ae[t];if(!e||!s)return!1;const o=e.canConnectTo.includes(t),u=s.canReceiveFrom.includes(n);return o&&u}function wt(n,t){return t?"policy":n}function En(n){return n==="command"?"commandEdge":"floating"}function xe(n){return n>=2?"commandEdge":"floating"}function Cn(n,t){return{sourceHandle:"source-right",targetHandle:"target-left"}}function be(){return{label:"Path",labelOffset:.5}}function ve(n,t){return!n||!t?{isNonStandard:!1}:{isNonStandard:!Mt(n,t),sourceKind:n,targetKind:t}}function Rt(n,t,e,s){const o=n.source,u=n.target,T=s.has(o);let M;if(T){const i=s.get(o);M=i?e.get(i):void 0}else M=e.get(o);const y=e.get(u);if(!M||!y)return n;const l=t.getNode(M),g=t.getNode(y),E=T?"policy":l==null?void 0:l.kind,f=g==null?void 0:g.kind,m=ve(E,f);return{...n,data:{...n.data,...m}}}function Ue(n,t,e,s){n.set(e,s);let o=t.get(s);o||(o=new Set,t.set(s,o)),o.add(e)}function Ve(n,t,e,s){const o=n.get(s);if(!o)return;n.delete(s),e.delete(s);const u=t.get(o);u&&(u.delete(s),u.size===0&&t.delete(o))}function je(n,t){var e;return((e=n.get(t))==null?void 0:e.size)??0}function Dt(n,t,e){var u;const s=t.get(n);return s?(((u=e.get(s))==null?void 0:u.size)??0)>2:!1}function It(n,t,e,s){return n.filter(o=>{const u=o;return u.type!=="remove"||!u.id||!t.has(u.id)||s!=null&&s.has(u.id)?!0:Dt(u.id,t,e)})}function Ot(n,t,e,s){return n}function At(n,t=oe){return ge(t+Z,n*(me+Z))}function Pt(n,t,e,s,o){return{id:n,type:"outcome",position:o,parentId:t,data:{label:s,parentPolicyId:t,parentPolicyInstanceId:t,parentPolicyDefId:e}}}function Ft(n,t,e,s,o,u,T){var g;const M=t.get(n);if(!M||(((g=e.get(M))==null?void 0:g.size)??0)<=2)return!1;if(s.get(n)){const E=o.cleanupEdgesFromSource(n);E.length>0&&T(f=>f.filter(m=>!E.includes(m.id)))}return Ve(t,e,s,n),u(E=>E.filter(f=>f.id!==n)),!0}function zt(n,t,e,s,o,u,T){const M=T(),y=je(o,n),l=At(y),g=Pt(M,n,t,e,l);return Ue(s,o,M,n),u(E=>[...E,g]),M}function $t(n,t,e){e(s=>s.map(o=>o.id===n?{...o,data:{...o.data,label:t}}:o))}function Be(n){const{instanceToDefRef:t,setNodes:e,getNodes:s}=n,o=c.useRef(new Map),u=c.useRef(new Map),T=c.useRef(new Map),M=c.useCallback(x=>T.current.get(x),[]),y=c.useCallback(x=>{const h=u.current.get(x);return h?Array.from(h):[]},[]),l=c.useCallback(x=>{const h=u.current.get(x);if(!h)return[];const I=s();return Array.from(h).map(U=>{var P;const L=I.find(S=>S.id===U),C=((P=L==null?void 0:L.data)==null?void 0:P.label)||"Outcome";return{id:U,label:C}})},[s]),g=c.useCallback(x=>o.current.has(x),[]),E=c.useCallback(x=>o.current.get(x),[]),f=c.useCallback(x=>je(u.current,x),[]),m=c.useCallback((x,h)=>{Ue(o.current,u.current,x,h)},[]),i=c.useCallback(x=>{Ve(o.current,u.current,T.current,x)},[]),r=c.useCallback((x,h)=>{T.current.set(x,h)},[]),d=c.useCallback(x=>{T.current.delete(x)},[]),a=c.useCallback((x,h)=>{var U;const I=(U=t.current)==null?void 0:U.get(x);if(!I)throw new Error(`Policy instance ${x} not found`);return zt(x,I,h,o.current,u.current,e,Ne)},[t,e]),D=c.useCallback((x,h)=>{$t(x,h,e)},[e]),z=c.useCallback(()=>{o.current.clear(),u.current.clear(),T.current.clear()},[]);return{outcomeToParentRef:o,policyToOutcomesRef:u,outcomeToTransitionRef:T,getOutcomeTransition:M,getOutcomesForPolicy:y,getOutcomesWithLabels:l,isOutcome:g,getOutcomeParent:E,getOutcomeCount:f,registerOutcome:m,unregisterOutcome:i,setOutcomeTransition:r,clearOutcomeTransition:d,addOutcomeToPolicy:a,updateOutcomeLabel:D,resetMappings:z}}function qe(n,t){const{edgeToTransitionRef:e,transitionToEdgesRef:s}=t,o=c.useCallback(f=>e.current.get(f),[e]),u=c.useCallback(f=>s.current.get(f),[s]),T=c.useCallback(f=>{const m=s.current.get(f);return m!==void 0&&m.size>0},[s]),M=c.useCallback((f,m)=>{if(!n.current)return;const r=n.current.getOutgoingTransitions(f).find(d=>d.targetDefId===m);return r==null?void 0:r.id},[n]),y=c.useCallback((f,m)=>{e.current.set(f,m);let i=s.current.get(m);i||(i=new Set,s.current.set(m,i)),i.add(f)},[e,s]),l=c.useCallback((f,m,i)=>{const r=bt({sourceDefId:m,targetDefId:i});return n.current.addTransition(r),e.current.set(f,r.id),s.current.set(r.id,new Set([f])),r.id},[n,e,s]),g=c.useCallback(f=>{const m=e.current.get(f);if(!m)return{transitionDeleted:!1};e.current.delete(f);const i=s.current.get(m);return i==null||i.delete(f),!i||i.size===0?(s.current.delete(m),n.current.removeTransition(m),{transitionDeleted:!0,transitionId:m}):{transitionDeleted:!1,transitionId:m}},[n,e,s]),E=c.useCallback((f,m,i,r)=>{if((r==null?void 0:r.allowReuseExisting)??!0){const a=M(m,i);if(a)return y(f,a),a}return l(f,m,i)},[M,y,l]);return{getTransitionForEdge:o,getEdgesForTransition:u,hasEdgesForTransition:T,findExistingTransition:M,linkEdgeToTransition:y,linkEdgeToNewTransition:l,unlinkEdgeFromTransition:g,getOrCreateTransitionAndLink:E}}function Ye(n,t){const e=c.useCallback(y=>{var g;const l=(g=t.current)==null?void 0:g.get(y);return l?Array.from(l):[]},[t]),s=c.useCallback(y=>{var l,g;return((g=(l=n.current)==null?void 0:l.getNode(y))==null?void 0:g.kind)==="command"},[n]),o=c.useCallback((y,l)=>{const g=e(y);if(g.length===0)return 0;const E=new Set(g);let f=0;for(const m of l)E.has(m.source)&&f++;return f},[e]),u=c.useCallback((y,l,g)=>{let E=o(y,l);return E+=(g==null?void 0:g.pendingAdd)??0,xe(E)},[o]),T=c.useCallback((y,l,g)=>{const E=e(y);if(E.length===0)return l;const f=new Set(E);let m=0;for(const r of l)f.has(r.source)&&m++;m+=(g==null?void 0:g.pendingAdd)??0;const i=xe(m);return l.map(r=>{var d;return!f.has(r.source)||r.type===i?r:{...r,type:i,data:{...r.data,...i==="commandEdge"&&!((d=r.data)!=null&&d.label)?be():{}}}})},[e]),M=c.useCallback((y,l,g,E)=>{const f=new Map;for(const m of y){const i=g.get(m.source);if(!i)continue;const r=l.getNode(i);(r==null?void 0:r.kind)==="command"&&f.set(i,(f.get(i)??0)+1)}return y.map(m=>{var D;const i=g.get(m.source);if(!i)return m;const r=l.getNode(i);if((r==null?void 0:r.kind)!=="command")return m;const d=f.get(i)??0,a=xe(d);return m.type===a?m:{...m,type:a,data:{...m.data,...a==="commandEdge"&&!((D=m.data)!=null&&D.label)?be():{}}}})},[]);return{countCommandEdges:o,resolveEdgeType:u,normalizeCommandEdges:T,normalizeAllCommandEdges:M,isCommandDefinition:s,getCommandInstanceIds:e}}const Pe=["hotspot","note","actor"];function _t(n){const{edges:t,setNodes:e,setEdges:s,onNodesChangeInternal:o,onEdgesChangeInternal:u,graphRef:T,getNode:M,nodesRef:y,instanceToDefRef:l,defToInstancesRef:g,edgeToTransitionRef:E,transitionToEdgesRef:f,outcomeManagement:m,edgeTransitionManager:i,commandEdgeResolver:r}=n,{isOutcome:d,unregisterOutcome:a,getOutcomesForPolicy:D,setOutcomeTransition:z,clearOutcomeTransition:x,outcomeToParentRef:h,policyToOutcomesRef:I}=m,U=c.useCallback(w=>{const p=l.current.get(w);if(!p)return;const N=D(w);for(const O of N)a(O);l.current.delete(w);const R=g.current.get(p);if(R==null||R.delete(w),!R||R.size===0){g.current.delete(p),T.current.removeNode(p);for(const[O,k]of E.current)T.current.getTransition(k)||(E.current.delete(O),f.current.delete(k))}},[T,l,g,E,f,D,a]),L=c.useCallback(w=>{i.unlinkEdgeFromTransition(w)},[i]),C=c.useCallback(w=>{const p=new Set;for(const v of w)if(v.type==="remove"){const $=I.current.get(v.id);if($)for(const F of $)p.add(F)}const N=It(w,h.current,I.current,p);for(const v of p)N.some($=>$.type==="remove"&&$.id===v)||N.push({type:"remove",id:v});const R=N.map(v=>{var $,F,_,G;if(v.type==="position"&&v.position){const V=h.current.get(v.id);if(V){const q=M(v.id),Y=M(V),W=ge(v.position.x,v.position.y,(($=Y==null?void 0:Y.measured)==null?void 0:$.width)??oe,((F=Y==null?void 0:Y.measured)==null?void 0:F.height)??Ge,((_=q==null?void 0:q.measured)==null?void 0:_.width)??We,((G=q==null?void 0:q.measured)==null?void 0:G.height)??me);return{...v,position:W}}}return v}),O=new Set;for(const v of R)v.type==="remove"&&O.add(v.id);const k=new Set;for(const v of t)(O.has(v.source)||O.has(v.target))&&k.add(v.id);for(const v of k)L(v);k.size>0&&s(v=>v.filter($=>!k.has($.id)));for(const v of R)v.type==="remove"&&U(v.id);o(R)},[o,U,L,M,t,s,I,h]),P=c.useCallback(w=>{const p=Ot(w,t,h.current,I.current),N=new Set,R=new Set;for(const O of p)if(O.type==="remove"){const k=t.find(v=>v.id===O.id);if(k){const v=k.source,$=k.target,F=l.current.get(v);if(F){const _=T.current.getNode(F);if((_==null?void 0:_.kind)==="command"){N.add(F);const G=l.current.get($);if(G){const V=T.current.getNode(G);(V==null?void 0:V.kind)==="event"&&R.add($)}}}}L(O.id)}u(p),N.size>0&&s(O=>{let k=O;for(const v of N)k=r.normalizeCommandEdges(v,k);return k}),R.size>0&&e(O=>O.map(k=>R.has(k.id)?t.some($=>{if($.target!==k.id||p.some(V=>V.type==="remove"&&V.id===$.id))return!1;const _=l.current.get($.source);if(!_)return!1;const G=T.current.getNode(_);return(G==null?void 0:G.kind)==="command"})?k:{...k,data:{...k.data,hasCommandParent:!1}}:k))},[u,L,t,s,e,r,T,l,h,I]),S=c.useCallback(w=>{if(!w.source||!w.target)return!1;const p=w.source,N=w.target;if(p===N)return!1;const R=d(p),O=y.current.find(F=>F.id===p),k=wt(O==null?void 0:O.type,R),v=y.current.find(F=>F.id===N),$=v==null?void 0:v.type;return!(!k||!$||Pe.includes(k)||Pe.includes($))},[d,y]),b=c.useCallback(w=>{if(!w.source||!w.target)return;const p=w.source,N=w.target,R=`edge_${p}_${N}`;if(E.current.has(R))return;const O=d(p);let k;if(O){const W=p,B=h.current.get(W);k=l.current.get(B)}else k=l.current.get(p);const v=l.current.get(N);if(!k||!v)return;const $=i.findExistingTransition(k,v);if($&&!O&&i.hasEdgesForTransition($))return;const F=O?i.linkEdgeToNewTransition(R,k,v):i.getOrCreateTransitionAndLink(R,k,v);O&&z(p,F);const _=T.current.getNode(k),G=T.current.getNode(v),V=(_==null?void 0:_.kind)==="command",q=O?"policy":_==null?void 0:_.kind,Y=ve(q,G==null?void 0:G.kind);V?(s(W=>{const B=r.resolveEdgeType(k,W,{pendingAdd:1}),ee=ke({...w,id:R,type:B,data:{state:"idle",transitionId:F,...Y,...B==="commandEdge"?be():{}}},W);return r.normalizeCommandEdges(k,ee)}),(G==null?void 0:G.kind)==="event"&&e(W=>W.map(B=>B.id===N?{...B,data:{...B.data,hasCommandParent:!0}}:B))):s(W=>ke({...w,id:R,type:"floating",data:{state:"idle",transitionId:F,...Y}},W))},[s,e,i,r,T,l,E,h,d,z]),A=c.useCallback((w,p)=>{if(!p.source||!p.target)return;const N=w.id,R=p.source,O=p.target,k=`edge_${R}_${O}`,v=N!==k;if(t.some(j=>j.id!==N&&j.id!==k&&j.source===R&&j.target===O)||v&&E.current.has(k))return;const F=d(R);let _;if(F){const j=R,ie=h.current.get(j);_=l.current.get(ie)}else _=l.current.get(R);const G=l.current.get(O);if(!_||!G)return;const V=E.current.get(N),q=V?T.current.getTransition(V):void 0,Y=!q||q.sourceDefId!==_||q.targetDefId!==G;let W;const B=w.source,ee=h.current.has(B);if(Y){V&&(i.unlinkEdgeFromTransition(N),ee&&x(B));const j=i.findExistingTransition(_,G);if(j&&!F&&i.hasEdgesForTransition(j))return;W=F?i.linkEdgeToNewTransition(k,_,G):i.getOrCreateTransitionAndLink(k,_,G),F&&z(R,W)}else{if(W=V,v){E.current.delete(N),E.current.set(k,W);const j=f.current.get(W);j&&(j.delete(N),j.add(k))}ee&&B!==R&&x(B),F&&z(R,W)}const H=T.current.getNode(_),se=T.current.getNode(G),re=(H==null?void 0:H.kind)==="command",he=re?"commandEdge":"floating",pe=F?"policy":H==null?void 0:H.kind,Te=ve(pe,se==null?void 0:se.kind);s(j=>gt(w,p,j).map(K=>{var ae;return K.source===p.source&&K.target===p.target?{...K,id:k,type:he,data:{...K.data,...Y?{state:"idle",progress:0}:{},transitionId:W,...Te,...re&&!((ae=K.data)!=null&&ae.label)?{label:"Path",labelOffset:.5}:{}}}:K}))},[t,s,i,T,l,E,f,h,d,z,x]);return{onNodesChange:C,onEdgesChange:P,onConnect:b,onReconnect:A,isValidConnection:S}}function Fe(n,t,e,s,o){return{id:n,type:"outcome",position:o,parentId:e,data:{label:t,parentPolicyInstanceId:e,parentPolicyDefId:s}}}function Lt(n){const{edges:t,setNodes:e,setEdges:s,graphRef:o,getNode:u,instanceMapping:T,outcomeManagement:M,edgeTransitionManager:y}=n,{instanceToDefRef:l,defToInstancesRef:g,edgeToTransitionRef:E,transitionToEdgesRef:f}=T,{outcomeToParentRef:m,policyToOutcomesRef:i,getOutcomesForPolicy:r,registerOutcome:d,unregisterOutcome:a}=M,D=c.useCallback(C=>{const P=l.current.get(C);if(!P)return;const S=r(C);for(const A of S)a(A);l.current.delete(C);const b=g.current.get(P);if(b==null||b.delete(C),!b||b.size===0){g.current.delete(P),o.current.removeNode(P);for(const[A,w]of E.current)o.current.getTransition(w)||(E.current.delete(A),f.current.delete(w))}},[o,l,g,E,f,r,a]),z=c.useCallback((C,P,S)=>{let b,A="event";if(C==="event"){const p=Ce({label:S||"Event"});o.current.addNode(p);const N=ue();l.current.set(N,p.id),g.current.set(p.id,new Set([N]));const R={id:N,type:"event",position:P,data:{label:p.label,executionMode:p.executionMode,definitionId:p.id}};return e(O=>[...O,R]),N}if(C==="trigger"){const p=xt({label:S||"Trigger"});o.current.addNode(p);const N=ue();l.current.set(N,p.id),g.current.set(p.id,new Set([N]));const R={id:N,type:"trigger",position:P,data:{label:p.label,definitionId:p.id}};return e(O=>[...O,R]),N}C==="policy"?(b=Me({label:S||"Policy"}),A="policy"):C==="externalSystem"?(b=we({label:S||"External System"}),A="externalSystem"):C==="externalEvent"?(b=Nt({label:S||"External Event"}),A="externalEvent"):C==="command"?(b=Re({label:S??"Command"}),A="command"):C==="hotspot"?(b=De({label:S||"HotSpot"}),A="hotspot"):C==="note"?(b=Ie({label:S||"Note"}),A="note"):C==="actor"?(b=Oe({label:S||"Actor"}),A="actor"):(b=Ce({label:S||"Event"}),A="event"),o.current.addNode(b);const w=ue();if(l.current.set(w,b.id),g.current.set(b.id,new Set([w])),C==="policy"){const p={id:w,type:"policy",position:P,data:{label:b.label,executionMode:b.executionMode,definitionId:b.id}},N=Ne(),R=Ne(),O=ge(oe+Z,0),k=ge(oe+Z,me+Z),v=Fe(N,"Yes",w,b.id,O),$=Fe(R,"No",w,b.id,k);d(N,w),d(R,w),e(F=>[...F,p,v,$])}else{const p={id:w,type:A,position:P,data:{label:b.label,executionMode:b.executionMode,definitionId:b.id}};e(N=>[...N,p])}return w},[o,l,g,e,d]),x=c.useCallback((C,P)=>{const S=o.current.getNode(C);if(!S)throw new Error(`Definition ${C} does not exist`);const b=ue();l.current.set(b,C);const A=g.current.get(C)??new Set;A.add(b),g.current.set(C,A);const w={id:b,type:S.kind,position:P,data:{label:S.label,executionMode:S.executionMode,definitionId:C}};return e(p=>[...p,w]),b},[o,l,g,e]),h=c.useCallback(C=>{const P=l.current.get(C);if(!P)return;const S=u(C);if(!S)return;const b={x:S.position.x+50,y:S.position.y+50};return x(P,b)},[l,u,x]),I=c.useCallback(C=>{const P=l.current.get(C);if(!P)return;const S=o.current.getNode(P);if(!S)return;const b=g.current.get(P);if(!b||b.size<=1)return;let A;S.kind==="event"?A=Ce({label:S.label}):S.kind==="policy"?A=Me({label:S.label}):S.kind==="command"?A=Re({label:S.label}):S.kind==="hotspot"?A=De({label:S.label}):S.kind==="note"?A=Ie({label:S.label}):S.kind==="actor"?A=Oe({label:S.label}):A=we({label:S.label}),o.current.addNode(A),l.current.set(C,A.id),b.delete(C),g.current.set(A.id,new Set([C]));const w=t.filter(p=>p.source===C||p.target===C);for(const p of w){const N=p.source===C,R=N?p.target:p.source;if(m.current.has(R))continue;const O=l.current.get(R);if(!O||O===P)continue;const k=N?A.id:O,v=N?O:A.id;y.getOrCreateTransitionAndLink(p.id,k,v)}e(p=>p.map(N=>N.id===C?{...N,data:{...N.data,definitionId:A.id}}:N)),s(p=>p.map(N=>{if(N.source===C||N.target===C){const R=E.current.get(N.id);if(R)return{...N,data:{...N.data,transitionId:R}}}return N}))},[o,l,g,m,E,t,e,s,y]),U=c.useCallback(C=>{const P=i.current.get(C),S=new Set([C]);if(P)for(const b of P)S.add(b);D(C),e(b=>b.filter(A=>!S.has(A.id)))},[i,D,e]),L=c.useCallback(C=>{const P=g.current.get(C);if(!P)return;const S=new Set(P);for(const b of S)l.current.delete(b);g.current.delete(C),o.current.removeNode(C),e(b=>b.filter(A=>!S.has(A.id)))},[o,l,g,e]);return{addNode:z,addInstance:x,duplicateInstance:h,dissociateInstance:I,deleteInstance:U,deleteDefinition:L,handleInstanceDeletion:D}}function Gt(n){const{setNodes:t,graphRef:e,instanceMapping:s}=n,{defToInstancesRef:o,getDefinitionForInstance:u,getInstancesForDefinition:T,isOriginalInstance:M}=s,y=c.useCallback(d=>T(d),[T]),l=c.useCallback((d,a)=>{e.current.updateNode(d,{executionMode:a});const D=o.current.get(d);D&&t(z=>z.map(x=>D.has(x.id)?{...x,data:{...x.data,executionMode:a}}:x))},[e,o,t]),g=c.useCallback((d,a)=>{const D=e.current.getNode(d);if(!D)return;e.current.updateNode(d,{label:a});const z=D.config;if(D.kind==="command"||D.kind==="trigger"||D.kind==="externalSystem"||D.kind==="externalEvent"){const h=ne(a);if(h){const I=z;if((I==null?void 0:I.slugName)!==h){const L={...I,slugName:h};e.current.updateNode(d,{config:L})}}}else if(D.kind==="event"){const h=Se(a);if(h){const I=z;if((I==null?void 0:I.type)!==h){const L={...I,type:h};e.current.updateNode(d,{config:L})}}}const x=o.current.get(d);x&&t(h=>h.map(I=>x.has(I.id)?{...I,data:{...I.data,label:a}}:I))},[e,o,t]),E=c.useCallback((d,a)=>{e.current.updateNode(d,{config:a})},[e]),f=c.useCallback((d,a)=>{e.current.updateNode(d,{awsExtension:a})},[e]),m=c.useCallback(d=>{var a;return(a=e.current.getNode(d))==null?void 0:a.config},[e]),i=c.useCallback(d=>{var a;return(a=e.current.getNode(d))==null?void 0:a.awsExtension},[e]),r=c.useCallback((d,a)=>{var I;const D=e.current.getNode(d);if(!D||D.kind!=="command"&&D.kind!=="trigger"||D.kind===a)return;const z=a==="trigger"?"manual":"automatic";e.current.updateNode(d,{kind:a,executionMode:z}),a==="command"&&e.current.recalculateExecutionMode(d);const x=o.current.get(d);if(!x)return;const h=(I=e.current.getNode(d))==null?void 0:I.executionMode;t(U=>U.map(L=>x.has(L.id)?{...L,type:a,data:{...L.data,executionMode:h}}:L))},[e,o,t]);return{getDefinitionForInstance:u,getInstancesForDefinition:y,isOriginalInstance:M,updateNodeExecutionMode:l,updateNodeLabel:g,updateNodeConfig:E,updateNodeAwsExtension:f,getNodeConfig:m,getNodeAwsExtension:i,convertNodeKind:r}}function Wt(n){const{edges:t,setNodes:e,setEdges:s,outcomeManagement:o,edgeTransitionManager:u}=n,{outcomeToParentRef:T,policyToOutcomesRef:M,outcomeToTransitionRef:y,getOutcomeTransition:l,getOutcomesForPolicy:g,getOutcomesWithLabels:E,addOutcomeToPolicy:f,updateOutcomeLabel:m}=o,i=c.useMemo(()=>({cleanupEdgesFromSource:d=>{const a=t.filter(D=>D.source===d).map(D=>D.id);for(const D of a)u.unlinkEdgeFromTransition(D);return a}}),[t,u]),r=c.useCallback(d=>Ft(d,T.current,M.current,y.current,i,e,s),[T,M,y,i,e,s]);return{getOutcomeTransition:l,getOutcomesForPolicy:g,getOutcomesWithLabels:E,addOutcomeToPolicy:f,deleteOutcome:r,updateOutcomeLabel:m}}const de=16;function Ut(n){const{nodes:t,edges:e,setNodes:s,setEdges:o,graphRef:u,instanceMapping:T,outcomeManagement:M,commandEdgeResolver:y,incrementGraphVersion:l}=n,{instanceToDefRef:g,defToInstancesRef:E,edgeToTransitionRef:f,transitionToEdgesRef:m}=T,{outcomeToParentRef:i,policyToOutcomesRef:r,outcomeToTransitionRef:d,resetMappings:a}=M,D=c.useCallback(()=>{u.current=new le,T.resetMappings(),a(),s([]),o([]),l()},[u,s,o,T,a,l]),z=c.useCallback(()=>({graph:u.current,nodes:t,edges:e,mappings:{instanceToDefRef:new Map(g.current),defToInstancesRef:new Map(Array.from(E.current.entries()).map(([h,I])=>[h,new Set(I)])),edgeToTransitionRef:new Map(f.current),transitionToEdgesRef:new Map(Array.from(m.current.entries()).map(([h,I])=>[h,new Set(I)])),outcomeToParentRef:new Map(i.current),policyToOutcomesRef:new Map(Array.from(r.current.entries()).map(([h,I])=>[h,new Set(I)])),outcomeToTransitionRef:new Map(d.current)}}),[t,e,u,g,E,f,m,i,r,d]),x=c.useCallback(h=>{u.current=h.graph,g.current=h.mappings.instanceToDefRef,E.current=h.mappings.defToInstancesRef,f.current=h.mappings.edgeToTransitionRef,m.current=h.mappings.transitionToEdgesRef,i.current=h.mappings.outcomeToParentRef??new Map,r.current=h.mappings.policyToOutcomesRef??new Map,d.current=h.mappings.outcomeToTransitionRef??new Map;const I=h.nodes.map(C=>({...C,position:{x:Math.round(C.position.x/de)*de,y:Math.round(C.position.y/de)*de}})),L=y.normalizeAllCommandEdges(h.edges,h.graph,h.mappings.instanceToDefRef,h.mappings.defToInstancesRef).map(C=>Rt(C,h.graph,h.mappings.instanceToDefRef,h.mappings.outcomeToParentRef??new Map));s(I),o(L),l()},[u,g,E,f,m,i,r,d,s,o,y,l]);return{reset:D,getWorkflowState:z,hydrateWorkflow:x}}const Vt=[],jt=[];function Bt(n){const t=c.useRef(new le),[e,s]=c.useState(0),o=Le(),[u,T,M]=ze(Vt),[y,l,g]=$e(jt),E=c.useRef([]);E.current=u;const{getNode:f,getNodes:m}=_e(),i=qe(t,{edgeToTransitionRef:o.edgeToTransitionRef,transitionToEdgesRef:o.transitionToEdgesRef}),r=Ye(t,o.defToInstancesRef),d=Be({instanceToDefRef:o.instanceToDefRef,setNodes:T,getNodes:m}),a=(n==null?void 0:n.graphRef)??t,D=n?n.incrementGraphVersion:()=>s(ce=>ce+1),z=(n==null?void 0:n.nodes)??u,x=(n==null?void 0:n.edges)??y,h=(n==null?void 0:n.setNodes)??T,I=(n==null?void 0:n.setEdges)??l,U=(n==null?void 0:n.onNodesChangeInternal)??M,L=(n==null?void 0:n.onEdgesChangeInternal)??g,C=(n==null?void 0:n.nodesRef)??E,P=(n==null?void 0:n.instanceMapping)??o,{instanceToDefRef:S,defToInstancesRef:b,edgeToTransitionRef:A,transitionToEdgesRef:w}=P,p=(n==null?void 0:n.edgeTransitionManager)??i,N=(n==null?void 0:n.commandEdgeResolver)??r,R=(n==null?void 0:n.outcomeManagement)??d,O=c.useMemo(()=>x.map(ce=>({...ce,reconnectable:ce.selected??!1})),[x]),{outcomeToParentRef:k,policyToOutcomesRef:v,outcomeToTransitionRef:$}=R,F={nodes:z,edges:x,setNodes:h,setEdges:I,onNodesChangeInternal:U,onEdgesChangeInternal:L,graphRef:a,graph:a.current,getNode:f,nodesRef:C,instanceMapping:P,instanceToDefRef:S,defToInstancesRef:b,edgeToTransitionRef:A,transitionToEdgesRef:w,outcomeManagement:R,edgeTransitionManager:p,commandEdgeResolver:N,incrementGraphVersion:D},{onNodesChange:_,onEdgesChange:G,onConnect:V,onReconnect:q,isValidConnection:Y}=_t(F),{addNode:W,addInstance:B,duplicateInstance:ee,dissociateInstance:H,deleteInstance:se,deleteDefinition:re}=Lt(F),{getDefinitionForInstance:he,getInstancesForDefinition:pe,isOriginalInstance:Te,updateNodeExecutionMode:j,updateNodeLabel:ie,updateNodeConfig:K,updateNodeAwsExtension:ae,getNodeConfig:Je,getNodeAwsExtension:Qe,convertNodeKind:He}=Gt(F),{getOutcomeTransition:Ke,getOutcomesForPolicy:et,getOutcomesWithLabels:tt,addOutcomeToPolicy:nt,deleteOutcome:st,updateOutcomeLabel:ot}=Wt(F),{reset:rt,getWorkflowState:it,hydrateWorkflow:at}=Ut(F),ct=c.useMemo(()=>t.current,[e]),ut=(n==null?void 0:n.graph)??ct;return{nodes:z,edges:O,graph:ut,onNodesChange:_,onEdgesChange:G,onConnect:V,isValidConnection:Y,onReconnect:q,addNode:W,addInstance:B,duplicateInstance:ee,dissociateInstance:H,deleteInstance:se,deleteDefinition:re,getDefinitionForInstance:he,getInstancesForDefinition:pe,isOriginalInstance:Te,updateNodeExecutionMode:j,updateNodeLabel:ie,updateNodeConfig:K,updateNodeAwsExtension:ae,getNodeConfig:Je,getNodeAwsExtension:Qe,convertNodeKind:He,reset:rt,getWorkflowState:it,hydrateWorkflow:at,getOutcomeTransition:Ke,getOutcomesForPolicy:et,getOutcomesWithLabels:tt,addOutcomeToPolicy:nt,deleteOutcome:st,updateOutcomeLabel:ot}}const qt=[],Yt=[];function Xt(){const n=c.useRef(new le),[t,e]=c.useState(0),s=Le(),{instanceToDefRef:o,defToInstancesRef:u,edgeToTransitionRef:T,transitionToEdgesRef:M}=s,[y,l,g]=ze(qt),[E,f,m]=$e(Yt),i=c.useRef([]);i.current=y;const r=c.useMemo(()=>E.map(b=>({...b,reconnectable:b.selected??!1})),[E]),{getNode:d,getNodes:a}=_e(),D=qe(n,{edgeToTransitionRef:T,transitionToEdgesRef:M}),z=Ye(n,u),x=Be({instanceToDefRef:o,setNodes:l,getNodes:a}),{outcomeToParentRef:h,policyToOutcomesRef:I,outcomeToTransitionRef:U,resetMappings:L}=x,C=c.useCallback(()=>{e(b=>b+1)},[]),P=c.useCallback(()=>{n.current=new le,s.resetMappings(),L(),l([]),f([]),e(b=>b+1)},[l,f,s,L]),S=c.useMemo(()=>n.current,[t]);return{nodes:y,edges:E,edgesWithReconnectable:r,setNodes:l,setEdges:f,onNodesChangeInternal:g,onEdgesChangeInternal:m,graphRef:n,graph:S,getNode:d,getNodes:a,nodesRef:i,instanceMapping:s,instanceToDefRef:o,defToInstancesRef:u,edgeToTransitionRef:T,transitionToEdgesRef:M,outcomeManagement:x,outcomeToParentRef:h,policyToOutcomesRef:I,outcomeToTransitionRef:U,edgeTransitionManager:D,commandEdgeResolver:z,incrementGraphVersion:C,reset:P}}const Xe=c.createContext(null);function Zt({children:n}){const t=Xt();return te.jsx(Xe.Provider,{value:t,children:n})}function Jt(){const n=c.useContext(Xe);if(!n)throw new Error("useWorkflowCoreContext must be used within a WorkflowCoreProvider");return n}const Ze=c.createContext(null);function Qt({children:n}){const t=Jt(),e=Bt(t);return te.jsx(Ze.Provider,{value:e,children:n})}function xn({children:n}){return te.jsx(Zt,{children:te.jsx(Qt,{children:n})})}function Ht(){const n=c.useContext(Ze);if(!n)throw new Error("useWorkflow must be used within a WorkflowProvider");return n}function Kt(n){const t=c.useRef(null),[e,s]=c.useState(null),[o,u]=c.useState([]),[T,M]=c.useState(!1);c.useEffect(()=>{const i=new St(n,{transitionDelay:1e3});t.current=i;const r=(a,D)=>{const z={id:`${Date.now()}-${Math.random()}`,type:a,timestamp:D.timestamp,data:D};u(x=>[...x,z]),s(i.getState())},d=[i.on("simulation:start",a=>{r("simulation:start",a),M(!0)}),i.on("simulation:stop",a=>{r("simulation:stop",a),M(!1)}),i.on("simulation:reset",a=>{r("simulation:reset",a),M(!1)}),i.on("node:enter",a=>r("node:enter",a)),i.on("node:active",a=>r("node:active",a)),i.on("node:waiting",a=>r("node:waiting",a)),i.on("node:exit",a=>r("node:exit",a)),i.on("node:complete",a=>r("node:complete",a)),i.on("node:reset",a=>r("node:reset",a)),i.on("transition:start",a=>r("transition:start",a)),i.on("transition:complete",a=>r("transition:complete",a)),i.on("transition:reset",a=>r("transition:reset",a)),i.on("error",a=>r("error",a)),i.on("state:initialized",()=>{s(i.getState())})];return queueMicrotask(()=>{s(i.getState())}),()=>{d.forEach(a=>a()),i.stop(),t.current=null}},[n]);const y=c.useCallback(()=>{var i;(i=t.current)==null||i.start()},[]),l=c.useCallback(()=>{var i;(i=t.current)==null||i.stop()},[]),g=c.useCallback(()=>{var i;(i=t.current)==null||i.reset(),u([])},[]),E=c.useCallback(i=>{var r;(r=t.current)==null||r.triggerNode(i)},[]),f=c.useCallback(i=>{var r;(r=t.current)==null||r.selectTransition(i)},[]),m=c.useCallback(i=>{var r;(r=t.current)==null||r.completeManualNode(i)},[]);return{isRunning:T,state:e,events:o,start:y,stop:l,reset:g,triggerNode:E,selectTransition:f,completeManualNode:m}}const en=c.createContext(null);function Nn({children:n}){const{graph:t}=Ht(),e=Kt(t);return te.jsx(en.Provider,{value:e,children:n})}const tn=c.createContext(null);function bn({children:n}){const[t,e]=c.useState(null),[s,o]=c.useState(null),u=c.useCallback(y=>{e(y)},[]),T=c.useCallback(()=>{e(null)},[]),M={pendingTooltip:t,hoveredWarningEdgeId:s,showTooltip:u,hideTooltip:T,setHoveredWarningEdgeId:o};return te.jsx(tn.Provider,{value:M,children:n})}function vn(){const n=Ee(s=>s.theme),t=Ee(s=>s.setTheme),e=Ee(s=>s.toggleTheme);return{theme:n,setTheme:t,toggleTheme:e}}export{At as A,Kt as B,Tn as C,en as D,tn as E,En as F,ve as G,be as H,Cn as I,ne as J,hn as K,le as L,an as M,bn as N,me as O,cn as P,Se as Q,ln as R,un as S,mn as T,Ae as U,dn as V,xn as W,Jt as a,Ne as b,Ct as c,Q as d,Ht as e,fn as f,ue as g,gn as h,Nn as i,It as j,ge as k,We as l,Ge as m,oe as n,Ot as o,Pt as p,J as q,Ue as r,Ve as s,kt as t,vn as u,pn as v,zt as w,Ft as x,$t as y,je as z};
