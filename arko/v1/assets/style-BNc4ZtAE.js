var gt=Object.defineProperty;var ft=(n,t,e)=>t in n?gt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var Y=(n,t,e)=>ft(n,typeof t!="symbol"?t+"":t,e);import{c as Se}from"./index-BcYYLFft.js";import{P as ue,b as c,m as Me,n as mt,k as _e,l as Le,u as Ge,j as te}from"./react-flow-Crnto5D5.js";import{F as me,u as Ce}from"./Toast-D25HDRZL.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ht=[["path",{d:"M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401",key:"kfwtm"}]],dn=Se("moon",ht);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pt=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],ln=Se("play",pt);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tt=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],gn=Se("sun",Tt);function Q(n){switch(n){case"trigger":case"externalSystem":case"externalEvent":case"hotspot":case"note":case"actor":return"manual";case"event":case"policy":case"command":default:return"automatic"}}function Et(n,t){if(n!=="command"&&n!=="policy")throw new Error(`calculateDynamicExecutionMode called with non-dynamic kind: ${n}`);return t<=1?"automatic":"manual"}function Ct(n){return n.executionMode==="manual"}function xt(n,t){return n.executionMode==="manual"?!1:t>0}class ge{constructor(){Y(this,"nodes",new Map);Y(this,"transitions",new Map);Y(this,"outgoingEdges",new Map);Y(this,"incomingEdges",new Map)}addNode(t){if(this.nodes.has(t.id))throw new Error(`Node with id ${t.id} already exists`);this.nodes.set(t.id,t),this.outgoingEdges.set(t.id,new Set),this.incomingEdges.set(t.id,new Set)}getNode(t){return this.nodes.get(t)}hasNode(t){return this.nodes.has(t)}getAllNodes(){return Array.from(this.nodes.values())}updateNode(t,e){const s=this.nodes.get(t);if(!s)return;const o={...s,...e};return this.nodes.set(t,o),o}removeNode(t){if(!this.nodes.has(t))return!1;const e=this.outgoingEdges.get(t)??new Set,s=this.incomingEdges.get(t)??new Set;for(const o of e)this.removeTransition(o);for(const o of s)this.removeTransition(o);return this.nodes.delete(t),this.outgoingEdges.delete(t),this.incomingEdges.delete(t),!0}addTransition(t){if(this.transitions.has(t.id))throw new Error(`Transition with id ${t.id} already exists`);if(!this.nodes.has(t.sourceDefId))throw new Error(`Source node ${t.sourceDefId} does not exist`);if(!this.nodes.has(t.targetDefId))throw new Error(`Target node ${t.targetDefId} does not exist`);this.transitions.set(t.id,t),this.outgoingEdges.get(t.sourceDefId).add(t.id),this.incomingEdges.get(t.targetDefId).add(t.id),this.recalculateExecutionMode(t.sourceDefId)}getTransition(t){return this.transitions.get(t)}getAllTransitions(){return Array.from(this.transitions.values())}removeTransition(t){var o,u;const e=this.transitions.get(t);if(!e)return!1;const s=e.sourceDefId;return(o=this.outgoingEdges.get(e.sourceDefId))==null||o.delete(t),(u=this.incomingEdges.get(e.targetDefId))==null||u.delete(t),this.transitions.delete(t),this.recalculateExecutionMode(s),!0}getOutgoingTransitions(t){const e=this.outgoingEdges.get(t);return e?Array.from(e).map(s=>this.transitions.get(s)).filter(Boolean):[]}getIncomingTransitions(t){const e=this.incomingEdges.get(t);return e?Array.from(e).map(s=>this.transitions.get(s)).filter(Boolean):[]}getSuccessors(t){return this.getOutgoingTransitions(t).map(e=>this.nodes.get(e.targetDefId)).filter(Boolean)}getPredecessors(t){return this.getIncomingTransitions(t).map(e=>this.nodes.get(e.sourceDefId)).filter(Boolean)}get nodeCount(){return this.nodes.size}get transitionCount(){return this.transitions.size}getEntryNodes(){return this.getAllNodes().filter(t=>{var e;return(((e=this.incomingEdges.get(t.id))==null?void 0:e.size)??0)===0})}getTerminalNodes(){return this.getAllNodes().filter(t=>{var e;return(((e=this.outgoingEdges.get(t.id))==null?void 0:e.size)??0)===0})}recalculateExecutionMode(t){var u;const e=this.nodes.get(t);if(!e||e.kind!=="command"&&e.kind!=="policy")return;const s=((u=this.outgoingEdges.get(t))==null?void 0:u.size)??0,o=Et(e.kind,s);e.executionMode!==o&&this.nodes.set(t,{...e,executionMode:o})}requiresUserAction(t){const e=this.nodes.get(t);return e?Ct(e):!1}canAutoTraverse(t){var o;const e=this.nodes.get(t);if(!e)return!1;const s=((o=this.outgoingEdges.get(t))==null?void 0:o.size)??0;return xt(e,s)}getReachableNodes(t){const e=[],s=new Set,o=[];for(const u of this.getSuccessors(t))s.has(u.id)||(s.add(u.id),o.push(u.id),e.push(u));for(;o.length>0;){const u=o.shift();for(const f of this.getSuccessors(u))s.has(f.id)||(s.add(f.id),o.push(f.id),e.push(f))}return e}getReachableTransitions(t){const e=[],s=new Set;for(const o of this.getOutgoingTransitions(t))s.has(o.id)||(s.add(o.id),e.push(o));for(const o of this.getReachableNodes(t))for(const u of this.getOutgoingTransitions(o.id))s.has(u.id)||(s.add(u.id),e.push(u));return e}}function ne(n,t=""){return n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]+/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")||t}function ke(n,t=""){return n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().replace(/\s+/g,".").replace(/[^a-z0-9.-]+/g,".").replace(/^[.-]+|[.-]+$/g,"").replace(/\.+/g,".").replace(/-+/g,"-")||t}function fn(n){return n.length<=13?n:`${n.slice(0,5)}...${n.slice(-5)}`}function mn(n){return n.replace(/^(def_|trans_|inst_|outcome_)/,"")}function hn(n,t,e){const s=ne(n);if(s)return s;const o=t.replace(/^def_/,"").toLowerCase();return`${e}-${o.slice(0,8)}`}function pn(n,t){const e=ke(n);return e||`event.${t.replace(/^def_/,"").toLowerCase().slice(0,8)}`}function Tn(n){const t=n.match(/\{([^}]+)\}/g);return t?t.map(e=>e.slice(1,-1)):[]}function En(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const t=Math.random()*16|0;return(n==="x"?t:t&3|8).toString(16)})}function we(n,t,e,s){switch(e){case ue.Top:return{x:n,y:t-s};case ue.Bottom:return{x:n,y:t+s};case ue.Left:return{x:n-s,y:t};case ue.Right:return{x:n+s,y:t};default:return{x:n,y:t}}}function Nt(n,t,e,s,o=100){const u=e-n,f=s-t,S=Math.sqrt(u*u+f*f);return Math.min(o,S/2)}function Cn(n,t,e,s,o,u){const f=Nt(n,t,e,s),S=we(n,t,o,f),b=we(e,s,u,f);return`M${n},${t} C${S.x},${S.y} ${b.x},${b.y} ${e},${s}`}function H(){return`def_${me()}`}function bt(){return`trans_${me()}`}function de(){return`inst_${me()}`}function be(){return`outcome_${me()}`}function xe(n){const t=ke(n.label);return{id:H(),label:n.label,kind:"event",category:"business",executionMode:Q("event"),config:t?{type:t}:void 0}}function Re(n){return{id:H(),label:n.label,kind:"policy",category:"business",executionMode:Q("policy")}}function vt(n){const t=ne(n.label);return{id:H(),label:n.label,kind:"trigger",category:"business",executionMode:Q("trigger"),config:t?{slugName:t}:void 0}}function De(n){const t=ne(n.label);return{id:H(),label:n.label,kind:"externalSystem",category:"technical",executionMode:Q("externalSystem"),config:t?{slugName:t}:void 0}}function yt(n){const t=ne(n.label);return{id:H(),label:n.label,kind:"externalEvent",category:"technical",executionMode:Q("externalEvent"),config:t?{slugName:t}:void 0}}function Ie(n){const t=ne(n.label);return{id:H(),label:n.label,kind:"command",category:"business",executionMode:Q("command"),config:t?{slugName:t}:void 0}}function Oe(n){return{id:H(),label:n.label,kind:"hotspot",category:"business",executionMode:Q("hotspot")}}function Ae(n){return{id:H(),label:n.label,kind:"note",category:"business",executionMode:Q("note")}}function Pe(n){return{id:H(),label:n.label,kind:"actor",category:"business",executionMode:Q("actor")}}function St(n){return{id:bt(),sourceDefId:n.sourceDefId,targetDefId:n.targetDefId}}const kt={transitionDelay:1e3,autoStart:!1};class Mt{constructor(){Y(this,"listeners",new Map)}on(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>this.off(t,e)}off(t,e){var s;(s=this.listeners.get(t))==null||s.delete(e)}emit(t,e){const s=this.listeners.get(t);if(s)for(const o of s)try{o(e)}catch(u){console.error(`Error in event handler for ${String(t)}:`,u)}}once(t,e){const s=o=>{this.off(t,s),e(o)};return this.on(t,s)}removeAllListeners(t){t?this.listeners.delete(t):this.listeners.clear()}listenerCount(t){var e;return((e=this.listeners.get(t))==null?void 0:e.size)??0}}class wt extends Mt{constructor(e,s={}){super();Y(this,"graph");Y(this,"config");Y(this,"running",!1);Y(this,"nodeStates",new Map);Y(this,"transitionStates",new Map);Y(this,"activeNodes",new Set);Y(this,"pendingActions",new Set);Y(this,"activeTimeouts",new Set);this.graph=e,this.config={...kt,...s},this.initializeState()}initializeState(){for(const e of this.graph.getAllNodes())this.nodeStates.set(e.id,"idle");for(const e of this.graph.getAllTransitions())this.transitionStates.set(e.id,"idle")}getState(){return{isRunning:this.running,nodeStates:new Map(this.nodeStates),transitionStates:new Map(this.transitionStates),activeNodes:new Set(this.activeNodes),pendingActions:new Set(this.pendingActions)}}getNodeState(e){return this.nodeStates.get(e)}getTransitionState(e){return this.transitionStates.get(e)}isSimulationRunning(){return this.running}start(){if(!this.running&&(this.running=!0,this.emit("simulation:start",{timestamp:Date.now()}),this.config.autoStart))for(const e of this.graph.getEntryNodes())this.triggerNode(e.id)}stop(){if(this.running){this.running=!1;for(const e of this.activeTimeouts)clearTimeout(e);this.activeTimeouts.clear(),this.emit("simulation:stop",{timestamp:Date.now()})}}reset(){this.stop(),this.nodeStates.clear(),this.transitionStates.clear(),this.activeNodes.clear(),this.pendingActions.clear(),this.initializeState(),this.emit("simulation:reset",{timestamp:Date.now()})}resetAllStates(){const e=Date.now();for(const s of this.graph.getAllNodes())this.nodeStates.set(s.id,"idle"),this.emit("node:reset",{node:s,timestamp:e});for(const s of this.graph.getAllTransitions())this.transitionStates.set(s.id,"idle"),this.emit("transition:reset",{transition:s,timestamp:e});this.activeNodes.clear(),this.pendingActions.clear()}triggerNode(e){if(!this.running){this.emitError(`Cannot trigger node ${e}: simulation is not running`,e);return}if(!this.graph.getNode(e)){this.emitError(`Node ${e} not found`,e);return}this.resetAllStates(),this.enterNode(e)}selectTransition(e){if(!this.running){this.emitError("Cannot select transition: simulation is not running",void 0,e);return}const s=this.graph.getTransition(e);if(!s){this.emitError(`Transition ${e} not found`,void 0,e);return}if(!this.graph.getNode(s.sourceDefId)){this.emitError("Source node for transition not found",s.sourceDefId,e);return}if(!this.pendingActions.has(s.sourceDefId)){this.emitError(`Node ${s.sourceDefId} is not waiting for action`,s.sourceDefId);return}this.resetAllStates(),this.executeTransition(s)}completeManualNode(e){if(!this.running){this.emitError("Cannot complete node: simulation is not running",e);return}if(!this.graph.getNode(e)){this.emitError(`Node ${e} not found`,e);return}if(!this.pendingActions.has(e)){this.emitError(`Node ${e} is not waiting for action`,e);return}this.resetAllStates(),this.pendingActions.delete(e),this.exitNode(e)}enterNode(e){const s=this.graph.getNode(e);s&&(this.nodeStates.set(e,"entering"),this.activeNodes.add(e),this.emit("node:enter",{node:s,timestamp:Date.now()}),this.activateNode(e))}activateNode(e){const s=this.graph.getNode(e);s&&(this.nodeStates.set(e,"active"),this.emit("node:active",{node:s,timestamp:Date.now()}),this.graph.requiresUserAction(e)?this.waitForAction(e):this.graph.canAutoTraverse(e)?this.exitNode(e):this.completeNode(e))}waitForAction(e){const s=this.graph.getNode(e);if(!s)return;this.nodeStates.set(e,"waiting_for_action"),this.pendingActions.add(e);const o=this.graph.getOutgoingTransitions(e);this.emit("node:waiting",{node:s,availableTransitions:o,timestamp:Date.now()})}exitNode(e){const s=this.graph.getNode(e);if(!s)return;this.nodeStates.set(e,"exiting"),this.emit("node:exit",{node:s,timestamp:Date.now()});const o=this.graph.getOutgoingTransitions(e);if(o.length===0)this.completeNode(e);else if(o.length===1)this.executeTransition(o[0]),this.completeNode(e);else{for(const u of o)this.executeTransition(u);this.completeNode(e)}}completeNode(e){const s=this.graph.getNode(e);s&&(this.nodeStates.set(e,"completed"),this.activeNodes.delete(e),this.emit("node:complete",{node:s,timestamp:Date.now()}))}executeTransition(e){this.transitionStates.set(e.id,"in_progress"),this.emit("transition:start",{transition:e,timestamp:Date.now()});const s=setTimeout(()=>{this.activeTimeouts.delete(s),this.completeTransition(e)},this.config.transitionDelay);this.activeTimeouts.add(s)}completeTransition(e){this.transitionStates.set(e.id,"completed"),this.emit("transition:complete",{transition:e,timestamp:Date.now()}),this.enterNode(e.targetDefId)}emitError(e,s,o){this.emit("error",{message:e,nodeId:s,transitionId:o,timestamp:Date.now()})}}function We(){const n=c.useRef(new Map),t=c.useRef(new Map),e=c.useRef(new Map),s=c.useRef(new Map),o=c.useCallback(r=>n.current.get(r),[]),u=c.useCallback(r=>{const d=t.current.get(r);return d?Array.from(d):[]},[]),f=c.useCallback(r=>{const d=n.current.get(r);if(!d)return!0;const a=t.current.get(d);if(!a||a.size<=1)return!0;const D=Array.from(a).sort();return r===D[0]},[]),S=c.useCallback((r,d,a)=>{if(!r.current)return;const z=r.current.getOutgoingTransitions(d).find(x=>x.targetDefId===a);return z==null?void 0:z.id},[]),b=c.useCallback(r=>e.current.get(r),[]),l=c.useCallback(r=>s.current.get(r),[]),g=c.useCallback((r,d)=>{n.current.set(r,d);let a=t.current.get(d);a||(a=new Set,t.current.set(d,a)),a.add(r)},[]),E=c.useCallback(r=>{const d=n.current.get(r);if(!d)return;n.current.delete(r);const a=t.current.get(d);return a&&(a.delete(r),a.size===0&&t.current.delete(d)),d},[]),m=c.useCallback((r,d)=>{e.current.set(r,d);let a=s.current.get(d);a||(a=new Set,s.current.set(d,a)),a.add(r)},[]),h=c.useCallback(r=>{const d=e.current.get(r);if(!d)return;e.current.delete(r);const a=s.current.get(d);return a&&(a.delete(r),a.size===0&&s.current.delete(d)),d},[]),i=c.useCallback(()=>{n.current.clear(),t.current.clear(),e.current.clear(),s.current.clear()},[]);return{instanceToDefRef:n,defToInstancesRef:t,edgeToTransitionRef:e,transitionToEdgesRef:s,getDefinitionForInstance:o,getInstancesForDefinition:u,isOriginalInstance:f,findExistingTransition:S,getEdgeTransition:b,getEdgesForTransition:l,registerInstance:g,unregisterInstance:E,registerEdge:m,unregisterEdge:h,resetMappings:i}}function xn(n,t){return{x:n.x-t.x,y:n.y-t.y}}function Rt(n,t){return{x:n.x+t.x,y:n.y+t.y}}function Nn(n,t){return t?Rt(n,t):n}const oe=152,Be=102,Ue=80,he=32,J=10;function fe(n,t,e=oe,s=Be,o=Ue,u=he){const f=n+o<=0,S=n>=e,b=t+u<=0,l=t>=s;if(f)return{x:-o-J,y:Math.max(-u,Math.min(t,s))};if(S)return{x:e+J,y:Math.max(-u,Math.min(t,s))};if(b)return{x:Math.max(-o,Math.min(n,e)),y:-u-J};if(l)return{x:Math.max(-o,Math.min(n,e)),y:s+J};const g=n+o/2,E=t+u/2,m=e/2,h=s/2,i=g-m,r=E-h;return Math.abs(i)>Math.abs(r)?i>0?{x:e+J,y:Math.max(-u,Math.min(t,s))}:{x:-o-J,y:Math.max(-u,Math.min(t,s))}:r>0?{x:Math.max(-o,Math.min(n,e)),y:s+J}:{x:Math.max(-o,Math.min(n,e)),y:-u-J}}const $e={command:{canConnectTo:["event"],canReceiveFrom:["event","policy","externalEvent"]},policy:{canConnectTo:["command","externalEvent","trigger","externalSystem"],canReceiveFrom:["event"]},externalEvent:{canConnectTo:["command","trigger"],canReceiveFrom:["event","policy"]},externalSystem:{canConnectTo:["event"],canReceiveFrom:["event","policy","externalEvent"]},trigger:{canConnectTo:["event"],canReceiveFrom:["event","policy","externalEvent"]},event:{canConnectTo:["policy","command","externalEvent","trigger","externalSystem"],canReceiveFrom:["command","trigger","externalSystem"]}};function Dt(n,t){const e=$e[n],s=$e[t];if(!e||!s)return!1;const o=e.canConnectTo.includes(t),u=s.canReceiveFrom.includes(n);return o&&u}function It(n,t){return t?"policy":n}function bn(n){return n==="command"?"commandEdge":"floating"}function Ne(n){return n>=2?"commandEdge":"floating"}function vn(n,t){return{sourceHandle:"source-right",targetHandle:"target-left"}}function ve(){return{label:"Path",labelOffset:.5}}function ye(n,t){return!n||!t?{isNonStandard:!1}:{isNonStandard:!Dt(n,t),sourceKind:n,targetKind:t}}function Ot(n,t,e,s){const o=n.source,u=n.target,f=s.has(o);let S;if(f){const i=s.get(o);S=i?e.get(i):void 0}else S=e.get(o);const b=e.get(u);if(!S||!b)return n;const l=t.getNode(S),g=t.getNode(b),E=f?"policy":l==null?void 0:l.kind,m=g==null?void 0:g.kind,h=ye(E,m);return{...n,data:{...n.data,...h}}}function Ve(n,t,e,s){n.set(e,s);let o=t.get(s);o||(o=new Set,t.set(s,o)),o.add(e)}function je(n,t,e,s){const o=n.get(s);if(!o)return;n.delete(s),e.delete(s);const u=t.get(o);u&&(u.delete(s),u.size===0&&t.delete(o))}function qe(n,t){var e;return((e=n.get(t))==null?void 0:e.size)??0}function At(n,t,e){var u;const s=t.get(n);return s?(((u=e.get(s))==null?void 0:u.size)??0)>2:!1}function Pt(n,t,e,s){return n.filter(o=>{const u=o;return u.type!=="remove"||!u.id||!t.has(u.id)||s!=null&&s.has(u.id)?!0:At(u.id,t,e)})}function $t(n,t,e,s){return n}function zt(n,t=oe){return fe(t+J,n*(he+J))}function Ft(n,t,e,s,o){return{id:n,type:"outcome",position:o,parentId:t,data:{label:s,parentPolicyId:t,parentPolicyInstanceId:t,parentPolicyDefId:e}}}function _t(n,t,e,s,o,u,f){var g;const S=t.get(n);if(!S||(((g=e.get(S))==null?void 0:g.size)??0)<=2)return!1;if(s.get(n)){const E=o.cleanupEdgesFromSource(n);E.length>0&&f(m=>m.filter(h=>!E.includes(h.id)))}return je(t,e,s,n),u(E=>E.filter(m=>m.id!==n)),!0}function Lt(n,t,e,s,o,u,f){const S=f(),b=qe(o,n),l=zt(b),g=Ft(S,n,t,e,l);return Ve(s,o,S,n),u(E=>[...E,g]),S}function Gt(n,t,e){e(s=>s.map(o=>o.id===n?{...o,data:{...o.data,label:t}}:o))}function Ze(n){const{instanceToDefRef:t,setNodes:e,getNodes:s}=n,o=c.useRef(new Map),u=c.useRef(new Map),f=c.useRef(new Map),S=c.useCallback(x=>f.current.get(x),[]),b=c.useCallback(x=>{const p=u.current.get(x);return p?Array.from(p):[]},[]),l=c.useCallback(x=>{const p=u.current.get(x);if(!p)return[];const I=s();return Array.from(p).map(B=>{var P;const L=I.find(k=>k.id===B),C=((P=L==null?void 0:L.data)==null?void 0:P.label)||"Outcome";return{id:B,label:C}})},[s]),g=c.useCallback(x=>o.current.has(x),[]),E=c.useCallback(x=>o.current.get(x),[]),m=c.useCallback(x=>qe(u.current,x),[]),h=c.useCallback((x,p)=>{Ve(o.current,u.current,x,p)},[]),i=c.useCallback(x=>{je(o.current,u.current,f.current,x)},[]),r=c.useCallback((x,p)=>{f.current.set(x,p)},[]),d=c.useCallback(x=>{f.current.delete(x)},[]),a=c.useCallback((x,p)=>{var B;const I=(B=t.current)==null?void 0:B.get(x);if(!I)throw new Error(`Policy instance ${x} not found`);return Lt(x,I,p,o.current,u.current,e,be)},[t,e]),D=c.useCallback((x,p)=>{Gt(x,p,e)},[e]),z=c.useCallback(()=>{o.current.clear(),u.current.clear(),f.current.clear()},[]);return{outcomeToParentRef:o,policyToOutcomesRef:u,outcomeToTransitionRef:f,getOutcomeTransition:S,getOutcomesForPolicy:b,getOutcomesWithLabels:l,isOutcome:g,getOutcomeParent:E,getOutcomeCount:m,registerOutcome:h,unregisterOutcome:i,setOutcomeTransition:r,clearOutcomeTransition:d,addOutcomeToPolicy:a,updateOutcomeLabel:D,resetMappings:z}}function Ye(n,t){const{edgeToTransitionRef:e,transitionToEdgesRef:s}=t,o=c.useCallback(m=>e.current.get(m),[e]),u=c.useCallback(m=>s.current.get(m),[s]),f=c.useCallback(m=>{const h=s.current.get(m);return h!==void 0&&h.size>0},[s]),S=c.useCallback((m,h)=>{if(!n.current)return;const r=n.current.getOutgoingTransitions(m).find(d=>d.targetDefId===h);return r==null?void 0:r.id},[n]),b=c.useCallback((m,h)=>{e.current.set(m,h);let i=s.current.get(h);i||(i=new Set,s.current.set(h,i)),i.add(m)},[e,s]),l=c.useCallback((m,h,i)=>{const r=St({sourceDefId:h,targetDefId:i});return n.current.addTransition(r),e.current.set(m,r.id),s.current.set(r.id,new Set([m])),r.id},[n,e,s]),g=c.useCallback(m=>{const h=e.current.get(m);if(!h)return{transitionDeleted:!1};e.current.delete(m);const i=s.current.get(h);return i==null||i.delete(m),!i||i.size===0?(s.current.delete(h),n.current.removeTransition(h),{transitionDeleted:!0,transitionId:h}):{transitionDeleted:!1,transitionId:h}},[n,e,s]),E=c.useCallback((m,h,i,r)=>{if((r==null?void 0:r.allowReuseExisting)??!0){const a=S(h,i);if(a)return b(m,a),a}return l(m,h,i)},[S,b,l]);return{getTransitionForEdge:o,getEdgesForTransition:u,hasEdgesForTransition:f,findExistingTransition:S,linkEdgeToTransition:b,linkEdgeToNewTransition:l,unlinkEdgeFromTransition:g,getOrCreateTransitionAndLink:E}}function Je(n,t){const e=c.useCallback(b=>{var g;const l=(g=t.current)==null?void 0:g.get(b);return l?Array.from(l):[]},[t]),s=c.useCallback(b=>{var l,g;return((g=(l=n.current)==null?void 0:l.getNode(b))==null?void 0:g.kind)==="command"},[n]),o=c.useCallback((b,l)=>{const g=e(b);if(g.length===0)return 0;const E=new Set(g);let m=0;for(const h of l)E.has(h.source)&&m++;return m},[e]),u=c.useCallback((b,l,g)=>{let E=o(b,l);return E+=(g==null?void 0:g.pendingAdd)??0,Ne(E)},[o]),f=c.useCallback((b,l,g)=>{const E=e(b);if(E.length===0)return l;const m=new Set(E);let h=0;for(const r of l)m.has(r.source)&&h++;h+=(g==null?void 0:g.pendingAdd)??0;const i=Ne(h);return l.map(r=>{var d;return!m.has(r.source)||r.type===i?r:{...r,type:i,data:{...r.data,...i==="commandEdge"&&!((d=r.data)!=null&&d.label)?ve():{}}}})},[e]),S=c.useCallback((b,l,g,E)=>{const m=new Map;for(const h of b){const i=g.get(h.source);if(!i)continue;const r=l.getNode(i);(r==null?void 0:r.kind)==="command"&&m.set(i,(m.get(i)??0)+1)}return b.map(h=>{var D;const i=g.get(h.source);if(!i)return h;const r=l.getNode(i);if((r==null?void 0:r.kind)!=="command")return h;const d=m.get(i)??0,a=Ne(d);return h.type===a?h:{...h,type:a,data:{...h.data,...a==="commandEdge"&&!((D=h.data)!=null&&D.label)?ve():{}}}})},[]);return{countCommandEdges:o,resolveEdgeType:u,normalizeCommandEdges:f,normalizeAllCommandEdges:S,isCommandDefinition:s,getCommandInstanceIds:e}}const ze=["hotspot","note","actor"];function Wt(n){const{edges:t,setNodes:e,setEdges:s,onNodesChangeInternal:o,onEdgesChangeInternal:u,graphRef:f,getNode:S,nodesRef:b,instanceToDefRef:l,defToInstancesRef:g,edgeToTransitionRef:E,transitionToEdgesRef:m,outcomeManagement:h,edgeTransitionManager:i,commandEdgeResolver:r}=n,{isOutcome:d,unregisterOutcome:a,getOutcomesForPolicy:D,setOutcomeTransition:z,clearOutcomeTransition:x,outcomeToParentRef:p,policyToOutcomesRef:I}=h,B=c.useCallback(w=>{const T=l.current.get(w);if(!T)return;const N=D(w);for(const O of N)a(O);l.current.delete(w);const R=g.current.get(T);if(R==null||R.delete(w),!R||R.size===0){g.current.delete(T),f.current.removeNode(T);for(const[O,M]of E.current)f.current.getTransition(M)||(E.current.delete(O),m.current.delete(M))}},[f,l,g,E,m,D,a]),L=c.useCallback(w=>{i.unlinkEdgeFromTransition(w)},[i]),C=c.useCallback(w=>{const T=new Set;for(const y of w)if(y.type==="remove"){const F=I.current.get(y.id);if(F)for(const $ of F)T.add($)}const N=Pt(w,p.current,I.current,T);for(const y of T)N.some(F=>F.type==="remove"&&F.id===y)||N.push({type:"remove",id:y});const R=N.map(y=>{var F,$,_,G;if(y.type==="position"&&y.position){const U=p.current.get(y.id);if(U){const q=S(y.id),Z=S(U),W=fe(y.position.x,y.position.y,((F=Z==null?void 0:Z.measured)==null?void 0:F.width)??oe,(($=Z==null?void 0:Z.measured)==null?void 0:$.height)??Be,((_=q==null?void 0:q.measured)==null?void 0:_.width)??Ue,((G=q==null?void 0:q.measured)==null?void 0:G.height)??he);return{...y,position:W}}}return y}),O=new Set;for(const y of R)y.type==="remove"&&O.add(y.id);const M=new Set;for(const y of t)(O.has(y.source)||O.has(y.target))&&M.add(y.id);for(const y of M)L(y);M.size>0&&s(y=>y.filter(F=>!M.has(F.id)));for(const y of R)y.type==="remove"&&B(y.id);o(R)},[o,B,L,S,t,s,I,p]),P=c.useCallback(w=>{const T=$t(w,t,p.current,I.current),N=new Set,R=new Set;for(const O of T)if(O.type==="remove"){const M=t.find(y=>y.id===O.id);if(M){const y=M.source,F=M.target,$=l.current.get(y);if($){const _=f.current.getNode($);if((_==null?void 0:_.kind)==="command"){N.add($);const G=l.current.get(F);if(G){const U=f.current.getNode(G);(U==null?void 0:U.kind)==="event"&&R.add(F)}}}}L(O.id)}u(T),N.size>0&&s(O=>{let M=O;for(const y of N)M=r.normalizeCommandEdges(y,M);return M}),R.size>0&&e(O=>O.map(M=>R.has(M.id)?t.some(F=>{if(F.target!==M.id||T.some(U=>U.type==="remove"&&U.id===F.id))return!1;const _=l.current.get(F.source);if(!_)return!1;const G=f.current.getNode(_);return(G==null?void 0:G.kind)==="command"})?M:{...M,data:{...M.data,hasCommandParent:!1}}:M))},[u,L,t,s,e,r,f,l,p,I]),k=c.useCallback(w=>{if(!w.source||!w.target)return!1;const T=w.source,N=w.target;if(T===N)return!1;const R=d(T),O=b.current.find($=>$.id===T),M=It(O==null?void 0:O.type,R),y=b.current.find($=>$.id===N),F=y==null?void 0:y.type;return!(!M||!F||ze.includes(M)||ze.includes(F))},[d,b]),v=c.useCallback(w=>{if(!w.source||!w.target)return;const T=w.source,N=w.target,R=`edge_${T}_${N}`;if(E.current.has(R))return;const O=d(T);let M;if(O){const W=T,j=p.current.get(W);M=l.current.get(j)}else M=l.current.get(T);const y=l.current.get(N);if(!M||!y)return;const F=i.findExistingTransition(M,y);if(F&&!O&&i.hasEdgesForTransition(F))return;const $=O?i.linkEdgeToNewTransition(R,M,y):i.getOrCreateTransitionAndLink(R,M,y);O&&z(T,$);const _=f.current.getNode(M),G=f.current.getNode(y),U=(_==null?void 0:_.kind)==="command",q=O?"policy":_==null?void 0:_.kind,Z=ye(q,G==null?void 0:G.kind);U?(s(W=>{const j=r.resolveEdgeType(M,W,{pendingAdd:1}),ee=Me({...w,id:R,type:j,data:{state:"idle",transitionId:$,...Z,...j==="commandEdge"?ve():{}}},W);return r.normalizeCommandEdges(M,ee)}),(G==null?void 0:G.kind)==="event"&&e(W=>W.map(j=>j.id===N?{...j,data:{...j.data,hasCommandParent:!0}}:j))):s(W=>Me({...w,id:R,type:"floating",data:{state:"idle",transitionId:$,...Z}},W))},[s,e,i,r,f,l,E,p,d,z]),A=c.useCallback((w,T)=>{if(!T.source||!T.target)return;const N=w.id,R=T.source,O=T.target,M=`edge_${R}_${O}`,y=N!==M;if(t.some(V=>V.id!==N&&V.id!==M&&V.source===R&&V.target===O)||y&&E.current.has(M))return;const $=d(R);let _;if($){const V=R,ie=p.current.get(V);_=l.current.get(ie)}else _=l.current.get(R);const G=l.current.get(O);if(!_||!G)return;const U=E.current.get(N),q=U?f.current.getTransition(U):void 0,Z=!q||q.sourceDefId!==_||q.targetDefId!==G;let W;const j=w.source,ee=p.current.has(j);if(Z){U&&(i.unlinkEdgeFromTransition(N),ee&&x(j));const V=i.findExistingTransition(_,G);if(V&&!$&&i.hasEdgesForTransition(V))return;W=$?i.linkEdgeToNewTransition(M,_,G):i.getOrCreateTransitionAndLink(M,_,G),$&&z(R,W)}else{if(W=U,y){E.current.delete(N),E.current.set(M,W);const V=m.current.get(W);V&&(V.delete(N),V.add(M))}ee&&j!==R&&x(j),$&&z(R,W)}const K=f.current.getNode(_),se=f.current.getNode(G),re=(K==null?void 0:K.kind)==="command",pe=re?"commandEdge":"floating",Te=$?"policy":K==null?void 0:K.kind,Ee=ye(Te,se==null?void 0:se.kind);s(V=>mt(w,T,V).map(X=>{var ae;return X.source===T.source&&X.target===T.target?{...X,id:M,type:pe,data:{...X.data,...Z?{state:"idle",progress:0}:{},transitionId:W,...Ee,...re&&!((ae=X.data)!=null&&ae.label)?{label:"Path",labelOffset:.5}:{}}}:X}))},[t,s,i,f,l,E,m,p,d,z,x]);return{onNodesChange:C,onEdgesChange:P,onConnect:v,onReconnect:A,isValidConnection:k}}function Fe(n,t,e,s,o){return{id:n,type:"outcome",position:o,parentId:e,data:{label:t,parentPolicyInstanceId:e,parentPolicyDefId:s}}}function Bt(n){const{edges:t,setNodes:e,setEdges:s,graphRef:o,getNode:u,instanceMapping:f,outcomeManagement:S,edgeTransitionManager:b}=n,{instanceToDefRef:l,defToInstancesRef:g,edgeToTransitionRef:E,transitionToEdgesRef:m}=f,{outcomeToParentRef:h,policyToOutcomesRef:i,getOutcomesForPolicy:r,registerOutcome:d,unregisterOutcome:a}=S,D=c.useCallback(C=>{const P=l.current.get(C);if(!P)return;const k=r(C);for(const A of k)a(A);l.current.delete(C);const v=g.current.get(P);if(v==null||v.delete(C),!v||v.size===0){g.current.delete(P),o.current.removeNode(P);for(const[A,w]of E.current)o.current.getTransition(w)||(E.current.delete(A),m.current.delete(w))}},[o,l,g,E,m,r,a]),z=c.useCallback((C,P,k)=>{let v,A="event";if(C==="event"){const T=xe({label:k||"Event"});o.current.addNode(T);const N=de();l.current.set(N,T.id),g.current.set(T.id,new Set([N]));const R={id:N,type:"event",position:P,data:{label:T.label,executionMode:T.executionMode,definitionId:T.id}};return e(O=>[...O,R]),N}if(C==="trigger"){const T=vt({label:k||"Trigger"});o.current.addNode(T);const N=de();l.current.set(N,T.id),g.current.set(T.id,new Set([N]));const R={id:N,type:"trigger",position:P,data:{label:T.label,definitionId:T.id}};return e(O=>[...O,R]),N}C==="policy"?(v=Re({label:k||"Policy"}),A="policy"):C==="externalSystem"?(v=De({label:k||"External System"}),A="externalSystem"):C==="externalEvent"?(v=yt({label:k||"External Event"}),A="externalEvent"):C==="command"?(v=Ie({label:k??"Command"}),A="command"):C==="hotspot"?(v=Oe({label:k||"HotSpot"}),A="hotspot"):C==="note"?(v=Ae({label:k||"Note"}),A="note"):C==="actor"?(v=Pe({label:k||"Actor"}),A="actor"):(v=xe({label:k||"Event"}),A="event"),o.current.addNode(v);const w=de();if(l.current.set(w,v.id),g.current.set(v.id,new Set([w])),C==="policy"){const T={id:w,type:"policy",position:P,data:{label:v.label,executionMode:v.executionMode,definitionId:v.id}},N=be(),R=be(),O=fe(oe+J,0),M=fe(oe+J,he+J),y=Fe(N,"Yes",w,v.id,O),F=Fe(R,"No",w,v.id,M);d(N,w),d(R,w),e($=>[...$,T,y,F])}else{const T={id:w,type:A,position:P,data:{label:v.label,executionMode:v.executionMode,definitionId:v.id}};e(N=>[...N,T])}return w},[o,l,g,e,d]),x=c.useCallback((C,P)=>{const k=o.current.getNode(C);if(!k)throw new Error(`Definition ${C} does not exist`);const v=de();l.current.set(v,C);const A=g.current.get(C)??new Set;A.add(v),g.current.set(C,A);const w={id:v,type:k.kind,position:P,data:{label:k.label,executionMode:k.executionMode,definitionId:C}};return e(T=>[...T,w]),v},[o,l,g,e]),p=c.useCallback(C=>{const P=l.current.get(C);if(!P)return;const k=u(C);if(!k)return;const v={x:k.position.x+50,y:k.position.y+50};return x(P,v)},[l,u,x]),I=c.useCallback(C=>{const P=l.current.get(C);if(!P)return;const k=o.current.getNode(P);if(!k)return;const v=g.current.get(P);if(!v||v.size<=1)return;let A;k.kind==="event"?A=xe({label:k.label}):k.kind==="policy"?A=Re({label:k.label}):k.kind==="command"?A=Ie({label:k.label}):k.kind==="hotspot"?A=Oe({label:k.label}):k.kind==="note"?A=Ae({label:k.label}):k.kind==="actor"?A=Pe({label:k.label}):A=De({label:k.label}),o.current.addNode(A),l.current.set(C,A.id),v.delete(C),g.current.set(A.id,new Set([C]));const w=t.filter(T=>T.source===C||T.target===C);for(const T of w){const N=T.source===C,R=N?T.target:T.source;if(h.current.has(R))continue;const O=l.current.get(R);if(!O||O===P)continue;const M=N?A.id:O,y=N?O:A.id;b.getOrCreateTransitionAndLink(T.id,M,y)}e(T=>T.map(N=>N.id===C?{...N,data:{...N.data,definitionId:A.id}}:N)),s(T=>T.map(N=>{if(N.source===C||N.target===C){const R=E.current.get(N.id);if(R)return{...N,data:{...N.data,transitionId:R}}}return N}))},[o,l,g,h,E,t,e,s,b]),B=c.useCallback(C=>{const P=i.current.get(C),k=new Set([C]);if(P)for(const v of P)k.add(v);D(C),e(v=>v.filter(A=>!k.has(A.id)))},[i,D,e]),L=c.useCallback(C=>{const P=g.current.get(C);if(!P)return;const k=new Set(P);for(const v of k)l.current.delete(v);g.current.delete(C),o.current.removeNode(C),e(v=>v.filter(A=>!k.has(A.id)))},[o,l,g,e]);return{addNode:z,addInstance:x,duplicateInstance:p,dissociateInstance:I,deleteInstance:B,deleteDefinition:L,handleInstanceDeletion:D}}function Ut(n){const{setNodes:t,graphRef:e,instanceMapping:s}=n,{defToInstancesRef:o,getDefinitionForInstance:u,getInstancesForDefinition:f,isOriginalInstance:S}=s,b=c.useCallback(d=>f(d),[f]),l=c.useCallback((d,a)=>{e.current.updateNode(d,{executionMode:a});const D=o.current.get(d);D&&t(z=>z.map(x=>D.has(x.id)?{...x,data:{...x.data,executionMode:a}}:x))},[e,o,t]),g=c.useCallback((d,a)=>{const D=e.current.getNode(d);if(!D)return;e.current.updateNode(d,{label:a});const z=D.config;if(D.kind==="command"||D.kind==="trigger"||D.kind==="externalSystem"||D.kind==="externalEvent"){const p=ne(a);if(p){const I=z;if((I==null?void 0:I.slugName)!==p){const L={...I,slugName:p};e.current.updateNode(d,{config:L})}}}else if(D.kind==="event"){const p=ke(a);if(p){const I=z;if((I==null?void 0:I.type)!==p){const L={...I,type:p};e.current.updateNode(d,{config:L})}}}const x=o.current.get(d);x&&t(p=>p.map(I=>x.has(I.id)?{...I,data:{...I.data,label:a}}:I))},[e,o,t]),E=c.useCallback((d,a)=>{e.current.updateNode(d,{config:a})},[e]),m=c.useCallback((d,a)=>{e.current.updateNode(d,{awsExtension:a})},[e]),h=c.useCallback(d=>{var a;return(a=e.current.getNode(d))==null?void 0:a.config},[e]),i=c.useCallback(d=>{var a;return(a=e.current.getNode(d))==null?void 0:a.awsExtension},[e]),r=c.useCallback((d,a)=>{var I;const D=e.current.getNode(d);if(!D||D.kind!=="command"&&D.kind!=="trigger"||D.kind===a)return;const z=a==="trigger"?"manual":"automatic";e.current.updateNode(d,{kind:a,executionMode:z}),a==="command"&&e.current.recalculateExecutionMode(d);const x=o.current.get(d);if(!x)return;const p=(I=e.current.getNode(d))==null?void 0:I.executionMode;t(B=>B.map(L=>x.has(L.id)?{...L,type:a,data:{...L.data,executionMode:p}}:L))},[e,o,t]);return{getDefinitionForInstance:u,getInstancesForDefinition:b,isOriginalInstance:S,updateNodeExecutionMode:l,updateNodeLabel:g,updateNodeConfig:E,updateNodeAwsExtension:m,getNodeConfig:h,getNodeAwsExtension:i,convertNodeKind:r}}function Vt(n){const{edges:t,setNodes:e,setEdges:s,outcomeManagement:o,edgeTransitionManager:u}=n,{outcomeToParentRef:f,policyToOutcomesRef:S,outcomeToTransitionRef:b,getOutcomeTransition:l,getOutcomesForPolicy:g,getOutcomesWithLabels:E,addOutcomeToPolicy:m,updateOutcomeLabel:h}=o,i=c.useMemo(()=>({cleanupEdgesFromSource:d=>{const a=t.filter(D=>D.source===d).map(D=>D.id);for(const D of a)u.unlinkEdgeFromTransition(D);return a}}),[t,u]),r=c.useCallback(d=>_t(d,f.current,S.current,b.current,i,e,s),[f,S,b,i,e,s]);return{getOutcomeTransition:l,getOutcomesForPolicy:g,getOutcomesWithLabels:E,addOutcomeToPolicy:m,deleteOutcome:r,updateOutcomeLabel:h}}const le=16;function jt(n){const{nodes:t,edges:e,setNodes:s,setEdges:o,graphRef:u,instanceMapping:f,outcomeManagement:S,commandEdgeResolver:b,incrementGraphVersion:l}=n,{instanceToDefRef:g,defToInstancesRef:E,edgeToTransitionRef:m,transitionToEdgesRef:h}=f,{outcomeToParentRef:i,policyToOutcomesRef:r,outcomeToTransitionRef:d,resetMappings:a}=S,D=c.useCallback(()=>{u.current=new ge,f.resetMappings(),a(),s([]),o([]),l()},[u,s,o,f,a,l]),z=c.useCallback(()=>({graph:u.current,nodes:t,edges:e,mappings:{instanceToDefRef:new Map(g.current),defToInstancesRef:new Map(Array.from(E.current.entries()).map(([p,I])=>[p,new Set(I)])),edgeToTransitionRef:new Map(m.current),transitionToEdgesRef:new Map(Array.from(h.current.entries()).map(([p,I])=>[p,new Set(I)])),outcomeToParentRef:new Map(i.current),policyToOutcomesRef:new Map(Array.from(r.current.entries()).map(([p,I])=>[p,new Set(I)])),outcomeToTransitionRef:new Map(d.current)}}),[t,e,u,g,E,m,h,i,r,d]),x=c.useCallback(p=>{u.current=p.graph,g.current=p.mappings.instanceToDefRef,E.current=p.mappings.defToInstancesRef,m.current=p.mappings.edgeToTransitionRef,h.current=p.mappings.transitionToEdgesRef,i.current=p.mappings.outcomeToParentRef??new Map,r.current=p.mappings.policyToOutcomesRef??new Map,d.current=p.mappings.outcomeToTransitionRef??new Map;const I=p.nodes.map(C=>({...C,position:{x:Math.round(C.position.x/le)*le,y:Math.round(C.position.y/le)*le}})),L=b.normalizeAllCommandEdges(p.edges,p.graph,p.mappings.instanceToDefRef,p.mappings.defToInstancesRef).map(C=>Ot(C,p.graph,p.mappings.instanceToDefRef,p.mappings.outcomeToParentRef??new Map));s(I),o(L),l()},[u,g,E,m,h,i,r,d,s,o,b,l]);return{reset:D,getWorkflowState:z,hydrateWorkflow:x}}const qt=[],Zt=[];function Yt(n){const t=c.useRef(new ge),[e,s]=c.useState(0),o=We(),[u,f,S]=_e(qt),[b,l,g]=Le(Zt),E=c.useRef([]);E.current=u;const{getNode:m,getNodes:h}=Ge(),i=Ye(t,{edgeToTransitionRef:o.edgeToTransitionRef,transitionToEdgesRef:o.transitionToEdgesRef}),r=Je(t,o.defToInstancesRef),d=Ze({instanceToDefRef:o.instanceToDefRef,setNodes:f,getNodes:h}),a=(n==null?void 0:n.graphRef)??t,D=n?n.incrementGraphVersion:()=>s(ce=>ce+1),z=(n==null?void 0:n.nodes)??u,x=(n==null?void 0:n.edges)??b,p=(n==null?void 0:n.setNodes)??f,I=(n==null?void 0:n.setEdges)??l,B=(n==null?void 0:n.onNodesChangeInternal)??S,L=(n==null?void 0:n.onEdgesChangeInternal)??g,C=(n==null?void 0:n.nodesRef)??E,P=(n==null?void 0:n.instanceMapping)??o,{instanceToDefRef:k,defToInstancesRef:v,edgeToTransitionRef:A,transitionToEdgesRef:w}=P,T=(n==null?void 0:n.edgeTransitionManager)??i,N=(n==null?void 0:n.commandEdgeResolver)??r,R=(n==null?void 0:n.outcomeManagement)??d,O=c.useMemo(()=>x.map(ce=>({...ce,reconnectable:ce.selected??!1})),[x]),{outcomeToParentRef:M,policyToOutcomesRef:y,outcomeToTransitionRef:F}=R,$={nodes:z,edges:x,setNodes:p,setEdges:I,onNodesChangeInternal:B,onEdgesChangeInternal:L,graphRef:a,graph:a.current,getNode:m,nodesRef:C,instanceMapping:P,instanceToDefRef:k,defToInstancesRef:v,edgeToTransitionRef:A,transitionToEdgesRef:w,outcomeManagement:R,edgeTransitionManager:T,commandEdgeResolver:N,incrementGraphVersion:D},{onNodesChange:_,onEdgesChange:G,onConnect:U,onReconnect:q,isValidConnection:Z}=Wt($),{addNode:W,addInstance:j,duplicateInstance:ee,dissociateInstance:K,deleteInstance:se,deleteDefinition:re}=Bt($),{getDefinitionForInstance:pe,getInstancesForDefinition:Te,isOriginalInstance:Ee,updateNodeExecutionMode:V,updateNodeLabel:ie,updateNodeConfig:X,updateNodeAwsExtension:ae,getNodeConfig:Ke,getNodeAwsExtension:Xe,convertNodeKind:et}=Ut($),{getOutcomeTransition:tt,getOutcomesForPolicy:nt,getOutcomesWithLabels:st,addOutcomeToPolicy:ot,deleteOutcome:rt,updateOutcomeLabel:it}=Vt($),{reset:at,getWorkflowState:ct,hydrateWorkflow:ut}=jt($),dt=c.useMemo(()=>t.current,[e]),lt=(n==null?void 0:n.graph)??dt;return{nodes:z,edges:O,graph:lt,onNodesChange:_,onEdgesChange:G,onConnect:U,isValidConnection:Z,onReconnect:q,addNode:W,addInstance:j,duplicateInstance:ee,dissociateInstance:K,deleteInstance:se,deleteDefinition:re,getDefinitionForInstance:pe,getInstancesForDefinition:Te,isOriginalInstance:Ee,updateNodeExecutionMode:V,updateNodeLabel:ie,updateNodeConfig:X,updateNodeAwsExtension:ae,getNodeConfig:Ke,getNodeAwsExtension:Xe,convertNodeKind:et,reset:at,getWorkflowState:ct,hydrateWorkflow:ut,getOutcomeTransition:tt,getOutcomesForPolicy:nt,getOutcomesWithLabels:st,addOutcomeToPolicy:ot,deleteOutcome:rt,updateOutcomeLabel:it}}const Jt=[],Qt=[];function Ht(){const n=c.useRef(new ge),[t,e]=c.useState(0),s=We(),{instanceToDefRef:o,defToInstancesRef:u,edgeToTransitionRef:f,transitionToEdgesRef:S}=s,[b,l,g]=_e(Jt),[E,m,h]=Le(Qt),i=c.useRef([]);i.current=b;const r=c.useMemo(()=>E.map(v=>({...v,reconnectable:v.selected??!1})),[E]),{getNode:d,getNodes:a}=Ge(),D=Ye(n,{edgeToTransitionRef:f,transitionToEdgesRef:S}),z=Je(n,u),x=Ze({instanceToDefRef:o,setNodes:l,getNodes:a}),{outcomeToParentRef:p,policyToOutcomesRef:I,outcomeToTransitionRef:B,resetMappings:L}=x,C=c.useCallback(()=>{e(v=>v+1)},[]),P=c.useCallback(()=>{n.current=new ge,s.resetMappings(),L(),l([]),m([]),e(v=>v+1)},[l,m,s,L]),k=c.useMemo(()=>n.current,[t]);return{nodes:b,edges:E,edgesWithReconnectable:r,setNodes:l,setEdges:m,onNodesChangeInternal:g,onEdgesChangeInternal:h,graphRef:n,graph:k,getNode:d,getNodes:a,nodesRef:i,instanceMapping:s,instanceToDefRef:o,defToInstancesRef:u,edgeToTransitionRef:f,transitionToEdgesRef:S,outcomeManagement:x,outcomeToParentRef:p,policyToOutcomesRef:I,outcomeToTransitionRef:B,edgeTransitionManager:D,commandEdgeResolver:z,incrementGraphVersion:C,reset:P}}const Qe=c.createContext(null);function Kt({children:n}){const t=Ht();return te.jsx(Qe.Provider,{value:t,children:n})}function Xt(){const n=c.useContext(Qe);if(!n)throw new Error("useWorkflowCoreContext must be used within a WorkflowCoreProvider");return n}const He=c.createContext(null);function en({children:n}){const t=Xt(),e=Yt(t);return te.jsx(He.Provider,{value:e,children:n})}function yn({children:n}){return te.jsx(Kt,{children:te.jsx(en,{children:n})})}function tn(){const n=c.useContext(He);if(!n)throw new Error("useWorkflow must be used within a WorkflowProvider");return n}function nn(n){const t=c.useRef(null),[e,s]=c.useState(null),[o,u]=c.useState([]),[f,S]=c.useState(!1);c.useEffect(()=>{const i=new wt(n,{transitionDelay:1e3});t.current=i;const r=(a,D)=>{const z={id:`${Date.now()}-${Math.random()}`,type:a,timestamp:D.timestamp,data:D};u(x=>[...x,z]),s(i.getState())},d=[i.on("simulation:start",a=>{r("simulation:start",a),S(!0)}),i.on("simulation:stop",a=>{r("simulation:stop",a),S(!1)}),i.on("simulation:reset",a=>{r("simulation:reset",a),S(!1)}),i.on("node:enter",a=>r("node:enter",a)),i.on("node:active",a=>r("node:active",a)),i.on("node:waiting",a=>r("node:waiting",a)),i.on("node:exit",a=>r("node:exit",a)),i.on("node:complete",a=>r("node:complete",a)),i.on("node:reset",a=>r("node:reset",a)),i.on("transition:start",a=>r("transition:start",a)),i.on("transition:complete",a=>r("transition:complete",a)),i.on("transition:reset",a=>r("transition:reset",a)),i.on("error",a=>r("error",a)),i.on("state:initialized",()=>{s(i.getState())})];return queueMicrotask(()=>{s(i.getState())}),()=>{d.forEach(a=>a()),i.stop(),t.current=null}},[n]);const b=c.useCallback(()=>{var i;(i=t.current)==null||i.start()},[]),l=c.useCallback(()=>{var i;(i=t.current)==null||i.stop()},[]),g=c.useCallback(()=>{var i;(i=t.current)==null||i.reset(),u([])},[]),E=c.useCallback(i=>{var r;(r=t.current)==null||r.triggerNode(i)},[]),m=c.useCallback(i=>{var r;(r=t.current)==null||r.selectTransition(i)},[]),h=c.useCallback(i=>{var r;(r=t.current)==null||r.completeManualNode(i)},[]);return{isRunning:f,state:e,events:o,start:b,stop:l,reset:g,triggerNode:E,selectTransition:m,completeManualNode:h}}const sn=c.createContext(null);function Sn({children:n}){const{graph:t}=tn(),e=nn(t);return te.jsx(sn.Provider,{value:e,children:n})}const on=c.createContext(null);function kn({children:n}){const[t,e]=c.useState(null),[s,o]=c.useState(null),u=c.useCallback(b=>{e(b)},[]),f=c.useCallback(()=>{e(null)},[]),S={pendingTooltip:t,hoveredWarningEdgeId:s,showTooltip:u,hideTooltip:f,setHoveredWarningEdgeId:o};return te.jsx(on.Provider,{value:S,children:n})}function Mn(){const n=Ce(s=>s.theme),t=Ce(s=>s.setTheme),e=Ce(s=>s.toggleTheme);return{theme:n,setTheme:t,toggleTheme:e}}export{qe as A,zt as B,nn as C,Nn as D,sn as E,on as F,bn as G,ye as H,ve as I,vn as J,ne as K,ge as L,dn as M,kn as N,he as O,ln as P,En as Q,ke as R,gn as S,mn as T,Tn as U,$e as V,yn as W,fn as X,Xt as a,be as b,Cn as c,bt as d,H as e,tn as f,de as g,pn as h,hn as i,Sn as j,Pt as k,fe as l,Ue as m,Be as n,oe as o,$t as p,Ft as q,Ve as r,Q as s,Rt as t,Mn as u,je as v,xn as w,Lt as x,_t as y,Gt as z};
