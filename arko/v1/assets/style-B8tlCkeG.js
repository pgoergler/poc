var Bt=Object.defineProperty;var Vt=(n,e,t)=>e in n?Bt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var te=(n,e,t)=>Vt(n,typeof e!="symbol"?e+"":e,t);import{c as ae,I as je,u as xe,d as Ae,J as Gt,A as Ht,x as Ut,y as qt,z as Yt,B as Kt,E as Qt,F as Jt,G as Zt,a as q,T as en,P as tn}from"./Toast-CVFMnbvX.js";import{P as R,b as a,l as He,m as nn,h as it,k as ct,u as Te,j as g,H as D,n as on,o as sn,c as rn,N as an,d as cn,p as lt,q as dt,E as ln}from"./react-flow-BRmdaK4b.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dn=[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]],un=ae("clipboard-list",dn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fn=[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]],Ue=ae("cloud",fn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gn=[["path",{d:"M12 3q1 4 4 6.5t3 5.5a1 1 0 0 1-14 0 5 5 0 0 1 1-3 1 1 0 0 0 5 0c0-2-1.5-3-1.5-5q0-2 2.5-4",key:"1slcih"}]],hs=ae("flame",gn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mn=[["path",{d:"M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401",key:"kfwtm"}]],ps=ae("moon",mn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hn=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],Ge=ae("play",hn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pn=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],xs=ae("refresh-cw",pn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xn=[["path",{d:"M12 3v18",key:"108xh3"}],["path",{d:"m19 8 3 8a5 5 0 0 1-6 0zV7",key:"zcdpyk"}],["path",{d:"M3 7h1a17 17 0 0 0 8-2 17 17 0 0 0 8 2h1",key:"1yorad"}],["path",{d:"m5 8 3 8a5 5 0 0 1-6 0zV7",key:"eua70x"}],["path",{d:"M7 21h10",key:"1b0cd5"}]],bs=ae("scale",xn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bn=[["path",{d:"M21 9a2.4 2.4 0 0 0-.706-1.706l-3.588-3.588A2.4 2.4 0 0 0 15 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z",key:"1dfntj"}],["path",{d:"M15 3v5a1 1 0 0 0 1 1h5",key:"6s6qgf"}]],Es=ae("sticky-note",bn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const En=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],ys=ae("sun",En);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yn=[["path",{d:"M12 19h8",key:"baeox8"}],["path",{d:"m4 17 6-6-6-6",key:"1yngyt"}]],wn=ae("terminal",yn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vn=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],ws=ae("user",vn);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tn=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],ut=ae("zap",Tn);function fe(n){switch(n){case"trigger":case"externalSystem":case"externalEvent":case"hotspot":case"note":case"actor":return"manual";case"event":case"policy":case"command":default:return"automatic"}}function Nn(n,e){if(n!=="command"&&n!=="policy")throw new Error(`calculateDynamicExecutionMode called with non-dynamic kind: ${n}`);return e<=1?"automatic":"manual"}function kn(n){return n.executionMode==="manual"}function Cn(n,e){return n.executionMode==="manual"?!1:e>0}class we{constructor(){te(this,"nodes",new Map);te(this,"transitions",new Map);te(this,"outgoingEdges",new Map);te(this,"incomingEdges",new Map)}addNode(e){if(this.nodes.has(e.id))throw new Error(`Node with id ${e.id} already exists`);this.nodes.set(e.id,e),this.outgoingEdges.set(e.id,new Set),this.incomingEdges.set(e.id,new Set)}getNode(e){return this.nodes.get(e)}hasNode(e){return this.nodes.has(e)}getAllNodes(){return Array.from(this.nodes.values())}updateNode(e,t){const o=this.nodes.get(e);if(!o)return;const s={...o,...t};return this.nodes.set(e,s),s}removeNode(e){if(!this.nodes.has(e))return!1;const t=this.outgoingEdges.get(e)??new Set,o=this.incomingEdges.get(e)??new Set;for(const s of t)this.removeTransition(s);for(const s of o)this.removeTransition(s);return this.nodes.delete(e),this.outgoingEdges.delete(e),this.incomingEdges.delete(e),!0}addTransition(e){if(this.transitions.has(e.id))throw new Error(`Transition with id ${e.id} already exists`);if(!this.nodes.has(e.sourceDefId))throw new Error(`Source node ${e.sourceDefId} does not exist`);if(!this.nodes.has(e.targetDefId))throw new Error(`Target node ${e.targetDefId} does not exist`);this.transitions.set(e.id,e),this.outgoingEdges.get(e.sourceDefId).add(e.id),this.incomingEdges.get(e.targetDefId).add(e.id),this.recalculateExecutionMode(e.sourceDefId)}getTransition(e){return this.transitions.get(e)}getAllTransitions(){return Array.from(this.transitions.values())}removeTransition(e){var s,r;const t=this.transitions.get(e);if(!t)return!1;const o=t.sourceDefId;return(s=this.outgoingEdges.get(t.sourceDefId))==null||s.delete(e),(r=this.incomingEdges.get(t.targetDefId))==null||r.delete(e),this.transitions.delete(e),this.recalculateExecutionMode(o),!0}getOutgoingTransitions(e){const t=this.outgoingEdges.get(e);return t?Array.from(t).map(o=>this.transitions.get(o)).filter(Boolean):[]}getIncomingTransitions(e){const t=this.incomingEdges.get(e);return t?Array.from(t).map(o=>this.transitions.get(o)).filter(Boolean):[]}getSuccessors(e){return this.getOutgoingTransitions(e).map(t=>this.nodes.get(t.targetDefId)).filter(Boolean)}getPredecessors(e){return this.getIncomingTransitions(e).map(t=>this.nodes.get(t.sourceDefId)).filter(Boolean)}get nodeCount(){return this.nodes.size}get transitionCount(){return this.transitions.size}getEntryNodes(){return this.getAllNodes().filter(e=>{var t;return(((t=this.incomingEdges.get(e.id))==null?void 0:t.size)??0)===0})}getTerminalNodes(){return this.getAllNodes().filter(e=>{var t;return(((t=this.outgoingEdges.get(e.id))==null?void 0:t.size)??0)===0})}recalculateExecutionMode(e){var r;const t=this.nodes.get(e);if(!t||t.kind!=="command"&&t.kind!=="policy")return;const o=((r=this.outgoingEdges.get(e))==null?void 0:r.size)??0,s=Nn(t.kind,o);t.executionMode!==s&&this.nodes.set(e,{...t,executionMode:s})}requiresUserAction(e){const t=this.nodes.get(e);return t?kn(t):!1}canAutoTraverse(e){var s;const t=this.nodes.get(e);if(!t)return!1;const o=((s=this.outgoingEdges.get(e))==null?void 0:s.size)??0;return Cn(t,o)}getReachableNodes(e){const t=[],o=new Set,s=[];for(const r of this.getSuccessors(e))o.has(r.id)||(o.add(r.id),s.push(r.id),t.push(r));for(;s.length>0;){const r=s.shift();for(const c of this.getSuccessors(r))o.has(c.id)||(o.add(c.id),s.push(c.id),t.push(c))}return t}getReachableTransitions(e){const t=[],o=new Set;for(const s of this.getOutgoingTransitions(e))o.has(s.id)||(o.add(s.id),t.push(s));for(const s of this.getReachableNodes(e))for(const r of this.getOutgoingTransitions(s.id))o.has(r.id)||(o.add(r.id),t.push(r));return t}}function ie(n,e=""){return n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]+/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")||e}function Le(n,e=""){return n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().replace(/\s+/g,".").replace(/[^a-z0-9.-]+/g,".").replace(/^[.-]+|[.-]+$/g,"").replace(/\.+/g,".").replace(/-+/g,"-")||e}function vs(n){return n.length<=13?n:`${n.slice(0,5)}...${n.slice(-5)}`}function me(n){return n.replace(/^(def_|trans_|inst_|outcome_)/,"")}function Ts(n,e,t){const o=ie(n);if(o)return o;const s=e.replace(/^def_/,"").toLowerCase();return`${t}-${s.slice(0,8)}`}function Ns(n,e){const t=Le(n);return t||`event.${e.replace(/^def_/,"").toLowerCase().slice(0,8)}`}function _n(n){const e=n.match(/\{([^}]+)\}/g);return e?e.map(t=>t.slice(1,-1)):[]}function Mn(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}function qe(n,e,t,o){switch(t){case R.Top:return{x:n,y:e-o};case R.Bottom:return{x:n,y:e+o};case R.Left:return{x:n-o,y:e};case R.Right:return{x:n+o,y:e};default:return{x:n,y:e}}}function In(n,e,t,o,s=100){const r=t-n,c=o-e,l=Math.sqrt(r*r+c*c);return Math.min(s,l/2)}function ft(n,e,t,o,s,r){const c=In(n,e,t,o),l=qe(n,e,s,c),h=qe(t,o,r,c);return`M${n},${e} C${l.x},${l.y} ${h.x},${h.y} ${t},${o}`}function ge(){return`def_${je()}`}function Sn(){return`trans_${je()}`}function Ce(){return`inst_${je()}`}function Be(){return`outcome_${je()}`}function $e(n){const e=Le(n.label);return{id:ge(),label:n.label,kind:"event",category:"business",executionMode:fe("event"),config:e?{type:e}:void 0}}function Ye(n){return{id:ge(),label:n.label,kind:"policy",category:"business",executionMode:fe("policy")}}function An(n){const e=ie(n.label);return{id:ge(),label:n.label,kind:"trigger",category:"business",executionMode:fe("trigger"),config:e?{slugName:e}:void 0}}function Ke(n){const e=ie(n.label);return{id:ge(),label:n.label,kind:"externalSystem",category:"technical",executionMode:fe("externalSystem"),config:e?{slugName:e}:void 0}}function Rn(n){const e=ie(n.label);return{id:ge(),label:n.label,kind:"externalEvent",category:"technical",executionMode:fe("externalEvent"),config:e?{slugName:e}:void 0}}function Qe(n){const e=ie(n.label);return{id:ge(),label:n.label,kind:"command",category:"business",executionMode:fe("command"),config:e?{slugName:e}:void 0}}function Je(n){return{id:ge(),label:n.label,kind:"hotspot",category:"business",executionMode:fe("hotspot")}}function Ze(n){return{id:ge(),label:n.label,kind:"note",category:"business",executionMode:fe("note")}}function et(n){return{id:ge(),label:n.label,kind:"actor",category:"business",executionMode:fe("actor")}}function Pn(n){return{id:Sn(),sourceDefId:n.sourceDefId,targetDefId:n.targetDefId}}const On={transitionDelay:1e3,autoStart:!1};class Dn{constructor(){te(this,"listeners",new Map)}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}off(e,t){var o;(o=this.listeners.get(e))==null||o.delete(t)}emit(e,t){const o=this.listeners.get(e);if(o)for(const s of o)try{s(t)}catch(r){console.error(`Error in event handler for ${String(e)}:`,r)}}once(e,t){const o=s=>{this.off(e,o),t(s)};return this.on(e,o)}removeAllListeners(e){e?this.listeners.delete(e):this.listeners.clear()}listenerCount(e){var t;return((t=this.listeners.get(e))==null?void 0:t.size)??0}}class jn extends Dn{constructor(t,o={}){super();te(this,"graph");te(this,"config");te(this,"running",!1);te(this,"nodeStates",new Map);te(this,"transitionStates",new Map);te(this,"activeNodes",new Set);te(this,"pendingActions",new Set);te(this,"activeTimeouts",new Set);this.graph=t,this.config={...On,...o},this.initializeState()}initializeState(){for(const t of this.graph.getAllNodes())this.nodeStates.set(t.id,"idle");for(const t of this.graph.getAllTransitions())this.transitionStates.set(t.id,"idle")}getState(){return{isRunning:this.running,nodeStates:new Map(this.nodeStates),transitionStates:new Map(this.transitionStates),activeNodes:new Set(this.activeNodes),pendingActions:new Set(this.pendingActions)}}getNodeState(t){return this.nodeStates.get(t)}getTransitionState(t){return this.transitionStates.get(t)}isSimulationRunning(){return this.running}start(){if(!this.running&&(this.running=!0,this.emit("simulation:start",{timestamp:Date.now()}),this.config.autoStart))for(const t of this.graph.getEntryNodes())this.triggerNode(t.id)}stop(){if(this.running){this.running=!1;for(const t of this.activeTimeouts)clearTimeout(t);this.activeTimeouts.clear(),this.emit("simulation:stop",{timestamp:Date.now()})}}reset(){this.stop(),this.nodeStates.clear(),this.transitionStates.clear(),this.activeNodes.clear(),this.pendingActions.clear(),this.initializeState(),this.emit("simulation:reset",{timestamp:Date.now()})}resetAllStates(){const t=Date.now();for(const o of this.graph.getAllNodes())this.nodeStates.set(o.id,"idle"),this.emit("node:reset",{node:o,timestamp:t});for(const o of this.graph.getAllTransitions())this.transitionStates.set(o.id,"idle"),this.emit("transition:reset",{transition:o,timestamp:t});this.activeNodes.clear(),this.pendingActions.clear()}triggerNode(t){if(!this.running){this.emitError(`Cannot trigger node ${t}: simulation is not running`,t);return}if(!this.graph.getNode(t)){this.emitError(`Node ${t} not found`,t);return}this.resetAllStates(),this.enterNode(t)}selectTransition(t){if(!this.running){this.emitError("Cannot select transition: simulation is not running",void 0,t);return}const o=this.graph.getTransition(t);if(!o){this.emitError(`Transition ${t} not found`,void 0,t);return}if(!this.graph.getNode(o.sourceDefId)){this.emitError("Source node for transition not found",o.sourceDefId,t);return}if(!this.pendingActions.has(o.sourceDefId)){this.emitError(`Node ${o.sourceDefId} is not waiting for action`,o.sourceDefId);return}this.resetAllStates(),this.executeTransition(o)}completeManualNode(t){if(!this.running){this.emitError("Cannot complete node: simulation is not running",t);return}if(!this.graph.getNode(t)){this.emitError(`Node ${t} not found`,t);return}if(!this.pendingActions.has(t)){this.emitError(`Node ${t} is not waiting for action`,t);return}this.resetAllStates(),this.pendingActions.delete(t),this.exitNode(t)}enterNode(t){const o=this.graph.getNode(t);o&&(this.nodeStates.set(t,"entering"),this.activeNodes.add(t),this.emit("node:enter",{node:o,timestamp:Date.now()}),this.activateNode(t))}activateNode(t){const o=this.graph.getNode(t);o&&(this.nodeStates.set(t,"active"),this.emit("node:active",{node:o,timestamp:Date.now()}),this.graph.requiresUserAction(t)?this.waitForAction(t):this.graph.canAutoTraverse(t)?this.exitNode(t):this.completeNode(t))}waitForAction(t){const o=this.graph.getNode(t);if(!o)return;this.nodeStates.set(t,"waiting_for_action"),this.pendingActions.add(t);const s=this.graph.getOutgoingTransitions(t);this.emit("node:waiting",{node:o,availableTransitions:s,timestamp:Date.now()})}exitNode(t){const o=this.graph.getNode(t);if(!o)return;this.nodeStates.set(t,"exiting"),this.emit("node:exit",{node:o,timestamp:Date.now()});const s=this.graph.getOutgoingTransitions(t);if(s.length===0)this.completeNode(t);else if(s.length===1)this.executeTransition(s[0]),this.completeNode(t);else{for(const r of s)this.executeTransition(r);this.completeNode(t)}}completeNode(t){const o=this.graph.getNode(t);o&&(this.nodeStates.set(t,"completed"),this.activeNodes.delete(t),this.emit("node:complete",{node:o,timestamp:Date.now()}))}executeTransition(t){this.transitionStates.set(t.id,"in_progress"),this.emit("transition:start",{transition:t,timestamp:Date.now()});const o=setTimeout(()=>{this.activeTimeouts.delete(o),this.completeTransition(t)},this.config.transitionDelay);this.activeTimeouts.add(o)}completeTransition(t){this.transitionStates.set(t.id,"completed"),this.emit("transition:complete",{transition:t,timestamp:Date.now()}),this.enterNode(t.targetDefId)}emitError(t,o,s){this.emit("error",{message:t,nodeId:o,transitionId:s,timestamp:Date.now()})}}function gt(){const n=a.useRef(new Map),e=a.useRef(new Map),t=a.useRef(new Map),o=a.useRef(new Map),s=a.useCallback(f=>n.current.get(f),[]),r=a.useCallback(f=>{const i=e.current.get(f);return i?Array.from(i):[]},[]),c=a.useCallback(f=>{const i=n.current.get(f);if(!i)return!0;const m=e.current.get(i);if(!m||m.size<=1)return!0;const y=Array.from(m).sort();return f===y[0]},[]),l=a.useCallback((f,i,m)=>{if(!f.current)return;const v=f.current.getOutgoingTransitions(i).find(w=>w.targetDefId===m);return v==null?void 0:v.id},[]),h=a.useCallback(f=>t.current.get(f),[]),u=a.useCallback(f=>o.current.get(f),[]),x=a.useCallback((f,i)=>{n.current.set(f,i);let m=e.current.get(i);m||(m=new Set,e.current.set(i,m)),m.add(f)},[]),b=a.useCallback(f=>{const i=n.current.get(f);if(!i)return;n.current.delete(f);const m=e.current.get(i);return m&&(m.delete(f),m.size===0&&e.current.delete(i)),i},[]),p=a.useCallback((f,i)=>{t.current.set(f,i);let m=o.current.get(i);m||(m=new Set,o.current.set(i,m)),m.add(f)},[]),E=a.useCallback(f=>{const i=t.current.get(f);if(!i)return;t.current.delete(f);const m=o.current.get(i);return m&&(m.delete(f),m.size===0&&o.current.delete(i)),i},[]),d=a.useCallback(()=>{n.current.clear(),e.current.clear(),t.current.clear(),o.current.clear()},[]);return{instanceToDefRef:n,defToInstancesRef:e,edgeToTransitionRef:t,transitionToEdgesRef:o,getDefinitionForInstance:s,getInstancesForDefinition:r,isOriginalInstance:c,findExistingTransition:l,getEdgeTransition:h,getEdgesForTransition:u,registerInstance:x,unregisterInstance:b,registerEdge:p,unregisterEdge:E,resetMappings:d}}function ks(n,e){return{x:n.x-e.x,y:n.y-e.y}}function Ln(n,e){return{x:n.x+e.x,y:n.y+e.y}}function Fn(n,e){return e?Ln(n,e):n}const ve=152,mt=102,ht=80,Fe=32,oe=10;function Re(n,e,t=ve,o=mt,s=ht,r=Fe){const c=n+s<=0,l=n>=t,h=e+r<=0,u=e>=o;if(c)return{x:-s-oe,y:Math.max(-r,Math.min(e,o))};if(l)return{x:t+oe,y:Math.max(-r,Math.min(e,o))};if(h)return{x:Math.max(-s,Math.min(n,t)),y:-r-oe};if(u)return{x:Math.max(-s,Math.min(n,t)),y:o+oe};const x=n+s/2,b=e+r/2,p=t/2,E=o/2,d=x-p,f=b-E;return Math.abs(d)>Math.abs(f)?d>0?{x:t+oe,y:Math.max(-r,Math.min(e,o))}:{x:-s-oe,y:Math.max(-r,Math.min(e,o))}:f>0?{x:Math.max(-s,Math.min(n,t)),y:o+oe}:{x:Math.max(-s,Math.min(n,t)),y:-r-oe}}const Ve={command:{canConnectTo:["event"],canReceiveFrom:["event","policy","externalEvent"]},policy:{canConnectTo:["command","externalEvent","trigger","externalSystem"],canReceiveFrom:["event"]},externalEvent:{canConnectTo:["command","trigger"],canReceiveFrom:["event","policy"]},externalSystem:{canConnectTo:["event"],canReceiveFrom:["event","policy","externalEvent"]},trigger:{canConnectTo:["event"],canReceiveFrom:["event","policy","externalEvent"]},event:{canConnectTo:["policy","command","externalEvent","trigger","externalSystem"],canReceiveFrom:["command","trigger","externalSystem"]}};function zn(n,e){const t=Ve[n],o=Ve[e];if(!t||!o)return!1;const s=t.canConnectTo.includes(e),r=o.canReceiveFrom.includes(n);return s&&r}function $n(n,e){return e?"policy":n}function pt(n){return n==="command"?"commandEdge":"floating"}function We(n){return n>=2?"commandEdge":"floating"}function Wn(n,e){return{sourceHandle:"source-right",targetHandle:"target-left"}}function Pe(){return{label:"Path",labelOffset:.5}}function Oe(n,e){return!n||!e?{isNonStandard:!1}:{isNonStandard:!zn(n,e),sourceKind:n,targetKind:e}}function Xn(n,e,t,o){const s=n.source,r=n.target,c=o.has(s);let l;if(c){const d=o.get(s);l=d?t.get(d):void 0}else l=t.get(s);const h=t.get(r);if(!l||!h)return n;const u=e.getNode(l),x=e.getNode(h),b=c?"policy":u==null?void 0:u.kind,p=x==null?void 0:x.kind,E=Oe(b,p);return{...n,data:{...n.data,...E}}}const _e=120,Bn=152,Vn=112,Gn={top:{source:"source-top",target:"target-bottom"},right:{source:"source-right",target:"target-left"},bottom:{source:"source-bottom",target:"target-top"},left:{source:"source-left",target:"target-right"}};function Hn(n){return Gn[n]}function Un(n,e,t,o){switch(o){case"top":return{x:n.x,y:n.y-_e};case"right":return{x:n.x+e+_e,y:n.y};case"bottom":return{x:n.x,y:n.y+t+_e};case"left":return{x:n.x-_e,y:n.y}}}function xt(n,e,t,o){n.set(t,o);let s=e.get(o);s||(s=new Set,e.set(o,s)),s.add(t)}function bt(n,e,t,o){const s=n.get(o);if(!s)return;n.delete(o),t.delete(o);const r=e.get(s);r&&(r.delete(o),r.size===0&&e.delete(s))}function Et(n,e){var t;return((t=n.get(e))==null?void 0:t.size)??0}function qn(n,e,t){var r;const o=e.get(n);return o?(((r=t.get(o))==null?void 0:r.size)??0)>2:!1}function Yn(n,e,t,o){return n.filter(s=>{const r=s;return r.type!=="remove"||!r.id||!e.has(r.id)||o!=null&&o.has(r.id)?!0:qn(r.id,e,t)})}function Kn(n,e,t,o){return n}function Qn(n,e=ve){return Re(e+oe,n*(Fe+oe))}function Jn(n,e,t,o,s){return{id:n,type:"outcome",position:s,parentId:e,data:{label:o,parentPolicyId:e,parentPolicyInstanceId:e,parentPolicyDefId:t}}}function Zn(n,e,t,o,s,r,c){var x;const l=e.get(n);if(!l||(((x=t.get(l))==null?void 0:x.size)??0)<=2)return!1;if(o.get(n)){const b=s.cleanupEdgesFromSource(n);b.length>0&&c(p=>p.filter(E=>!b.includes(E.id)))}return bt(e,t,o,n),r(b=>b.filter(p=>p.id!==n)),!0}function eo(n,e,t,o,s,r,c){const l=c(),h=Et(s,n),u=Qn(h),x=Jn(l,n,e,t,u);return xt(o,s,l,n),r(b=>[...b,x]),l}function to(n,e,t){t(o=>o.map(s=>s.id===n?{...s,data:{...s.data,label:e}}:s))}function yt(n){const{instanceToDefRef:e,setNodes:t,getNodes:o}=n,s=a.useRef(new Map),r=a.useRef(new Map),c=a.useRef(new Map),l=a.useCallback(w=>c.current.get(w),[]),h=a.useCallback(w=>{const T=r.current.get(w);return T?Array.from(T):[]},[]),u=a.useCallback(w=>{const T=r.current.get(w);if(!T)return[];const I=o();return Array.from(T).map(B=>{var W;const M=I.find(O=>O.id===B),N=((W=M==null?void 0:M.data)==null?void 0:W.label)||"Outcome";return{id:B,label:N}})},[o]),x=a.useCallback(w=>s.current.has(w),[]),b=a.useCallback(w=>s.current.get(w),[]),p=a.useCallback(w=>Et(r.current,w),[]),E=a.useCallback((w,T)=>{xt(s.current,r.current,w,T)},[]),d=a.useCallback(w=>{bt(s.current,r.current,c.current,w)},[]),f=a.useCallback((w,T)=>{c.current.set(w,T)},[]),i=a.useCallback(w=>{c.current.delete(w)},[]),m=a.useCallback((w,T)=>{var B;const I=(B=e.current)==null?void 0:B.get(w);if(!I)throw new Error(`Policy instance ${w} not found`);return eo(w,I,T,s.current,r.current,t,Be)},[e,t]),y=a.useCallback((w,T)=>{to(w,T,t)},[t]),v=a.useCallback(()=>{s.current.clear(),r.current.clear(),c.current.clear()},[]);return{outcomeToParentRef:s,policyToOutcomesRef:r,outcomeToTransitionRef:c,getOutcomeTransition:l,getOutcomesForPolicy:h,getOutcomesWithLabels:u,isOutcome:x,getOutcomeParent:b,getOutcomeCount:p,registerOutcome:E,unregisterOutcome:d,setOutcomeTransition:f,clearOutcomeTransition:i,addOutcomeToPolicy:m,updateOutcomeLabel:y,resetMappings:v}}function wt(n,e){const{edgeToTransitionRef:t,transitionToEdgesRef:o}=e,s=a.useCallback(p=>t.current.get(p),[t]),r=a.useCallback(p=>o.current.get(p),[o]),c=a.useCallback(p=>{const E=o.current.get(p);return E!==void 0&&E.size>0},[o]),l=a.useCallback((p,E)=>{if(!n.current)return;const f=n.current.getOutgoingTransitions(p).find(i=>i.targetDefId===E);return f==null?void 0:f.id},[n]),h=a.useCallback((p,E)=>{t.current.set(p,E);let d=o.current.get(E);d||(d=new Set,o.current.set(E,d)),d.add(p)},[t,o]),u=a.useCallback((p,E,d)=>{const f=Pn({sourceDefId:E,targetDefId:d});return n.current.addTransition(f),t.current.set(p,f.id),o.current.set(f.id,new Set([p])),f.id},[n,t,o]),x=a.useCallback(p=>{const E=t.current.get(p);if(!E)return{transitionDeleted:!1};t.current.delete(p);const d=o.current.get(E);return d==null||d.delete(p),!d||d.size===0?(o.current.delete(E),n.current.removeTransition(E),{transitionDeleted:!0,transitionId:E}):{transitionDeleted:!1,transitionId:E}},[n,t,o]),b=a.useCallback((p,E,d,f)=>{if((f==null?void 0:f.allowReuseExisting)??!0){const m=l(E,d);if(m)return h(p,m),m}return u(p,E,d)},[l,h,u]);return{getTransitionForEdge:s,getEdgesForTransition:r,hasEdgesForTransition:c,findExistingTransition:l,linkEdgeToTransition:h,linkEdgeToNewTransition:u,unlinkEdgeFromTransition:x,getOrCreateTransitionAndLink:b}}function vt(n,e){const t=a.useCallback(h=>{var x;const u=(x=e.current)==null?void 0:x.get(h);return u?Array.from(u):[]},[e]),o=a.useCallback(h=>{var u,x;return((x=(u=n.current)==null?void 0:u.getNode(h))==null?void 0:x.kind)==="command"},[n]),s=a.useCallback((h,u)=>{const x=t(h);if(x.length===0)return 0;const b=new Set(x);let p=0;for(const E of u)b.has(E.source)&&p++;return p},[t]),r=a.useCallback((h,u,x)=>{let b=s(h,u);return b+=(x==null?void 0:x.pendingAdd)??0,We(b)},[s]),c=a.useCallback((h,u,x)=>{const b=t(h);if(b.length===0)return u;const p=new Set(b);let E=0;for(const f of u)p.has(f.source)&&E++;E+=(x==null?void 0:x.pendingAdd)??0;const d=We(E);return u.map(f=>{var i;return!p.has(f.source)||f.type===d?f:{...f,type:d,data:{...f.data,...d==="commandEdge"&&!((i=f.data)!=null&&i.label)?Pe():{}}}})},[t]),l=a.useCallback((h,u,x,b)=>{const p=new Map;for(const E of h){const d=x.get(E.source);if(!d)continue;const f=u.getNode(d);(f==null?void 0:f.kind)==="command"&&p.set(d,(p.get(d)??0)+1)}return h.map(E=>{var y;const d=x.get(E.source);if(!d)return E;const f=u.getNode(d);if((f==null?void 0:f.kind)!=="command")return E;const i=p.get(d)??0,m=We(i);return E.type===m?E:{...E,type:m,data:{...E.data,...m==="commandEdge"&&!((y=E.data)!=null&&y.label)?Pe():{}}}})},[]);return{countCommandEdges:s,resolveEdgeType:r,normalizeCommandEdges:c,normalizeAllCommandEdges:l,isCommandDefinition:o,getCommandInstanceIds:t}}const tt=["hotspot","note","actor"];function no(n){const{edges:e,setNodes:t,setEdges:o,onNodesChangeInternal:s,onEdgesChangeInternal:r,graphRef:c,getNode:l,nodesRef:h,instanceToDefRef:u,defToInstancesRef:x,edgeToTransitionRef:b,transitionToEdgesRef:p,outcomeManagement:E,edgeTransitionManager:d,commandEdgeResolver:f}=n,{isOutcome:i,unregisterOutcome:m,getOutcomesForPolicy:y,setOutcomeTransition:v,clearOutcomeTransition:w,outcomeToParentRef:T,policyToOutcomesRef:I}=E,B=a.useCallback(j=>{const k=u.current.get(j);if(!k)return;const _=y(j);for(const F of _)m(F);u.current.delete(j);const L=x.current.get(k);if(L==null||L.delete(j),!L||L.size===0){x.current.delete(k),c.current.removeNode(k);for(const[F,z]of b.current)c.current.getTransition(z)||(b.current.delete(F),p.current.delete(z))}},[c,u,x,b,p,y,m]),M=a.useCallback(j=>{d.unlinkEdgeFromTransition(j)},[d]),N=a.useCallback(j=>{const k=new Set;for(const P of j)if(P.type==="remove"){const G=I.current.get(P.id);if(G)for(const X of G)k.add(X)}const _=Yn(j,T.current,I.current,k);for(const P of k)_.some(G=>G.type==="remove"&&G.id===P)||_.push({type:"remove",id:P});const L=_.map(P=>{var G,X,H,Y;if(P.type==="position"&&P.position){const U=T.current.get(P.id);if(U){const Z=l(P.id),Q=l(U),S=Re(P.position.x,P.position.y,((G=Q==null?void 0:Q.measured)==null?void 0:G.width)??ve,((X=Q==null?void 0:Q.measured)==null?void 0:X.height)??mt,((H=Z==null?void 0:Z.measured)==null?void 0:H.width)??ht,((Y=Z==null?void 0:Z.measured)==null?void 0:Y.height)??Fe);return{...P,position:S}}}return P}),F=new Set;for(const P of L)P.type==="remove"&&F.add(P.id);const z=new Set;for(const P of e)(F.has(P.source)||F.has(P.target))&&z.add(P.id);for(const P of z)M(P);z.size>0&&o(P=>P.filter(G=>!z.has(G.id)));for(const P of L)P.type==="remove"&&B(P.id);s(L)},[s,B,M,l,e,o,I,T]),W=a.useCallback(j=>{const k=Kn(j,e,T.current,I.current),_=new Set,L=new Set;for(const F of k)if(F.type==="remove"){const z=e.find(P=>P.id===F.id);if(z){const P=z.source,G=z.target,X=u.current.get(P);if(X){const H=c.current.getNode(X);if((H==null?void 0:H.kind)==="command"){_.add(X);const Y=u.current.get(G);if(Y){const U=c.current.getNode(Y);(U==null?void 0:U.kind)==="event"&&L.add(G)}}}}M(F.id)}r(k),_.size>0&&o(F=>{let z=F;for(const P of _)z=f.normalizeCommandEdges(P,z);return z}),L.size>0&&t(F=>F.map(z=>L.has(z.id)?e.some(G=>{if(G.target!==z.id||k.some(U=>U.type==="remove"&&U.id===G.id))return!1;const H=u.current.get(G.source);if(!H)return!1;const Y=c.current.getNode(H);return(Y==null?void 0:Y.kind)==="command"})?z:{...z,data:{...z.data,hasCommandParent:!1}}:z))},[r,M,e,o,t,f,c,u,T,I]),O=a.useCallback(j=>{if(!j.source||!j.target)return!1;const k=j.source,_=j.target;if(k===_)return!1;const L=i(k),F=h.current.find(X=>X.id===k),z=$n(F==null?void 0:F.type,L),P=h.current.find(X=>X.id===_),G=P==null?void 0:P.type;return!(!z||!G||tt.includes(z)||tt.includes(G))},[i,h]),A=a.useCallback(j=>{if(!j.source||!j.target)return;const k=j.source,_=j.target,L=`edge_${k}_${_}`;if(b.current.has(L))return;const F=i(k);let z;if(F){const S=k,C=T.current.get(S);z=u.current.get(C)}else z=u.current.get(k);const P=u.current.get(_);if(!z||!P)return;const G=d.findExistingTransition(z,P);if(G&&!F&&d.hasEdgesForTransition(G))return;const X=F?d.linkEdgeToNewTransition(L,z,P):d.getOrCreateTransitionAndLink(L,z,P);F&&v(k,X);const H=c.current.getNode(z),Y=c.current.getNode(P),U=(H==null?void 0:H.kind)==="command",Z=F?"policy":H==null?void 0:H.kind,Q=Oe(Z,Y==null?void 0:Y.kind);U?(o(S=>{const C=f.resolveEdgeType(z,S,{pendingAdd:1}),V=He({...j,id:L,type:C,data:{state:"idle",transitionId:X,...Q,...C==="commandEdge"?Pe():{}}},S);return f.normalizeCommandEdges(z,V)}),(Y==null?void 0:Y.kind)==="event"&&t(S=>S.map(C=>C.id===_?{...C,data:{...C.data,hasCommandParent:!0}}:C))):o(S=>He({...j,id:L,type:"floating",data:{state:"idle",transitionId:X,...Q}},S))},[o,t,d,f,c,u,b,T,i,v]),$=a.useCallback((j,k)=>{if(!k.source||!k.target)return;const _=j.id,L=k.source,F=k.target,z=`edge_${L}_${F}`,P=_!==z;if(e.some(J=>J.id!==_&&J.id!==z&&J.source===L&&J.target===F)||P&&b.current.has(z))return;const X=i(L);let H;if(X){const J=L,ee=T.current.get(J);H=u.current.get(ee)}else H=u.current.get(L);const Y=u.current.get(F);if(!H||!Y)return;const U=b.current.get(_),Z=U?c.current.getTransition(U):void 0,Q=!Z||Z.sourceDefId!==H||Z.targetDefId!==Y;let S;const C=j.source,V=T.current.has(C);if(Q){U&&(d.unlinkEdgeFromTransition(_),V&&w(C));const J=d.findExistingTransition(H,Y);if(J&&!X&&d.hasEdgesForTransition(J))return;S=X?d.linkEdgeToNewTransition(z,H,Y):d.getOrCreateTransitionAndLink(z,H,Y),X&&v(L,S)}else{if(S=U,P){b.current.delete(_),b.current.set(z,S);const J=p.current.get(S);J&&(J.delete(_),J.add(z))}V&&C!==L&&w(C),X&&v(L,S)}const K=c.current.getNode(H),ne=c.current.getNode(Y),se=(K==null?void 0:K.kind)==="command",Ee=se?"commandEdge":"floating",ye=X?"policy":K==null?void 0:K.kind,pe=Oe(ye,ne==null?void 0:ne.kind);o(J=>nn(j,k,J).map(re=>{var le;return re.source===k.source&&re.target===k.target?{...re,id:z,type:Ee,data:{...re.data,...Q?{state:"idle",progress:0}:{},transitionId:S,...pe,...se&&!((le=re.data)!=null&&le.label)?{label:"Path",labelOffset:.5}:{}}}:re}))},[e,o,d,c,u,b,p,T,i,v,w]);return{onNodesChange:N,onEdgesChange:W,onConnect:A,onReconnect:$,isValidConnection:O}}function nt(n,e,t,o,s){return{id:n,type:"outcome",position:s,parentId:t,data:{label:e,parentPolicyInstanceId:t,parentPolicyDefId:o}}}function oo(n){const{edges:e,setNodes:t,setEdges:o,graphRef:s,getNode:r,instanceMapping:c,outcomeManagement:l,edgeTransitionManager:h}=n,{instanceToDefRef:u,defToInstancesRef:x,edgeToTransitionRef:b,transitionToEdgesRef:p}=c,{outcomeToParentRef:E,policyToOutcomesRef:d,getOutcomesForPolicy:f,registerOutcome:i,unregisterOutcome:m}=l,y=a.useCallback(N=>{const W=u.current.get(N);if(!W)return;const O=f(N);for(const $ of O)m($);u.current.delete(N);const A=x.current.get(W);if(A==null||A.delete(N),!A||A.size===0){x.current.delete(W),s.current.removeNode(W);for(const[$,j]of b.current)s.current.getTransition(j)||(b.current.delete($),p.current.delete(j))}},[s,u,x,b,p,f,m]),v=a.useCallback((N,W,O)=>{let A,$="event";if(N==="event"){const k=$e({label:O||"Event"});s.current.addNode(k);const _=Ce();u.current.set(_,k.id),x.current.set(k.id,new Set([_]));const L={id:_,type:"event",position:W,data:{label:k.label,executionMode:k.executionMode,definitionId:k.id}};return t(F=>[...F,L]),_}if(N==="trigger"){const k=An({label:O||"Trigger"});s.current.addNode(k);const _=Ce();u.current.set(_,k.id),x.current.set(k.id,new Set([_]));const L={id:_,type:"trigger",position:W,data:{label:k.label,definitionId:k.id}};return t(F=>[...F,L]),_}N==="policy"?(A=Ye({label:O||"Policy"}),$="policy"):N==="externalSystem"?(A=Ke({label:O||"External System"}),$="externalSystem"):N==="externalEvent"?(A=Rn({label:O||"External Event"}),$="externalEvent"):N==="command"?(A=Qe({label:O??"Command"}),$="command"):N==="hotspot"?(A=Je({label:O||"HotSpot"}),$="hotspot"):N==="note"?(A=Ze({label:O||"Note"}),$="note"):N==="actor"?(A=et({label:O||"Actor"}),$="actor"):(A=$e({label:O||"Event"}),$="event"),s.current.addNode(A);const j=Ce();if(u.current.set(j,A.id),x.current.set(A.id,new Set([j])),N==="policy"){const k={id:j,type:"policy",position:W,data:{label:A.label,executionMode:A.executionMode,definitionId:A.id}},_=Be(),L=Be(),F=Re(ve+oe,0),z=Re(ve+oe,Fe+oe),P=nt(_,"Yes",j,A.id,F),G=nt(L,"No",j,A.id,z);i(_,j),i(L,j),t(X=>[...X,k,P,G])}else{const k={id:j,type:$,position:W,data:{label:A.label,executionMode:A.executionMode,definitionId:A.id}};t(_=>[..._,k])}return j},[s,u,x,t,i]),w=a.useCallback((N,W)=>{const O=s.current.getNode(N);if(!O)throw new Error(`Definition ${N} does not exist`);const A=Ce();u.current.set(A,N);const $=x.current.get(N)??new Set;$.add(A),x.current.set(N,$);const j={id:A,type:O.kind,position:W,data:{label:O.label,executionMode:O.executionMode,definitionId:N}};return t(k=>[...k,j]),A},[s,u,x,t]),T=a.useCallback(N=>{const W=u.current.get(N);if(!W)return;const O=r(N);if(!O)return;const A={x:O.position.x+50,y:O.position.y+50};return w(W,A)},[u,r,w]),I=a.useCallback(N=>{const W=u.current.get(N);if(!W)return;const O=s.current.getNode(W);if(!O)return;const A=x.current.get(W);if(!A||A.size<=1)return;let $;O.kind==="event"?$=$e({label:O.label}):O.kind==="policy"?$=Ye({label:O.label}):O.kind==="command"?$=Qe({label:O.label}):O.kind==="hotspot"?$=Je({label:O.label}):O.kind==="note"?$=Ze({label:O.label}):O.kind==="actor"?$=et({label:O.label}):$=Ke({label:O.label}),s.current.addNode($),u.current.set(N,$.id),A.delete(N),x.current.set($.id,new Set([N]));const j=e.filter(k=>k.source===N||k.target===N);for(const k of j){const _=k.source===N,L=_?k.target:k.source;if(E.current.has(L))continue;const F=u.current.get(L);if(!F||F===W)continue;const z=_?$.id:F,P=_?F:$.id;h.getOrCreateTransitionAndLink(k.id,z,P)}t(k=>k.map(_=>_.id===N?{..._,data:{..._.data,definitionId:$.id}}:_)),o(k=>k.map(_=>{if(_.source===N||_.target===N){const L=b.current.get(_.id);if(L)return{..._,data:{..._.data,transitionId:L}}}return _}))},[s,u,x,E,b,e,t,o,h]),B=a.useCallback(N=>{const W=d.current.get(N),O=new Set([N]);if(W)for(const A of W)O.add(A);y(N),t(A=>A.filter($=>!O.has($.id)))},[d,y,t]),M=a.useCallback(N=>{const W=x.current.get(N);if(!W)return;const O=new Set(W);for(const A of O)u.current.delete(A);x.current.delete(N),s.current.removeNode(N),t(A=>A.filter($=>!O.has($.id)))},[s,u,x,t]);return{addNode:v,addInstance:w,duplicateInstance:T,dissociateInstance:I,deleteInstance:B,deleteDefinition:M,handleInstanceDeletion:y}}function so(n){const{setNodes:e,graphRef:t,instanceMapping:o}=n,{defToInstancesRef:s,getDefinitionForInstance:r,getInstancesForDefinition:c,isOriginalInstance:l}=o,h=a.useCallback(i=>c(i),[c]),u=a.useCallback((i,m)=>{t.current.updateNode(i,{executionMode:m});const y=s.current.get(i);y&&e(v=>v.map(w=>y.has(w.id)?{...w,data:{...w.data,executionMode:m}}:w))},[t,s,e]),x=a.useCallback((i,m)=>{const y=t.current.getNode(i);if(!y)return;t.current.updateNode(i,{label:m});const v=y.config;if(y.kind==="command"||y.kind==="trigger"||y.kind==="externalSystem"||y.kind==="externalEvent"){const T=ie(m);if(T){const I=v;if((I==null?void 0:I.slugName)!==T){const M={...I,slugName:T};t.current.updateNode(i,{config:M})}}}else if(y.kind==="event"){const T=Le(m);if(T){const I=v;if((I==null?void 0:I.type)!==T){const M={...I,type:T};t.current.updateNode(i,{config:M})}}}const w=s.current.get(i);w&&e(T=>T.map(I=>w.has(I.id)?{...I,data:{...I.data,label:m}}:I))},[t,s,e]),b=a.useCallback((i,m)=>{t.current.updateNode(i,{config:m})},[t]),p=a.useCallback((i,m)=>{t.current.updateNode(i,{awsExtension:m})},[t]),E=a.useCallback(i=>{var m;return(m=t.current.getNode(i))==null?void 0:m.config},[t]),d=a.useCallback(i=>{var m;return(m=t.current.getNode(i))==null?void 0:m.awsExtension},[t]),f=a.useCallback((i,m)=>{var I;const y=t.current.getNode(i);if(!y||y.kind!=="command"&&y.kind!=="trigger"||y.kind===m)return;const v=m==="trigger"?"manual":"automatic";t.current.updateNode(i,{kind:m,executionMode:v}),m==="command"&&t.current.recalculateExecutionMode(i);const w=s.current.get(i);if(!w)return;const T=(I=t.current.getNode(i))==null?void 0:I.executionMode;e(B=>B.map(M=>w.has(M.id)?{...M,type:m,data:{...M.data,executionMode:T}}:M))},[t,s,e]);return{getDefinitionForInstance:r,getInstancesForDefinition:h,isOriginalInstance:l,updateNodeExecutionMode:u,updateNodeLabel:x,updateNodeConfig:b,updateNodeAwsExtension:p,getNodeConfig:E,getNodeAwsExtension:d,convertNodeKind:f}}function ro(n){const{edges:e,setNodes:t,setEdges:o,outcomeManagement:s,edgeTransitionManager:r}=n,{outcomeToParentRef:c,policyToOutcomesRef:l,outcomeToTransitionRef:h,getOutcomeTransition:u,getOutcomesForPolicy:x,getOutcomesWithLabels:b,addOutcomeToPolicy:p,updateOutcomeLabel:E}=s,d=a.useMemo(()=>({cleanupEdgesFromSource:i=>{const m=e.filter(y=>y.source===i).map(y=>y.id);for(const y of m)r.unlinkEdgeFromTransition(y);return m}}),[e,r]),f=a.useCallback(i=>Zn(i,c.current,l.current,h.current,d,t,o),[c,l,h,d,t,o]);return{getOutcomeTransition:u,getOutcomesForPolicy:x,getOutcomesWithLabels:b,addOutcomeToPolicy:p,deleteOutcome:f,updateOutcomeLabel:E}}const Me=16;function ao(n){const{nodes:e,edges:t,setNodes:o,setEdges:s,graphRef:r,instanceMapping:c,outcomeManagement:l,commandEdgeResolver:h,incrementGraphVersion:u}=n,{instanceToDefRef:x,defToInstancesRef:b,edgeToTransitionRef:p,transitionToEdgesRef:E}=c,{outcomeToParentRef:d,policyToOutcomesRef:f,outcomeToTransitionRef:i,resetMappings:m}=l,y=a.useCallback(()=>{r.current=new we,c.resetMappings(),m(),o([]),s([]),u()},[r,o,s,c,m,u]),v=a.useCallback(()=>({graph:r.current,nodes:e,edges:t,mappings:{instanceToDefRef:new Map(x.current),defToInstancesRef:new Map(Array.from(b.current.entries()).map(([T,I])=>[T,new Set(I)])),edgeToTransitionRef:new Map(p.current),transitionToEdgesRef:new Map(Array.from(E.current.entries()).map(([T,I])=>[T,new Set(I)])),outcomeToParentRef:new Map(d.current),policyToOutcomesRef:new Map(Array.from(f.current.entries()).map(([T,I])=>[T,new Set(I)])),outcomeToTransitionRef:new Map(i.current)}}),[e,t,r,x,b,p,E,d,f,i]),w=a.useCallback(T=>{r.current=T.graph,x.current=T.mappings.instanceToDefRef,b.current=T.mappings.defToInstancesRef,p.current=T.mappings.edgeToTransitionRef,E.current=T.mappings.transitionToEdgesRef,d.current=T.mappings.outcomeToParentRef??new Map,f.current=T.mappings.policyToOutcomesRef??new Map,i.current=T.mappings.outcomeToTransitionRef??new Map;const I=T.nodes.map(N=>({...N,position:{x:Math.round(N.position.x/Me)*Me,y:Math.round(N.position.y/Me)*Me}})),M=h.normalizeAllCommandEdges(T.edges,T.graph,T.mappings.instanceToDefRef,T.mappings.defToInstancesRef).map(N=>Xn(N,T.graph,T.mappings.instanceToDefRef,T.mappings.outcomeToParentRef??new Map));o(I),s(M),u()},[r,x,b,p,E,d,f,i,o,s,h,u]);return{reset:y,getWorkflowState:v,hydrateWorkflow:w}}const io=[],co=[];function lo(n){const e=a.useRef(new we),[t,o]=a.useState(0),s=gt(),[r,c,l]=it(io),[h,u,x]=ct(co),b=a.useRef([]);b.current=r;const{getNode:p,getNodes:E}=Te(),d=wt(e,{edgeToTransitionRef:s.edgeToTransitionRef,transitionToEdgesRef:s.transitionToEdgesRef}),f=vt(e,s.defToInstancesRef),i=yt({instanceToDefRef:s.instanceToDefRef,setNodes:c,getNodes:E}),m=(n==null?void 0:n.graphRef)??e,y=n?n.incrementGraphVersion:()=>o(ke=>ke+1),v=(n==null?void 0:n.nodes)??r,w=(n==null?void 0:n.edges)??h,T=(n==null?void 0:n.setNodes)??c,I=(n==null?void 0:n.setEdges)??u,B=(n==null?void 0:n.onNodesChangeInternal)??l,M=(n==null?void 0:n.onEdgesChangeInternal)??x,N=(n==null?void 0:n.nodesRef)??b,W=(n==null?void 0:n.instanceMapping)??s,{instanceToDefRef:O,defToInstancesRef:A,edgeToTransitionRef:$,transitionToEdgesRef:j}=W,k=(n==null?void 0:n.edgeTransitionManager)??d,_=(n==null?void 0:n.commandEdgeResolver)??f,L=(n==null?void 0:n.outcomeManagement)??i,F=a.useMemo(()=>w.map(ke=>({...ke,reconnectable:ke.selected??!1})),[w]),{outcomeToParentRef:z,policyToOutcomesRef:P,outcomeToTransitionRef:G}=L,X={nodes:v,edges:w,setNodes:T,setEdges:I,onNodesChangeInternal:B,onEdgesChangeInternal:M,graphRef:m,graph:m.current,getNode:p,nodesRef:N,instanceMapping:W,instanceToDefRef:O,defToInstancesRef:A,edgeToTransitionRef:$,transitionToEdgesRef:j,outcomeManagement:L,edgeTransitionManager:k,commandEdgeResolver:_,incrementGraphVersion:y},{onNodesChange:H,onEdgesChange:Y,onConnect:U,onReconnect:Z,isValidConnection:Q}=no(X),{addNode:S,addInstance:C,duplicateInstance:V,dissociateInstance:K,deleteInstance:ne,deleteDefinition:se}=oo(X),{getDefinitionForInstance:Ee,getInstancesForDefinition:ye,isOriginalInstance:pe,updateNodeExecutionMode:J,updateNodeLabel:ee,updateNodeConfig:re,updateNodeAwsExtension:le,getNodeConfig:de,getNodeAwsExtension:Ne,convertNodeKind:At}=so(X),{getOutcomeTransition:Rt,getOutcomesForPolicy:Pt,getOutcomesWithLabels:Ot,addOutcomeToPolicy:Dt,deleteOutcome:jt,updateOutcomeLabel:Lt}=ro(X),{reset:Ft,getWorkflowState:zt,hydrateWorkflow:$t}=ao(X),Wt=a.useMemo(()=>e.current,[t]),Xt=(n==null?void 0:n.graph)??Wt;return{nodes:v,edges:F,graph:Xt,onNodesChange:H,onEdgesChange:Y,onConnect:U,isValidConnection:Q,onReconnect:Z,addNode:S,addInstance:C,duplicateInstance:V,dissociateInstance:K,deleteInstance:ne,deleteDefinition:se,getDefinitionForInstance:Ee,getInstancesForDefinition:ye,isOriginalInstance:pe,updateNodeExecutionMode:J,updateNodeLabel:ee,updateNodeConfig:re,updateNodeAwsExtension:le,getNodeConfig:de,getNodeAwsExtension:Ne,convertNodeKind:At,reset:Ft,getWorkflowState:zt,hydrateWorkflow:$t,getOutcomeTransition:Rt,getOutcomesForPolicy:Pt,getOutcomesWithLabels:Ot,addOutcomeToPolicy:Dt,deleteOutcome:jt,updateOutcomeLabel:Lt}}const uo=[],fo=[];function go(){const n=a.useRef(new we),[e,t]=a.useState(0),o=gt(),{instanceToDefRef:s,defToInstancesRef:r,edgeToTransitionRef:c,transitionToEdgesRef:l}=o,[h,u,x]=it(uo),[b,p,E]=ct(fo),d=a.useRef([]);d.current=h;const f=a.useMemo(()=>b.map(A=>({...A,reconnectable:A.selected??!1})),[b]),{getNode:i,getNodes:m}=Te(),y=wt(n,{edgeToTransitionRef:c,transitionToEdgesRef:l}),v=vt(n,r),w=yt({instanceToDefRef:s,setNodes:u,getNodes:m}),{outcomeToParentRef:T,policyToOutcomesRef:I,outcomeToTransitionRef:B,resetMappings:M}=w,N=a.useCallback(()=>{t(A=>A+1)},[]),W=a.useCallback(()=>{n.current=new we,o.resetMappings(),M(),u([]),p([]),t(A=>A+1)},[u,p,o,M]),O=a.useMemo(()=>n.current,[e]);return{nodes:h,edges:b,edgesWithReconnectable:f,setNodes:u,setEdges:p,onNodesChangeInternal:x,onEdgesChangeInternal:E,graphRef:n,graph:O,getNode:i,getNodes:m,nodesRef:d,instanceMapping:o,instanceToDefRef:s,defToInstancesRef:r,edgeToTransitionRef:c,transitionToEdgesRef:l,outcomeManagement:w,outcomeToParentRef:T,policyToOutcomesRef:I,outcomeToTransitionRef:B,edgeTransitionManager:y,commandEdgeResolver:v,incrementGraphVersion:N,reset:W}}const Tt=a.createContext(null);function mo({children:n}){const e=go();return g.jsx(Tt.Provider,{value:e,children:n})}function ho(){const n=a.useContext(Tt);if(!n)throw new Error("useWorkflowCoreContext must be used within a WorkflowCoreProvider");return n}const Nt=a.createContext(null);function po({children:n}){const e=ho(),t=lo(e);return g.jsx(Nt.Provider,{value:t,children:n})}function Cs({children:n}){return g.jsx(mo,{children:g.jsx(po,{children:n})})}function ze(){const n=a.useContext(Nt);if(!n)throw new Error("useWorkflow must be used within a WorkflowProvider");return n}function xo(n){const e=a.useRef(null),[t,o]=a.useState(null),[s,r]=a.useState([]),[c,l]=a.useState(!1);a.useEffect(()=>{const d=new jn(n,{transitionDelay:1e3});e.current=d;const f=(m,y)=>{const v={id:`${Date.now()}-${Math.random()}`,type:m,timestamp:y.timestamp,data:y};r(w=>[...w,v]),o(d.getState())},i=[d.on("simulation:start",m=>{f("simulation:start",m),l(!0)}),d.on("simulation:stop",m=>{f("simulation:stop",m),l(!1)}),d.on("simulation:reset",m=>{f("simulation:reset",m),l(!1)}),d.on("node:enter",m=>f("node:enter",m)),d.on("node:active",m=>f("node:active",m)),d.on("node:waiting",m=>f("node:waiting",m)),d.on("node:exit",m=>f("node:exit",m)),d.on("node:complete",m=>f("node:complete",m)),d.on("node:reset",m=>f("node:reset",m)),d.on("transition:start",m=>f("transition:start",m)),d.on("transition:complete",m=>f("transition:complete",m)),d.on("transition:reset",m=>f("transition:reset",m)),d.on("error",m=>f("error",m)),d.on("state:initialized",()=>{o(d.getState())})];return queueMicrotask(()=>{o(d.getState())}),()=>{i.forEach(m=>m()),d.stop(),e.current=null}},[n]);const h=a.useCallback(()=>{var d;(d=e.current)==null||d.start()},[]),u=a.useCallback(()=>{var d;(d=e.current)==null||d.stop()},[]),x=a.useCallback(()=>{var d;(d=e.current)==null||d.reset(),r([])},[]),b=a.useCallback(d=>{var f;(f=e.current)==null||f.triggerNode(d)},[]),p=a.useCallback(d=>{var f;(f=e.current)==null||f.selectTransition(d)},[]),E=a.useCallback(d=>{var f;(f=e.current)==null||f.completeManualNode(d)},[]);return{isRunning:c,state:t,events:s,start:h,stop:u,reset:x,triggerNode:b,selectTransition:p,completeManualNode:E}}const kt=a.createContext(null);function _s({children:n}){const{graph:e}=ze(),t=xo(e);return g.jsx(kt.Provider,{value:t,children:n})}function bo(){const n=a.useContext(kt);if(!n)throw new Error("useSimulationContext must be used within a SimulationProvider");return n}const Ct=a.createContext(null);function Ms({children:n}){const[e,t]=a.useState(null),[o,s]=a.useState(null),r=a.useCallback(h=>{t(h)},[]),c=a.useCallback(()=>{t(null)},[]),l={pendingTooltip:e,hoveredWarningEdgeId:o,showTooltip:r,hideTooltip:c,setHoveredWarningEdgeId:s};return g.jsx(Ct.Provider,{value:l,children:n})}function _t(){const n=a.useContext(Ct);if(!n)throw new Error("useNonStandardConnectionContext must be used within a NonStandardConnectionProvider");return n}function Eo(){const n=xe(o=>o.theme),e=xe(o=>o.setTheme),t=xe(o=>o.toggleTheme);return{theme:n,setTheme:e,toggleTheme:t}}function yo({pathRef:n,edgeId:e,onOffsetChange:t}){const[o,s]=a.useState(!1),r=a.useRef(!1),c=a.useCallback(l=>{l.stopPropagation(),l.preventDefault(),r.current=!1,s(!0)},[]);return a.useEffect(()=>{if(!o||!n.current)return;const l=u=>{var m;if(!n.current)return;r.current=!0;const x=n.current.ownerSVGElement;if(!x)return;const b=x.createSVGPoint();b.x=u.clientX,b.y=u.clientY;const p=b.matrixTransform((m=x.getScreenCTM())==null?void 0:m.inverse()),E=n.current.getTotalLength();let d=.5,f=1/0;for(let y=0;y<=100;y++){const v=y/100,w=n.current.getPointAtLength(E*v),T=Math.sqrt(Math.pow(w.x-p.x,2)+Math.pow(w.y-p.y,2));T<f&&(f=T,d=v)}const i=Math.max(.1,Math.min(.9,d));t(e,i)},h=()=>{s(!1)};return document.addEventListener("mousemove",l),document.addEventListener("mouseup",h),()=>{document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",h)}},[o,e,n,t]),{isDragging:o,hasDraggedRef:r,handleDragStart:c}}class wo{serialize(e){try{const{graph:t,nodes:o,edges:s,mappings:r}=e,c=t.getAllNodes().map(p=>({id:p.id,label:p.label,kind:p.kind,category:p.category,executionMode:p.executionMode,config:p.config,awsExtension:p.awsExtension})),l=t.getAllTransitions().map(p=>({id:p.id,sourceDefId:p.sourceDefId,targetDefId:p.targetDefId})),h=o.filter(p=>p.type!=="outcome").map(p=>({id:p.id,definitionId:r.instanceToDefRef.get(p.id),position:{x:p.position.x,y:p.position.y}})),u=o.filter(p=>p.type==="outcome").map(p=>({id:p.id,label:p.data.label||"Outcome",parentPolicyInstanceId:p.parentId,parentPolicyDefId:p.data.parentPolicyDefId||"",position:{x:p.position.x,y:p.position.y}})),x=r.outcomeToTransitionRef?Array.from(r.outcomeToTransitionRef.entries()).map(([p,E])=>({outcomeId:p,transitionId:E})):[],b=s.filter(p=>r.edgeToTransitionRef.has(p.id)).map(p=>{const E=p.data;return{edgeId:p.id,transitionId:r.edgeToTransitionRef.get(p.id),source:p.source,target:p.target,sourceHandle:p.sourceHandle??void 0,targetHandle:p.targetHandle??void 0,label:E==null?void 0:E.label,labelOffset:E==null?void 0:E.labelOffset}});return{success:!0,workflow:{definitions:c,transitions:l,instances:h,edgeMappings:b,outcomes:u,outcomeEdgeMappings:x}}}catch(t){return{success:!1,error:{code:"VALIDATION_ERROR",message:"Failed to serialize workflow",details:t}}}}}class vo{recoverOrphanEdges(e,t,o,s){var E;const{instanceToDefRef:r,defToInstancesRef:c,edgeToTransitionRef:l,transitionToEdgesRef:h}=o,u=e.filter(d=>{const f=l.get(d.id);return f?t.getTransition(f)!==void 0:!1}),x=new Set(u.map(d=>d.id));for(const d of l.keys())if(!x.has(d)){const f=l.get(d);l.delete(d),f&&((E=h.get(f))==null||E.delete(d))}const b=new Set(l.values()),p=t.getAllTransitions().filter(d=>!b.has(d.id));for(const d of p){const f=this.createEdgeForTransition(d,t,r,c,s);f&&(u.push(f),l.set(f.id,d.id),h.has(d.id)||h.set(d.id,new Set),h.get(d.id).add(f.id))}return{edges:u,edgeToTransitionRef:l,transitionToEdgesRef:h}}createEdgeForTransition(e,t,o,s,r){const c=s.get(e.sourceDefId),l=s.get(e.targetDefId);if(!(c!=null&&c.size)||!(l!=null&&l.size))return null;const h=c.values().next().value,u=l.values().next().value,x=r.get(h),b=r.get(u);if(!x||!b)return null;const{sourceHandle:p,targetHandle:E}=Wn(),d=`edge_${h}_${u}`,f=t.getNode(e.sourceDefId),i=t.getNode(e.targetDefId),m=f?pt(f.kind):"floating",y=Oe(f==null?void 0:f.kind,i==null?void 0:i.kind);return{id:d,source:h,target:u,sourceHandle:p,targetHandle:E,type:m,data:{state:"idle",transitionId:e.id,...y,...m==="commandEdge"?Pe():{}}}}}class To{constructor(){te(this,"edgeRecovery",new vo)}deserialize(e){try{const t=new we;for(const i of e.definitions){const m={id:i.id,label:i.label,kind:i.kind,category:i.category,executionMode:i.executionMode,config:i.config,awsExtension:i.awsExtension};t.addNode(m)}for(const i of e.transitions){const m={id:i.id,sourceDefId:i.sourceDefId,targetDefId:i.targetDefId};t.addTransition(m)}const o=new Map,s=new Map,r=e.instances.map(i=>{const m=i.id,y=i.definitionId,v=t.getNode(y);o.set(m,y),s.has(y)||s.set(y,new Set),s.get(y).add(m);let w="event";return v.kind==="policy"?w="policy":v.kind==="externalSystem"?w="externalSystem":v.kind==="externalEvent"?w="externalEvent":v.kind==="command"?w="command":v.kind==="trigger"?w="trigger":v.kind==="hotspot"&&(w="hotspot"),{id:i.id,type:w,position:i.position,data:{label:v.label,executionMode:v.executionMode,definitionId:y}}}),c=new Map,l=new Map,h=new Map;if(e.outcomes)for(const i of e.outcomes){const m=i.id,y=i.parentPolicyInstanceId,v=i.parentPolicyDefId;c.set(m,y),l.has(y)||l.set(y,new Set),l.get(y).add(m),r.push({id:i.id,type:"outcome",position:i.position,parentId:i.parentPolicyInstanceId,data:{label:i.label,parentPolicyInstanceId:y,parentPolicyDefId:v}})}if(e.outcomeEdgeMappings)for(const i of e.outcomeEdgeMappings)h.set(i.outcomeId,i.transitionId);const u=new Map,x=new Map,b=e.edgeMappings.map(i=>{const m=i.transitionId,y=`edge_${i.source}_${i.target}`;u.set(y,m),x.has(m)||x.set(m,new Set),x.get(m).add(y);const v=c.has(i.source);let w;if(v){const B=c.get(i.source);w=B?o.get(B):void 0}else w=o.get(i.source);const T=w?t.getNode(w):void 0,I=T?pt(T.kind):"floating";return{id:y,source:i.source,target:i.target,sourceHandle:i.sourceHandle??"source-right",targetHandle:i.targetHandle??"target-left",type:I,data:{state:"idle",transitionId:m,...i.label!==void 0?{label:i.label}:{},...i.labelOffset!==void 0?{labelOffset:i.labelOffset}:{}}}}),p=new Map(r.map(i=>[i.id,i])),E={instanceToDefRef:o,defToInstancesRef:s,edgeToTransitionRef:u,transitionToEdgesRef:x,outcomeToParentRef:c,policyToOutcomesRef:l,outcomeToTransitionRef:h},d=this.edgeRecovery.recoverOrphanEdges(b,t,E,p),f={instanceToDefRef:o,defToInstancesRef:s,edgeToTransitionRef:d.edgeToTransitionRef,transitionToEdgesRef:d.transitionToEdgesRef,outcomeToParentRef:c,policyToOutcomesRef:l,outcomeToTransitionRef:h};return{success:!0,workflow:{graph:t,nodes:r,edges:d.edges,mappings:f}}}catch(t){return{success:!1,error:{code:"VALIDATION_ERROR",message:"Failed to deserialize workflow",details:t}}}}}class No{constructor(){te(this,"serialization",new wo);te(this,"deserialization",new To)}serialize(e){return this.serialization.serialize(e)}deserialize(e){return this.deserialization.deserialize(e)}}const be=new Map,ko=n=>{const e=n.workflow,t=new Set(e.definitions.filter(c=>c.kind==="command"&&c.label.trim()==="").map(c=>c.id));if(t.size===0)return n;const o=new Set(e.transitions.filter(c=>t.has(c.sourceDefId)).map(c=>c.id)),s=new Set(e.instances.filter(c=>t.has(c.definitionId)).map(c=>c.id)),r=new Set(e.edgeMappings.filter(c=>o.has(c.transitionId)||s.has(c.source)||s.has(c.target)).map(c=>c.edgeId));return{...n,workflow:{...e,definitions:e.definitions.filter(c=>!t.has(c.id)),transitions:e.transitions.filter(c=>!o.has(c.id)),instances:e.instances.filter(c=>!s.has(c.id)),edgeMappings:e.edgeMappings.filter(c=>!r.has(c.edgeId))}}},Co=n=>{const e=n.metadata.name.toLowerCase().trim().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-");return{...n,metadata:{...n.metadata,slugName:e}}},_o=n=>{const t=n.metadata.targetPlugin==="none"?void 0:n.metadata.targetPlugin;return{...n,metadata:{...n.metadata,targetPlugin:t}}},Mo=n=>({...n,metadata:{...n.metadata,pluginConfig:{}}}),Io=n=>({...n,workflow:{...n.workflow,definitions:n.workflow.definitions.map(e=>({...e,kind:e.kind==="externalSystem"?"externalEvent":e.kind}))}});be.set(2,ko);be.set(3,Co);be.set(4,_o);be.set(5,Mo);be.set(6,Io);class So{migrate(e){try{let t=e;for(;t.version<Ae;){const o=be.get(t.version);if(!o)return{success:!1,error:{code:"MIGRATION_ERROR",message:`No migration found for version ${t.version}`}};t=o(t),t={...t,version:t.version+1}}return{success:!0,document:t}}catch(t){return{success:!1,error:{code:"MIGRATION_ERROR",message:"Migration failed",details:t}}}}validate(e){if(!e.version||typeof e.version!="number"||!e.metadata||!e.workflow||!Array.isArray(e.workflow.definitions)||!Array.isArray(e.workflow.transitions)||!Array.isArray(e.workflow.instances)||!Array.isArray(e.workflow.edgeMappings))return!1;for(const t of e.workflow.definitions)if(!t.id.startsWith("def_"))return!1;for(const t of e.workflow.transitions)if(!t.id.startsWith("trans_"))return!1;for(const t of e.workflow.instances)if(!t.id.startsWith("inst_"))return!1;return!0}}const Ie="arko:workflow";class Ao{async save(e){try{const t=JSON.stringify(e);return localStorage.setItem(Ie,t),{success:!0}}catch(t){return{success:!1,error:{code:"STORAGE_ERROR",message:"Failed to save to localStorage",details:t}}}}async load(){try{const e=localStorage.getItem(Ie);return e?{success:!0,document:JSON.parse(e)}:{success:!1,error:{code:"NOT_FOUND",message:"No workflow found in localStorage"}}}catch(e){return{success:!1,error:{code:"PARSE_ERROR",message:"Failed to parse stored workflow",details:e}}}}async exists(){return localStorage.getItem(Ie)!==null}async clear(){try{return localStorage.removeItem(Ie),{success:!0}}catch(e){return{success:!1,error:{code:"STORAGE_ERROR",message:"Failed to clear localStorage",details:e}}}}}const Ro="1.0",Po="https://arko.dev/ir/v1.json",Oo={id:"serverless-aws-ts",name:"Serverless / TypeScript / AWS",description:"AWS Lambda with TypeScript and Serverless Framework",nodeExtensions:{command:{timeout:30,memory:128},trigger:{timeout:30,memory:128}}},Do={id:"serverless-aws-php",name:"Serverless / PHP / AWS (Bref)",description:"AWS Lambda with PHP 8.3 and Bref.sh",nodeExtensions:{command:{timeout:30,memory:128},trigger:{timeout:30,memory:128}}},Mt=new Map([["serverless-aws-ts",Oo],["serverless-aws-php",Do]]);function jo(n){return Mt.get(n)}function Is(){return Array.from(Mt.values())}class Lo{compile(e,t){try{const{graph:o,nodes:s,mappings:r}=e,c=t.metadata.targetPlugin?jo(t.metadata.targetPlugin):void 0,l=c?this.getExtensionProviderForPlugin(c.id):void 0,h=o.getAllNodes(),u=[],x=[],b=[],p=[];for(const y of h)switch(y.kind){case"event":u.push(y);break;case"command":x.push(y);break;case"trigger":b.push(y);break;case"policy":p.push(y);break}const E=this.buildEventTypeMap(u),d=this.compileEvents(u,E),f=this.compilePolicies(p,o,s,r,E),i=this.compileCommands(x,b,o,E,f,l);return{success:!0,ir:{$schema:Po,version:Ro,metadata:{workflowId:Mn(),name:t.metadata.name,slugName:t.metadata.slugName||ie(t.metadata.name),targetPlugin:t.metadata.targetPlugin,generatedAt:new Date().toISOString(),sourceVersion:6,pluginConfig:t.metadata.pluginConfig},events:d,commands:i,policies:f}}}catch(o){return{success:!1,error:{code:"COMPILATION_ERROR",message:o instanceof Error?o.message:"Unknown compilation error",details:o}}}}getExtensionProviderForPlugin(e){if(e==="serverless-aws-ts")return{getExtensions(t,o){if(!(t.kind!=="command"&&t.kind!=="trigger")&&o)return{aws:{timeout:o.timeout,memory:o.memory}}}}}buildEventTypeMap(e){const t=new Map;for(const o of e){const s=o.config,r=(s==null?void 0:s.type)||Le(o.label);t.set(o.id,r)}return t}compileEvents(e,t){return e.map(o=>{const s=o.config;return{id:me(o.id),name:o.label,type:t.get(o.id),schema:s!=null&&s.schema?this.convertSchema(s.schema):null,outputPath:s==null?void 0:s.outputPath}})}compilePolicies(e,t,o,s,r){return e.map(c=>{var E,d,f,i;const h=t.getIncomingTransitions(c.id).map(m=>r.get(m.sourceDefId)).filter(m=>m!==void 0),u=s.defToInstancesRef.get(c.id),x=u==null?void 0:u.values().next().value,b=x?(E=s.policyToOutcomesRef)==null?void 0:E.get(x):void 0,p=[];if(b){const m=c.config;for(const y of b){const v=o.find(M=>M.id===y),w=((d=v==null?void 0:v.data)==null?void 0:d.label)||"Outcome",T=(f=m==null?void 0:m.outcomeConditions)==null?void 0:f.find(M=>M.outcomeLabel===w),I=(i=s.outcomeToTransitionRef)==null?void 0:i.get(y),B=[];if(I){const M=t.getTransition(I);if(M){const N=t.getNode(M.targetDefId);N&&(N.kind==="command"||N.kind==="trigger")&&B.push(me(N.id))}}p.push({id:me(y),label:w,condition:(T==null?void 0:T.condition)||"",targetCommandIds:B})}}return{id:me(c.id),name:c.label,slugName:ie(c.label),consumes:h,outcomes:p}})}compileCommands(e,t,o,s,r,c){const l=[];for(const h of e){const u=this.compileCommand(h,o,s,r,c);l.push(u)}for(const h of t){const u=this.compileTriggerAsCommand(h,o,s,c);u&&l.push(u)}return l}compileCommand(e,t,o,s,r){const c=e.config,h=t.getOutgoingTransitions(e.id).map(b=>o.get(b.targetDefId)).filter(b=>b!==void 0),u=this.buildConsumptions(e.id,t,o,s),x=r==null?void 0:r.getExtensions(e,e.awsExtension);return{id:me(e.id),name:e.label,slugName:(c==null?void 0:c.slugName)||ie(e.label,"unnamed"),produces:h,trigger:"consumer",consumes:u,requestSchema:c!=null&&c.requestSchema?this.convertSchema(c.requestSchema):null,extensions:x,outputPath:c==null?void 0:c.outputPath}}compileTriggerAsCommand(e,t,o,s){const r=e.config,l=t.getOutgoingTransitions(e.id).map(b=>o.get(b.targetDefId)).filter(b=>b!==void 0),h=s==null?void 0:s.getExtensions(e,e.awsExtension),u={id:me(e.id),name:e.label,slugName:(r==null?void 0:r.slugName)||ie(e.label),produces:l,extensions:h,outputPath:r==null?void 0:r.outputPath};if((r==null?void 0:r.triggerType)==="schedule"&&r.schedule)return{...u,trigger:"scheduled",schedule:r.schedule};const x=(r==null?void 0:r.path)||`/${ie(e.label)}`;return{...u,trigger:"http",http:{method:(r==null?void 0:r.httpMethod)||"POST",path:x,pathParameters:_n(x)},requestSchema:r!=null&&r.schema?this.convertSchema(r.schema):null}}buildConsumptions(e,t,o,s){const r=[],c=t.getIncomingTransitions(e);for(const l of c){const h=t.getNode(l.sourceDefId);if(h){if(h.kind==="event"){const u=o.get(h.id);u&&r.push({type:"event",eventType:u})}else if(h.kind==="policy"){const u=s.find(x=>x.id===me(h.id));if(u){const x=u.outcomes.find(b=>b.targetCommandIds.includes(me(e)));x&&r.push({type:"policy",policyId:u.id,outcomeId:x.id})}}}}return r}convertSchema(e){return{properties:e.map(t=>this.convertSchemaProperty(t))}}convertSchemaProperty(e){const t={name:e.name,required:e.required??!1};return e.type==="array"&&e.items?{...t,type:"array",items:{properties:[this.convertSchemaProperty(e.items)]}}:e.type==="object"&&e.properties?{...t,type:"object",nested:this.convertSchema(e.properties)}:{...t,type:e.type}}}const Xe={version:7,metadata:{name:"E-commerce Order",slugName:"ecommerce-order",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),description:"Example workflow demonstrating an e-commerce order flow with stock checking"},workflow:{definitions:[{id:"def_01EXAMPLE_TRIGGER",label:"Order Received",kind:"trigger",category:"technical",executionMode:"manual",config:{slugName:"order-received",triggerType:"http",httpMethod:"POST",path:"/orders"}},{id:"def_01EXAMPLE_CMD_CREATE",label:"Create Order",kind:"command",category:"business",executionMode:"automatic",config:{slugName:"create-order"}},{id:"def_01EXAMPLE_EVT_CREATED",label:"Order Created",kind:"event",category:"business",executionMode:"automatic",config:{type:"order.created"}},{id:"def_01EXAMPLE_POLICY",label:"Check Stock",kind:"policy",category:"business",executionMode:"manual",config:{type:"check-stock",outcomeConditions:[{outcomeLabel:"In Stock",condition:"item.quantity > 0"},{outcomeLabel:"Out of Stock",condition:"item.quantity === 0"}]}},{id:"def_01EXAMPLE_CMD_PAYMENT",label:"Process Payment",kind:"command",category:"business",executionMode:"automatic",config:{slugName:"process-payment"}},{id:"def_01EXAMPLE_CMD_NOTIFY",label:"Notify Out of Stock",kind:"command",category:"business",executionMode:"automatic",config:{slugName:"notify-out-of-stock"}},{id:"def_01EXAMPLE_EVT_PAYMENT",label:"Payment Processed",kind:"event",category:"business",executionMode:"automatic",config:{type:"payment.processed"}},{id:"def_01EXAMPLE_EVT_NOTIFIED",label:"Customer Notified",kind:"event",category:"business",executionMode:"automatic",config:{type:"customer.notified"}}],transitions:[{id:"trans_01EXAMPLE_T1",sourceDefId:"def_01EXAMPLE_TRIGGER",targetDefId:"def_01EXAMPLE_CMD_CREATE"},{id:"trans_01EXAMPLE_T2",sourceDefId:"def_01EXAMPLE_CMD_CREATE",targetDefId:"def_01EXAMPLE_EVT_CREATED"},{id:"trans_01EXAMPLE_T3",sourceDefId:"def_01EXAMPLE_EVT_CREATED",targetDefId:"def_01EXAMPLE_POLICY"},{id:"trans_01EXAMPLE_T4",sourceDefId:"def_01EXAMPLE_POLICY",targetDefId:"def_01EXAMPLE_CMD_PAYMENT"},{id:"trans_01EXAMPLE_T5",sourceDefId:"def_01EXAMPLE_POLICY",targetDefId:"def_01EXAMPLE_CMD_NOTIFY"},{id:"trans_01EXAMPLE_T6",sourceDefId:"def_01EXAMPLE_CMD_PAYMENT",targetDefId:"def_01EXAMPLE_EVT_PAYMENT"},{id:"trans_01EXAMPLE_T7",sourceDefId:"def_01EXAMPLE_CMD_NOTIFY",targetDefId:"def_01EXAMPLE_EVT_NOTIFIED"}],instances:[{id:"inst_01EXAMPLE_TRIGGER",definitionId:"def_01EXAMPLE_TRIGGER",position:{x:100,y:300}},{id:"inst_01EXAMPLE_CMD_CREATE",definitionId:"def_01EXAMPLE_CMD_CREATE",position:{x:320,y:300}},{id:"inst_01EXAMPLE_EVT_CREATED",definitionId:"def_01EXAMPLE_EVT_CREATED",position:{x:540,y:300}},{id:"inst_01EXAMPLE_POLICY",definitionId:"def_01EXAMPLE_POLICY",position:{x:760,y:300}},{id:"inst_01EXAMPLE_CMD_PAYMENT",definitionId:"def_01EXAMPLE_CMD_PAYMENT",position:{x:1100,y:180}},{id:"inst_01EXAMPLE_CMD_NOTIFY",definitionId:"def_01EXAMPLE_CMD_NOTIFY",position:{x:1100,y:420}},{id:"inst_01EXAMPLE_EVT_PAYMENT",definitionId:"def_01EXAMPLE_EVT_PAYMENT",position:{x:1320,y:180}},{id:"inst_01EXAMPLE_EVT_NOTIFIED",definitionId:"def_01EXAMPLE_EVT_NOTIFIED",position:{x:1320,y:420}}],edgeMappings:[{edgeId:"edge_01EXAMPLE_E1",transitionId:"trans_01EXAMPLE_T1",source:"inst_01EXAMPLE_TRIGGER",target:"inst_01EXAMPLE_CMD_CREATE"},{edgeId:"edge_01EXAMPLE_E2",transitionId:"trans_01EXAMPLE_T2",source:"inst_01EXAMPLE_CMD_CREATE",target:"inst_01EXAMPLE_EVT_CREATED"},{edgeId:"edge_01EXAMPLE_E3",transitionId:"trans_01EXAMPLE_T3",source:"inst_01EXAMPLE_EVT_CREATED",target:"inst_01EXAMPLE_POLICY"},{edgeId:"edge_01EXAMPLE_E4",transitionId:"trans_01EXAMPLE_T4",source:"outcome_01EXAMPLE_INSTOCK",target:"inst_01EXAMPLE_CMD_PAYMENT"},{edgeId:"edge_01EXAMPLE_E5",transitionId:"trans_01EXAMPLE_T5",source:"outcome_01EXAMPLE_OUTSTOCK",target:"inst_01EXAMPLE_CMD_NOTIFY"},{edgeId:"edge_01EXAMPLE_E6",transitionId:"trans_01EXAMPLE_T6",source:"inst_01EXAMPLE_CMD_PAYMENT",target:"inst_01EXAMPLE_EVT_PAYMENT"},{edgeId:"edge_01EXAMPLE_E7",transitionId:"trans_01EXAMPLE_T7",source:"inst_01EXAMPLE_CMD_NOTIFY",target:"inst_01EXAMPLE_EVT_NOTIFIED"}],outcomes:[{id:"outcome_01EXAMPLE_INSTOCK",label:"In Stock",parentPolicyInstanceId:"inst_01EXAMPLE_POLICY",parentPolicyDefId:"def_01EXAMPLE_POLICY",position:{x:162,y:-30}},{id:"outcome_01EXAMPLE_OUTSTOCK",label:"Out of Stock",parentPolicyInstanceId:"inst_01EXAMPLE_POLICY",parentPolicyDefId:"def_01EXAMPLE_POLICY",position:{x:162,y:100}}],outcomeEdgeMappings:[{outcomeId:"outcome_01EXAMPLE_INSTOCK",transitionId:"trans_01EXAMPLE_T4"},{outcomeId:"outcome_01EXAMPLE_OUTSTOCK",transitionId:"trans_01EXAMPLE_T5"}]}},Se="Untitled Workflow",Fo=1e3,It="arko:workflows";function ue(n){return n.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"workflow"}function ot(){try{const n=localStorage.getItem(It);return n?JSON.parse(n):[]}catch{return[]}}function zo(n){try{localStorage.setItem(It,JSON.stringify(n))}catch(e){console.error("Failed to save workflows to localStorage:",e)}}const $o=a.createContext(null);function Ss({children:n,initialWorkflowId:e}){const t=ze(),[o,s]=a.useState(!0),[r,c]=a.useState(null),[l,h]=a.useState(Se),[u,x]=a.useState(()=>ue(Se)),[b,p]=a.useState(void 0),[E,d]=a.useState({}),[f,i]=a.useState(null),[m,y]=a.useState(null),[v,w]=a.useState(!1),T=a.useRef(null),I=a.useCallback(S=>{h(C=>(x(V=>V===ue(C)?ue(S):V),S))},[]),B=a.useCallback(S=>{x(S)},[]),M=a.useRef(new No),N=a.useRef(new So),W=a.useRef(new Ao),O=a.useRef(new Gt),A=a.useRef(new Lo),$=a.useRef(void 0),j=a.useRef(!1),k=a.useRef(!1),_=a.useCallback(S=>{const C=M.current.deserialize(S.workflow);return C.success?(t.hydrateWorkflow(C.workflow),h(S.metadata.name),x(S.metadata.slugName||ue(S.metadata.name)),p(S.metadata.targetPlugin),d(S.metadata.pluginConfig??{}),i(S.metadata.createdAt),!0):!1},[t]);a.useEffect(()=>{(async()=>{try{const C=await W.current.load();if(C.success){if(!N.current.validate(C.document)){console.warn("Invalid workflow document in localStorage, loading example instead"),_(Xe),s(!1);return}const V=N.current.migrate(C.document);V.success&&_(V.document)}else console.info("No saved workflow found, loading example workflow"),_(Xe)}catch(C){console.error("Failed to load workflow from localStorage:",C),_(Xe)}finally{s(!1)}})()},[]);const L=a.useCallback(async()=>{const S=t.getWorkflowState(),C=M.current.serialize(S);if(!C.success)return{success:!1,error:C.error};const V=new Date().toISOString(),K={version:Ae,metadata:{name:l,slugName:u,targetPlugin:b,pluginConfig:E,createdAt:f||V,updatedAt:V},workflow:C.workflow};return f||i(V),W.current.save(K)},[t,l,u,b,E,f]),{nodes:F,edges:z}=t;a.useEffect(()=>{if(!o){if(!j.current){j.current=!0;return}return $.current&&clearTimeout($.current),$.current=setTimeout(()=>{L()},Fo),()=>{$.current&&clearTimeout($.current)}}},[F,z,l,u,b,E,L,o]);const P=a.useCallback(()=>{const S=t.getWorkflowState(),C=M.current.serialize(S);if(!C.success)return{success:!1,error:C.error};const V=new Date().toISOString(),K={version:Ae,metadata:{name:l,slugName:u,targetPlugin:b,pluginConfig:E,createdAt:f||V,updatedAt:V},workflow:C.workflow},ne=`${u||ue(l)}.json`;return O.current.exportToFile(K,ne)},[t,l,u,b,E,f]),G=a.useCallback(()=>{const S=t.getWorkflowState(),C=new Date().toISOString();return A.current.compile(S,{metadata:{name:l,slugName:u||ue(l),targetPlugin:b,pluginConfig:E,createdAt:f||C,updatedAt:C}})},[t,l,u,b,E,f]),X=a.useCallback(()=>{const S=t.getWorkflowState(),C=M.current.serialize(S);if(!C.success)throw new Error(C.error.message);const V=new Date().toISOString();return{version:Ae,metadata:{name:l,slugName:u||ue(l),targetPlugin:b,pluginConfig:E,createdAt:f||V,updatedAt:V},workflow:C.workflow}},[t,l,u,b,E,f]),H=a.useCallback(async()=>{const S=await O.current.importFromFile();if(!S.success)return S;if(!N.current.validate(S.document))return{success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid workflow file format"}};const C=N.current.migrate(S.document);if(!C.success)return{success:!1,error:C.error};const V=M.current.deserialize(C.document.workflow);return V.success?(t.hydrateWorkflow(V.workflow),h(C.document.metadata.name),x(C.document.metadata.slugName||ue(C.document.metadata.name)),p(C.document.metadata.targetPlugin),d(C.document.metadata.pluginConfig??{}),i(C.document.metadata.createdAt),await W.current.save(C.document),{success:!0,document:C.document}):{success:!1,error:V.error}},[t]),Y=a.useCallback(async()=>(h(Se),x(ue(Se)),p(void 0),d({}),i(null),y(null),w(!1),T.current=null,W.current.clear()),[]),U=a.useCallback(S=>JSON.stringify({workflow:S.workflow,name:S.metadata.name,slugName:S.metadata.slugName,targetPlugin:S.metadata.targetPlugin,pluginConfig:S.metadata.pluginConfig}),[]),Z=a.useCallback(async()=>{const S=X();try{const C=ot(),V=new Date().toISOString();if(m){const K=C.findIndex(ne=>ne.id===m);K!==-1&&(C[K]={...C[K],document:S,updatedAt:V})}else console.warn("saveToApi called without currentWorkflowId");return zo(C),T.current=U(S),w(!1),{success:!0}}catch(C){return{success:!1,error:{code:"STORAGE_ERROR",message:C instanceof Error?C.message:"Failed to save workflow"}}}},[X,m,U]),Q=a.useCallback(async S=>{try{const V=ot().find(se=>se.id===S);if(!V)return{success:!1,error:{code:"NOT_FOUND",message:"Workflow not found"}};if(!N.current.validate(V.document))return{success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid workflow document"}};const K=N.current.migrate(V.document);return K.success?_(K.document)?(y(V.id),T.current=U(K.document),w(!1),await W.current.save(K.document),{success:!0,document:K.document}):{success:!1,error:{code:"PARSE_ERROR",message:"Failed to hydrate workflow"}}:{success:!1,error:K.error}}catch(C){return{success:!1,error:{code:"STORAGE_ERROR",message:C instanceof Error?C.message:"Failed to load workflow"}}}},[_,U]);return a.useEffect(()=>{if(o||T.current!==null||m!==null)return;const S=X();T.current=U(S)},[o,m,X,U]),a.useEffect(()=>{if(o||!j.current||T.current===null)return;const S=X(),C=U(S);w(C!==T.current)},[F,z,l,u,b,E,o,X,U]),a.useEffect(()=>{o||e&&!k.current&&(k.current=!0,s(!0),c(null),Q(e).then(S=>{S.success||(console.error("Failed to load workflow from URL:",S.error.message),c(S.error))}).finally(()=>{s(!1)}))},[o,e,Q]),g.jsx($o.Provider,{value:{isLoading:o,loadError:r,workflowName:l,setWorkflowName:I,slugName:u,setSlugName:B,targetPlugin:b,setTargetPlugin:p,pluginConfig:E,setPluginConfig:d,saveToLocalStorage:L,exportToFile:P,exportToIR:G,getWorkflowDocument:X,importFromFile:H,clearStorage:Y,currentWorkflowId:m,isDirty:v,saveToApi:Z,loadFromApi:Q,hydrateDocument:_},children:n})}function As({open:n,onOpenChange:e,onConfirm:t,title:o,description:s,confirmLabel:r="Confirmer",cancelLabel:c="Annuler"}){const l=()=>{t(),e(!1)};return g.jsx(Ht,{open:n,onOpenChange:e,children:g.jsxs(Ut,{children:[g.jsxs(qt,{children:[g.jsx(Yt,{children:o}),g.jsx(Kt,{children:s})]}),g.jsxs(Qt,{children:[g.jsx(Jt,{children:c}),g.jsx(Zt,{onClick:l,children:r})]})]})})}const St=10,De=50;function Wo(n,e){const t=a.useRef([]);return a.useEffect(()=>()=>{t.current.forEach(clearTimeout)},[]),{execute:a.useCallback((s,r)=>{const{isRunning:c,start:l,triggerNode:h,selectTransition:u}=n;if(t.current.forEach(clearTimeout),t.current=[],e!=null&&e.isSourceWaiting)u(r);else if(c){h(s);const x=setTimeout(()=>{u(r)},De);t.current.push(x)}else{l();const x=setTimeout(()=>{h(s);const b=setTimeout(()=>{u(r)},De);t.current.push(b)},St);t.current.push(x)}},[n,e==null?void 0:e.isSourceWaiting])}}function Rs(n){const e=a.useRef([]);return a.useEffect(()=>()=>{e.current.forEach(clearTimeout)},[]),{execute:a.useCallback(o=>{const{isRunning:s,start:r,triggerNode:c,completeManualNode:l}=n;if(e.current.forEach(clearTimeout),e.current=[],s){c(o);const h=setTimeout(()=>{l(o)},De);e.current.push(h)}else{r();const h=setTimeout(()=>{c(o);const u=setTimeout(()=>{l(o)},De);e.current.push(u)},St);e.current.push(h)}},[n])}}function Xo({ref:n,onClose:e,enabled:t=!0,listenEscape:o=!0,listenClickOutside:s=!0}){a.useEffect(()=>{if(!t)return;const r=h=>{n.current&&!n.current.contains(h.target)&&e()},c=h=>{h.key==="Escape"&&e()},l=setTimeout(()=>{s&&document.addEventListener("mousedown",r),o&&document.addEventListener("keydown",c)},0);return()=>{clearTimeout(l),s&&document.removeEventListener("mousedown",r),o&&document.removeEventListener("keydown",c)}},[n,e,t,o,s])}function Ps(n,e=!0){a.useEffect(()=>{if(!e)return;const t=o=>{o.key==="Escape"&&n()};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[n,e])}function Os(){const n=xe(o=>o.sidebarCollapsed),e=xe(o=>o.setSidebarCollapsed),t=xe(o=>o.toggleSidebar);return{collapsed:n,setCollapsed:e,toggleCollapsed:t}}const he={event:{gradient:"gradient-event",rotate:"rotate-event",selected:"node-selected-event",pulse:"animate-pulse-event"},command:{gradient:"gradient-command",rotate:"rotate-command",selected:"node-selected-command",pulse:"animate-pulse-command"},policy:{gradient:"gradient-policy",rotate:"rotate-policy",selected:"node-selected-policy",pulse:"animate-pulse-policy"},trigger:{gradient:"gradient-trigger",rotate:"rotate-trigger",selected:"node-selected-trigger",pulse:"animate-pulse-trigger"},externalSystem:{gradient:"gradient-external",rotate:"rotate-external-system",selected:"node-selected-external",pulse:"animate-pulse-external"},externalEvent:{gradient:"gradient-external",rotate:"rotate-external-event",selected:"node-selected-external",pulse:"animate-pulse-external"},hotspot:{gradient:"gradient-hotspot",rotate:"rotate-hotspot",selected:"node-selected-hotspot"}};function Bo({text:n,maxWidth:e,maxHeight:t,minFontSize:o=8,maxFontSize:s=18}){return a.useMemo(()=>{if(!n||e<=0||t<=0)return{fontSize:s};const r=document.createElement("div");r.style.cssText=`
      position: absolute;
      left: -9999px;
      top: -9999px;
      width: ${e}px;
      height: ${t}px;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
      font-weight: 400;
      line-height: 1.3;
      white-space: pre-wrap;
      word-wrap: break-word;
      text-align: center;
      box-sizing: border-box;
    `,r.textContent=n,document.body.appendChild(r);let c=o;for(let l=s;l>=o;l--){r.style.fontSize=`${l}px`;const h=r.scrollHeight<=r.clientHeight,u=r.scrollWidth<=r.clientWidth;if(h&&u){c=l;break}}return document.body.removeChild(r),{fontSize:c}},[n,e,t,o,s])}const Vo=128,Go=78,ce=a.memo(a.forwardRef(function({value:e,onChange:t,className:o,placeholder:s="Label",maxWidth:r=Vo,maxHeight:c=Go,minFontSize:l=8,maxFontSize:h=18,autoSize:u=!1,onEditEnd:x},b){const[p,E]=a.useState(!1),d=a.useRef(null),{fontSize:f}=Bo({text:u?"":e||s,maxWidth:r,maxHeight:c,minFontSize:l,maxFontSize:h});a.useImperativeHandle(b,()=>({startEditing:()=>E(!0)}),[]),a.useEffect(()=>{if(p&&d.current){d.current.focus();const M=window.getSelection(),N=document.createRange();N.selectNodeContents(d.current),M==null||M.removeAllRanges(),M==null||M.addRange(N)}},[p]);const i=a.useCallback(M=>{M.stopPropagation(),E(!0)},[]),m=a.useCallback(()=>{var N;if(!d.current)return;const M=((N=d.current.textContent)==null?void 0:N.trim())||"";M!==e&&t(M),E(!1),x==null||x(M)},[e,t,x]),y=a.useCallback(()=>{d.current&&(d.current.textContent=e),E(!1),x==null||x(e)},[e,x]),v=a.useCallback(M=>{M.key==="Enter"&&!M.shiftKey?(M.preventDefault(),m()):M.key==="Escape"&&(M.preventDefault(),y())},[m,y]),w=a.useCallback(()=>{m()},[m]),T=a.useCallback(M=>{p&&M.stopPropagation()},[p]),I=a.useCallback(M=>{p&&M.stopPropagation()},[p]),B=u?void 0:{fontSize:`${f}px`};return g.jsx("span",{ref:d,className:q("flex items-center text-center font-normal text-[0.75rem] whitespace-pre-wrap leading-[1.3] break-words overflow-hidden flex-1 min-w-[4em] min-h-[1.3em] text-postit-text","cursor-text",p&&"outline-none bg-black/20 rounded px-1.5 py-0.5 shadow-[0_0_0_1px_rgba(255,255,255,0.4)] nodrag nopan",o),style:B,contentEditable:p,suppressContentEditableWarning:!0,onDoubleClick:i,onKeyDown:p?v:void 0,onBlur:p?w:void 0,onMouseDown:T,onClick:I,children:e})})),Ds=a.memo(function({label:e,selected:t,isCompleted:o,isActive:s,isTargetConnectable:r,isSourceConnectable:c,onLabelChange:l,placeholder:h="Event",instanceCount:u,isOriginal:x,toolbar:b,quickCreateButtons:p}){const E=he.event;return g.jsxs("div",{className:q("node-postit",E.gradient,E.rotate,"w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&`node-selected ${E.selected}`,o&&"bg-success! node-completed",s&&E.pulse,u&&u>1&&!x&&"texture-diagonal-clone"),children:[b,p,g.jsx(D,{type:"target",position:R.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:r}),g.jsx(D,{type:"target",position:R.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:r}),g.jsx(D,{type:"target",position:R.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:r}),g.jsx(D,{type:"target",position:R.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:r}),g.jsx(D,{type:"source",position:R.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:c}),g.jsx(D,{type:"source",position:R.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:c}),g.jsx(D,{type:"source",position:R.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:c}),g.jsx(D,{type:"source",position:R.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:c}),g.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ce,{value:e,onChange:l,placeholder:h})}),u&&u>1&&g.jsx("div",{className:"absolute top-1 left-1 flex items-center gap-1 z-10",children:g.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${u} instances share this definition`,children:[g.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[g.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),g.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),u]})})]})}),js=a.memo(function({label:e,selected:t,isCompact:o,isCompleted:s,isActive:r,isWaiting:c,isTargetConnectable:l,isSourceConnectable:h,onLabelChange:u,onDoubleClick:x,onEditEnd:b,labelRef:p,placeholder:E="Command",instanceCount:d,isOriginal:f,toolbar:i,quickCreateButtons:m}){const y=he.command;return g.jsxs("div",{className:q("node-postit",y.gradient,y.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5":"w-[152px]",t&&`node-selected ${y.selected}`,s&&"bg-success! node-completed",r&&"animate-pulse-success",c&&y.pulse,d&&d>1&&!f&&"texture-diagonal-clone"),onDoubleClick:x,children:[i,m,g.jsx(D,{type:"target",position:R.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(D,{type:"target",position:R.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(D,{type:"target",position:R.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(D,{type:"target",position:R.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(D,{type:"source",position:R.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(D,{type:"source",position:R.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(D,{type:"source",position:R.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx(D,{type:"source",position:R.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ce,{ref:p,value:e,onChange:u,placeholder:E,onEditEnd:b})}),d&&d>1&&g.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex items-center gap-1 z-10",children:g.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${d} instances share this definition`,children:[g.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[g.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),g.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),d]})})]})}),Ls=a.memo(function({label:e,selected:t,isCompleted:o,isActive:s,isWaiting:r,isTargetConnectable:c,isSourceConnectable:l,onLabelChange:h,placeholder:u="Policy",instanceCount:x,isOriginal:b,toolbar:p,quickCreateButtons:E,children:d}){const f=he.policy;return g.jsxs("div",{className:q("node-postit",f.gradient,f.rotate,"w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&`node-selected ${f.selected}`,o&&"bg-success! node-completed",s&&"animate-pulse-success",r&&f.pulse,x&&x>1&&!b&&"texture-diagonal-clone"),children:[p,E,g.jsx(D,{type:"target",position:R.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:c}),g.jsx(D,{type:"target",position:R.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:c}),g.jsx(D,{type:"target",position:R.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:c}),g.jsx(D,{type:"target",position:R.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:c}),l!==void 0&&g.jsxs(g.Fragment,{children:[g.jsx(D,{type:"source",position:R.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(D,{type:"source",position:R.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(D,{type:"source",position:R.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(D,{type:"source",position:R.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:l})]}),g.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ce,{value:e,onChange:h,placeholder:u})}),x&&x>1&&g.jsx("div",{className:"absolute top-1 left-1 flex items-center gap-1 z-10",children:g.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${x} instances share this definition`,children:[g.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[g.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),g.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),x]})}),d]})}),Fs=a.memo(function({label:e,selected:t,isCompact:o,isCompleted:s,isActive:r,isWaiting:c,isTargetConnectable:l,isSourceConnectable:h,onLabelChange:u,onDoubleClick:x,onEditEnd:b,labelRef:p,placeholder:E="Trigger",instanceCount:d,isOriginal:f,toolbar:i,quickCreateButtons:m,playButton:y}){const v=he.trigger;return g.jsxs("div",{className:q("node-postit",v.gradient,v.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5 [&_.play-btn]:right-auto [&_.play-btn]:left-1/2 [&_.play-btn]:-translate-x-1/2":"w-[152px]",t&&`node-selected ${v.selected}`,s&&"bg-success! node-completed",r&&"animate-pulse-success",c&&v.pulse,d&&d>1&&!f&&"texture-diagonal-clone"),onDoubleClick:x,children:[i,m,g.jsx(D,{type:"target",position:R.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(D,{type:"target",position:R.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(D,{type:"target",position:R.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(D,{type:"target",position:R.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(D,{type:"source",position:R.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(D,{type:"source",position:R.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(D,{type:"source",position:R.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx(D,{type:"source",position:R.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ce,{ref:p,value:e,onChange:u,placeholder:E,onEditEnd:b})}),y,d&&d>1&&g.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex items-center gap-1 z-10",children:g.jsxs("span",{className:"flex items-center gap-[3px] text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white font-semibold cursor-help",title:`${d} instances share this definition`,children:[g.jsxs("svg",{className:"w-2.5 h-2.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[g.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),g.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]}),d]})})]})}),zs=a.memo(function({label:e,selected:t,isCompact:o,isCompleted:s,isActive:r,isWaiting:c,isTargetConnectable:l,isSourceConnectable:h,onLabelChange:u,onDoubleClick:x,onEditEnd:b,labelRef:p,placeholder:E="External System",instanceCount:d,toolbar:f,quickCreateButtons:i,playButton:m}){const y=he.externalSystem;return g.jsxs("div",{className:q("node-postit",y.gradient,y.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5 [&_.play-btn]:right-auto [&_.play-btn]:left-1/2 [&_.play-btn]:-translate-x-1/2":"w-[152px]",t&&`node-selected ${y.selected}`,s&&"bg-success! node-completed",r&&"animate-pulse-success",c&&y.pulse),onDoubleClick:x,children:[f,i,g.jsx(D,{type:"target",position:R.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(D,{type:"target",position:R.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(D,{type:"target",position:R.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(D,{type:"target",position:R.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(D,{type:"source",position:R.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(D,{type:"source",position:R.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(D,{type:"source",position:R.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx(D,{type:"source",position:R.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ce,{ref:p,value:e,onChange:u,placeholder:E,onEditEnd:b})}),m,d&&d>1&&g.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex gap-[3px] z-10",children:g.jsxs("span",{className:"text-[0.4rem] px-[5px] py-0.5 rounded-[3px] bg-black/30 text-white/80 font-semibold tracking-[0.3px] cursor-help",title:`${d} instances share this definition`,children:["x",d]})})]})}),$s=a.memo(function({label:e,selected:t,isCompact:o,isCompleted:s,isActive:r,isWaiting:c,isTargetConnectable:l,isSourceConnectable:h,onLabelChange:u,onDoubleClick:x,onEditEnd:b,labelRef:p,placeholder:E="External Event",instanceCount:d,toolbar:f,quickCreateButtons:i,playButton:m}){const y=he.externalEvent;return g.jsxs("div",{className:q("node-postit",y.gradient,y.rotate,"h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",o?"w-8 [&_.node-content]:hidden [&_.top-left-tags]:hidden [&::before]:left-[10%] [&::before]:right-[10%] [&::before]:h-1.5 [&_.play-btn]:right-auto [&_.play-btn]:left-1/2 [&_.play-btn]:-translate-x-1/2":"w-[152px]",t&&`node-selected ${y.selected}`,s&&"bg-success! node-completed",r&&"animate-pulse-success",c&&y.pulse),onDoubleClick:x,children:[f,i,g.jsx(D,{type:"target",position:R.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(D,{type:"target",position:R.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:l}),g.jsx(D,{type:"target",position:R.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(D,{type:"target",position:R.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:l}),g.jsx(D,{type:"source",position:R.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(D,{type:"source",position:R.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:h}),g.jsx(D,{type:"source",position:R.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx(D,{type:"source",position:R.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:h}),g.jsx("div",{className:"node-content p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ce,{ref:p,value:e,onChange:u,placeholder:E,onEditEnd:b})}),m,d&&d>1&&g.jsx("div",{className:"top-left-tags absolute top-1 left-1 flex gap-[3px] z-10",children:g.jsxs("span",{className:"text-[0.4rem] px-[5px] py-0.5 rounded-[3px] bg-black/30 text-white/80 font-semibold tracking-[0.3px] cursor-help",title:`${d} instances share this definition`,children:["x",d]})})]})}),Ws=a.memo(function({label:e,selected:t,description:o,onLabelChange:s,placeholder:r="HotSpot",instanceCount:c,toolbar:l}){const h=he.hotspot;return g.jsxs("div",{className:q("node-postit",h.gradient,h.rotate,"w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&`node-selected ${h.selected}`),children:[l,g.jsxs("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:[g.jsx(ce,{value:e,onChange:s,placeholder:r}),o&&g.jsx("div",{className:"text-[0.6rem] text-black/70 mt-1 text-center overflow-hidden line-clamp-2 leading-[1.2]",children:o})]}),c&&c>1&&g.jsx("div",{className:"absolute top-1 left-1 flex gap-[3px] z-10",children:g.jsxs("span",{className:"text-[0.4rem] px-[5px] py-0.5 rounded-[3px] bg-black/30 text-white/80 font-semibold tracking-[0.3px] cursor-help",title:`${c} instances share this definition`,children:["x",c]})})]})}),Xs=a.memo(function({label:e,selected:t,isCompleted:o,isActive:s,isTargetConnectable:r,isSourceConnectable:c,onLabelChange:l,placeholder:h="Actor",toolbar:u,quickCreateButtons:x}){return g.jsxs("div",{className:q("node-postit gradient-actor rotate-actor","w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&"node-selected node-selected-actor",o&&"bg-success! node-completed",s&&"animate-pulse-actor"),children:[u,x,r!==void 0&&g.jsxs(g.Fragment,{children:[g.jsx(D,{type:"target",position:R.Top,id:"target-top",className:"node-handle node-handle-horizontal",isConnectable:r}),g.jsx(D,{type:"target",position:R.Bottom,id:"target-bottom",className:"node-handle node-handle-horizontal",isConnectable:r}),g.jsx(D,{type:"target",position:R.Left,id:"target-left",className:"node-handle node-handle-vertical",isConnectable:r}),g.jsx(D,{type:"target",position:R.Right,id:"target-right",className:"node-handle node-handle-vertical",isConnectable:r})]}),c!==void 0&&g.jsxs(g.Fragment,{children:[g.jsx(D,{type:"source",position:R.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:c}),g.jsx(D,{type:"source",position:R.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:c}),g.jsx(D,{type:"source",position:R.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:c}),g.jsx(D,{type:"source",position:R.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:c})]}),g.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ce,{value:e,onChange:l,placeholder:h})})]})}),Bs=a.memo(function({label:e,selected:t,onLabelChange:o,placeholder:s="Note",toolbar:r}){return g.jsxs("div",{className:q("node-postit gradient-note rotate-note","w-[152px] h-[112px] p-3 flex items-center justify-center","transition-shadow duration-200 hover:scale-[1.02]",t&&"node-selected node-selected-note"),children:[r,g.jsx("div",{className:"p-0 text-center w-full h-full flex flex-col items-center justify-center",children:g.jsx(ce,{value:e,onChange:o,placeholder:s})})]})}),Ho=200,Uo=150,Vs=a.memo(function({label:e,selected:t,onLabelChange:o,onResizeStart:s,onResize:r,onResizeEnd:c,placeholder:l="Group",toolbar:h,children:u}){const{zoom:x}=on(),b=a.useRef(null),p=a.useRef(null),E=Math.min(8,Math.max(.7,1/x));return a.useEffect(()=>{if(b.current&&p.current){p.current.textContent=e||l;const d=p.current.offsetWidth;b.current.style.width=`${Math.max(60,d+4)}px`}},[e,l]),g.jsxs("div",{className:q("relative w-full h-full rounded-lg","border-[1.5px] border-[rgba(139,92,246,0.5)]"),style:{background:"radial-gradient(ellipse at center, transparent 30%, rgba(139,92,246,0.06) 100%)"},children:[g.jsx(sn,{minWidth:Ho,minHeight:Uo,isVisible:!0,lineClassName:"group-resize-line !z-[1000]",handleClassName:"group-resize-handle !z-[1000]",onResizeStart:()=>s==null?void 0:s(),onResize:(d,f)=>r==null?void 0:r(f.width,f.height),onResizeEnd:(d,f)=>c==null?void 0:c(f.width,f.height)}),h,g.jsxs("div",{className:q("absolute z-10 origin-bottom-left"),style:{top:`${-10*E-20}px`,left:"8px",transform:`scale(${E})`},children:[g.jsx("span",{ref:p,className:"absolute invisible whitespace-pre text-sm font-semibold","aria-hidden":"true"}),g.jsx("input",{ref:b,type:"text",value:e,onChange:d=>o(d.target.value),placeholder:l,className:q("bg-transparent border-none outline-none","text-sm font-semibold","min-w-[60px]","text-[rgba(139,92,246,0.7)] placeholder:text-[rgba(139,92,246,0.4)]")})]}),g.jsx("div",{className:"w-full h-full pointer-events-none",children:u})]})}),Gs="w-4 h-4",Hs=10,qo=q("w-7 h-7 rounded-md flex items-center justify-center","border-none cursor-pointer","transition-all duration-150","hover:scale-110 active:scale-95","focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-text-primary"),Yo=q("p-1.5 rounded","transition-colors","focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1"),Us=q("flex items-center gap-1.5 p-1.5 rounded-lg","bg-bg-secondary/95 backdrop-blur-sm","border border-border shadow-[var(--shadow-toolbar)]"),qs=q("flex gap-1 bg-white rounded-lg shadow-lg p-1 border border-gray-200","dark:bg-bg-secondary dark:border-border");function Ys(n){return q(qo,{default:"bg-text-muted/20 text-text-secondary hover:bg-text-muted/30",danger:"bg-danger/20 text-danger hover:bg-danger/30",info:"bg-info/20 text-info hover:bg-info/30",accent:"bg-accent/20 text-accent hover:bg-accent/30",event:"bg-node-event/20 text-node-event hover:bg-node-event/30",trigger:"bg-node-trigger/20 text-node-trigger hover:bg-node-trigger/30",command:"bg-node-command/20 text-node-command hover:bg-node-command/30"}[n])}function Ks(n){return q(Yo,{default:"text-gray-500 hover:bg-gray-50 hover:text-gray-700 dark:hover:bg-text-muted/20 dark:hover:text-text-primary",danger:"text-gray-500 hover:bg-red-50 hover:text-red-500 dark:hover:bg-danger/20 dark:hover:text-danger",purple:"text-gray-500 hover:bg-purple-50 hover:text-purple-500 dark:hover:bg-node-policy/20 dark:hover:text-node-policy"}[n])}function Ko(){const{getNode:n}=Te(),{addNode:e,onConnect:t}=ze(),o=a.useCallback((r,c=!1)=>{const h=Ve[c?"policy":r];return h?[...h.canConnectTo]:[]},[]),s=a.useCallback((r,c,l)=>{var i,m;const h=n(r);if(!h)return;const u=h.parentId?n(h.parentId):void 0,x=Fn(h.position,u==null?void 0:u.position),b=((i=h.measured)==null?void 0:i.width)??Bn,p=((m=h.measured)==null?void 0:m.height)??Vn,E=Un(x,b,p,l),d=e(c,E),f=Hn(l);t({source:r,target:d,sourceHandle:f.source,targetHandle:f.target})},[n,e,t]);return{getValidTargetTypes:o,createConnectedNode:s}}const Qo={event:{label:"Event",Icon:ut},command:{label:"Command",Icon:wn},policy:{label:"Policy",Icon:un},trigger:{label:"Trigger",Icon:Ge},externalSystem:{label:"Ext System",Icon:Ue},externalEvent:{label:"Ext Event",Icon:Ue}},Jo={event:"bg-node-event text-postit-text",command:"bg-[#3b82f6] text-white",policy:"bg-node-policy text-postit-text",trigger:"bg-node-trigger text-postit-text",externalSystem:"bg-node-external text-postit-text",externalEvent:"bg-node-external text-postit-text"};function Zo({validTypes:n,anchorPosition:e,direction:t,onSelect:o,onClose:s,typeConfig:r,getIconColorClass:c}){const l=a.useRef(null);Xo({ref:l,onClose:s});const u=a.useCallback(()=>{const i=n.length*44+8,m=10,y=8;let v,w;switch(t){case"top":v=e.x-180/2,w=e.y-i-y;break;case"bottom":v=e.x-180/2,w=e.y+y;break;case"left":v=e.x-180-y,w=e.y-i/2;break;case"right":v=e.x+y,w=e.y-i/2;break}return v+180>window.innerWidth-m&&(v=window.innerWidth-180-m),w+i>window.innerHeight-m&&(w=window.innerHeight-i-m),v<m&&(v=m),w<m&&(w=m),{x:v,y:w}},[e,t,n.length])(),x=a.useMemo(()=>{if(!n.includes("event"))return n;const f=n.filter(m=>m!=="event"),i=Math.floor(f.length/2);return[...f.slice(0,i),"event",...f.slice(i)]},[n]),b=a.useCallback(f=>{o(f),s()},[o,s]),p=a.useCallback(f=>r&&f in r?r[f]:Qo[f]??{label:f,Icon:ut},[r]),E=a.useCallback(f=>c?c(f):Jo[f]??"bg-gray-500 text-white",[c]);if(x.length===0)return null;const d=g.jsx("div",{ref:l,className:q("fixed bg-bg-secondary border border-border rounded-lg","shadow-[0_4px_16px_rgba(0,0,0,0.3)] p-1 z-[10000] min-w-[160px]","animate-zoom-in","light:bg-white light:shadow-[0_4px_16px_rgba(0,0,0,0.15)]"),style:{left:u.x,top:u.y},children:x.map(f=>{const i=p(f);return g.jsxs("button",{className:q("flex items-center gap-2.5 py-2 px-3 rounded-md","cursor-pointer transition-colors duration-100","text-text-primary border-none bg-transparent w-full text-[13px]","hover:bg-bg-tertiary active:scale-[0.98]"),onClick:()=>b(f),children:[g.jsx("span",{className:q("w-6 h-6 rounded flex items-center justify-center shrink-0","[&_svg]:w-3.5 [&_svg]:h-3.5",E(f)),children:g.jsx(i.Icon,{})}),g.jsx("span",{className:"flex-1 text-left",children:i.label})]},f)})});return rn.createPortal(d,document.body)}const es=a.memo(Zo),ts=a.memo(function({outcomeId:e,canDelete:t,onDelete:o}){const s=a.useCallback(r=>{r.stopPropagation(),t&&o(e)},[e,t,o]);return g.jsx(an,{position:R.Top,offset:10,className:q("flex items-center gap-1.5 p-1.5 rounded-lg","bg-bg-secondary/95 backdrop-blur-sm","border border-border shadow-[var(--shadow-toolbar)]"),children:g.jsx("button",{className:q("w-7 h-7 rounded-md flex items-center justify-center","border-none cursor-pointer transition-all duration-150","hover:scale-110 active:scale-95","bg-danger/20 text-danger hover:bg-danger/30","disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"),onClick:s,disabled:!t,title:t?"Delete outcome":"Cannot delete - minimum 2 outcomes required",children:g.jsx(en,{className:"w-4 h-4"})})})}),Qs=a.memo(function({id:e,data:t,selected:o}){const s=cn(),r=o||s.inProgress,{state:c,selectTransition:l,isRunning:h,start:u,triggerNode:x}=bo(),{getOutcomeTransition:b,updateOutcomeLabel:p,deleteOutcome:E,getOutcomesForPolicy:d}=ze(),i=(t.parentPolicyDefId?c==null?void 0:c.nodeStates.get(t.parentPolicyDefId):void 0)==="waiting_for_action",m=e,y=b(m),v=!!y,T=d(t.parentPolicyInstanceId).length>2,I=a.useCallback(N=>{T&&E(N)},[T,E]),B=a.useCallback(N=>{N.stopPropagation(),!(!y||!t.parentPolicyDefId)&&(i?l(y):h?(x(t.parentPolicyDefId),setTimeout(()=>{l(y)},50)):(u(),setTimeout(()=>{x(t.parentPolicyDefId),setTimeout(()=>{l(y)},50)},10)))},[y,t.parentPolicyDefId,i,h,u,x,l]),M=a.useCallback(N=>{p(e,N)},[e,p]);return g.jsxs("div",{className:q("gradient-outcome border border-node-policy/50 rounded-md","w-auto h-auto min-w-[50px] min-h-8 p-0","shadow-[0_2px_4px_rgba(0,0,0,0.3)] transition-all duration-200","hover:scale-[1.02]",o&&"node-selected node-selected-outcome shadow-[0_0_8px_rgba(147,51,234,0.8)] border-node-policy",i&&"gradient-outcome-clickable border-node-policy cursor-pointer animate-pulse-outcome hover:scale-[1.08] hover:shadow-[0_0_12px_rgba(147,51,234,0.9)]"),children:[g.jsx(ts,{outcomeId:m,canDelete:T,onDelete:I}),o&&g.jsx(is,{instanceId:m,nodeType:"policy",isOutcome:!0}),g.jsx(D,{type:"source",position:R.Top,id:"source-top",className:"node-handle node-handle-horizontal",isConnectable:r}),g.jsx(D,{type:"source",position:R.Bottom,id:"source-bottom",className:"node-handle node-handle-horizontal",isConnectable:r}),g.jsx(D,{type:"source",position:R.Left,id:"source-left",className:"node-handle node-handle-vertical",isConnectable:r}),g.jsx(D,{type:"source",position:R.Right,id:"source-right",className:"node-handle node-handle-vertical",isConnectable:r}),g.jsxs("div",{className:"flex flex-row items-center gap-1.5 py-1 px-2",children:[g.jsx("button",{className:q("w-[18px] h-[18px] rounded-full border flex items-center justify-center","shadow-[0_1px_3px_rgba(0,0,0,0.2)] transition-all duration-200 p-0 outline-none shrink-0",v?"bg-node-policy border-white/30 text-white cursor-pointer hover:scale-[1.15] hover:bg-[#a855f7] hover:border-white/50":"bg-node-policy/40 border-white/20 text-white/50 cursor-default"),onClick:B,disabled:!v,title:v?i?`Select ${t.label}`:`Trigger from ${t.label}`:"Connect this outcome to enable",children:g.jsx(Ge,{className:"w-2.5 h-2.5"})}),g.jsx(ce,{value:t.label,onChange:M,placeholder:"Outcome",autoSize:!0,className:"text-white [.light_&]:text-postit-text"})]})]})}),ns=["right"];function os(n){switch(n){case"top":return"top-[-28px] left-1/2 -translate-x-1/2 hover:-translate-x-1/2";case"right":return"right-[-28px] top-1/2 -translate-y-1/2 hover:-translate-y-1/2";case"bottom":return"bottom-[-28px] left-1/2 -translate-x-1/2 hover:-translate-x-1/2";case"left":return"left-[-28px] top-1/2 -translate-y-1/2 hover:-translate-y-1/2"}}function ss(n){return q("absolute rounded-full border-2 border-border","cursor-pointer flex items-center justify-center text-sm font-bold","pointer-events-auto p-0 transition-all duration-150 z-[5]","shadow-[0_2px_4px_rgba(0,0,0,0.3)]","focus:outline-none focus-visible:outline-2 focus-visible:outline-text-primary focus-visible:outline-offset-2","hover:scale-[1.2] hover:shadow-[0_3px_8px_rgba(0,0,0,0.4)] active:scale-110","dark:bg-[#e0e0e8] dark:border-[#d0d0d8] dark:text-[#1e1e3a]","dark:hover:bg-[#5a5a7a] dark:hover:border-[#f0f0f8] dark:hover:text-[#f0f0f8]","bg-[#6a6a8a] border-[#7a7a9a] text-white shadow-[0_2px_4px_rgba(0,0,0,0.15)]","hover:bg-[#5a5a7a] hover:border-white hover:text-white",n?"w-4 h-4":"w-5 h-5")}function rs({validTypes:n,isCompact:e=!1,onCreateNode:t,renderMenu:o,directions:s=ns}){const[r,c]=a.useState(!1),[l,h]=a.useState(null),[u,x]=a.useState(null),b=a.useRef({top:null,right:null,bottom:null,left:null}),p=a.useCallback((i,m)=>{if(m.stopPropagation(),n.length===1){t(n[0],i);return}const y=b.current[i];if(!y)return;const v=y.getBoundingClientRect();x({x:v.x+v.width/2,y:v.y+v.height/2}),h(i),c(!0)},[n,t]),E=a.useCallback(i=>{l&&(t(i,l),c(!1),h(null))},[l,t]),d=a.useCallback(()=>{c(!1),h(null)},[]);if(n.length===0)return null;const f=ss(e);return g.jsxs(g.Fragment,{children:[g.jsx("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",children:s.map(i=>g.jsx("button",{ref:m=>{b.current[i]=m},className:q(f,os(i),"nodrag nopan"),onClick:m=>p(i,m),"aria-label":`Create node ${i==="top"?"above":i==="bottom"?"below":`to the ${i}`}`,title:"Add connected node",children:g.jsx(tn,{className:"w-3 h-3"})},i))}),r&&u&&l&&o({validTypes:n,anchorPosition:u,direction:l,onSelect:E,onClose:d})]})}const as=a.memo(rs),is=a.memo(function({instanceId:e,nodeType:t,isOutcome:o=!1,isCompact:s=!1}){const{getValidTargetTypes:r,createConnectedNode:c}=Ko(),l=r(t,o),h=a.useCallback((x,b)=>{c(e,x,b)},[e,c]),u=a.useCallback(x=>g.jsx(es,{...x}),[]);return g.jsx(as,{validTypes:l,isCompact:s,onCreateNode:h,renderMenu:u})}),cs=n=>n.nodes.filter(e=>e.selected).length+n.edges.filter(e=>e.selected).length;function Js({id:n,source:e,sourceX:t,sourceY:o,targetX:s,targetY:r,sourcePosition:c,targetPosition:l,selected:h,markerEnd:u,markerStart:x,data:b,simulationState:p,isRunning:E,start:d,triggerNode:f,selectTransition:i,getSourceDefinitionId:m}){const y=b,v=(y==null?void 0:y.state)||"idle",w=(y==null?void 0:y.progress)||0,T=(y==null?void 0:y.labelOffset)??.5,I=y==null?void 0:y.transitionId,B=(y==null?void 0:y.isNonStandard)||!1,M=y==null?void 0:y.sourceKind,N=y==null?void 0:y.targetKind,{setEdges:W}=Te(),{showTooltip:O,hideTooltip:A,setHoveredWarningEdgeId:$}=_t(),j=lt(cs),k=a.useRef(null),[_,L]=a.useState({x:0,y:0}),[F,z]=a.useState({x:0,y:0}),[P,G]=a.useState(0),X=a.useRef(void 0),H=a.useCallback((ee,re)=>{W(le=>le.map(de=>de.id===ee?{...de,data:{...de.data,labelOffset:re}}:de))},[W]),{isDragging:Y,hasDraggedRef:U,handleDragStart:Z}=yo({pathRef:k,edgeId:n,onOffsetChange:H}),Q=m(e),C=(Q?p==null?void 0:p.nodeStates.get(Q):void 0)==="waiting_for_action",V=a.useMemo(()=>({isRunning:E,start:d,triggerNode:f,selectTransition:i}),[E,d,f,i]),K=a.useMemo(()=>({isSourceWaiting:C}),[C]),{execute:ne}=Wo(V,K),se=ft(t,o,s,r,c,l);a.useLayoutEffect(()=>{if(k.current){const ee=k.current.getTotalLength();G(ee)}},[se]),a.useLayoutEffect(()=>{if(k.current&&P>0){const ee=k.current.getPointAtLength(P*T);z({x:ee.x,y:ee.y})}},[P,T]),a.useEffect(()=>{if(v!=="animating"||!k.current)return;const ee=k.current,re=ee.getTotalLength(),le=()=>{const de=(y==null?void 0:y.progress)||0,Ne=ee.getPointAtLength(re*de);L({x:Ne.x,y:Ne.y}),de<1&&(X.current=requestAnimationFrame(le))};return X.current=requestAnimationFrame(le),()=>{X.current&&cancelAnimationFrame(X.current)}},[v,y==null?void 0:y.progress]);const Ee=a.useCallback(ee=>{ee.stopPropagation(),ee.preventDefault(),!U.current&&(!I||!Q||ne(Q,I))},[I,Q,ne,U]),ye=P*(1-w),pe=!!I,J=pe;return a.useEffect(()=>{if(h&&j===1&&B&&M&&N)return $(n),O({edgeId:n,sourceKind:M,targetKind:N,targetPosition:{x:s,y:r}}),()=>{$(null),A()}},[h,j,B,M,N,n,s,r,O,A,$]),g.jsxs(g.Fragment,{children:[!B&&g.jsx("path",{d:se,fill:"none",stroke:v==="executed"?"#22c55e":"oklch(55% 0.18 303)",strokeWidth:16,strokeLinecap:"butt",style:{opacity:.15,pointerEvents:"none"}}),g.jsx(dt,{id:n,path:se,markerEnd:u,markerStart:x,className:[v==="idle"&&!h?"animate-dash-flow":"",B?"non-standard":""].filter(Boolean).join(" ")||void 0,style:{strokeDasharray:v==="idle"&&!h?"5 5":"none",opacity:v==="executed"?0:1}}),g.jsx("path",{ref:k,d:se,fill:"none",stroke:"transparent",strokeWidth:0}),(v==="animating"||v==="executed"||v==="waiting_at_label")&&P>0&&g.jsx("path",{d:se,fill:"none",stroke:"#22c55e",strokeWidth:2,style:{strokeDasharray:v!=="executed"?P:"none",strokeDashoffset:v!=="executed"?ye:0}}),v==="animating"&&g.jsxs(g.Fragment,{children:[g.jsx("circle",{cx:_.x,cy:_.y,r:10,fill:"rgba(34, 197, 94, 0.3)"}),g.jsx("circle",{cx:_.x,cy:_.y,r:6,fill:"#22c55e",style:{filter:"drop-shadow(0 0 4px rgba(34, 197, 94, 0.6))"}})]}),v==="waiting_at_label"&&g.jsxs(g.Fragment,{children:[g.jsx("circle",{cx:F.x,cy:F.y,r:10,fill:"rgba(34, 197, 94, 0.3)",className:"animate-ball-fade-out"}),g.jsx("circle",{cx:F.x,cy:F.y,r:6,fill:"#22c55e",className:"animate-ball-fade-out",style:{filter:"drop-shadow(0 0 4px rgba(34, 197, 94, 0.6))"}})]}),h&&g.jsxs(g.Fragment,{children:[g.jsx(st,{x:t,y:o}),g.jsx(st,{x:s,y:r})]}),g.jsx(ln,{children:g.jsx("div",{className:q("absolute cursor-grab select-none z-[1000] nodrag nopan",Y&&"cursor-grabbing",C&&"[&_.play-btn]:animate-button-pulse"),style:{position:"absolute",transform:`translate(-50%, -50%) translate(${F.x}px, ${F.y}px)`,pointerEvents:"all"},onMouseDown:Z,children:g.jsx("button",{className:q("play-btn w-[18px] h-[18px] rounded-full flex items-center justify-center p-0 outline-none shrink-0","shadow-[0_1px_3px_rgba(0,0,0,0.2)] transition-all duration-200",J?"bg-[#3b82f6] border border-white/30 text-white cursor-pointer hover:scale-[1.15] hover:bg-[#60a5fa] hover:border-white/50":"bg-[#3b82f6]/40 border border-white/20 text-white/50 cursor-default"),onClick:Ee,disabled:!J,title:pe?C?"Select this path":"Trigger command":"No transition connected",children:g.jsx(Ge,{className:"w-2.5 h-2.5"})})})})]})}function st({x:n,y:e}){return g.jsx("circle",{cx:n,cy:e,r:6,fill:"oklch(40% 0.18 303)",stroke:"#fff",strokeWidth:2,style:{cursor:"grab",filter:"drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3))"}})}const ls=n=>n.nodes.filter(e=>e.selected).length+n.edges.filter(e=>e.selected).length;function Zs({id:n,sourceX:e,sourceY:t,targetX:o,targetY:s,sourcePosition:r,targetPosition:c,selected:l,markerEnd:h,markerStart:u,data:x}){const{theme:b}=Eo(),{showTooltip:p,hideTooltip:E,setHoveredWarningEdgeId:d}=_t(),f=lt(ls),i=x,m=(i==null?void 0:i.state)||"idle",y=(i==null?void 0:i.progress)||0,v=(i==null?void 0:i.isNonStandard)||!1,w=i==null?void 0:i.sourceKind,T=i==null?void 0:i.targetKind,I=a.useRef(null),[B,M]=a.useState({x:0,y:0}),[N,W]=a.useState(0),O=a.useRef(void 0),A=ft(e,t,o,s,r,c);a.useLayoutEffect(()=>{if(I.current){const j=I.current.getTotalLength();W(j)}},[A]),a.useEffect(()=>{if(m!=="animating"||!I.current)return;const j=I.current,k=j.getTotalLength(),_=()=>{const L=(i==null?void 0:i.progress)||0,F=j.getPointAtLength(k*L);M({x:F.x,y:F.y}),L<1&&(O.current=requestAnimationFrame(_))};return O.current=requestAnimationFrame(_),()=>{O.current&&cancelAnimationFrame(O.current)}},[m,i==null?void 0:i.progress]);const $=N*(1-y);return a.useEffect(()=>{if(l&&f===1&&v&&w&&T)return d(n),p({edgeId:n,sourceKind:w,targetKind:T,targetPosition:{x:o,y:s}}),()=>{d(null),E()}},[l,f,v,w,T,n,o,s,p,E,d]),g.jsxs(g.Fragment,{children:[!v&&g.jsx("path",{d:A,fill:"none",stroke:m==="executed"?"#22c55e":"oklch(55% 0.18 303)",strokeWidth:16,strokeLinecap:"butt",style:{opacity:.15,pointerEvents:"none"}}),g.jsx(dt,{id:n,path:A,markerEnd:h,markerStart:u,className:[m==="idle"&&!l?"animate-dash-flow":"",v?"non-standard":""].filter(Boolean).join(" ")||void 0,style:{strokeDasharray:m==="idle"&&!l?"5 5":"none",opacity:m==="executed"?0:1}}),g.jsx("path",{ref:I,d:A,fill:"none",stroke:"transparent",strokeWidth:0}),(m==="animating"||m==="executed")&&N>0&&g.jsx("path",{d:A,fill:"none",stroke:"#22c55e",strokeWidth:2,style:{strokeDasharray:m==="animating"?N:"none",strokeDashoffset:m==="animating"?$:0}}),m==="animating"&&g.jsxs(g.Fragment,{children:[g.jsx("circle",{cx:B.x,cy:B.y,r:10,fill:"rgba(34, 197, 94, 0.3)"}),g.jsx("circle",{cx:B.x,cy:B.y,r:6,fill:"#22c55e",style:{filter:"drop-shadow(0 0 4px rgba(34, 197, 94, 0.6))"}})]}),l&&g.jsxs(g.Fragment,{children:[g.jsx(rt,{x:e,y:t,isLight:b==="light"}),g.jsx(rt,{x:o,y:s,isLight:b==="light"})]})]})}function rt({x:n,y:e,isLight:t}){const o=t?"#ffffff":"#1e1e3f",s=t?"oklch(45% 0.18 303)":"oklch(70% 0.15 303)";return g.jsx("circle",{cx:n,cy:e,r:6,fill:o,stroke:s,strokeWidth:2,style:{cursor:"grab",filter:"drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3))"}})}const ds=()=>({activeTransitions:new Map,animationFrame:void 0,processedEvents:new Set,previousEventsLength:0,wasWaiting:new Map,animate:null}),at=1e3,us=500;function er(n){const{setEdges:e,getEdges:t}=Te(),o=a.useRef(ds()),s=a.useCallback((l,h,u)=>{e(x=>x.map(b=>{const p=b.data;return(p==null?void 0:p.transitionId)===l?{...b,data:{...b.data,state:h,progress:u}}:b}))},[e]),r=a.useCallback(()=>{const l=o.current,h=Date.now();let u=!1;l.activeTransitions.forEach((x,b)=>{const p=h-x.startTime,E=x.targetProgress-x.startProgress,d=Math.min(p/x.duration,1),f=x.startProgress+d*E;d<1?(u=!0,s(b,"animating",f)):(x.targetProgress<1?(s(b,"waiting_at_label",x.targetProgress),l.wasWaiting.set(b,x.targetProgress)):s(b,"executed",1),l.activeTransitions.delete(b))}),u&&l.animate?l.animationFrame=requestAnimationFrame(l.animate):l.animationFrame=void 0},[s]);a.useEffect(()=>{o.current.animate=r},[r]);const c=a.useCallback(()=>{const l=o.current;l.animationFrame&&(cancelAnimationFrame(l.animationFrame),l.animationFrame=void 0),l.activeTransitions.clear(),l.processedEvents.clear(),l.wasWaiting.clear(),e(h=>h.map(u=>({...u,data:{...u.data,state:"idle",progress:0}})))},[e]);a.useEffect(()=>{const l=o.current;n.length===0&&l.previousEventsLength>0&&c(),l.previousEventsLength=n.length;let h=!1;n.forEach(u=>{var x,b,p;if(!l.processedEvents.has(u.id)){if(l.processedEvents.add(u.id),u.type==="transition:start"){const d=(x=u.data.transition)==null?void 0:x.id;if(!d)return;const f=l.wasWaiting.get(d),i=f!==void 0?f:0,m=f!==void 0?at*(1-f):at;l.wasWaiting.delete(d),l.activeTransitions.set(d,{transitionId:d,startTime:Date.now(),duration:m,startProgress:i,targetProgress:1}),s(d,"animating",i),h=!0}if(u.type==="transition:reset"){const d=(b=u.data.transition)==null?void 0:b.id;if(!d)return;l.activeTransitions.delete(d),s(d,"idle",0)}if(u.type==="simulation:reset"&&c(),u.type==="node:waiting"){const E=u.data;if(((p=E.node)==null?void 0:p.kind)!=="command")return;const d=E.availableTransitions||[],f=t();for(const i of d){const m=i.id,y=f.find(T=>{const I=T.data;return(I==null?void 0:I.transitionId)===m});if(!y)continue;const v=y.data,w=(v==null?void 0:v.labelOffset)??.5;l.activeTransitions.set(m,{transitionId:m,startTime:Date.now(),duration:us,startProgress:0,targetProgress:w}),s(m,"animating",0),h=!0}}}}),h&&!l.animationFrame&&(l.animationFrame=requestAnimationFrame(r))},[n,r,s,c,t]),a.useEffect(()=>{const l=o.current;return()=>{l.animationFrame&&cancelAnimationFrame(l.animationFrame)}},[])}export{Re as $,Xs as A,Js as B,Ue as C,Zs as D,Ds as E,hs as F,_t as G,Ws as H,er as I,Ms as J,Cs as K,Ss as L,ps as M,Bs as N,Qs as O,$o as P,is as Q,xs as R,bs as S,wn as T,ws as U,_s as V,No as W,Ln as X,we as Y,ut as Z,Yn as _,Be as a,Fe as a0,ht as a1,mt as a2,ve as a3,Kn as a4,xt as a5,Jn as a6,fe as a7,bt as a8,ks as a9,eo as aa,Zn as ab,to as ac,Et as ad,Qn as ae,xo as af,qs as ag,Ks as ah,Fn as ai,Bn as aj,Vn as ak,Un as al,Hn as am,es as an,as as ao,Rs as ap,Vs as aq,Wo as ar,ts as as,ce as at,vs as au,Lo as av,Sn as b,ge as c,ze as d,Ns as e,Ts as f,Ce as g,Ps as h,Is as i,Ge as j,Es as k,bo as l,Os as m,Eo as n,ys as o,As as p,Hs as q,Ys as r,Gs as s,Us as t,ho as u,js as v,Ls as w,Fs as x,zs as y,$s as z};
